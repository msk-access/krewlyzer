params {
    // Pipeline Options
    samplesheet = null  // Required: CSV with sample info
    help = false        // Display help message
    outdir = './results'
    ref = null          // Required
    targets = null      // Optional global targets
    
    // Mode Selection
    use_runall = true         // true = unified run-all (default), false = tool-level
    
    // Genome Build & Correction
    genome = 'hg19'           // Genome build (hg19/hg38)
    gc_correct = true         // Enable GC correction
    pon_model = null          // Optional global PON model path
    pon_variant = 'all_unique'  // PON variant: 'all_unique' (default) or 'duplex'
    
    // Assay-based asset resolution
    asset_dir = null          // Base directory for PON/targets lookup by assay
                              // Structure: {asset_dir}/pon/{assay}.pon.parquet
                              //            {asset_dir}/targets/{assay}_targets.bed
    
    // Panel-specific options
    bait_padding = 50         // Bait edge padding for WPS (bp)
    wps_anchors = null        // WPS anchors BED (auto-loaded if not specified)
    wps_background = null     // WPS background Alu BED (auto-loaded if not specified)
    
    // Filters & Algorithm Settings
    mapq = 20
    minlen = 65
    maxlen = 1000             // Extended FSD range (default: 1000bp)
    skip_duplicates = true
    require_proper_pair = false   // Duplex BAMs often lack proper-pair flags
    duplex = true             // Enable duplex weighting for mFSD (graceful fallback)
    exclude_regions = ''
    threads = 8

    // Region Entropy Toggles
    no_tfbs = false           // Disable TFBS entropy (--no-tfbs)
    no_atac = false           // Disable ATAC entropy (--no-atac)
    skip_pon = false          // Skip PON z-score normalization (--skip-pon)
    skip_target_regions = false  // Force WGS mode (--skip-target-regions)
    
    // E1-only (First Exon) Feature Toggles
    disable_e1_aggregation = false  // Skip E1-only FSC aggregation
    region_mds_e1_only = false      // Run region-MDS on E1 only

    // Logging & Observability
    verbose = false           // Enable verbose/debug logging in tools

    // Output Format Options
    generate_json = true      // Generate unified sample.features.json for ML (default: true)

    // nf-core institutional config support
    custom_config_version = 'master'
    custom_config_base    = "https://raw.githubusercontent.com/nf-core/configs/${params.custom_config_version}"
    monochrome_logs = false
    
    // Test mode inputs (used with -profile test)
    test_data_base = null
}

// Global Process Configuration
process {
    cpus = params.threads
    memory = '32 GB'
    time = '24h'
    shell = ['/bin/bash', '-euo', 'pipefail']

    // Publish Results organized by Sample ID
    publishDir = [
        path: { "${params.outdir}/${task.process.tokenize(':')[-1].tokenize('_')[-1].toLowerCase() == 'runall' ? meta.id : meta.id}" },
        mode: 'copy',
        saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
    ]

    // Tower/nf-core resource labels
    withLabel:process_low {
        cpus = 2
        memory = '4 GB'
        time = '1h'
    }
    withLabel:process_medium {
        cpus = 8
        memory = '16 GB'
        time = '8h'
    }
    withLabel:process_high {
        cpus = 8
        memory = '32 GB'
        time = '24h'
    }
}

// Load nf-core institutional configs (e.g. iris, jax, sanger, etc.)
// See: https://github.com/nf-core/configs
try {
    includeConfig "${params.custom_config_base}/nfcore_custom.config"
} catch (Exception e) {
    System.err.println("WARNING: Could not load nf-core/configs â€” institutional profiles unavailable")
}

// Profiles
profiles {
    docker {
        docker.enabled = true
        docker.runOptions = '--platform linux/amd64 --entrypoint=""'
        singularity.enabled = false
        podman.enabled = false
        shifter.enabled = false
        charliecloud.enabled = false
    }
    
    singularity {
        singularity.enabled = true
        singularity.autoMounts = true
        docker.enabled = false
    }
    
    slurm {
        process {
            executor = 'slurm'
            queue = 'cmobic_cpu'
            clusterOptions = '' // Add specific options if needed
        }
        singularity {
            enabled = true
            autoMounts = true
            cacheDir = "${HOME}/.singularity_cache"
        }
        docker.enabled = false
    }
    
    // Test profile for CI - uses stub-run mode
    test {
        params {
            outdir = './test_output'
            genome = 'hg19'
            threads = 2
        }
        process {
            cpus = 2
            memory = '4 GB'
            time = '1h'
        }
    }
    
    // Local development profile (no container, reduced resources for parallelism)
    local {
        docker.enabled = false
        singularity.enabled = false
        
        // Disable trace - macOS without container lacks ps for metrics
        trace.enabled = false
        
        // Lower CPUs per task to allow 2-3 concurrent samples on 12-CPU Mac
        process {
            cpus = 4
            memory = '8 GB'
            time = '24h'
        }
        
        params {
            threads = 4
        }
    }
}

// Execution reports for Tower
trace {
    enabled = true
    file = "${params.outdir}/pipeline_info/execution_trace.txt"
    overwrite = true
    fields = 'task_id,hash,native_id,process,tag,name,status,exit,module,container,cpus,time,disk,memory,attempt,submit,start,complete,duration,realtime,queue,%cpu,%mem,rss,vmem,peak_rss,peak_vmem,rchar,wchar,syscr,syscw,read_bytes,write_bytes'
}

report {
    enabled = true
    file = "${params.outdir}/pipeline_info/execution_report.html"
    overwrite = true
}

timeline {
    enabled = true
    file = "${params.outdir}/pipeline_info/execution_timeline.html"
    overwrite = true
}

dag {
    enabled = true
    file = "${params.outdir}/pipeline_info/pipeline_dag.svg"
    overwrite = true
}

manifest {
    name = 'msk-access/krewlyzer'
    author = 'MSK-ACCESS Team'
    homePage = 'https://github.com/msk-access/krewlyzer'
    description = 'Fragmentomics Feature Extraction Pipeline for cfDNA Analysis'
    mainScript = 'main.nf'
    nextflowVersion = '!>=22.10.1'
    version = '0.5.3'
}
