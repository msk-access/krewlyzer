{"config":{"lang":["en"],"separator":"[\\s\\-,:!=\\[\\]()\"/]+|(?!\\b)(?=[A-Z][a-z])|\\,(?!\\d)|&[lg]t;","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"Home","text":""},{"location":"#welcome-to-krewlyzer","title":"Welcome to Krewlyzer","text":"<p>Krewlyzer is a robust, user-friendly command-line toolkit for extracting a wide range of biological features from cell-free DNA (cfDNA) sequencing data. It is designed for cancer genomics, liquid biopsy research, and clinical bioinformatics, providing high-performance, reproducible feature extraction from BAM files.</p> <p>Krewlyzer draws inspiration from cfDNAFE and implements state-of-the-art methods for fragmentation, motif, and methylation analysis, all in a modern Pythonic interface with rich parallelization and logging.</p>"},{"location":"#tldr","title":"TL;DR","text":"<p>Krewlyzer extracts fragmentomics features from cfDNA sequencing data:</p> <ol> <li>Input: BAM file (aligned reads from blood sample)</li> <li>Output: Tables of numerical features for ML/statistical analysis</li> <li>Use case: Cancer detection, treatment monitoring, tissue-of-origin</li> </ol> <p>One command does it all: </p><pre><code>krewlyzer run-all -i sample.bam --reference hg19.fa --output results/\n</code></pre><p></p> <p>New to cfDNA? Start with What is Cell-Free DNA? Visual learner? See the Overview PDF Need terminology help? See the Glossary</p>"},{"location":"#key-features","title":"Key Features","text":"<ul> <li>Motif Analysis: End motifs, breakpoint motifs, and diversity scores.</li> <li>Fragment Size Analysis: Coverage (FSC), Ratios (FSR), and Distributions (FSD).</li> <li>Nucleosome Positioning: Windowed Protection Scores (WPS).</li> <li>Tissue of Origin: Orientation-aware Fragmentation (OCF).</li> <li>Methylation: Fragment-level methylation patterns (UXM).</li> <li>Mutant Analysis: Mutant vs. Wild-type fragment size comparison (mFSD).</li> </ul>"},{"location":"#system-requirements","title":"System Requirements","text":"<ul> <li>Linux or macOS (tested on Ubuntu 20.04, macOS 12+)</li> <li>Python 3.8+</li> <li>\u226516GB RAM recommended for large BAM files</li> <li>Docker (optional, for easiest setup)</li> </ul>"},{"location":"#installation","title":"Installation","text":""},{"location":"#with-docker-recommended","title":"With Docker (Recommended)","text":"<pre><code>docker pull ghcr.io/msk-access/krewlyzer:latest\n# Example usage:\ndocker run --rm -v $PWD:/data ghcr.io/msk-access/krewlyzer:latest run-all -i /data/sample.bam --reference /data/hg19.fa --output /data/output_dir\n</code></pre>"},{"location":"#with-uv-pip","title":"With uv / pip","text":"<pre><code>uv venv .venv\nsource .venv/bin/activate\nuv pip install krewlyzer\n</code></pre> Or install from source: <pre><code>git clone https://github.com/msk-access/krewlyzer.git\ncd krewlyzer\nuv pip install .\n</code></pre>"},{"location":"cli/","title":"Overview","text":""},{"location":"cli/#cli-reference","title":"CLI Reference","text":"<p>Krewlyzer provides a command-line interface for all feature extraction tools.</p>"},{"location":"cli/#main-command","title":"Main Command","text":"<pre><code>krewlyzer run-all -i sample.bam --reference hg19.fa --output results/\n</code></pre> <p>See run-all for the unified command that runs all features.</p>"},{"location":"cli/#individual-commands","title":"Individual Commands","text":"Command Description <code>extract</code> Extract fragments from BAM <code>fsc</code> Fragment Size Coverage <code>fsd</code> Fragment Size Distribution <code>fsr</code> Fragment Size Ratio <code>wps</code> Windowed Protection Score <code>motif</code> End Motif extraction <code>ocf</code> Orientation-aware Fragmentation <code>region-entropy</code> TFBS/ATAC entropy <code>region-mds</code> Per-gene MDS <code>mfsd</code> Mutant Fragment Size Distribution <code>uxm</code> Fragment-level Methylation <code>build-pon</code> Build Panel of Normals <code>build-gc-reference</code> Build GC reference assets"},{"location":"cli/#see-also","title":"See Also","text":"<ul> <li>Nextflow Pipeline - Batch processing</li> <li>Features - Feature documentation</li> </ul>"},{"location":"cli/run-all/","title":"run-all","text":""},{"location":"cli/run-all/#usage-guide","title":"Usage Guide","text":""},{"location":"cli/run-all/#command-summary","title":"Command Summary","text":"Command Description <code>motif</code> Motif-based feature extraction <code>fsc</code> Fragment size coverage (<code>.FSC.tsv</code>) <code>fsr</code> Fragment size ratio (<code>.FSR.tsv</code>) <code>fsd</code> Fragment size distribution (<code>.FSD.tsv</code>) <code>wps</code> Windowed protection score (<code>.WPS.parquet</code>) <code>ocf</code> Orientation-aware fragmentation (<code>.OCF.tsv</code>) <code>uxm</code> Fragment-level methylation (<code>.UXM.tsv</code>) <code>mfsd</code> Mutant fragment size distribution (<code>.mFSD.tsv</code>) <code>run-all</code> Run all features for a BAM"},{"location":"cli/run-all/#architecture-flowchart","title":"Architecture Flowchart","text":"<pre><code>flowchart TB\n    BAM[\"sample.bam\"] --&gt; EXTRACT[\"extract\"]\n    REF[\"Reference FASTA\"] --&gt; EXTRACT\n\n    EXTRACT --&gt; BED[\"sample.bed.gz\"]\n    EXTRACT --&gt; MOTIF[\"EndMotif + MDS\"]\n    EXTRACT --&gt; GC[\"GC Correction Factors\"]\n\n    BED --&gt; PIPELINE[\"Unified Rust Pipeline\"]\n    GC --&gt; PIPELINE\n\n    PIPELINE --&gt; FSC[\"FSC.tsv\"]\n    PIPELINE --&gt; FSR[\"FSR.tsv\"]\n    PIPELINE --&gt; FSD[\"FSD.tsv\"]\n    PIPELINE --&gt; WPS[\"WPS.parquet\"]\n    PIPELINE --&gt; OCF[\"OCF.tsv\"]\n\n    BED --&gt; ENTROPY[\"TFBS/ATAC Entropy\"]\n    ENTROPY --&gt; TFBS[\"TFBS.tsv\"]\n    ENTROPY --&gt; ATAC[\"ATAC.tsv\"]\n\n    EXTRACT --&gt; META[\"metadata.json\"]\n\n    subgraph \"With --variants\"\n        BAM --&gt; MFSD[\"mFSD.tsv\"]\n        MFSD_BAM[\"--mfsd-bam (optional)\"] -.-&gt; MFSD\n        VCF[\"variants.vcf/maf\"] --&gt; MFSD\n    end\n\n    subgraph \"With --assay (Panel Mode)\"\n        PIPELINE --&gt; FSCG[\"FSC.gene.tsv\"]\n        FSCG --&gt; FSCR[\"FSC.regions.tsv\"]\n        FSCR --&gt; E1[\"FSC.regions.e1only.tsv\"]\n        BAM --&gt; RMDS[\"Region-MDS\"]\n        RMDS --&gt; MDSE[\"MDS.exon.tsv\"]\n        RMDS --&gt; MDSG[\"MDS.gene.tsv\"]\n    end\n\n    subgraph \"With --target-regions\"\n        TARGETS[\"Target BED\"] --&gt; PIPELINE\n        PIPELINE --&gt; ON[\"*.ontarget.tsv files\"]\n    end\n</code></pre>  Use mouse to pan and zoom"},{"location":"cli/run-all/#pythonrust-boundary","title":"Python/Rust Boundary","text":"<pre><code>flowchart TB\n    subgraph \"Python Layer\"\n        CLI[\"run-all CLI (wrapper.py)\"]\n        UP[\"unified_processor.py\"]\n        PROC[\"*_processor.py (post-processing)\"]\n        PON[\"PonModel (normalization)\"]\n        ASSETS[\"AssetManager\"]\n    end\n\n    subgraph \"Rust Layer (_core)\"\n        EXTRACT[\"extract_fragments()\"]\n        UNIFIED[\"run_unified_pipeline()\"]\n        GC[\"GC correction\"]\n        FSC_R[\"FSC/FSR counting\"]\n        FSD_R[\"FSD per arm\"]\n        WPS_R[\"WPS profiling\"]\n        OCF_R[\"OCF calculation\"]\n    end\n\n    CLI --&gt; ASSETS\n    CLI --&gt; UP\n    UP --&gt; UNIFIED\n\n    UNIFIED --&gt; GC --&gt; FSC_R &amp; FSD_R &amp; WPS_R &amp; OCF_R\n\n    FSC_R --&gt; PROC\n    FSD_R --&gt; PROC\n    WPS_R --&gt; PROC\n    OCF_R --&gt; PROC\n\n    PROC --&gt; PON\n</code></pre>  Use mouse to pan and zoom"},{"location":"cli/run-all/#reference-data","title":"Reference Data","text":"<ul> <li>Reference Genome (FASTA):</li> <li>Download GRCh37/hg19 from UCSC</li> <li>BAMs must be sorted, indexed, and aligned to the same build</li> <li>Bin/Region/Marker Files:</li> <li>Provided in <code>krewlyzer/data/</code> (see options for each feature)</li> </ul>"},{"location":"cli/run-all/#typical-workflow","title":"Typical Workflow","text":"<p>The recommended way to run krewlyzer is using the Unified Pipeline via <code>run-all</code>, which processes the BAM file in a single pass for maximum efficiency.</p> <pre><code># Optimized Unified Pipeline\nkrewlyzer run-all sample.bam --reference hg19.fa --output output_dir \\\n    --variants variants.maf --bin-input targets.bed --threads 4\n</code></pre> <p>Alternatively, you can run tools individually. Note that most tools require a fragment BED file (<code>.bed.gz</code>) produced by the <code>extract</code> command.</p> <pre><code># 1. Extract fragments (BAM -&gt; BED.gz)\nkrewlyzer extract -i sample.bam -r hg19.fa -o output_dir\n\n# 2. Run feature tools using the BED file\nkrewlyzer fsc -i output_dir/sample.bed.gz --output output_dir/\nkrewlyzer wps -i output_dir/sample.bed.gz --output output_dir/\n# ... (fsd, ocf, etc.)\n\n# 3. Motif analysis (Independent of BED, uses BAM directly)\nkrewlyzer motif -i sample.bam -r hg19.fa -o output_dir \n</code></pre>"},{"location":"cli/run-all/#targeted-panel-usage-access-etc","title":"Targeted Panel Usage (ACCESS, etc.)","text":"<p>For targeted sequencing panels (e.g., MSK-ACCESS), FSC/FSR require a custom regions BED file instead of the default genome-wide 100kb bins:</p> <pre><code># Using run-all with custom target regions\nkrewlyzer run-all sample.bam --reference hg19.fa --output out/ \\\n  --bin-input /path/to/MSK-ACCESS-v2_canonicaltargets.bed\n\n# Or run FSC/FSR individually with target regions\nkrewlyzer fsc -i motif_out/sample.bed.gz -b targets.bed -w 1 -c 1 --output out_dir/\nkrewlyzer fsr -i motif_out/sample.bed.gz -b targets.bed -w 1 -c 1 --output out_dir/\n</code></pre> <p>Note</p> <p>Without <code>--bin-input</code>, FSC/FSR will produce zeros for targeted panels since data only covers specific gene regions, not genome-wide bins. The <code>--output</code> argument for individual tools specifies the output directory, not a filename.</p>"},{"location":"cli/run-all/#pon-and-z-score-normalization","title":"PON and Z-Score Normalization","text":""},{"location":"cli/run-all/#auto-pon-with-assay-flag","title":"Auto-PON with Assay Flag","text":"<p>When you specify an assay with <code>-A</code>, the bundled PON is automatically loaded:</p> <pre><code># Auto-loads bundled PON for xs2 assay and applies z-scores\nkrewlyzer run-all -i sample.bam -r hg19.fa -o out/ -A xs2 -G hg19\n</code></pre>"},{"location":"cli/run-all/#skip-z-score-normalization-skip-pon","title":"Skip Z-Score Normalization (<code>--skip-pon</code>)","text":"<p>For ML training workflows where PON samples are used as true negatives:</p> <pre><code># Process PON samples as ML negatives (auto-loads PON but skips z-scores)\nkrewlyzer run-all -i pon_sample.bam -r hg19.fa -o out/ -A xs2 --skip-pon\n\n# Individual tools also support --skip-pon\nkrewlyzer fsd -i sample.bed.gz -o out/ --skip-pon\n</code></pre> <p>Warning</p> <p><code>-P/--pon-model</code> and <code>--skip-pon</code> are mutually exclusive.</p>"},{"location":"cli/run-all/#pon-variant-selection-pon-variant","title":"PON Variant Selection (<code>--pon-variant</code>)","text":"<p>For duplex sequencing workflows, select the appropriate PON variant:</p> <pre><code># Default: all_unique PON (standard cfDNA, max coverage)\nkrewlyzer run-all -i sample.bam -r hg19.fa -o out/ -A xs2\n\n# Duplex PON (highest accuracy for duplex consensus BAMs)\nkrewlyzer run-all -i sample.bam -r hg19.fa -o out/ -A xs2 --pon-variant duplex\n</code></pre> <p>Note</p> <p><code>--pon-variant</code> controls PON file selection, while <code>--duplex</code> (mFSD only) enables cD tag weighting.</p>"},{"location":"cli/run-all/#output-formats","title":"Output Formats","text":"<p>Krewlyzer outputs support multiple formats for different use cases.</p>"},{"location":"cli/run-all/#unified-json-for-ml","title":"Unified JSON for ML","text":"<pre><code># Generate single JSON with ALL features for ML pipelines\nkrewlyzer run-all sample.bam --reference hg19.fa --output out/ --generate-json\n# Output: out/sample.features.json (contains FSD, FSR, WPS, Motif, OCF, etc.)\n</code></pre> <p>Note</p> <p>Output format is determined automatically per feature (TSV for tabular data, Parquet for WPS profiles). There is no global <code>--output-format</code> flag. Use <code>--generate-json</code> to produce a unified JSON for ML pipelines.</p> <p>See JSON Output for full documentation.</p>"},{"location":"development/changelog/","title":"Changelog","text":""},{"location":"development/contributing-data/","title":"Contributing Data","text":""},{"location":"development/contributing-data/#contributing-data-files","title":"Contributing Data Files","text":"<p>This guide explains how to add or modify data files in the Krewlyzer repository.</p>"},{"location":"development/contributing-data/#git-lfs-setup","title":"Git LFS Setup","text":"<p>The <code>src/krewlyzer/data/</code> folder uses Git LFS (Large File Storage) for binary files.</p>"},{"location":"development/contributing-data/#file-types-tracked","title":"File Types Tracked","text":"<pre><code>src/krewlyzer/data/**/*.gz filter=lfs diff=lfs merge=lfs -text\nsrc/krewlyzer/data/**/*.parquet filter=lfs diff=lfs merge=lfs -text\nsrc/krewlyzer/data/**/*.bed filter=lfs diff=lfs merge=lfs -text\n</code></pre>"},{"location":"development/contributing-data/#prerequisites","title":"Prerequisites","text":"<ol> <li> <p>Install Git LFS:    </p><pre><code># macOS\nbrew install git-lfs\n\n# Ubuntu\napt-get install git-lfs\n</code></pre><p></p> </li> <li> <p>Initialize LFS in your clone:    </p><pre><code>cd krewlyzer\ngit lfs install\n</code></pre><p></p> </li> </ol>"},{"location":"development/contributing-data/#cloning-with-lfs","title":"Cloning with LFS","text":"<pre><code># Clone with LFS files\ngit clone https://github.com/msk-access/krewlyzer.git\n\n# If LFS files weren't pulled, fetch them\ngit lfs pull\n</code></pre>"},{"location":"development/contributing-data/#adding-new-panel-assets","title":"Adding New Panel Assets","text":""},{"location":"development/contributing-data/#1-target-regions","title":"1. Target Regions","text":"<p>Place in <code>src/krewlyzer/data/targets/GRCh37/</code>:</p> <pre><code># File: {assay}.targets.bed.gz\n# Format: BED3 or BED4\nchr1  11166102  11166202  MTOR_exon1\nchr1  27022522  27022622  ARID1A_exon1\n</code></pre>"},{"location":"development/contributing-data/#2-tfbs-regions-pre-intersected","title":"2. TFBS Regions (Pre-intersected)","text":"<p>Place in <code>src/krewlyzer/data/TFBS/GRCh37/</code>:</p> <pre><code># Create panel-specific TFBS by intersecting with targets\nbedtools intersect -u \\\n    -a Homo_sapiens_meta_clusters_hg19.bed.gz \\\n    -b ../targets/GRCh37/{assay}.targets.bed.gz \\\n    | bgzip &gt; {assay}.meta_clusters_hg19.bed.gz\ntabix -p bed {assay}.meta_clusters_hg19.bed.gz\n</code></pre>"},{"location":"development/contributing-data/#3-atac-regions-pre-intersected","title":"3. ATAC Regions (Pre-intersected)","text":"<p>Place in <code>src/krewlyzer/data/ATAC/GRCh37/</code>:</p> <pre><code># Create panel-specific ATAC by intersecting with targets\nbedtools intersect -u \\\n    -a TCGA_ATAC_peak.hg19.bed.gz \\\n    -b ../targets/GRCh37/{assay}.targets.bed.gz \\\n    | bgzip &gt; {assay}.TCGA_ATAC_peak.hg19.bed.gz\ntabix -p bed {assay}.TCGA_ATAC_peak.hg19.bed.gz\n</code></pre>"},{"location":"development/contributing-data/#4-wps-anchors","title":"4. WPS Anchors","text":"<p>Place in <code>src/krewlyzer/data/WpsAnchors/GRCh37/</code>:</p> <pre><code># File: {assay}.wps_anchors.bed.gz\n# Format: BED6 with TSS/CTCF annotations\nchr1  10000  10500  TSS  100  +\nchr1  15000  15500  CTCF  100  -\n</code></pre>"},{"location":"development/contributing-data/#file-format-requirements","title":"File Format Requirements","text":"File Type Format Index Notes Targets BED3/4 Optional 0-based coordinates TFBS BED4 <code>.tbi</code> Col4 = TF name ATAC BED4 <code>.tbi</code> Col4 = cancer type WPS Anchors BED6 <code>.tbi</code> TSS/CTCF regions Gene BEDs BED6 None Per-gene exon regions"},{"location":"development/contributing-data/#compression","title":"Compression","text":"<ul> <li> <p>Use bgzip (not gzip) for indexed files:   </p><pre><code>bgzip file.bed\ntabix -p bed file.bed.gz\n</code></pre><p></p> </li> <li> <p>BGZF format is required for tabix indexing</p> </li> </ul>"},{"location":"development/contributing-data/#registering-assets","title":"Registering Assets","text":"<p>After adding files, update <code>src/krewlyzer/assets.py</code>:</p> <pre><code># In AssetManager.get_targets()\nif assay == \"new_assay\":\n    return self.targets_dir / \"new_assay.targets.bed.gz\"\n</code></pre>"},{"location":"development/contributing-data/#committing-lfs-files","title":"Committing LFS Files","text":"<pre><code># Stage new files\ngit add src/krewlyzer/data/targets/GRCh37/new_assay.targets.bed.gz\n\n# Verify LFS tracking\ngit lfs status\n\n# Commit\ngit commit -m \"feat: add new_assay target regions\"\n\n# Push (uploads to LFS)\ngit push origin main\n</code></pre>"},{"location":"development/contributing-data/#troubleshooting","title":"Troubleshooting","text":""},{"location":"development/contributing-data/#lfs-object-not-found","title":"\"LFS object not found\"","text":"<pre><code>git lfs fetch --all\ngit lfs checkout\n</code></pre>"},{"location":"development/contributing-data/#large-clone-size","title":"Large clone size","text":"<pre><code># Clone without LFS content (faster)\nGIT_LFS_SKIP_SMUDGE=1 git clone https://github.com/msk-access/krewlyzer.git\n\n# Pull only needed LFS files\ngit lfs pull --include=\"src/krewlyzer/data/gc/**\"\n</code></pre>"},{"location":"development/contributing/","title":"Contributing","text":""},{"location":"development/developer-guide/","title":"Developer Guide","text":""},{"location":"development/developer-guide/#developer-guide","title":"Developer Guide","text":"<p>This guide covers the Krewlyzer codebase architecture for contributors.</p>"},{"location":"development/developer-guide/#repository-structure","title":"Repository Structure","text":"<pre><code>krewlyzer/\n\u251c\u2500\u2500 src/krewlyzer/          # Python package\n\u2502   \u251c\u2500\u2500 cli.py              # Typer CLI entry point\n\u2502   \u251c\u2500\u2500 wrapper.py          # run-all orchestration\n\u2502   \u251c\u2500\u2500 assets.py           # AssetManager for bundled data\n\u2502   \u251c\u2500\u2500 extract.py          # BAM \u2192 BED extraction\n\u2502   \u251c\u2500\u2500 fsc.py              # Fragment size coverage\n\u2502   \u251c\u2500\u2500 fsd.py              # Fragment size distribution\n\u2502   \u251c\u2500\u2500 fsr.py              # Fragment size ratio\n\u2502   \u251c\u2500\u2500 wps.py              # Windowed protection score\n\u2502   \u251c\u2500\u2500 ocf.py              # Orientation-aware fragmentation\n\u2502   \u251c\u2500\u2500 motif.py            # End motif analysis\n\u2502   \u251c\u2500\u2500 mfsd.py             # Mutant fragment size distribution\n\u2502   \u251c\u2500\u2500 region_entropy.py   # TFBS/ATAC region entropy\n\u2502   \u251c\u2500\u2500 region_mds.py       # Per-gene MDS\n\u2502   \u251c\u2500\u2500 uxm.py              # Fragment-level methylation\n\u2502   \u251c\u2500\u2500 build_gc_reference.py # GC reference generation\n\u2502   \u251c\u2500\u2500 core/               # Shared processors\n\u2502   \u2502   \u251c\u2500\u2500 asset_resolution.py  # Target/PON resolution logic\n\u2502   \u2502   \u251c\u2500\u2500 asset_validation.py  # Asset validation checks\n\u2502   \u2502   \u251c\u2500\u2500 bam_utils.py         # BAM utilities\n\u2502   \u2502   \u251c\u2500\u2500 feature_serializer.py # JSON output\n\u2502   \u2502   \u251c\u2500\u2500 fsc_processor.py     # FSC post-processing\n\u2502   \u2502   \u251c\u2500\u2500 fsd_processor.py     # FSD post-processing\n\u2502   \u2502   \u251c\u2500\u2500 fsr_processor.py     # FSR post-processing\n\u2502   \u2502   \u251c\u2500\u2500 gc_assets.py         # GC resolution helper\n\u2502   \u2502   \u251c\u2500\u2500 gene_bed.py          # Gene BED parsing\n\u2502   \u2502   \u251c\u2500\u2500 logging.py           # Startup banner and logging\n\u2502   \u2502   \u251c\u2500\u2500 motif_processor.py   # Motif post-processing\n\u2502   \u2502   \u251c\u2500\u2500 ocf_processor.py     # OCF post-processing\n\u2502   \u2502   \u251c\u2500\u2500 pon_integration.py   # PON post-processing\n\u2502   \u2502   \u251c\u2500\u2500 region_entropy_processor.py # TFBS/ATAC processor\n\u2502   \u2502   \u251c\u2500\u2500 sample_processor.py  # Per-sample orchestration\n\u2502   \u2502   \u251c\u2500\u2500 unified_processor.py # Unified pipeline Python layer\n\u2502   \u2502   \u251c\u2500\u2500 wps_processor.py     # WPS post-processing\n\u2502   \u2502   \u2514\u2500\u2500 utils.py, resource_utils.py\n\u2502   \u251c\u2500\u2500 pon/                # PON model code\n\u2502   \u2502   \u251c\u2500\u2500 model.py        # PonModel dataclass\n\u2502   \u2502   \u2514\u2500\u2500 build.py        # PON building logic\n\u2502   \u2514\u2500\u2500 data/               # Bundled assets (Git LFS)\n\u251c\u2500\u2500 rust/                   # Rust backend (19 modules)\n\u2502   \u251c\u2500\u2500 Cargo.toml\n\u2502   \u2514\u2500\u2500 src/\n\u2502       \u251c\u2500\u2500 lib.rs          # PyO3 module exports\n\u2502       \u251c\u2500\u2500 pipeline.rs     # Unified pipeline entry\n\u2502       \u251c\u2500\u2500 engine.rs       # Core engine utilities\n\u2502       \u251c\u2500\u2500 bed.rs          # BGZF/gzip BED reader\n\u2502       \u251c\u2500\u2500 filters.rs      # Fragment filtering logic\n\u2502       \u2514\u2500\u2500 (feature modules: see table below)\n\u251c\u2500\u2500 tests/                  # Test suite (248 tests)\n\u251c\u2500\u2500 docs/                   # MkDocs documentation\n\u2514\u2500\u2500 nextflow/               # Nextflow pipeline\n    \u251c\u2500\u2500 main.nf\n    \u251c\u2500\u2500 nextflow.config\n    \u251c\u2500\u2500 modules/local/       # Per-tool NF modules\n    \u2514\u2500\u2500 subworkflows/local/  # Subworkflows\n</code></pre>"},{"location":"development/developer-guide/#rust-backend-architecture","title":"Rust Backend Architecture","text":""},{"location":"development/developer-guide/#module-structure","title":"Module Structure","text":"<pre><code>lib.rs\n\u251c\u2500\u2500 extract_motif     # BAM extraction module\n\u251c\u2500\u2500 gc                # GC correction module  \n\u251c\u2500\u2500 run_unified_pipeline  # Main pipeline function\n\u2514\u2500\u2500 configure_threads # Thread pool setup\n</code></pre>"},{"location":"development/developer-guide/#key-rust-modules","title":"Key Rust Modules","text":"<p>| Module | Purpose | |--------|---------|| | <code>lib.rs</code> | PyO3 module exports and thread config | | <code>pipeline.rs</code> | Unified pipeline coordination | | <code>engine.rs</code> | Core engine utilities | | <code>bed.rs</code> | BGZF/gzip BED reader | | <code>extract_motif.rs</code> | BAM parsing, fragment + motif extraction | | <code>motif_utils.rs</code> | Shared 4-mer encoding, MDS, GC utils | | <code>fsc.rs</code> | Fragment size coverage + gene aggregation | | <code>fsd.rs</code> | Per-arm size distribution + PON log-ratio | | <code>wps.rs</code> | Dual-stream WPS, FFT, smoothing | | <code>ocf.rs</code> | Orientation-aware fragmentation + PON z-score | | <code>mfsd.rs</code> | Mutant fragment size distribution | | <code>region_entropy.rs</code> | TFBS/ATAC entropy + PON z-score | | <code>region_mds.rs</code> | Per-gene MDS at exon boundaries | | <code>uxm.rs</code> | Fragment-level methylation (UXM) | | <code>gc_correction.rs</code> | LOESS GC bias correction | | <code>gc_reference.rs</code> | Pre-computed GC reference generation | | <code>pon_model.rs</code> | PON model loading and hybrid correction | | <code>pon_builder.rs</code> | PON model construction | | <code>filters.rs</code> | Fragment filtering logic |</p>"},{"location":"development/developer-guide/#unified-pipeline","title":"Unified Pipeline","text":"<p>All feature computation goes through <code>run_unified_pipeline</code>:</p> <pre><code>pub fn run_unified_pipeline(\n    _py: Python,\n    bed_path: PathBuf,\n    // GC Correction\n    gc_ref_path: Option&lt;PathBuf&gt;,\n    valid_regions_path: Option&lt;PathBuf&gt;,\n    correction_out_path: Option&lt;PathBuf&gt;,\n    correction_input_path: Option&lt;PathBuf&gt;,\n    // FSC\n    fsc_bins: Option&lt;PathBuf&gt;, fsc_output: Option&lt;PathBuf&gt;,\n    // WPS Foreground (TSS/CTCF anchors)\n    wps_regions: Option&lt;PathBuf&gt;, wps_output: Option&lt;PathBuf&gt;,\n    // WPS Background (Alu stacking)\n    wps_background_regions: Option&lt;PathBuf&gt;, wps_background_output: Option&lt;PathBuf&gt;,\n    wps_empty: bool,\n    // FSD\n    fsd_arms: Option&lt;PathBuf&gt;, fsd_output: Option&lt;PathBuf&gt;,\n    // OCF\n    ocf_regions: Option&lt;PathBuf&gt;, ocf_output: Option&lt;PathBuf&gt;,\n    // Target regions for on/off-target split (panel mode)\n    target_regions_path: Option&lt;PathBuf&gt;,\n    bait_padding: u64,\n    silent: bool,\n) -&gt; PyResult&lt;()&gt;\n</code></pre>"},{"location":"development/developer-guide/#adding-a-new-feature","title":"Adding a New Feature","text":"<ol> <li>Create Rust module (<code>rust/src/new_feature.rs</code>)</li> <li>Add to lib.rs module exports</li> <li>Create Python wrapper (<code>src/krewlyzer/new_feature.py</code>)</li> <li>Add to CLI in <code>cli.py</code></li> <li>Integrate with run_unified_pipeline if applicable</li> <li>Add to FeatureSerializer for JSON output</li> <li>Write tests in <code>tests/unit/</code> and <code>tests/integration/</code></li> </ol>"},{"location":"development/developer-guide/#python-architecture","title":"Python Architecture","text":""},{"location":"development/developer-guide/#tool-pattern","title":"Tool Pattern","text":"<p>All standalone tools follow this pattern:</p> <pre><code>def tool_name(\n    input: Path = typer.Option(...),\n    output: Path = typer.Option(...),\n    # ... options\n):\n    # 1. Initialize AssetManager\n    assets = AssetManager(genome)\n\n    # 2. Resolve GC assets (use helper)\n    from .core.gc_assets import resolve_gc_assets\n    gc = resolve_gc_assets(assets, output, sample_name, input, gc_correct, genome)\n\n    # 3. Call Rust backend\n    _core.run_unified_pipeline(...)\n\n    # 4. Post-process (Python)\n    from .core.tool_processor import process_tool\n    process_tool(output_file, ...)\n</code></pre>"},{"location":"development/developer-guide/#assetmanager","title":"AssetManager","text":"<p>Centralizes access to bundled data:</p> <pre><code>assets = AssetManager(\"hg19\")\n\n# Properties\nassets.gc_reference      # GC ref parquet\nassets.valid_regions     # Valid regions BED\nassets.bins_100kb        # Default bins\nassets.wps_anchors       # WPS anchors BED\n\n# Assay-aware methods\nassets.get_gene_bed(\"xs2\")     # Panel gene BED\nassets.get_wps_anchors(\"xs2\")  # Panel WPS anchors\nassets.get_pon(\"xs2\")          # Bundled PON\n</code></pre>"},{"location":"development/developer-guide/#featureserializer","title":"FeatureSerializer","text":"<p>Collects all features into unified JSON:</p> <pre><code>serializer = FeatureSerializer(sample_id, version=\"0.5.3\")\nserializer.add_fsc(fsc_df)\nserializer.add_fsc_e1(fsc_e1_df)\nserializer.add_wps(wps_df)\nserializer.add_motif(edm_df, bpm_df, mds, mds_z)\nserializer.add_ocf(ocf_df)\nserializer.add_mfsd(mfsd_df)\nserializer.add_uxm(uxm_df)\nserializer.add_qc(\"total_fragments\", 1234567)\nserializer.save(output_dir)\n\n# Or load from existing outputs\nserializer = FeatureSerializer.from_outputs(\n    sample_id=sample_id,\n    output_dir=output_dir,\n    version=\"0.5.3\"\n)\n</code></pre>"},{"location":"development/developer-guide/#testing","title":"Testing","text":"<p>Krewlyzer has 248 tests across unit, integration, and e2e categories.</p> <p>\u2192 Testing Guide for complete documentation including: - Feature \u2192 test file mapping - Fixture reference - Test writing examples</p>"},{"location":"development/developer-guide/#quick-commands","title":"Quick Commands","text":"<pre><code># All tests\npytest tests/\n\n# Fast unit tests only\npytest tests/unit/\n\n# Specific feature\npytest tests/unit/test_fsc.py\n\n# With coverage\npytest tests/ --cov=krewlyzer --cov-report=html\n</code></pre> <p>Tip</p> <p>Modifying a feature? Check the Feature \u2192 Test Map to find which test file to update.</p>"},{"location":"development/developer-guide/#rust-development","title":"Rust Development","text":""},{"location":"development/developer-guide/#building","title":"Building","text":"<pre><code>cd rust\n\n# Debug build (fast compile, slow run)\nmaturin develop\n\n# Release build (slow compile, fast run)\nmaturin develop --release\n</code></pre>"},{"location":"development/developer-guide/#testing-rust","title":"Testing Rust","text":"<pre><code># Run Rust tests (currently minimal)\ncargo test\n\n# Check before committing\ncargo clippy\ncargo fmt --check\n</code></pre>"},{"location":"development/developer-guide/#debugging","title":"Debugging","text":"<pre><code># Enable verbose logging\nRUST_LOG=debug krewlyzer run-all -i sample.bam ...\n\n# Or in Python\npython -c \"\nimport logging\nlogging.basicConfig(level=logging.DEBUG)\nfrom krewlyzer import _core\n# ... your test code\n\"\n</code></pre>"},{"location":"development/developer-guide/#code-style","title":"Code Style","text":""},{"location":"development/developer-guide/#python","title":"Python","text":"<ul> <li>Use <code>typer</code> for CLIs</li> <li>Use <code>rich</code> for logging/progress</li> <li>Type hints for all public functions</li> <li>Docstrings (Google style)</li> </ul>"},{"location":"development/developer-guide/#rust","title":"Rust","text":"<ul> <li>Run <code>cargo fmt</code> before committing</li> <li>Address <code>cargo clippy</code> warnings</li> <li>Use <code>anyhow::Result</code> for error handling</li> <li>Log with <code>log::info!</code>, <code>log::debug!</code></li> </ul>"},{"location":"development/developer-guide/#contributing-checklist","title":"Contributing Checklist","text":"<ul> <li> Code follows existing patterns</li> <li> Added/updated tests</li> <li> Updated documentation</li> <li> Ran <code>pytest tests/</code></li> <li> Ran <code>cargo fmt &amp;&amp; cargo clippy</code></li> <li> Updated CHANGELOG.md</li> </ul> <p>See CONTRIBUTING.md for full guidelines.</p>"},{"location":"development/release-guide/","title":"Release Guide","text":""},{"location":"development/release-guide/#release-guide","title":"Release Guide","text":"<p>This guide documents the process for releasing new versions of Krewlyzer following Git Flow.</p>"},{"location":"development/release-guide/#prerequisites","title":"Prerequisites","text":"<ul> <li>Git LFS installed and configured</li> <li>Access to push to <code>origin</code></li> <li>All tests passing on develop branch</li> </ul> <p>Important</p> <p>Version Format: Use <code>0.5.2</code> (no <code>v</code> prefix) everywhere - code, filenames, and git tags.</p>"},{"location":"development/release-guide/#git-flow-overview","title":"Git Flow Overview","text":"<pre><code>gitGraph\n    commit id: \"develop\"\n    branch release/X.Y.Z\n    commit id: \"bump version\"\n    commit id: \"update CHANGELOG\"\n    checkout main\n    merge release/X.Y.Z tag: \"vX.Y.Z\"\n    checkout develop\n    merge release/X.Y.Z\n</code></pre>  Use mouse to pan and zoom"},{"location":"development/release-guide/#phase-1-create-release-branch","title":"Phase 1: Create Release Branch","text":"<pre><code># Ensure you're on latest develop\ngit checkout develop\ngit pull origin develop\n\n# Create release branch\ngit checkout -b release/X.Y.Z\n\n# Verify\ngit branch --show-current\n</code></pre>"},{"location":"development/release-guide/#phase-2-update-version-files","title":"Phase 2: Update Version Files","text":""},{"location":"development/release-guide/#version-locations-37-total","title":"Version Locations (37 total)","text":"Category File Line(s) Python <code>src/krewlyzer/__init__.py</code> 3 Python <code>pyproject.toml</code> 3 Python <code>src/krewlyzer/wrapper.py</code> 674 Python <code>src/krewlyzer/core/feature_serializer.py</code> 54, 291 Rust <code>rust/Cargo.toml</code> 3 Rust <code>rust/Cargo.lock</code> Auto-updated Nextflow <code>nextflow/nextflow.config</code> 171 Nextflow <code>nextflow/main.nf</code> 36 Modules <code>nextflow/modules/local/krewlyzer/*/main.nf</code> 2 per module"},{"location":"development/release-guide/#quick-update-script","title":"Quick Update Script","text":"<pre><code>VERSION=\"X.Y.Z\"\nOLD_VERSION=\"A.B.C\"  # Current version before bump\n\n# Python\nsed -i '' \"s/__version__ = \\\".*\\\"/__version__ = \\\"${VERSION}\\\"/g\" src/krewlyzer/__init__.py\nsed -i '' \"s/version = \\\"${OLD_VERSION}\\\"/version = \\\"${VERSION}\\\"/g\" pyproject.toml\nsed -i '' \"s/version=\\\"${OLD_VERSION}\\\"/version=\\\"${VERSION}\\\"/g\" src/krewlyzer/wrapper.py\nsed -i '' \"s/\\\"${OLD_VERSION}\\\"/\\\"${VERSION}\\\"/g\" src/krewlyzer/core/feature_serializer.py\n\n# Rust\nsed -i '' \"s/version = \\\"${OLD_VERSION}\\\"/version = \\\"${VERSION}\\\"/g\" rust/Cargo.toml\ncd rust &amp;&amp; cargo check &amp;&amp; cd ..\n\n# Nextflow\nsed -i '' \"s/${OLD_VERSION}/${VERSION}/g\" nextflow/nextflow.config\nsed -i '' \"s/${OLD_VERSION}/${VERSION}/g\" nextflow/main.nf\nfind nextflow/modules -name \"main.nf\" -exec sed -i '' \"s/${OLD_VERSION}/${VERSION}/g\" {} \\;\n</code></pre>"},{"location":"development/release-guide/#phase-25-update-documentation-versions","title":"Phase 2.5: Update Documentation Versions","text":"<p>Docker image versions are referenced in documentation files:</p> File Version Location <code>docs/getting-started/installation.md</code> Docker/Singularity pull commands <code>docs/getting-started/quickstart.md</code> Docker pull example <code>docs/nextflow/examples.md</code> Container image references"},{"location":"development/release-guide/#update-script","title":"Update Script","text":"<pre><code>OLD_VERSION=\"0.5.1\"\nVERSION=\"X.Y.Z\"\n\n# Update installation docs\nsed -i '' \"s/${OLD_VERSION}/${VERSION}/g\" docs/getting-started/installation.md\nsed -i '' \"s/${OLD_VERSION}/${VERSION}/g\" docs/getting-started/quickstart.md\n\n# Verify no :latest tags remain (we don't publish :latest)\ngrep -r \":latest\" docs/ &amp;&amp; echo \"WARNING: :latest tags found!\" || echo \"\u2713 No :latest tags\"\n\n# Verify changes\ngrep -n \"ghcr.io/msk-access/krewlyzer\" docs/getting-started/*.md\n</code></pre> <p>No :latest Tag</p> <p>We do NOT publish a <code>:latest</code> tag. Always use explicit version tags (e.g., <code>:0.5.3</code>). Replace <code>X.Y.Z</code> with the version from releases.</p>"},{"location":"development/release-guide/#phase-3-update-changelog","title":"Phase 3: Update CHANGELOG","text":"<p>Add new entry at the top of <code>CHANGELOG.md</code>:</p> <pre><code>## [X.Y.Z] - YYYY-MM-DD\n\n### Added\n- Feature descriptions\n\n### Changed\n- Breaking changes and modifications\n\n### Fixed\n- Bug fixes\n\n### Documentation\n- Doc updates\n</code></pre>"},{"location":"development/release-guide/#phase-4-verify-and-commit","title":"Phase 4: Verify and Commit","text":"<pre><code># Run tests\npytest tests/ -v --tb=short\n\n# Verify Rust compiles\ncd rust &amp;&amp; cargo check &amp;&amp; cd ..\n\n# Check version\npython -c \"from krewlyzer import __version__; print(__version__)\"\n\n# Commit\ngit add -A\ngit commit -m \"chore: bump version to X.Y.Z\"\n\n# Push release branch for review\ngit push -u origin release/X.Y.Z\n</code></pre>"},{"location":"development/release-guide/#phase-5-finalize-release","title":"Phase 5: Finalize Release","text":"<p>After review and approval:</p> <pre><code># Merge to main\ngit checkout main\ngit pull origin main\ngit merge --no-ff release/X.Y.Z -m \"Release vX.Y.Z\"\n\n# Create annotated tag\ngit tag -a vX.Y.Z -m \"Release vX.Y.Z\"\n\n# Push main and tag (triggers CI release)\ngit push origin main\ngit push origin vX.Y.Z\n\n# Merge back to develop\ngit checkout develop\ngit merge --no-ff release/X.Y.Z -m \"Merge release/X.Y.Z back to develop\"\ngit push origin develop\n\n# Delete release branch\ngit branch -d release/X.Y.Z\ngit push origin --delete release/X.Y.Z\n</code></pre>"},{"location":"development/release-guide/#git-lfs","title":"Git LFS","text":"<p>Large files are tracked via Git LFS (see <code>.gitattributes</code>):</p> <pre><code>src/krewlyzer/data/**/*.gz filter=lfs diff=lfs merge=lfs -text\nsrc/krewlyzer/data/**/*.parquet filter=lfs diff=lfs merge=lfs -text\nsrc/krewlyzer/data/**/*.bed filter=lfs diff=lfs merge=lfs -text\n</code></pre> <p>Ensure Git LFS is installed before cloning:</p> <pre><code>git lfs install\ngit clone https://github.com/msk-access/krewlyzer.git\n</code></pre>"},{"location":"development/release-guide/#nextflow-module-locations","title":"Nextflow Module Locations","text":"<p>Each module has 2 version references:</p> Module Container Line versions.yml Line build_pon 13 63 extract 13 68 fsc 14 67 fsd 13 60 fsr 13 63 mfsd 13 62 motif 13 55 ocf 13 63 region_entropy 14 73 region_mds 14 79 runall 18 183 uxm 13 55 wps 14 76"},{"location":"development/testing-guide/","title":"Testing Guide","text":""},{"location":"development/testing-guide/#testing-guide","title":"Testing Guide","text":""},{"location":"development/testing-guide/#overview","title":"Overview","text":"<p>Krewlyzer has 248 tests covering all features via pytest.</p> Category Tests Speed Location Unit 155 &lt;1s <code>tests/unit/</code> Integration 52 5-30s <code>tests/integration/</code> CLI 10 2-5s <code>tests/cli/</code> E2E 3 30-60s <code>tests/e2e/</code> Asset Resolution 19 &lt;1s <code>tests/test_asset_resolution.py</code> <p>Note</p> <p>Rust code is tested via Python. The <code>test_rust_python_equivalence.py</code> suite verifies Rust output matches Python implementations.</p> <p></p>"},{"location":"development/testing-guide/#feature-test-map","title":"Feature \u2192 Test Map","text":"<p>When modifying a feature, update the corresponding test file:</p> Feature Test File(s) Tests FSC <code>unit/test_fsc.py</code> 7 FSD <code>unit/test_fsd.py</code>, <code>integration/test_fsd_cli.py</code> 8 FSR <code>integration/test_fsr_cli.py</code> 3 WPS <code>unit/test_wps.py</code>, <code>integration/test_wps_cli.py</code> 19 Motif <code>integration/test_motif.py</code> 3 OCF <code>integration/test_ocf.py</code> 1 mFSD <code>integration/test_mfsd.py</code> 9 UXM <code>integration/test_uxm.py</code> 1 Region Entropy <code>integration/test_region_entropy.py</code> 10 Extract <code>integration/test_extract.py</code> 4 PON Model <code>unit/test_pon_model.py</code> 51 PON Validation <code>unit/test_pon_validation.py</code> 14 PON Build <code>integration/test_pon.py</code>, <code>test_pon_dual_gc.py</code> 8 Gene BED <code>unit/test_gene_bed.py</code> 25 Asset Manager <code>unit/test_asset_manager.py</code> 10 External Data Dir <code>unit/test_external_data_dir.py</code> 6 Asset Resolution <code>test_asset_resolution.py</code> 19 BGZF Reader <code>unit/test_bgzf_reader.py</code> 5 Normalization <code>unit/test_normalization.py</code> 6 run-all flags <code>unit/test_run_all_flags.py</code> 6 Rust/Python <code>unit/test_rust_python_equivalence.py</code> 11 Real Data <code>integration/test_real_data.py</code> 5"},{"location":"development/testing-guide/#running-tests","title":"Running Tests","text":"<pre><code># All tests\npytest tests/\n\n# By category\npytest tests/unit/           # Fast unit tests\npytest tests/integration/    # Tool integration\npytest tests/e2e/            # Full pipeline\n\n# Specific feature\npytest tests/unit/test_fsc.py\npytest tests/unit/test_wps.py -v\n\n# Stop on first failure\npytest -x\n\n# With coverage\npytest tests/ --cov=krewlyzer --cov-report=html\n</code></pre>"},{"location":"development/testing-guide/#test-markers","title":"Test Markers","text":"<pre><code>pytest -m unit           # Unit tests only\npytest -m integration    # Integration tests\npytest -m \"not slow\"     # Skip slow tests\n</code></pre>"},{"location":"development/testing-guide/#data-availability","title":"Data Availability","text":"<p>Important</p> <p>The entire <code>src/krewlyzer/data/</code> folder is EXCLUDED from PyPI wheels to keep size &lt;100MB. Tests that require bundled data files are automatically skipped in CI/PyPI installs.</p>"},{"location":"development/testing-guide/#data-by-install-method","title":"Data by Install Method","text":"Install Method Data Files Test Coverage <code>pip install krewlyzer</code> (PyPI) \u274c None ~85% (skips asset tests) <code>pip install -e .</code> (git clone) \u2705 All 100% Docker image \u2705 All 100%"},{"location":"development/testing-guide/#how-it-works","title":"How It Works","text":"<p>Tests that verify bundled assets use the <code>@requires_data</code> decorator from <code>conftest.py</code>:</p> <pre><code>from conftest import requires_data\n\n@requires_data\nclass TestAssetManager:\n    def test_gene_bed_exists(self):\n        # Skipped if data not available\n        ...\n</code></pre>"},{"location":"development/testing-guide/#running-full-tests-locally","title":"Running Full Tests Locally","text":"<pre><code># Clone the repository (includes data/)\ngit clone https://github.com/msk-access/krewlyzer.git\ncd krewlyzer\n\n# Development install (uses source data directly)\npip install -e \".[test]\"\n\n# Run all tests - data-dependent tests will pass\npytest tests/ -v\n</code></pre>"},{"location":"development/testing-guide/#external-data-directory","title":"External Data Directory","text":"<p>For PyPI installs, you can provide data via environment variable:</p> <pre><code>export KREWLYZER_DATA_DIR=/path/to/krewlyzer/src/krewlyzer/data\npytest tests/ -v\n</code></pre>"},{"location":"development/testing-guide/#fixtures","title":"Fixtures","text":"<p>Key fixtures from <code>tests/conftest.py</code>:</p> Fixture Description <code>temp_bam</code> Minimal BAM with proper pair <code>temp_bedgz</code> Minimal BED.gz (3 fragments) <code>temp_reference</code> FASTA reference (12kb chr1) <code>temp_bins</code> FSC bins file <code>temp_arms</code> FSD arms file <code>temp_transcripts</code> WPS transcripts file <code>temp_ocr</code> OCF regions file <code>temp_vcf</code> mFSD variants file <code>full_test_data</code> Bundle for run-all <code>real_bam</code> Production data (3144 reads) <code>real_pon</code> MSK-ACCESS v1 PON"},{"location":"development/testing-guide/#adding-tests","title":"Adding Tests","text":""},{"location":"development/testing-guide/#naming-convention","title":"Naming Convention","text":"<ul> <li>File: <code>test_&lt;feature&gt;.py</code></li> <li>Function: <code>test_&lt;action&gt;_&lt;expected&gt;()</code></li> </ul>"},{"location":"development/testing-guide/#example-unit-test","title":"Example Unit Test","text":"<pre><code>@pytest.mark.unit\ndef test_fsc_counts_fragments_by_size(temp_bedgz, temp_bins):\n    \"\"\"FSC should categorize fragments into size bins.\"\"\"\n    result = fsc.count_fragments(temp_bedgz, temp_bins)\n\n    assert \"core_short\" in result.columns\n    assert result[\"total\"].sum() &gt; 0\n</code></pre>"},{"location":"development/testing-guide/#example-integration-test","title":"Example Integration Test","text":"<pre><code>@pytest.mark.integration\ndef test_fsc_cli_produces_output(temp_bedgz, temp_bins, tmp_path):\n    \"\"\"FSC CLI should write TSV output.\"\"\"\n    from typer.testing import CliRunner\n    from krewlyzer.cli import app\n\n    runner = CliRunner()\n    result = runner.invoke(app, [\n        \"fsc\", \"-i\", str(temp_bedgz), \n        \"-b\", str(temp_bins), \"-o\", str(tmp_path)\n    ])\n\n    assert result.exit_code == 0\n    assert (tmp_path / \"test.FSC.tsv\").exists()\n</code></pre>"},{"location":"development/testing-guide/#example-data-dependent-test","title":"Example Data-Dependent Test","text":"<pre><code>from conftest import requires_data\n\n@requires_data\ndef test_bundled_gene_bed_loads(manager):\n    \"\"\"Test bundled gene BED (only runs with source data).\"\"\"\n    path = manager.get_gene_bed(\"xs1\")\n    assert path.exists()\n</code></pre>"},{"location":"development/testing-guide/#see-also","title":"See Also","text":"<ul> <li>Developer Guide - Setup and architecture</li> <li>Contributing - PR process</li> </ul>"},{"location":"features/","title":"Overview","text":""},{"location":"features/#features-overview","title":"Features Overview","text":"<p>Krewlyzer provides 11 standalone feature extraction commands plus a unified <code>run-all</code> pipeline.</p>"},{"location":"features/#quick-comparison","title":"Quick Comparison","text":"Command Input Output Primary Use Case <code>extract</code> BAM <code>.bed.gz</code>, <code>.metadata.json</code> Fragment extraction &amp; GC factors <code>motif</code> BAM <code>.EndMotif.tsv</code>, <code>.MDS.tsv</code> Fragmentation patterns <code>fsc</code> BED.gz <code>.FSC.tsv</code> Copy number detection <code>fsr</code> BED.gz <code>.FSR.tsv</code> Tumor fraction estimation <code>fsd</code> BED.gz <code>.FSD.tsv</code> Size distribution analysis <code>wps</code> BED.gz <code>.WPS.parquet</code> Nucleosome positioning <code>ocf</code> BED.gz <code>.OCF.tsv</code> Tissue of origin <code>region-entropy</code> BED.gz <code>.TFBS.tsv</code>, <code>.ATAC.tsv</code> Regulatory region analysis <code>uxm</code> Bisulfite BAM <code>.UXM.tsv</code> Methylation deconvolution <code>mfsd</code> BAM + VCF/MAF <code>.mFSD.tsv</code> Mutant vs wild-type sizes <code>run-all</code> BAM All outputs Complete analysis"},{"location":"features/#workflow-diagram","title":"Workflow Diagram","text":"<pre><code>flowchart LR\n    BAM[BAM File] --&gt; extract\n    extract --&gt; BED[.bed.gz]\n    BAM --&gt; motif\n\n    BED --&gt; fsc\n    BED --&gt; fsr\n    BED --&gt; fsd\n    BED --&gt; wps\n    BED --&gt; ocf\n\n    BAM --&gt; mfsd\n    VCF[VCF/MAF] --&gt; mfsd\n\n    BS_BAM[Bisulfite BAM] --&gt; uxm\n\n    subgraph outputs[Output Files]\n        fsc --&gt; FSC[.FSC.tsv]\n        fsr --&gt; FSR[.FSR.tsv]\n        fsd --&gt; FSD[.FSD.tsv]\n        wps --&gt; WPS[.WPS.parquet]\n        ocf --&gt; OCF[.OCF.tsv]\n        motif --&gt; MOTIF[.EndMotif.tsv]\n        mfsd --&gt; MFSD[.mFSD.tsv]\n        uxm --&gt; UXM[.UXM.tsv]\n    end\n\n    BED --&gt; tfbs[region-entropy]\n    BAM --&gt; rmds[region-mds]\n    tfbs --&gt; TFBS[.TFBS.tsv / .ATAC.tsv]\n    rmds --&gt; RMDS2[.MDS.exon.tsv / .MDS.gene.tsv]\n</code></pre>  Use mouse to pan and zoom"},{"location":"features/#feature-categories","title":"Feature Categories","text":""},{"location":"features/#fragmentation-features","title":"Fragmentation Features","text":"Feature Biological Signal Clinical Application FSC Fragment coverage by size class CNV detection, copy number profiling FSR Short/Long fragment ratios Tumor fraction estimation FSD Size distribution per arm Nucleosome patterns, ctDNA detection"},{"location":"features/#nucleosome-chromatin","title":"Nucleosome &amp; Chromatin","text":"Feature Biological Signal Clinical Application WPS Nucleosome protection scores Tissue of origin, gene regulation OCF Open chromatin fragmentation Tissue-specific cfDNA detection Motif End motif diversity (MDS) Fragmentation patterns, cancer detection Region Entropy TFBS/ATAC size distribution Regulatory element alterations, cancer detection"},{"location":"features/#specialized","title":"Specialized","text":"Feature Biological Signal Clinical Application mFSD Mutant vs wild-type sizes MRD monitoring, ctDNA quantification UXM Fragment methylation (U/X/M) Cell-type deconvolution"},{"location":"features/#choosing-features","title":"Choosing Features","text":""},{"location":"features/#for-cancer-detection","title":"For Cancer Detection","text":"<pre><code>krewlyzer run-all sample.bam -r hg19.fa -o output/\n# Focus on: FSR (tumor fraction), FSC (CNV), Motif (MDS)\n</code></pre>"},{"location":"features/#for-tissue-of-origin","title":"For Tissue of Origin","text":"<pre><code># Run WPS and OCF\nkrewlyzer wps -i sample.bed.gz -o output/\nkrewlyzer ocf -i sample.bed.gz -o output/\n</code></pre>"},{"location":"features/#for-mrd-monitoring","title":"For MRD Monitoring","text":"<pre><code># Compare mutant vs wild-type fragment sizes\nkrewlyzer mfsd -i sample.bam -V variants.vcf -o output/\n</code></pre>"},{"location":"features/#for-methylation-deconvolution","title":"For Methylation Deconvolution","text":"<pre><code># Requires bisulfite sequencing BAM\nkrewlyzer uxm bisulfite.bam -o output/\n</code></pre>"},{"location":"features/#common-options","title":"Common Options","text":"<p>All feature commands share these core options:</p> Option Description <code>-o, --output</code> Output directory (required) <code>-s, --sample-name</code> Override sample name <code>-G, --genome</code> Genome build: hg19/hg38 <code>-t, --threads</code> Thread count (0=all) <code>-v, --verbose</code> Enable verbose logging <p>See individual feature pages for command-specific options, or JSON Output for format details.</p>"},{"location":"features/#additional-resources","title":"Additional Resources","text":"<ul> <li>JSON Output - Unified JSON for ML pipelines (<code>--generate-json</code>)</li> <li>Panel Mode - MSK-ACCESS and targeted panel analysis (<code>--assay</code>)</li> <li>PON Building - Creating cohort baselines for z-score normalization</li> </ul>"},{"location":"features/core/extract/","title":"Fragment Extraction","text":""},{"location":"features/core/extract/#fragment-extraction","title":"Fragment Extraction","text":"<p>Command: <code>krewlyzer extract</code></p> <p>Plain English</p> <p>Extract converts your BAM file into cfDNA fragments with quality information. It's the first step for most analyses\u2014think of it as \"preprocessing\" your sequencing data.</p> <p>Key output: <code>.bed.gz</code> file containing fragment coordinates and GC correction factors.</p>"},{"location":"features/core/extract/#purpose","title":"Purpose","text":"<p>The <code>extract</code> module serves as the entry point for most analysis workflows. It processes a BAM file to extract valid cell-free DNA (cfDNA) fragments and saves them in a standardized, compressed BED format with GC content.</p>"},{"location":"features/core/extract/#processing-flowchart","title":"Processing Flowchart","text":"<pre><code>flowchart LR\n    BAM[BAM File] --&gt; RUST[Rust Backend]\n    REF[Reference FASTA] --&gt; RUST\n    GC_REF[GC Reference] --&gt; RUST\n\n    RUST --&gt; BED[\"sample.bed.gz\"]\n    RUST --&gt; META[\"metadata.json\"]\n    RUST --&gt; FACTORS[\"correction_factors.tsv\"]\n\n    subgraph \"With --target-regions\"\n        TARGETS[Target BED] --&gt; RUST\n        RUST --&gt; GC_OFF[\"GC model from OFF-target only\"]\n    end\n</code></pre>  Use mouse to pan and zoom"},{"location":"features/core/extract/#biological-context","title":"Biological Context","text":"<p>Raw sequencing data (BAM) contains reads that must be paired and filtered to reconstruct physical DNA fragments. This step standardizes the data, removing PCR duplicates and low-quality mappings, ensuring downstream analysis focuses on high-confidence unique molecules.</p>"},{"location":"features/core/extract/#usage","title":"Usage","text":"<pre><code>krewlyzer extract -i sample.bam -r hg19.fa -o output_dir/ [options]\n</code></pre>"},{"location":"features/core/extract/#options","title":"Options","text":"Option Short Type Default Description <code>--input</code> <code>-i</code> PATH required Input BAM file <code>--reference</code> <code>-r</code> PATH required Reference genome FASTA (indexed) <code>--output</code> <code>-o</code> PATH required Output directory <code>--genome</code> <code>-G</code> TEXT hg19 Genome build for GC assets <code>--assay</code> <code>-A</code> TEXT Assay code (xs1/xs2) for auto-loading bundled targets <code>--target-regions</code> <code>-T</code> PATH Target BED (panel mode: GC from off-target) <code>--skip-target-regions</code> FLAG Disable panel mode even when --assay is specified <code>--gc-correct</code> FLAG True Compute GC correction factors <code>--exclude-regions</code> <code>-x</code> PATH BED file of regions to exclude <code>--mapq</code> <code>-q</code> INT 20 Minimum mapping quality <code>--minlen</code> INT 65 Minimum fragment length <code>--maxlen</code> INT 1000 Maximum fragment length <code>--skip-duplicates</code> FLAG True Skip duplicate reads <code>--require-proper-pair</code> FLAG True Require proper read pairs <code>--chromosomes</code> TEXT Comma-separated chromosomes to process <code>--sample-name</code> <code>-s</code> TEXT Override sample name <code>--verbose</code> <code>-v</code> FLAG Enable verbose logging <code>--threads</code> <code>-t</code> INT 0 Number of threads (0=all)"},{"location":"features/core/extract/#output-files","title":"Output Files","text":"File Description <code>{sample}.bed.gz</code> Block-gzipped BED with fragment coordinates + GC <code>{sample}.bed.gz.tbi</code> Tabix index for random access <code>{sample}.metadata.json</code> Run statistics and configuration <code>{sample}.correction_factors.tsv</code> GC correction factors (with --gc-correct)"},{"location":"features/core/extract/#gc-correction-factors-format","title":"GC Correction Factors Format","text":"Column Description <code>len_bin</code> Fragment length bin (0-16) <code>gc_bin</code> GC content (0.00-1.00) <code>factor</code> Correction multiplier <code>observed</code> Raw fragment count <code>expected</code> LOESS-predicted count <code>n_fragments</code> Number of fragments in bin"},{"location":"features/core/extract/#panel-mode-assay-or-target-regions","title":"Panel Mode (--assay or --target-regions)","text":"<p>For targeted sequencing panels (MSK-ACCESS), use <code>--assay</code> to auto-load bundled targets, or <code>--target-regions</code> for a custom target file:</p> <pre><code># Recommended: Auto-load bundled targets for xs2 assay\nkrewlyzer extract -i sample.bam -r hg19.fa -o output/ --assay xs2\n\n# Alternative: Explicit target file\nkrewlyzer extract -i sample.bam -r hg19.fa -o output/ \\\n    --target-regions MSK-ACCESS_targets.bed\n</code></pre>"},{"location":"features/core/extract/#why-this-matters","title":"Why This Matters","text":"<pre><code>flowchart TB\n    subgraph \"Without --target-regions\"\n        ALL[All Fragments] --&gt; GC_ALL[\"GC model biased by capture\"]\n        GC_ALL --&gt; BAD[\"\u274c Incorrect correction\"]\n    end\n\n    subgraph \"With --target-regions\"\n        OFF[Off-Target Only] --&gt; GC_OFF[\"GC model from unbiased reads\"]\n        GC_OFF --&gt; GOOD[\"\u2705 Accurate correction\"]\n    end\n</code></pre>  Use mouse to pan and zoom  <p>Problem: On-target fragments have GC bias from hybridization probes. Using all fragments for GC modeling contaminates the correction factors.</p> <p>Solution: With <code>--target-regions</code>, only off-target fragments are used to compute GC correction factors, producing unbiased normalization for downstream analysis.</p>"},{"location":"features/core/extract/#outputs-in-panel-mode","title":"Outputs in Panel Mode","text":"Output Description <code>correction_factors.tsv</code> GC factors from off-target only (unbiased) <code>correction_factors.ontarget.tsv</code> GC factors from on-target only (for mFSD) <code>sample.bed.gz</code> All fragments (on + off-target) <p>Tip</p> <p>Use <code>.correction_factors.ontarget.tsv</code> with <code>krewlyzer mfsd --correction-factors</code> for panel variant calling\u2014it's trained on the same capture regions as your variants.</p> <p>Important</p> <p>The BED file contains all fragments. Target filtering happens per-tool using the same <code>--target-regions</code> flag in FSC, FSD, WPS, etc.</p>"},{"location":"features/core/extract/#bam-compatibility","title":"BAM Compatibility","text":""},{"location":"features/core/extract/#duplexconsensus-bams","title":"Duplex/Consensus BAMs","text":"<p>If you're using duplex or consensus BAMs, disable the proper pair filter:</p> <pre><code>krewlyzer extract -i duplex.bam -r hg19.fa -o output/ \\\n    --no-require-proper-pair\n</code></pre> BAM Type Proper Pairs? Flag Needed? Standard WGS \u2705 Yes Default works Standard Panel \u2705 Yes Default works Duplex/UMI \u274c No <code>--no-require-proper-pair</code> Consensus \u274c No <code>--no-require-proper-pair</code>"},{"location":"features/core/extract/#auto-detection","title":"Auto-Detection","text":"<p>The <code>run-all</code> command automatically detects BAM compatibility issues and suggests the correct flags.</p>"},{"location":"features/core/extract/#see-also","title":"See Also","text":"<ul> <li>GC Correction - LOESS algorithm details</li> <li>Troubleshooting - Common issues</li> <li>Glossary - Terminology reference</li> </ul>"},{"location":"features/core/fsc/","title":"FSC","text":""},{"location":"features/core/fsc/#fragment-size-coverage-fsc","title":"Fragment Size Coverage (FSC)","text":"<p>Command: <code>krewlyzer fsc</code></p> <p>Plain English</p> <p>FSC counts how many DNA fragments of each size fall into each genomic region. Think of it as a \"heatmap\" of fragment sizes across the genome.</p> <p>Use case: Copy number detection - regions with more short fragments suggest tumor amplification.</p>"},{"location":"features/core/fsc/#purpose","title":"Purpose","text":"<p>Computes GC-corrected coverage of cfDNA fragments in 6 biologically-meaningful size channels per genomic bin. Designed for ML feature extraction in cancer detection.</p>"},{"location":"features/core/fsc/#biological-context","title":"Biological Context","text":""},{"location":"features/core/fsc/#why-fragment-sizes-matter","title":"Why Fragment Sizes Matter","text":"<p>cfDNA fragments are not random\u2014their sizes reflect the chromatin state of their source cells:</p> Fragment Size Source Biological Meaning Short (&lt;100bp) Open chromatin, active transcription TF footprints, regulatory elements ~167bp Mono-nucleosome \"Classic\" cfDNA peak ~334bp Di-nucleosome Linked nucleosomes Long (&gt;260bp) Multi-nucleosome Necrosis, incomplete digestion <p>Cancer signature: Tumors release shorter cfDNA fragments than healthy cells due to: - Altered nucleosome positioning - Different apoptotic pathways - Chromatin accessibility changes</p>"},{"location":"features/core/fsc/#6-channel-ml-features","title":"6-Channel ML Features","text":"<p>FSC partitions fragments into non-overlapping channels optimized for ML:</p> Channel Size Range Biological Meaning Cancer Relevance ultra_short 65-100bp Di-nucleosomal debris Early apoptosis markers core_short 101-149bp Sub-nucleosomal Specific chromatin states mono_nucl 150-220bp Mono-nucleosomal Classic cfDNA (reference) di_nucl 221-260bp Di-nucleosomal Transitional long 261-400bp Multi-nucleosomal Necrosis-associated ultra_long 401-1000bp Extended fragments Necrosis, fetal cfDNA, late apoptosis <p>Non-overlapping</p> <p>Each fragment is counted in exactly one channel. This prevents multicollinearity in ML models.</p>"},{"location":"features/core/fsc/#implementation-details","title":"Implementation Details","text":""},{"location":"features/core/fsc/#counting-pipeline","title":"Counting Pipeline","text":"<pre><code>flowchart LR\n    BED[\"sample.bed.gz\"] --&gt; RUST[\"Rust Backend\"]\n    BINS[\"100kb Bins\"] --&gt; RUST\n    GC[\"GC Correction\"] --&gt; RUST\n\n    RUST --&gt; FSC[\"FSC.tsv\"]\n\n    subgraph \"6 Channels\"\n        FSC --&gt; US[\"ultra_short (65-100bp)\"]\n        FSC --&gt; CS[\"core_short (101-149bp)\"]\n        FSC --&gt; MN[\"mono_nucl (150-220bp)\"]\n        FSC --&gt; DN[\"di_nucl (221-260bp)\"]\n        FSC --&gt; LG[\"long (261-400bp)\"]\n        FSC --&gt; UL[\"ultra_long (401-1000bp)\"]\n    end\n\n    subgraph \"With --pon-model\"\n        FSC --&gt; PON[\"PON log\u2082 ratios\"]\n    end\n\n    subgraph \"With --target-regions\"\n        RUST --&gt; FSC_ON[\"FSC.ontarget.tsv\"]\n    end\n</code></pre>  Use mouse to pan and zoom"},{"location":"features/core/fsc/#pythonrust-architecture","title":"Python/Rust Architecture","text":"<pre><code>flowchart TB\n    subgraph \"Python (CLI)\"\n        CLI[\"fsc.py\"] --&gt; UP[\"unified_processor.py\"]\n        UP --&gt; ASSETS[\"AssetManager\"]\n    end\n\n    subgraph \"Rust Backend\"\n        UP --&gt; RUST[\"_core.run_unified_pipeline()\"]\n        RUST --&gt; GC[\"GC correction\"]\n        GC --&gt; COUNT[\"6-channel counting (65-1000bp)\"]\n    end\n\n    subgraph \"Python (Post-processing)\"\n        COUNT --&gt; PROC[\"fsc_processor.py\"]\n        PROC --&gt; AGG[\"Window aggregation\"]\n        AGG --&gt; PON[\"PON log2 ratios\"]\n        PON --&gt; OUT[\"FSC.tsv\"]\n        PON --&gt; GENE[\"FSC.gene.tsv\"]\n        GENE --&gt; REG[\"FSC.regions.tsv\"]\n        REG --&gt; E1[\"filter_fsc_to_e1()\"]\n        E1 --&gt; E1OUT[\"FSC.regions.e1only.tsv\"]\n    end\n</code></pre>  Use mouse to pan and zoom"},{"location":"features/core/fsc/#aggregation-strategy","title":"Aggregation Strategy","text":"<p>Critical</p> <p>Aggregation should match your analysis goal.</p> Data Type Bin Input Aggregation Use Case WGS 100kb genome tiles 50 bins \u2192 5Mb Arm-level CNV WGS focal 100kb genome tiles No aggregation Focal amps (EGFR, MYC) Panel Exon/Gene targets No aggregation Gene-level resolution <p>Auto-detection</p> <p>When <code>--target-regions</code> is provided in <code>run-all</code>, aggregation is automatically disabled to preserve gene-level resolution for panel data.</p> <p>Why this matters: - 5Mb aggregation is great for detecting arm-level events (e.g., 1p/19q co-deletion) - Focal amplifications (e.g., EGFR amp &lt;1Mb) are washed out by 5Mb aggregation - Panel targets are already gene-resolution\u2014aggregation destroys their value</p> <p>Recommendation: - For broad CNV detection (tumor fraction, aneuploidy): Use aggregated 5Mb windows - For focal analysis (driver genes, amplicons): Preserve raw bin resolution</p>"},{"location":"features/core/fsc/#gc-correction-details","title":"GC Correction Details","text":"<p>Each fragment receives a weight based on its (length, GC%) bin:</p> <pre><code>weight = correction_factors[(length, gc_pct)]\nchannel_count += weight  # Instead of += 1\n</code></pre> <p>This removes GC bias before ML, not after. The correction factors come from: - WGS: Computed from all genome-wide fragments - Panel: Computed from off-target reads only (when <code>--target-regions</code> provided)</p>"},{"location":"features/core/fsc/#bin-assignment","title":"Bin Assignment","text":"<p>Fragments are assigned to bins based on overlap (not midpoint):</p> <pre><code>// If fragment overlaps bin, count it\ntree.query(start, end, |bin| {\n    bin.channel_count += weight;\n});\n</code></pre> <p>A fragment spanning two bins counts in both. This is intentional for coverage metrics.</p>"},{"location":"features/core/fsc/#usage","title":"Usage","text":"<pre><code># Basic (auto-loads bundled 100kb bins)\nkrewlyzer fsc -i sample.bed.gz -o output/ --genome hg38\n\n# With PoN for log2 ratios\nkrewlyzer fsc -i sample.bed.gz -o output/ --pon-model cohort.pon\n\n# Custom bin size\nkrewlyzer fsc -i sample.bed.gz -o output/ --bin-input custom_bins.bed\n</code></pre>"},{"location":"features/core/fsc/#cli-options","title":"CLI Options","text":"Option Short Type Default Description <code>--input</code> <code>-i</code> PATH required Input .bed.gz file (output from extract) <code>--output</code> <code>-o</code> PATH required Output directory <code>--sample-name</code> <code>-s</code> TEXT Override sample name <code>--bin-input</code> <code>-b</code> PATH Custom bin file (default: 100kb genome-wide) <code>--pon-model</code> <code>-P</code> PATH PON model for hybrid GC correction <code>--pon-variant</code> TEXT all_unique PON variant: <code>all_unique</code> or <code>duplex</code> <code>--skip-pon</code> FLAG Skip PON z-score normalization <code>--target-regions</code> <code>-T</code> PATH Target BED (for on/off-target FSC split) <code>--skip-target-regions</code> FLAG Force WGS mode (ignore bundled targets) <code>--assay</code> <code>-A</code> TEXT Assay type (xs1/xs2) for gene-centric FSC <code>--windows</code> <code>-w</code> INT 100000 Window size for aggregation <code>--continue-n</code> <code>-c</code> INT 50 Consecutive window number <code>--genome</code> <code>-G</code> TEXT hg19 Genome build (hg19/hg38) <code>--gc-correct</code> FLAG True Apply GC bias correction <code>--threads</code> <code>-t</code> INT 0 Number of threads (0=all cores) <code>--verbose</code> <code>-v</code> FLAG Enable verbose logging"},{"location":"features/core/fsc/#output-format","title":"Output Format","text":"<p>Output: <code>{sample}.FSC.tsv</code></p>"},{"location":"features/core/fsc/#base-columns-always-present","title":"Base Columns (always present)","text":"Column Type Description <code>chrom</code> str Chromosome <code>start</code> int Window start (0-based) <code>end</code> int Window end <code>ultra_short</code> float GC-weighted count (65\u2013100 bp) <code>core_short</code> float GC-weighted count (101\u2013149 bp) <code>mono_nucl</code> float GC-weighted count (150\u2013220 bp) <code>di_nucl</code> float GC-weighted count (221\u2013260 bp) <code>long</code> float GC-weighted count (261\u2013400 bp) <code>ultra_long</code> float GC-weighted count (401\u20131000 bp) <code>total</code> float GC-weighted total (65\u20131000 bp) <code>mean_gc</code> float Mean GC fraction of fragments in this window"},{"location":"features/core/fsc/#pon-columns-when-pon-model-provided","title":"PoN Columns (when <code>--pon-model</code> provided)","text":"Column Type Description <code>*_log2</code> float log2(channel / PoN_mean) <code>*_reliability</code> float 1 / (PoN_variance + k) <p>Note</p> <p>Log2 ratios are signed: positive = above PoN mean, negative = below.</p>"},{"location":"features/core/fsc/#wgs-vs-panel-data-msk-access","title":"WGS vs Panel Data (MSK-ACCESS)","text":"Aspect WGS Panel (MSK-ACCESS) Coverage Uniform genome-wide High on-target, sparse off-target GC correction source All fragments Off-target only Typical depth ~30x genome ~1000x on-target Best bins All bins reliable On-target bins only"},{"location":"features/core/fsc/#panel-mode-details","title":"Panel Mode Details","text":"<p>When you provide <code>--target-regions</code> to <code>run-all</code>:</p> <ol> <li>GC model training: Uses only off-target reads (unbiased by capture)</li> <li>Counting: All reads are counted (on-target + off-target)</li> <li>Interpretation: On-target bins have high counts, off-target bins are sparse</li> </ol> <pre><code>krewlyzer run-all sample.bam -g ref.fa -o out/ \\\n    --target-regions msk_access_baits.bed\n</code></pre>"},{"location":"features/core/fsc/#panel-recommendations","title":"Panel Recommendations","text":"Feature Recommendation Which bins to use Filter to high-coverage bins (&gt;100 fragments) Channel ratios More robust than absolute counts PoN Build from same panel type only"},{"location":"features/core/fsc/#ml-feature-engineering","title":"ML Feature Engineering","text":""},{"location":"features/core/fsc/#raw-features-per-5mb-window","title":"Raw Features (per 5Mb window)","text":"<ul> <li>5 channel counts (ultra_short, core_short, mono_nucl, di_nucl, long)</li> <li>1 total count</li> </ul>"},{"location":"features/core/fsc/#derived-features-recommended","title":"Derived Features (recommended)","text":"<ul> <li>Channel ratios: <code>short / long</code>, <code>mono_nucl / total</code></li> <li>Log2 ratios vs PoN: Tumor-specific deviations</li> <li>Reliability-weighted: Use reliability scores in loss functions</li> </ul>"},{"location":"features/core/fsc/#example-short-to-long-ratio","title":"Example: Short-to-Long Ratio","text":"<pre><code>df['short_long_ratio'] = (df['ultra_short'] + df['core_short']) / (df['long'] + 1e-9)\n</code></pre> <p>Higher ratio = more short fragments = potential tumor signal</p> <p>FSC ratios vs FSR \u2014 not redundant</p> <p>The <code>*_ratio</code> columns in <code>FSC.gene.tsv</code> and <code>FSC.regions.tsv</code> are simple proportions: <code>channel / total</code> per gene or exon. They answer \"what fraction of fragments at this gene are short?\"</p> <p>FSR is different in two key ways:</p> <ol> <li>PON-normalized BEFORE ratio: <code>normalize(short) / normalize(long)</code> \u2014 removes batch effects and library size before dividing, so cross-sample comparisons are valid</li> <li>Window-level (5 Mb genome tiles), not gene-level</li> </ol> <p>When to use which:</p> Use case Use Gene-level copy-number composition <code>FSC.gene.tsv</code> <code>*_ratio</code> columns Tumor fraction / genome-wide cancer signal <code>FSR.tsv</code> <code>short_long_ratio</code> (PON-normalized) ML features for per-gene models FSC gene ratios ML features for pan-cancer models FSR <code>short_long_log2</code>"},{"location":"features/core/fsc/#normalization-order","title":"Normalization Order","text":"<ol> <li>GC-weighting (Rust): Raw counts \u00d7 correction factor per (length, GC) bin</li> <li>Window aggregation (Python): 50 bins \u2192 5Mb windows</li> <li>PoN log-ratio (Python): log2(sample / PoN mean) when PoN model provided</li> </ol> <p>Important</p> <p>GC correction is applied first in Rust, not after. This ensures all downstream features are GC-unbiased.</p>"},{"location":"features/core/fsc/#panel-mode-target-regions","title":"Panel Mode (--target-regions)","text":"<p>For targeted sequencing panels (MSK-ACCESS), use <code>--target-regions</code> to generate separate on/off-target outputs:</p> <pre><code>krewlyzer fsc -i sample.bed.gz -o output/ \\\n    --target-regions MSK-ACCESS_targets.bed \\\n    --bin-input gene_level_bins.bed\n</code></pre>"},{"location":"features/core/fsc/#processing-with-target-regions","title":"Processing with Target Regions","text":"<pre><code>flowchart TB\n    BED[\"sample.bed.gz\"] --&gt; SPLIT{\"Fragment Location\"}\n\n    SPLIT --&gt;|\"Overlaps target\"| ON[\"On-Target\"]\n    SPLIT --&gt;|\"Does not overlap\"| OFF[\"Off-Target\"]\n\n    ON --&gt; FSC_ON[\"FSC.ontarget.tsv\"]\n    OFF --&gt; FSC_OFF[\"FSC.tsv\"]\n</code></pre>  Use mouse to pan and zoom"},{"location":"features/core/fsc/#output-files","title":"Output Files","text":"File Contents Use Case <code>{sample}.FSC.tsv</code> Off-target fragments Unbiased global signal (primary) <code>{sample}.FSC.ontarget.tsv</code> On-target fragments Gene-level local signal <p>Important</p> <p>Off-target = unbiased \u2013 preferred for fragmentomics biomarkers. On-target = capture-biased \u2013 reflects library prep + target selection.</p>"},{"location":"features/core/fsc/#when-to-use-on-target-fsc","title":"When to Use On-Target FSC","text":"Use Case Recommended CNV detection Off-target Tumor fraction Off-target Gene-level amplification On-target Panel-specific features Both"},{"location":"features/core/fsc/#gene-centric-fsc-msk-access","title":"Gene-Centric FSC (MSK-ACCESS)","text":"<p>For MSK-ACCESS panels, use <code>--assay</code> to aggregate fragment counts by gene instead of genomic windows:</p> <pre><code>krewlyzer fsc -i sample.bed.gz -o output/ --assay xs2\n</code></pre>"},{"location":"features/core/fsc/#output-files_1","title":"Output Files","text":"File Description Rows <code>{sample}.FSC.tsv</code> Standard window-based FSC ~28,000 <code>{sample}.FSC.gene.tsv</code> Gene-level FSC 146 (xs2) <code>{sample}.FSC.regions.tsv</code> Per-exon/target FSC ~1,000"},{"location":"features/core/fsc/#gene-fsc-output-format-samplefscgenetsv","title":"Gene FSC Output Format (<code>{sample}.FSC.gene.tsv</code>)","text":"Column Type Description <code>gene</code> str HGNC gene symbol <code>n_regions</code> int Number of exons/targets for this gene <code>total_bp</code> int Total covered base pairs <code>ultra_short</code> float GC-weighted count (65\u2013100 bp) <code>core_short</code> float GC-weighted count (101\u2013149 bp) <code>mono_nucl</code> float GC-weighted count (150\u2013220 bp) <code>di_nucl</code> float GC-weighted count (221\u2013260 bp) <code>long</code> float GC-weighted count (261\u2013400 bp) <code>total</code> float GC-weighted total count <code>ultra_short_ratio</code> float <code>ultra_short / total</code> <code>core_short_ratio</code> float <code>core_short / total</code> <code>mono_nucl_ratio</code> float <code>mono_nucl / total</code> <code>di_nucl_ratio</code> float <code>di_nucl / total</code> <code>long_ratio</code> float <code>long / total</code> <code>normalized_depth</code> float RPKM-like: <code>(total \u00d7 10\u2079) / (total_bp \u00d7 total_frags)</code>"},{"location":"features/core/fsc/#region-fsc-output-format-samplefscregionstsv","title":"Region FSC Output Format (<code>{sample}.FSC.regions.tsv</code>)","text":"<p>Per-exon/target output for fine-grained copy number analysis:</p> Column Type Description <code>chrom</code> str Chromosome <code>start</code> int Region start (0-based) <code>end</code> int Region end <code>gene</code> str Gene symbol <code>region_name</code> str Exon/target identifier <code>region_bp</code> int Region length in bp <code>ultra_short</code> float GC-weighted count (65\u2013100 bp) <code>core_short</code> float GC-weighted count (101\u2013149 bp) <code>mono_nucl</code> float GC-weighted count (150\u2013220 bp) <code>di_nucl</code> float GC-weighted count (221\u2013260 bp) <code>long</code> float GC-weighted count (261\u2013400 bp) <code>total</code> float GC-weighted total count <code>ultra_short_ratio</code> float <code>ultra_short / total</code> <code>core_short_ratio</code> float <code>core_short / total</code> <code>mono_nucl_ratio</code> float <code>mono_nucl / total</code> <code>di_nucl_ratio</code> float <code>di_nucl / total</code> <code>long_ratio</code> float <code>long / total</code> <code>normalized_depth</code> float RPKM-like depth"},{"location":"features/core/fsc/#e1-only-fsc-output","title":"E1-Only FSC Output","text":"<p>File: <code>{sample}.FSC.regions.e1only.tsv</code></p> <p>E1 (first exon) filtering extracts only the first exon per gene by genomic position. Per Helzer et al. (2025), promoter-proximal regions (E1) are Nucleosome Depleted Regions (NDRs) with distinct fragmentation patterns, often showing stronger cancer signal than whole-gene averages.</p> <p>Usage: </p><pre><code># Default: E1-only file generated automatically with --assay\nkrewlyzer run-all -i sample.bam -r ref.fa -o out/ -A xs2\n\n# Disable E1-only generation\nkrewlyzer run-all -i sample.bam -r ref.fa -o out/ -A xs2 --disable-e1-aggregation\n</code></pre><p></p> <p>Tip</p> <p>E1-only FSC is particularly useful for early cancer detection where promoter fragmentation changes are an early marker.</p>"},{"location":"features/core/fsc/#normalized-depth-rpkm-like","title":"Normalized Depth (RPKM-like)","text":"<p>Both gene and region outputs include <code>normalized_depth</code>:</p> \\[ \\text{normalized_depth} = \\frac{\\text{count} \\times 10^9}{\\text{region_bp} \\times \\text{total_fragments}} \\] <p>This enables cross-sample depth comparisons independent of library size and region size.</p>"},{"location":"features/core/fsc/#supported-assays","title":"Supported Assays","text":"Assay Flag Genes MSK-ACCESS v1 <code>--assay xs1</code> 128 MSK-ACCESS v2 <code>--assay xs2</code> 146 <p>Tip</p> <p>Gene-level FSC is useful for gene-specific amplification detection and integration with variant calling pipelines.</p>"},{"location":"features/core/fsc/#gc-correction-for-gene-fsc","title":"GC Correction for Gene FSC","text":"<p>In panel mode, gene-level FSC uses on-target GC correction factors (<code>.correction_factors.ontarget.tsv</code>) for accurate copy number estimates.</p> <p>Why this matters: - Different genes have different GC content - High-GC genes (e.g., EGFR) capture with different efficiency than low-GC genes - Without correction, high-GC genes appear falsely deleted, low-GC genes appear amplified</p> <p>How it works: </p><pre><code># Instead of raw counting (+= 1):\nweight = correction_factors[(len_bin, gc_pct)]\ngene_count += weight  # GC-corrected counting\n</code></pre><p></p> <p>Log output example: </p><pre><code>Aggregating FSC by gene: 146 genes, GC correction: ON (weighted counting)\nProcessed 2.4M fragments, 2.4M assigned to genes\n  GC correction: avg_weight=1.898, missing_gc=0\n</code></pre><p></p> <p>Note</p> <p>On-target factors are automatically used when available. If not found, raw counting is used with a debug log message.</p>"},{"location":"features/core/fsc/#see-also","title":"See Also","text":"<ul> <li>Citation: Cristiano et al. (2019) - DELFI fragmentomics paper</li> <li>PON: Z-Score Normalization - Log2 ratio computation</li> <li>Inputs: File Formats - Bin file format</li> <li>Related: FSR (ratios), FSD (distribution), Extract (BED.gz source)</li> <li>Guides: Panel Mode, GC Correction</li> <li>CLI: <code>run-all</code> - Unified pipeline</li> <li>Nextflow: Parameters - Batch processing</li> </ul>"},{"location":"features/core/fsc/#references","title":"References","text":"<p>References</p> <p>Snyder et al. (2016). Cell-free DNA comprises an in vivo nucleosome footprint that informs its tissues-of-origin. Cell, 164(1-2), 57-68.</p> <p>Cristiano et al. (2019). Genome-wide cell-free DNA fragmentation in patients with cancer. Nature, 570(7761), 385-389.</p>"},{"location":"features/core/fsd/","title":"FSD","text":""},{"location":"features/core/fsd/#fragment-size-distribution-fsd","title":"Fragment Size Distribution (FSD)","text":"<p>Command: <code>krewlyzer fsd</code></p> <p>Plain English</p> <p>FSD creates a \"histogram\" of fragment sizes for each chromosome arm. Healthy samples have a peak at ~166bp. Cancer samples show a left-shifted peak (~145bp).</p> <p>Use case: Detect aneuploidy and copy number changes by comparing arm-level size distributions.</p>"},{"location":"features/core/fsd/#purpose","title":"Purpose","text":"<p>Computes high-resolution (5bp bins) fragment length distributions per chromosome arm. Produces ML-ready features with log-ratio normalization and on/off-target split for panel data.</p>"},{"location":"features/core/fsd/#processing-flowchart","title":"Processing Flowchart","text":"<pre><code>flowchart LR\n    BED[\"sample.bed.gz\"] --&gt; PIPELINE[\"Rust Pipeline\"]\n    ARMS[\"Chromosome Arms\"] --&gt; PIPELINE\n    GC[\"GC Correction\"] --&gt; PIPELINE\n    PIPELINE --&gt; FSD[\"FSD.tsv\"]\n\n    subgraph \"With --pon-model\"\n        FSD --&gt; PON[\"PON Normalization\"]\n        PON --&gt; LOGR[\"FSD.tsv + _logR columns\"]\n    end\n\n    subgraph \"With --target-regions\"\n        PIPELINE --&gt; FSD_ON[\"FSD.ontarget.tsv\"]\n    end\n</code></pre>  Use mouse to pan and zoom"},{"location":"features/core/fsd/#pythonrust-architecture","title":"Python/Rust Architecture","text":"<pre><code>flowchart TB\n    subgraph \"Python (CLI)\"\n        CLI[\"fsd.py\"] --&gt; UP[\"unified_processor.py\"]\n        UP --&gt; ASSETS[\"AssetManager\"]\n    end\n\n    subgraph \"Rust Backend\"\n        UP --&gt; RUST[\"_core.run_unified_pipeline()\"]\n        RUST --&gt; GC[\"GC correction\"]\n        GC --&gt; HIST[\"187-bin histogram per arm (65-999bp)\"]\n    end\n\n    subgraph \"Python (Post-processing)\"\n        HIST --&gt; PROC[\"fsd_processor.py\"]\n        PROC --&gt; PON[\"PON log-ratio\"]\n        PON --&gt; OUT[\"FSD.tsv\"]\n    end\n</code></pre>  Use mouse to pan and zoom"},{"location":"features/core/fsd/#biological-context","title":"Biological Context","text":""},{"location":"features/core/fsd/#why-fragment-sizes-matter","title":"Why Fragment Sizes Matter","text":"<p>cfDNA fragment sizes reflect nucleosome positioning and chromatin state in source cells:</p> Fragment Size Source Biological Significance ~145bp Core nucleosome Minimal DNA protection ~166bp Mono-nucleosome + linker \"Classic\" cfDNA peak ~334bp Di-nucleosome Stable chromatin regions 10bp periodicity DNA helical pitch Rotational phasing"},{"location":"features/core/fsd/#cancer-signature","title":"Cancer Signature","text":"Signal Healthy Plasma Cancer (ctDNA) Modal peak ~166bp Left-shifted (~145bp) 10bp periodicity Clear Often disrupted Arm-level variation Minimal Increased (correlates with CNAs) <p>Why arm-level?</p> <p>Chromosome arms have distinct chromatin environments. Tumor-derived cfDNA shows arm-specific fragmentation shifts that correlate with copy number alterations.</p>"},{"location":"features/core/fsd/#usage","title":"Usage","text":"<pre><code># Basic usage\nkrewlyzer fsd -i sample.bed.gz -o output_dir/ --genome hg19\n\n# With PON for log-ratio normalization\nkrewlyzer fsd -i sample.bed.gz -o output_dir/ -P msk-access.pon.parquet\n\n# Panel data (MSK-ACCESS) with on/off-target split\nkrewlyzer run-all -i sample.bam -r ref.fa -o out/ \\\n    --target-regions panel_targets.bed\n</code></pre>"},{"location":"features/core/fsd/#options","title":"Options","text":"Option Short Type Default Description <code>--input</code> <code>-i</code> PATH required Input .bed.gz file (from extract) <code>--output</code> <code>-o</code> PATH required Output directory <code>--sample-name</code> <code>-s</code> TEXT Override sample name <code>--arms-file</code> <code>-a</code> PATH Chromosome arms BED file <code>--target-regions</code> <code>-T</code> PATH Target BED (enables on/off split) <code>--skip-target-regions</code> FLAG Force WGS mode (ignore bundled targets) <code>--assay</code> <code>-A</code> TEXT Assay code (xs1/xs2) for bundled assets <code>--genome</code> <code>-G</code> TEXT hg19 Genome build (hg19/hg38) <code>--pon-model</code> <code>-P</code> PATH PON model for z-score computation <code>--pon-variant</code> TEXT all_unique PON variant: <code>all_unique</code> or <code>duplex</code> <code>--skip-pon</code> FLAG Skip PON z-score normalization <code>--gc-correct</code> FLAG True Apply GC bias correction <code>--threads</code> <code>-t</code> INT 0 Threads (0=all cores) <code>--verbose</code> <code>-v</code> FLAG Enable verbose logging"},{"location":"features/core/fsd/#output-files","title":"Output Files","text":""},{"location":"features/core/fsd/#samplefsdtsv-off-target-default","title":"<code>{sample}.FSD.tsv</code> (Off-Target / Default)","text":"Column Type Description <code>region</code> str Chromosome arm (e.g., \"chr1:0-125000000\") <code>65-69</code>, <code>70-74</code>, ..., <code>995-999</code> float GC-weighted counts in 187 bins (5bp steps, 65-999bp) <code>total</code> float Sum of all bins <code>65-69_logR</code>, ... float log2(sample / PoN_expected) (with -P) <code>pon_stability</code> float 1 / (variance + k) (with -P)"},{"location":"features/core/fsd/#samplefsdontargettsv-panel-mode-only","title":"<code>{sample}.FSD.ontarget.tsv</code> (Panel Mode Only)","text":"<p>Same schema as above, but for fragments overlapping target regions.</p> <p>Important</p> <p>Off-target = unbiased (preferred for biomarkers) On-target = capture-biased (use cautiously for local analysis only)</p>"},{"location":"features/core/fsd/#gc-correction","title":"GC Correction","text":"<p>When <code>--gc-correct</code> is enabled (default):</p> <pre><code>Normalization Order:\n1. GC-weighting (Rust): raw_count \u00d7 gc_correction_factor\n2. PoN log-ratio (Python): log2((sample + 1) / (pon + 1))\n</code></pre> GC Option Effect Enabled Corrects for PCR/capture GC bias Disabled (<code>--no-gc-correct</code>) Raw counts (faster, biased) <p>Tip</p> <p>See GC Correction Details for the LOESS algorithm.</p>"},{"location":"features/core/fsd/#pon-integration","title":"PON Integration","text":"<p>With <code>--pon-model</code>, FSD outputs include log-ratio normalization:</p> Column Formula Interpretation <code>{bin}_logR</code> <code>log2((sample + 1) / (PoN_expected + 1))</code> &gt; 0 = above normal <code>pon_stability</code> <code>1 / (variance + 0.01)</code> Higher = more reliable <p>Formulas:</p> <p>Log-Ratio:</p> \\[ \\text{logR} = \\log_2 \\left( \\frac{\\text{sample_count} + 1}{\\text{PoN_expected} + 1} \\right) \\] <p>PON Stability:</p> \\[ \\text{stability} = \\frac{1}{\\text{variance} + 0.01} \\] <p>Algorithm: 1. For each arm and size bin, retrieve PoN expected value 2. Compute log-ratio with pseudocount (+1) for zero-handling 3. Calculate stability from PoN variance (inverse weighting)</p> <p>Tip</p> <p>See PON Models for model structure and building.</p>"},{"location":"features/core/fsd/#clinical-interpretation","title":"Clinical Interpretation","text":""},{"location":"features/core/fsd/#interpreting-log-ratio-values","title":"Interpreting Log-Ratio Values","text":"<code>*_logR</code> Value Meaning Possible Cause ~0 Normal No deviation from healthy &gt; 0.5 Elevated short fragments Tumor-derived cfDNA &lt; -0.5 Depleted Copy number loss?"},{"location":"features/core/fsd/#arm-level-variation","title":"Arm-Level Variation","text":"Pattern Interpretation Uniform across arms Healthy profile Single arm deviation Focal CNA or arm-level event Multiple arm deviations High tumor fraction (aneuploidy)"},{"location":"features/core/fsd/#187-bin-structure-65-999bp-5bp-steps","title":"187-Bin Structure (65-999bp, 5bp steps)","text":"Bin Range Size Range Description 0 65-69bp Ultra-short (sub-nucleosomal) 1-6 70-99bp Short fragments 7-16 100-149bp Core mono-nucleosomal 17-30 150-219bp Peak mono-nucleosomal 31-50 220-319bp Di-nucleosomal 51-86 320-499bp Multi-nucleosomal 87-186 500-999bp Extended range <p>Note</p> <p>The pipeline uses 5bp bins from 65bp to 999bp, yielding 187 columns. This extended range (up to 1000bp) captures multi-nucleosomal fragments for comprehensive FSD analysis.</p>"},{"location":"features/core/fsd/#panel-data-mode","title":"Panel Data Mode","text":"<p>For targeted sequencing (MSK-ACCESS):</p> <pre><code>krewlyzer fsd -i sample.bed.gz -o output/ \\\n    --target-regions MSK-ACCESS-v2_targets.bed\n</code></pre> Output Contents Use Case <code>.FSD.tsv</code> Off-target fragments Unbiased arm-level biomarkers <code>.FSD.ontarget.tsv</code> On-target fragments Local context (capture-biased) <p>Warning</p> <p>On-target FSD has capture bias and should not be used for global fragmentomics.</p>"},{"location":"features/core/fsd/#see-also","title":"See Also","text":"<ul> <li>Input File Formats - Arms BED format for <code>--arms-file</code></li> <li>GC Correction - LOESS algorithm details</li> <li>PON Models - Building and using PON</li> <li>Citation - DELFI paper references</li> <li>Troubleshooting - Common issues</li> </ul>"},{"location":"features/core/fsr/","title":"FSR","text":""},{"location":"features/core/fsr/#fragment-size-ratio-fsr","title":"Fragment Size Ratio (FSR)","text":"<p>Command: <code>krewlyzer fsr</code></p> <p>Plain English</p> <p>FSR measures the ratio of short (tumor-enriched) to long (healthy) DNA fragments. A higher <code>core_short_long_ratio</code> means more tumor-derived DNA in your sample.</p> <p>Example: <code>core_short_long_ratio = 1.5</code> suggests ~30% tumor burden (vs. ~0.9 in healthy plasma).</p>"},{"location":"features/core/fsr/#purpose","title":"Purpose","text":"<p>Computes short/long fragment ratios for cancer biomarker analysis. Uses PoN-normalization before ratio calculation for accurate cross-sample comparison.</p>"},{"location":"features/core/fsr/#processing-flowchart","title":"Processing Flowchart","text":"<pre><code>flowchart LR\n    BED[\"sample.bed.gz\"] --&gt; RUST[\"Rust Pipeline\"]\n    BINS[\"100kb Bins\"] --&gt; RUST\n    GC[\"GC Correction\"] --&gt; RUST\n\n    RUST --&gt; COUNTS[\"Raw Counts\"]\n\n    subgraph \"Normalization Order\"\n        COUNTS --&gt; NORM[\"PoN Normalize\"]\n        NORM --&gt; RATIO[\"Compute Ratio\"]\n    end\n\n    RATIO --&gt; FSR[\"FSR.tsv\"]\n</code></pre>  Use mouse to pan and zoom"},{"location":"features/core/fsr/#pythonrust-architecture","title":"Python/Rust Architecture","text":"<pre><code>flowchart TB\n    subgraph \"Python (CLI)\"\n        CLI[\"fsr.py\"] --&gt; UP[\"unified_processor.py\"]\n        UP --&gt; ASSETS[\"AssetManager\"]\n    end\n\n    subgraph \"Rust Backend\"\n        UP --&gt; RUST[\"_core.run_unified_pipeline()\"]\n        RUST --&gt; GC[\"GC correction\"]\n        GC --&gt; COUNT[\"Size bin counting\"]\n    end\n\n    subgraph \"Python (Post-processing)\"\n        COUNT --&gt; PROC[\"fsr_processor.py\"]\n        PROC --&gt; PON[\"PON normalization\"]\n        PON --&gt; OUT[\"FSR.tsv\"]\n    end\n</code></pre>  Use mouse to pan and zoom"},{"location":"features/core/fsr/#biological-context","title":"Biological Context","text":"<p>The ratio of short to long fragments is a key indicator of tumor burden in cfDNA:</p> Fragment Type Size Range Biological Source core_short 100-149bp Tumor DNA (sub-nucleosomal, ~145bp peak) mono_nucl 150-259bp Standard mono-nucleosomal cfDNA di_nucl 260-399bp Di-nucleosomal (healthy chromatin) long 400+bp Very long fragments <p>Key Biomarker: <code>core_short_long_ratio</code> \u2013 Higher ratio = higher probability of tumor DNA</p>"},{"location":"features/core/fsr/#why-short-fragments-tumor","title":"Why Short Fragments = Tumor?","text":"<p>Tumor cells have abnormal chromatin structure: - Disrupted nucleosome positioning \u2192 non-canonical cutting - Smaller protected regions \u2192 shorter fragments - Result: Tumor cfDNA peaks at ~145bp vs. healthy cfDNA at ~166bp</p>"},{"location":"features/core/fsr/#usage","title":"Usage","text":"<pre><code># Basic usage\nkrewlyzer fsr -i sample.bed.gz -o output_dir/ --sample-name SAMPLE\n\n# With PON normalization (recommended)\nkrewlyzer fsr -i sample.bed.gz -o output/ -P cohort.pon.parquet\n\n# Panel data with on/off-target split\nkrewlyzer fsr -i sample.bed.gz -o output/ \\\n    --target-regions MSK-ACCESS_targets.bed\n</code></pre>"},{"location":"features/core/fsr/#cli-options","title":"CLI Options","text":"Option Short Type Default Description <code>--input</code> <code>-i</code> PATH required Input .bed.gz file (output from extract) <code>--output</code> <code>-o</code> PATH required Output directory <code>--sample-name</code> <code>-s</code> TEXT Override sample name <code>--bin-input</code> <code>-b</code> PATH Custom bin file <code>--pon-model</code> <code>-P</code> PATH PON model for hybrid GC correction <code>--pon-variant</code> TEXT all_unique PON variant: <code>all_unique</code> or <code>duplex</code> <code>--skip-pon</code> FLAG Skip PON z-score normalization <code>--target-regions</code> <code>-T</code> PATH Target BED (for on/off-target split) <code>--skip-target-regions</code> FLAG Force WGS mode (ignore bundled targets) <code>--assay</code> <code>-A</code> TEXT Assay code (xs1/xs2) for bundled assets <code>--genome</code> <code>-G</code> TEXT hg19 Genome build (hg19/hg38) <code>--windows</code> <code>-w</code> INT 100000 Window size <code>--continue-n</code> <code>-c</code> INT 50 Consecutive window number <code>--gc-correct</code> FLAG True Apply GC bias correction <code>--threads</code> <code>-t</code> INT 0 Number of threads (0=all cores) <code>--verbose</code> <code>-v</code> FLAG Enable verbose logging"},{"location":"features/core/fsr/#size-bin-definitions","title":"Size Bin Definitions","text":"<p>FSR uses the Rust backend's 5-channel size bins:</p> Bin Name Size Range Biological Meaning <code>ultra_short</code> 65-99bp TF footprints, highly tumor-specific <code>core_short</code> 100-149bp Primary tumor biomarker <code>mono_nucl</code> 150-259bp Standard mono-nucleosomal <code>di_nucl</code> 260-399bp Di-nucleosomal, healthy-enriched <code>long</code> 400+bp Multi-nucleosomal (rare)"},{"location":"features/core/fsr/#formulas","title":"Formulas","text":""},{"location":"features/core/fsr/#normalization-order-critical","title":"Normalization Order (Critical)","text":"<p>Important</p> <p>FSR normalizes counts to PoN BEFORE computing ratios.</p> <p>Step 1 - Normalize short:</p> \\[ \\text{core_short_norm} = \\frac{\\text{core_short_count}}{\\text{PoN_core_short_mean}} \\] <p>Step 2 - Normalize long:</p> \\[ \\text{long_norm} = \\frac{\\text{long_count}}{\\text{PoN_long_mean}} \\] <p>Step 3 - Compute ratio:</p> \\[ \\text{core_short_long_ratio} = \\frac{\\text{core_short_norm}}{\\text{long_norm}} \\] <p>This removes batch effects before ratio calculation, ensuring accurate cross-sample comparison.</p> <p>Step 4 - Log2 ratio (optional):</p> \\[ \\text{short_long_log2} = \\log_2(\\text{core_short_long_ratio}) \\] log2 Value Meaning 0 Equal short/long (baseline) &gt; 0.5 Elevated short fragments (tumor signal) &lt; -0.5 Depleted short fragments"},{"location":"features/core/fsr/#output-format","title":"Output Format","text":"<p>Output: <code>{sample}.FSR.tsv</code></p> Column Type Description <code>region</code> str Genomic region (chr:start-end) <code>ultra_short_count</code> int Ultra-short fragments (65-99bp) <code>core_short_count</code> int Core short fragments (100-149bp) <code>mono_nucl_count</code> int Mono-nucleosomal fragments (150-259bp) <code>di_nucl_count</code> int Di-nucleosomal fragments (260-399bp) <code>long_count</code> int Long fragments (400+bp) <code>total_count</code> int Total fragments <code>ultra_short_ratio</code> float ultra_short / total <code>core_short_ratio</code> float core_short / total <code>mono_nucl_ratio</code> float mono_nucl / total <code>di_nucl_ratio</code> float di_nucl / total <code>long_ratio</code> float long / total <code>core_short_long_ratio</code> float core_short / long (primary biomarker)"},{"location":"features/core/fsr/#panel-mode-target-regions","title":"Panel Mode (--target-regions)","text":"<p>For targeted sequencing panels (MSK-ACCESS):</p> <pre><code>krewlyzer fsr -i sample.bed.gz -o output/ \\\n    --target-regions MSK-ACCESS_targets.bed\n</code></pre>"},{"location":"features/core/fsr/#output-files","title":"Output Files","text":"File Contents Use Case <code>{sample}.FSR.tsv</code> Off-target fragment ratios Unbiased ratio (primary biomarker) <p>Important</p> <p>FSR is computed from off-target FSC counts and does not produce a separate <code>.ontarget.tsv</code> file. Off-target fragments provide unbiased short/long ratios for tumor detection.</p>"},{"location":"features/core/fsr/#clinical-interpretation","title":"Clinical Interpretation","text":"Metric Healthy Plasma Cancer (ctDNA) Modal fragment size ~166bp Left-shifted (~145bp) <code>core_short_long_ratio</code> ~0.8-1.0 (baseline) &gt;1.2 elevated Interpretation Normal profile Elevated tumor burden"},{"location":"features/core/fsr/#decision-flowchart","title":"Decision Flowchart","text":"<pre><code>flowchart TD\n    FSR[FSR Results] --&gt; Q1{core_short_long_ratio &gt; 1.3?}\n    Q1 --&gt;|Yes| HIGH[High tumor burden]\n    Q1 --&gt;|No| Q2{core_short_long_ratio &gt; 1.1?}\n    Q2 --&gt;|Yes| MOD[Moderate tumor signal]\n    Q2 --&gt;|No| LOW[Low/no detectable tumor]\n</code></pre>  Use mouse to pan and zoom  <p>Note</p> <p>Thresholds depend on your cohort and should be validated against known samples.</p>"},{"location":"features/core/fsr/#see-also","title":"See Also","text":"<ul> <li>FSC \u2013 Full 5-channel coverage</li> <li>FSD \u2013 Size distribution by arm</li> <li>PON Models \u2013 Normalization baselines</li> <li>Glossary \u2013 Terminology reference</li> <li>Citation \u2013 DELFI paper references</li> </ul>"},{"location":"features/core/wps/","title":"WPS","text":""},{"location":"features/core/wps/#windowed-protection-score-wps","title":"Windowed Protection Score (WPS)","text":"<p>Command: <code>krewlyzer wps</code></p> <p>Plain English</p> <p>WPS measures how well nucleosomes protect DNA from cutting. Healthy cfDNA shows a regular ~190bp spacing pattern. Cancer disrupts this pattern - lower <code>nrl_quality</code> = more tumor burden.</p> <p>Quick metric: <code>nrl_quality &gt; 0.7</code> = healthy, <code>&lt; 0.5</code> = potentially abnormal</p>"},{"location":"features/core/wps/#purpose","title":"Purpose","text":"<p>Computes ML-ready nucleosome and transcription factor protection profiles from cfDNA fragments around genomic anchors (TSS, CTCF sites) and global chromatin metrics from Alu elements.</p>"},{"location":"features/core/wps/#biological-context","title":"Biological Context","text":""},{"location":"features/core/wps/#what-is-wps","title":"What is WPS?","text":"<p>When DNA wraps around a nucleosome, the histone core protects ~147bp from enzymatic digestion. In cfDNA, fragments that span a nucleosome are \"protected\" (whole), while fragments that end at nucleosome boundaries are \"fragmented\" (cut).</p> <p>WPS Formula:</p> \\[ \\text{WPS} = \\text{Fragments}_{\\text{spanning}} - \\text{Fragments}_{\\text{ending}} \\] WPS Value Meaning Biological Interpretation Positive Protected Nucleosome present (stable chromatin) Zero Balanced Transition zone Negative Fragmented Open chromatin (accessible DNA)"},{"location":"features/core/wps/#dual-stream-processing","title":"Dual-Stream Processing","text":"<p>Krewlyzer separates fragments into two biological signals:</p> Stream Window Fragment Size Weight Biological Signal WPS-Nuc 120bp [160-175bp] 1.0 (primary) Nucleosome positioning [120-159] \u222a [176-180bp] 0.5 (secondary) Flanking nucleosomes WPS-TF 16bp [35-80bp] 1.0 Transcription factor footprints <p>The tiered weights for nucleosome fragments prioritize \"perfect\" mono-nucleosome sizes (~167bp) over edge cases.</p>"},{"location":"features/core/wps/#pythonrust-architecture","title":"Python/Rust Architecture","text":"<pre><code>flowchart TB\n    subgraph \"Python (CLI)\"\n        CLI[\"wps.py\"] --&gt; UP[\"unified_processor.py\"]\n        UP --&gt; ASSETS[\"AssetManager\"]\n    end\n\n    subgraph \"Rust Backend (Parallel)\"\n        UP --&gt; RUST[\"_core.run_unified_pipeline()\"]\n        RUST --&gt; GC[\"GC correction\"]\n        GC --&gt; WPS_NUC[\"WPS foreground(par_iter over regions)\"]\n        GC --&gt; WPS_BG[\"WPS background (Alu)\"]\n    end\n\n    subgraph \"Python (Post-processing)\"\n        WPS_NUC --&gt; PROC[\"wps_processor.py\"]\n        WPS_BG --&gt; PROC\n        PROC --&gt; SMOOTH[\"Savitzky-Golay smoothing\"]\n        SMOOTH --&gt; FFT[\"FFT periodicity (Rust)\"]\n        FFT --&gt; PON[\"PON z-scores\"]\n        PON --&gt; OUT[\"WPS.parquet\"]\n    end\n</code></pre>  Use mouse to pan and zoom  <p>Performance</p> <p>Region-level parallelization via Rayon <code>par_iter()</code> enables efficient multi-core processing of anchor regions.</p>"},{"location":"features/core/wps/#foreground-vs-background","title":"Foreground vs Background","text":"<p>WPS generates two complementary outputs that capture different biological scales:</p>"},{"location":"features/core/wps/#foreground-samplewpsparquet","title":"Foreground (<code>sample.WPS.parquet</code>)","text":"<p>What it is: High-resolution WPS profiles around specific genomic anchors (TSS, CTCF sites).</p> <p>Why it matters: Gene promoters and CTCF sites have characteristic nucleosome patterns: - Active promoters: Nucleosome-depleted region (NDR) upstream of TSS - Silent promoters: Packed nucleosomes across TSS - CTCF sites: Sharp nucleosome boundaries (insulator function)</p> <p>ML use: These 200-bin vectors are gene-specific signatures. Comparing them across cancer types reveals tissue-of-origin and tumor-specific disruptions.</p> <pre><code>                          TSS\n                           |\n    \u2190\u2500\u2500\u2500\u2500\u2500 -1kb \u2500\u2500\u2500\u2500\u2500      \u2193      \u2500\u2500\u2500\u2500\u2500 +1kb \u2500\u2500\u2500\u2500\u2500\u2192\n    [bin 0] ... [bin 99] [100] [bin 101] ... [bin 199]\n</code></pre>"},{"location":"features/core/wps/#background-samplewps_backgroundparquet","title":"Background (<code>sample.WPS_background.parquet</code>)","text":"<p>What it is: Stacked WPS profiles from ~770,000 Alu elements across the genome.</p> <p>Why Alu elements?</p> <ol> <li>Ubiquitous: Alu elements are everywhere (~11% of human genome)</li> <li>Consistent size: ~300bp (perfect for 2-nucleosome periodicity)</li> <li>No gene bias: Not restricted to specific genes or pathways</li> <li>Robust signal: Stacking 770K elements averages out noise</li> </ol> <p>What it measures: When you stack all Alu WPS profiles, a periodic wave emerges at ~190bp (nucleosome repeat length). This periodicity reflects global chromatin health:</p> Periodicity Meaning Cancer Implication Strong (~190bp) Regular nucleosome spacing Healthy chromatin Weak/disrupted Irregular chromatin Tumor burden, genomic instability <p>Hierarchical Groups: - <code>Global_All</code>: All Alu (highest SNR, best for QC) - <code>Family_AluY/S/J</code>: Subfamily ages (~15M / ~35M / ~65M years) - <code>Chr1_All</code> ... <code>ChrY_All</code>: Per-chromosome (CNV context)</p>"},{"location":"features/core/wps/#post-processing-smoothing-and-fft","title":"Post-Processing: Smoothing and FFT","text":""},{"location":"features/core/wps/#savitzky-golay-smoothing","title":"Savitzky-Golay Smoothing","text":"<p>Purpose: Reduce high-frequency noise while preserving peak shapes.</p> <p>How it works: Fits a polynomial (order=3) to sliding windows (size=11) and uses the fitted value. Unlike moving average, it preserves peak heights and widths.</p> Column Description <code>wps_nuc_smooth</code> Smoothed nucleosome profile <code>wps_tf_smooth</code> Smoothed TF profile <p>When to use: Always use smoothed columns for visualization. Raw columns for debugging.</p>"},{"location":"features/core/wps/#fft-periodicity-extraction","title":"FFT Periodicity Extraction","text":"<p>Purpose: Quantify the ~190bp nucleosome repeat length (NRL) from Alu stacking.</p> <p>How it works: 1. Detrend: Remove linear trends from stacked profile 2. Normalize: Z-score to make amplitude comparable across samples 3. Window: Apply Hann window to reduce spectral leakage 4. FFT: Find dominant frequency in 150-250bp range 5. SNR: Compare peak amplitude to background</p> Column Description <code>nrl_period_bp</code> Detected nucleosome repeat length <code>nrl_amplitude</code> FFT amplitude at dominant frequency <code>nrl_snr</code> Signal-to-noise ratio (peak vs background) <code>nrl_quality</code> 0-1 quality score (SNR/3, capped) <p>Expected values: - Healthy samples: NRL ~190bp, quality &gt; 0.7 - Cancer samples: NRL shifted, quality &lt; 0.5</p>"},{"location":"features/core/wps/#usage","title":"Usage","text":"<pre><code># Basic (auto-loads bundled assets)\nkrewlyzer wps -i sample.bed.gz -o output/ --genome hg38\n\n# With explicit background override\nkrewlyzer wps -i sample.bed.gz -o output/ --background custom_alu.bed.gz\n\n# Panel data (MSK-ACCESS)\nkrewlyzer wps -i sample.bed.gz -o output/ --target-regions msk_access_baits.bed --bait-padding 20\n\n# Panel data with panel-specific anchors (recommended for MSK-ACCESS)\nkrewlyzer wps -i sample.bed.gz -o output/ \\\n    --wps-anchors /path/to/xs2.wps_anchors.bed.gz \\\n    --target-regions msk_access_baits.bed\n</code></pre>"},{"location":"features/core/wps/#panel-specific-wps-anchors","title":"Panel-Specific WPS Anchors","text":"<p>For targeted panels like MSK-ACCESS, genome-wide WPS anchors include many regions with no coverage. Use panel-specific anchors for focused analysis:</p> Assay Bundled File Anchors Genes MSK-ACCESS v1 <code>xs1.wps_anchors.bed.gz</code> 1,611 128 MSK-ACCESS v2 <code>xs2.wps_anchors.bed.gz</code> 1,820 146 <p>What's included: - TSS anchors for genes in the panel - CTCF anchors within 100kb of panel genes</p> <p>Benefits: - Reduced noise from off-target regions - Faster processing - More interpretable ML features</p>"},{"location":"features/core/wps/#cli-options","title":"CLI Options","text":"Option Short Type Default Description <code>--input</code> <code>-i</code> PATH required Input .bed.gz file (output from extract) <code>--output</code> <code>-o</code> PATH required Output directory <code>--sample-name</code> <code>-s</code> TEXT Override sample name <code>--wps-anchors</code> PATH WPS anchors BED (TSS+CTCF) for dual-stream profiling <code>--assay</code> <code>-A</code> TEXT Assay code (xs1/xs2) for bundled assets <code>--target-regions</code> <code>-T</code> PATH Panel capture BED (enables bait edge masking) <code>--skip-target-regions</code> FLAG Force WGS mode (ignore bundled targets) <code>--bait-padding</code> INT 50 Bait edge padding in bp <code>--background</code> <code>-B</code> PATH Background Alu BED for hierarchical stacking <code>--genome</code> <code>-G</code> TEXT hg19 Genome build (hg19/hg38) <code>--pon-model</code> <code>-P</code> PATH PON model for z-score computation <code>--pon-variant</code> TEXT all_unique PON variant: <code>all_unique</code> or <code>duplex</code> <code>--skip-pon</code> FLAG Skip PON z-score normalization <code>--empty</code> FLAG False Include regions with no coverage <code>--gc-correct</code> FLAG True Apply GC bias correction <code>--threads</code> <code>-t</code> INT 0 Number of threads (0=all cores) <code>--verbose</code> <code>-v</code> FLAG Enable verbose logging"},{"location":"features/core/wps/#bait-padding-trade-off","title":"Bait Padding Trade-Off","text":"<p>The <code>--bait-padding</code> option controls how many bp to trim from bait edges to avoid capture artifacts.</p> Value Effect Best For 50 (default) Maximum artifact removal WGS, large targets (&gt;200bp) 15-20 Preserves data in small exons Dense exon panels (MSK-ACCESS) 0 No trimming (not recommended) Debugging only <p>Adaptive Safety: The tool automatically reduces padding for small targets: </p><pre><code>effective_trim = min(user_trim, target_length / 4)\n</code></pre> This ensures you never mask more than 50% of a small exon (25% per side).<p></p>"},{"location":"features/core/wps/#dual-wps-output-with-assay","title":"Dual WPS Output (with <code>--assay</code>)","text":"<p>When using <code>--assay</code> (e.g., for MSK-ACCESS), Krewlyzer generates two WPS output files:</p> <pre><code>krewlyzer wps -i sample.bed.gz -o output/ --assay xs2\n</code></pre>"},{"location":"features/core/wps/#output-files","title":"Output Files","text":"File Anchors Purpose <code>{sample}.WPS.parquet</code> Genome-wide (~15k) Global cancer detection signature <code>{sample}.WPS.panel.parquet</code> Panel genes (~2k) Targeted gene-level profiling"},{"location":"features/core/wps/#why-dual-output","title":"Why Dual Output?","text":"Scenario Use Pan-cancer detection Use <code>WPS.parquet</code> (genome-wide) Specific gene analysis Use <code>WPS.panel.parquet</code> (focused) Feature vectors for ML Combine both via JSON output"},{"location":"features/core/wps/#how-it-works","title":"How It Works","text":"<ol> <li>First pass: Genome-wide anchors (TSS+CTCF for ~5,000 genes)</li> <li>Second pass: Panel-specific anchors (genes in your assay)</li> </ol> <p>Both use the same pre-computed GC correction factors for consistency.</p>"},{"location":"features/core/wps/#output-files_1","title":"Output Files","text":""},{"location":"features/core/wps/#foreground-samplewpsparquet_1","title":"Foreground: <code>sample.WPS.parquet</code>","text":"<p>Per-region profiles centered on TSS/CTCF anchors (\u00b11kb, 200 bins \u00d7 10bp).</p> Column Type Description <code>region_id</code> string Anchor identifier <code>chrom</code> string Chromosome <code>center</code> int64 Anchor center position <code>strand</code> string +/- strand <code>region_type</code> string TSS/CTCF <code>wps_nuc</code> float32[200] Nucleosome WPS profile <code>wps_tf</code> float32[200] TF WPS profile <code>wps_nuc_smooth</code> float32[200] Savitzky-Golay smoothed <code>wps_tf_smooth</code> float32[200] Savitzky-Golay smoothed <code>prot_frac_nuc</code> float32[200] Protection fraction (nuc) <code>prot_frac_tf</code> float32[200] Protection fraction (TF) <code>capture_mask</code> uint8[200] Panel mask (1=reliable, 0=edge/off-target) <code>local_depth</code> float32 Local fragment coverage <p>Strand Correction</p> <p>All profiles are strand-corrected.</p> <ul> <li>Genes on <code>+</code> strand are stored 5' \u2192 3'</li> <li>Genes on <code>-</code> strand are reversed so they are also 5' \u2192 3'</li> <li>Result: Bin 100 is always the TSS, and Bin 110 is always \"+100bp downstream\", regardless of gene orientation.</li> </ul>"},{"location":"features/core/wps/#pon-normalized-columns-v20","title":"PON-Normalized Columns (v2.0)","text":"<p>When using a v2.0 vector PON, these additional columns are computed:</p> Column Type Description <code>z_vector</code> float32[200] Position-wise z-scores vs healthy baseline <code>shape_score</code> float32 Pearson correlation with healthy shape [-1, 1] <code>z_amplitude</code> float32 Mean of abs(z_vector) for backward compat <p>Tip</p> <p>Shape Score Interpretation: - 0.9-1.0: Healthy nucleosome positioning - 0.5-0.9: Mild chromatin disorganization - &lt;0.5: Significant disruption (cancer signal)</p> <p>See PON v2.0 for baseline details.</p>"},{"location":"features/core/wps/#background-samplewps_backgroundparquet_1","title":"Background: <code>sample.WPS_background.parquet</code>","text":"<p>Hierarchical stacking of ~770K Alu elements into 29 groups.</p> Column Type Description <code>group_id</code> string Group name (e.g., Global_All, Chr1_H, AluJb) <code>stacked_wps_nuc</code> float32[30] Stacked nucleosome profile (200 bins) <code>stacked_wps_tf</code> float32[30] Stacked TF profile <code>stacked_wps_nuc_smooth</code> float32[30] Savitzky-Golay smoothed profile <code>alu_count</code> int64 Number of Alu elements in group <code>nrl_bp</code> float32 Nucleosome Repeat Length in bp (expected ~190bp) <code>nrl_deviation_bp</code> float32 NEW: Absolute deviation from expected 190bp <code>periodicity_score</code> float32 Raw SNR-based quality score (0-1) <code>adjusted_score</code> float32 NEW: periodicity_score \u00d7 deviation_penalty <p>NRL Deviation Scoring</p> <p>The <code>adjusted_score</code> penalizes samples with abnormal NRL values. A sample with strong periodicity but wrong NRL (e.g., 170bp instead of 190bp) will have lower <code>adjusted_score</code>.</p> \\[ \\text{adjusted_score} = \\text{periodicity_score} \\times \\max\\left(0, 1 - \\frac{|\\text{nrl_bp} - 190|}{50}\\right) \\]"},{"location":"features/core/wps/#wgs-vs-panel-data-msk-access","title":"WGS vs Panel Data (MSK-ACCESS)","text":"Aspect WGS Panel (MSK-ACCESS) Foreground coverage All regions Sparse off-target capture_mask All 1s 1=on-target, 0=off-target Background Alu Full stacking Still works! (Alu is global) Best ML features Gene-specific vectors Global periodicity metrics <p>Key insight: Background Alu stacking works for panels because Alu elements are genome-wide, not restricted to capture regions.</p>"},{"location":"features/core/wps/#ml-feature-summary","title":"ML Feature Summary","text":""},{"location":"features/core/wps/#from-foreground","title":"From Foreground","text":"<ul> <li>Gene-specific nucleosome disruption patterns</li> <li>TF binding footprints at promoters</li> <li>Tissue-of-origin signatures</li> </ul>"},{"location":"features/core/wps/#from-background","title":"From Background","text":"<ul> <li>Global tumor burden: Loss of periodicity correlates with tumor fraction</li> <li>Subfamily ratios: <code>Family_AluY / Family_AluJ</code> \u2192 Tissue context</li> <li>Per-chromosome: Chromatin disruption \u2192 CNV context</li> </ul>"},{"location":"features/core/wps/#references","title":"References","text":"<p>Reference</p> <p>Snyder et al. (2016). Cell-free DNA comprises an in vivo nucleosome footprint that informs its tissues-of-origin. Cell, 164(1-2), 57-68.</p>"},{"location":"features/core/wps/#see-also","title":"See Also","text":"<ul> <li>Input File Formats - WPS anchors BED6 format for <code>--wps-anchors</code></li> <li>PON Models - Building and using PON</li> <li>Troubleshooting - Common issues</li> </ul>"},{"location":"features/methylation/uxm/","title":"UXM","text":""},{"location":"features/methylation/uxm/#fragment-level-methylation-uxm","title":"Fragment-level Methylation (UXM)","text":"<p>Command: <code>krewlyzer uxm</code></p> <p>Plain English: UXM analyzes methylation patterns to determine which cell types contributed cfDNA. Different tissues have unique methylation signatures\u2014like a \"fingerprint\" for each cell type.</p> <p>Use case: Cell-type deconvolution - determine if cfDNA comes from liver, immune cells, tumor, etc.</p>"},{"location":"features/methylation/uxm/#purpose","title":"Purpose","text":"<p>Computes the proportions of Unmethylated (U), Mixed (X), and Methylated (M) fragments per genomic region for cell-type deconvolution.</p>"},{"location":"features/methylation/uxm/#processing-flowchart","title":"Processing Flowchart","text":"<pre><code>flowchart LR\n    BAM[\"Bisulfite BAM\"] --&gt; RUST[\"Rust Backend\"]\n    MARKERS[\"Methylation Markers\"] --&gt; RUST\n\n    RUST --&gt; UXM[\"UXM.tsv\"]\n\n    subgraph \"Per Fragment\"\n        RUST --&gt; CLASS{\"CpG Methylation\"}\n        CLASS --&gt;|\"\u226425%\"| U[\"Unmethylated (U)\"]\n        CLASS --&gt;|\"25-75%\"| X[\"Mixed (X)\"]\n        CLASS --&gt;|\"\u226575%\"| M[\"Methylated (M)\"]\n    end\n</code></pre>  Use mouse to pan and zoom"},{"location":"features/methylation/uxm/#biological-context","title":"Biological Context","text":"<p>Fragment-level methylation (UXM, Loyfer et al., 2022) reveals cell-of-origin and cancer-specific methylation patterns in cfDNA. Each fragment is classified by its CpG methylation level within marker regions.</p>"},{"location":"features/methylation/uxm/#usage","title":"Usage","text":"<pre><code># Basic usage\nkrewlyzer uxm -i bisulfite.bam -o output_dir/ --genome hg19\n\n# With custom marker file\nkrewlyzer uxm -i bisulfite.bam -o output/ \\\n    --mark-input custom_markers.bed.gz\n\n# Paired-end mode\nkrewlyzer uxm -i bisulfite.bam -o output/ --type PE\n</code></pre>"},{"location":"features/methylation/uxm/#cli-options","title":"CLI Options","text":"Option Short Type Default Description <code>--input</code> <code>-i</code> PATH required Bisulfite sequencing BAM <code>--output</code> <code>-o</code> PATH required Output directory <code>--sample-name</code> <code>-s</code> TEXT Override sample name <code>--mark-input</code> <code>-m</code> PATH Auto Path to genomic marker file <code>--type</code> TEXT SE Sequencing type: SE or PE <code>--genome</code> <code>-G</code> TEXT hg19 Genome build (hg19/hg38) <code>--verbose</code> <code>-v</code> FLAG Enable verbose logging <code>--threads</code> <code>-t</code> INT 0 Number of threads (0=all)"},{"location":"features/methylation/uxm/#output-format","title":"Output Format","text":"<p>Output: <code>{sample}.UXM.tsv</code></p> Column Type Description <code>region</code> str Marker region ID <code>U_count</code> int Unmethylated fragments <code>X_count</code> int Mixed fragments <code>M_count</code> int Methylated fragments <code>total</code> int Total fragments <code>U_frac</code> float U / total <code>X_frac</code> float X / total <code>M_frac</code> float M / total"},{"location":"features/methylation/uxm/#fragment-classification","title":"Fragment Classification","text":"<pre><code>                   CpG Methylation Level\n    \u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n    0%            25%            75%           100%\n    \u2502      U      \u2502      X       \u2502      M      \u2502\n    \u2502 Unmethylated\u2502    Mixed     \u2502 Methylated  \u2502\n</code></pre> Class Threshold Interpretation U \u226425% CpGs methylated Cell-type specific unmethylated X 25-75% Heterogeneous/mosaic M \u226575% CpGs methylated Stably methylated"},{"location":"features/methylation/uxm/#clinical-interpretation","title":"Clinical Interpretation","text":""},{"location":"features/methylation/uxm/#healthy-cfdna-composition","title":"Healthy cfDNA Composition","text":"<p>Based on the Human Methylation Atlas:</p> Cell Type Contribution Megakaryocytes ~31% Granulocytes ~30% Monocytes/Macrophages ~20% Endothelial ~6% Hepatocytes ~3% Lymphocytes ~3%"},{"location":"features/methylation/uxm/#cancer-detection","title":"Cancer Detection","text":"Pattern Interpretation Altered tissue proportions Tumor shifts composition Non-hematopoietic increase Possible tumor cfDNA Resolution Can detect ~0.1% tumor fractions"},{"location":"features/methylation/uxm/#see-also","title":"See Also","text":"<ul> <li>Citation - Loyfer et al. paper</li> <li>Troubleshooting - Common issues</li> </ul>"},{"location":"features/output/json-output/","title":"JSON Export","text":""},{"location":"features/output/json-output/#json-feature-output","title":"JSON Feature Output","text":"<p>The <code>--generate-json</code> flag produces a single JSON file containing all features for ML integration.</p> <pre><code>krewlyzer run-all -i sample.bam -r hg19.fa -o out/ \\\n    --assay xs2 \\\n    --generate-json\n</code></pre> <p>This generates <code>{sample}.features.json</code> alongside the standard TSV/Parquet outputs.</p>"},{"location":"features/output/json-output/#top-level-structure","title":"Top-Level Structure","text":"<pre><code>{\n  \"schema_version\": \"1.0\",\n  \"sample_id\": \"sample_001\",\n  \"krewlyzer_version\": \"0.6.0\",\n  \"timestamp\": \"2026-02-28T19:00:00\",\n  \"metadata\": {\n    \"genome\": \"hg19\",\n    \"assay\": \"xs2\",\n    \"panel_mode\": true,\n    \"on_target_rate\": 0.45\n  },\n  \"features\": {\n    \"fsc\": { ... },\n    \"fsc_gene\": [ ... ],\n    \"fsc_region\": [ ... ],\n    \"fsc_region_e1\": [ ... ],\n    \"fsc_counts\": [ ... ],\n    \"fsr\": { ... },\n    \"fsd\": { ... },\n    \"wps\": { ... },\n    \"wps_panel\": { ... },\n    \"wps_background\": { ... },\n    \"motif\": { ... },\n    \"ocf\": { ... },\n    \"tfbs\": { ... },\n    \"atac\": { ... },\n    \"gc_factors\": { ... },\n    \"mfsd\": { ... },\n    \"region_mds\": { ... },\n    \"uxm\": { ... }\n  },\n  \"qc\": { ... }\n}\n</code></pre>"},{"location":"features/output/json-output/#feature-schemas","title":"Feature Schemas","text":""},{"location":"features/output/json-output/#fsc-fragment-size-coverage","title":"FSC (Fragment Size Coverage)","text":"<p>Window-based fragment size counts. Split into <code>off_target</code> (genome-wide) and <code>on_target</code> (panel capture regions).</p> <pre><code>\"fsc\": {\n  \"off_target\": [\n    {\n      \"region\": \"chr1:0-500000\",\n      \"ultra_short\": 123,\n      \"core_short\": 4567,\n      \"mono_nucl\": 8901,\n      \"di_nucl\": 2345,\n      \"long\": 678,\n      \"total\": 16614,\n      \"log_ratio_core_short\": -0.15,\n      \"zscore_core_short\": -1.23\n    }\n  ],\n  \"on_target\": [ ... ]\n}\n</code></pre> Field Type Description <code>region</code> string Genomic window coordinates <code>ultra_short</code> int Fragments 65\u201399 bp <code>core_short</code> int Fragments 100\u2013149 bp <code>mono_nucl</code> int Fragments 150\u2013259 bp <code>di_nucl</code> int Fragments 260\u2013399 bp <code>long</code> int Fragments 400+ bp <code>log_ratio_*</code> float Log\u2082(observed/expected) vs PON <code>zscore_*</code> float Z-score vs PON (if PON provided)"},{"location":"features/output/json-output/#fsc-gene-panel-mode-only","title":"FSC Gene (Panel Mode Only)","text":"<p>Gene-level fragment size aggregation. Only present with <code>--assay</code>.</p> <pre><code>\"fsc_gene\": [\n  {\n    \"gene\": \"ATM\",\n    \"n_regions\": 62,\n    \"total_bp\": 8432,\n    \"ultra_short\": 1234,\n    \"core_short\": 5678,\n    \"mono_nucl\": 9012,\n    \"core_short_ratio\": 0.282,\n    \"normalized_depth\": 1245.67,\n    \"z_core_short\": -0.45\n  }\n]\n</code></pre>"},{"location":"features/output/json-output/#fsc-region-panel-mode-only","title":"FSC Region (Panel Mode Only)","text":"<p>Per-exon/target fragment size data. More granular than gene-level.</p> <pre><code>\"fsc_region\": [\n  {\n    \"chrom\": \"1\",\n    \"start\": 11168235,\n    \"end\": 11168345,\n    \"gene\": \"MTOR\",\n    \"region_name\": \"MTOR_target_02\",\n    \"region_bp\": 110,\n    \"ultra_short\": 8.0,\n    \"core_short\": 229.0,\n    \"mono_nucl\": 804.0,\n    \"di_nucl\": 88.0,\n    \"total\": 1129.0,\n    \"normalized_depth\": 1272.71\n  }\n]\n</code></pre>"},{"location":"features/output/json-output/#fsc-region-e1-panel-mode-only","title":"FSC Region E1 (Panel Mode Only)","text":"<p>First exon (E1) per gene. E1 = promoter-proximal region with stronger cancer signal (Helzer et al. 2025).</p> <pre><code>\"fsc_region_e1\": [\n  {\n    \"chrom\": \"14\",\n    \"start\": 105238685,\n    \"end\": 105238805,\n    \"gene\": \"AKT1\",\n    \"region_name\": \"exon_AKT1_15a_1\",\n    \"region_bp\": 120,\n    \"ultra_short\": 19.0,\n    \"mono_nucl\": 635.0,\n    \"total\": 1082.0,\n    \"normalized_depth\": 3039.77\n  }\n]\n</code></pre> <p>Tip</p> <p>Use <code>fsc_region_e1</code> for early cancer detection models where promoter fragmentation changes are a primary signal.</p>"},{"location":"features/output/json-output/#fsc-counts-raw-gc-binned-counts","title":"FSC Counts (Raw GC-Binned Counts)","text":"<p>Raw per-GC-bin, per-size-class fragment counts. Source: <code>{sample}.fsc_counts.tsv</code>.</p> <pre><code>\"fsc_counts\": [\n  {\n    \"gc_bin\": 0.40,\n    \"len_bin\": 150,\n    \"count\": 1234,\n    \"expected\": 1012.5,\n    \"correction_factor\": 1.218\n  }\n]\n</code></pre> <p>Note</p> <p><code>fsc_counts</code> contains pre-correction data. The GC bias correction is already applied to <code>fsc</code>, <code>fsr</code>, and <code>fsd</code> values.</p>"},{"location":"features/output/json-output/#fsr-fragment-size-ratios","title":"FSR (Fragment Size Ratios)","text":"<p>Biomarker ratios for tumor detection. Split into <code>off_target</code> and <code>on_target</code>.</p> <pre><code>\"fsr\": {\n  \"off_target\": [\n    {\n      \"region\": \"chr1:0-500000\",\n      \"ultra_short_ratio\": 0.0074,\n      \"core_short_ratio\": 0.275,\n      \"mono_nucl_ratio\": 0.536,\n      \"di_nucl_ratio\": 0.141,\n      \"long_ratio\": 0.041,\n      \"core_short_long_ratio\": 6.73\n    }\n  ],\n  \"on_target\": [ ... ]\n}\n</code></pre> Field Type Description <code>*_ratio</code> float Fraction of total fragments in that size class <code>core_short_long_ratio</code> float Primary cancer biomarker (higher = more tumor content)"},{"location":"features/output/json-output/#fsd-fragment-size-distribution","title":"FSD (Fragment Size Distribution)","text":"<p>Per-arm size distribution profiles. Split into <code>off_target</code> and <code>on_target</code>.</p> <pre><code>\"fsd\": {\n  \"off_target\": {\n    \"arms\": [\"1p\", \"1q\", \"2p\", \"...\"],\n    \"size_bins\": [\"65-69\", \"70-74\", \"...\", \"395-399\"],\n    \"counts\": [[123, 456, ...], [...]],\n    \"total\": [12345, 13456, ...]\n  },\n  \"on_target\": { ... }\n}\n</code></pre> Field Type Description <code>arms</code> string[] Chromosomal arm labels <code>size_bins</code> string[] Fragment size range labels (bp) <code>counts</code> int[][] Count matrix: arms \u00d7 size bins <code>total</code> int[] Total fragment count per arm"},{"location":"features/output/json-output/#wps-windowed-protection-score","title":"WPS (Windowed Protection Score)","text":"<p>Nucleosome positioning profiles. Stored as columnar arrays (one value per region), not row records.</p> <pre><code>\"wps\": {\n  \"regions\": [\"ENSG00000142611_TSS\", \"ENSG00000157764_TSS\", \"...\"],\n  \"chrom\": [\"1\", \"7\", \"...\"],\n  \"center\": [11166302, 140453136, \"...\"],\n  \"wps_nuc\": [24.5, 18.2, \"...\"],\n  \"wps_tf\": [-3.2, -1.8, \"...\"],\n  \"wps_nuc_smooth\": [23.1, 17.9, \"...\"],\n  \"wps_tf_smooth\": [-3.0, -1.7, \"...\"],\n  \"wps_nuc_mean\": [22.8, 17.5, \"...\"],\n  \"wps_tf_mean\": [-2.9, -1.6, \"...\"],\n  \"wps_nuc_z\": [1.2, 0.8, \"...\"],\n  \"wps_tf_z\": [-0.4, -0.2, \"...\"],\n  \"prot_frac_nuc\": [0.62, 0.55, \"...\"],\n  \"prot_frac_tf\": [0.41, 0.38, \"...\"]\n}\n</code></pre> Field Type Description <code>regions</code> string[] Region IDs (one entry per anchor) <code>wps_nuc</code> float[] Nucleosomal WPS (120\u2013180 bp fragments) <code>wps_tf</code> float[] TF footprint WPS (35\u201380 bp fragments) <code>wps_*_smooth</code> float[] Savitzky-Golay smoothed profiles <code>wps_*_z</code> float[] Z-scores vs PON baseline <code>prot_frac_*</code> float[] Protected fraction (values &gt; 0) <p>Reconstructing a DataFrame</p> <pre><code>import pandas as pd\nwps = features[\"wps\"]\ndf = pd.DataFrame({\"region_id\": wps[\"regions\"], \"wps_nuc\": wps[\"wps_nuc\"], ...})\n</code></pre>"},{"location":"features/output/json-output/#wps-panel-panel-mode-only","title":"WPS Panel (Panel Mode Only)","text":"<p>Same schema as standard TSV/Parquet WPS output, but stored as row records and filtered to panel gene anchors.</p> <pre><code>\"wps_panel\": {\n  \"n_anchors\": 1820,\n  \"data\": [\n    {\n      \"region_id\": \"ATM_TSS\",\n      \"chrom\": \"11\",\n      \"center\": 108093559,\n      \"strand\": \"+\",\n      \"wps_nuc\": 22.1,\n      \"wps_tf\": -2.8,\n      \"prot_frac_nuc\": 0.59,\n      \"prot_frac_tf\": 0.38,\n      \"wps_nuc_z\": 0.9,\n      \"wps_tf_z\": -0.3\n    }\n  ]\n}\n</code></pre>"},{"location":"features/output/json-output/#wps-background","title":"WPS Background","text":"<p>Alu element hierarchical stacking profiles (global, family, per-chromosome groups).</p> <pre><code>\"wps_background\": {\n  \"n_elements\": 27,\n  \"data\": [\n    {\n      \"group_id\": \"Global_All\",\n      \"stacked_wps_nuc\": [0.12, 0.08, \"...\"],\n      \"stacked_wps_tf\": [-0.03, -0.01, \"...\"],\n      \"alu_count\": 142567,\n      \"mean_wps_nuc\": 0.11,\n      \"mean_wps_tf\": -0.02,\n      \"nrl_bp\": 192.4,\n      \"nrl_deviation_bp\": 2.4,\n      \"periodicity_score\": 0.78,\n      \"adjusted_score\": 0.69,\n      \"fragment_ratio\": 0.31\n    }\n  ]\n}\n</code></pre> Field Type Description <code>group_id</code> string <code>Global_All</code>, <code>Family_AluY/S/J/Other</code>, <code>Chr{N}_All</code> <code>stacked_wps_nuc</code> float[] 30-bin binned WPS nucleosomal profile <code>nrl_bp</code> float Nucleosome Repeat Length in bp (expected ~190 bp) <code>periodicity_score</code> float SNR-based quality 0\u20131 <code>adjusted_score</code> float Periodicity score penalized by NRL deviation"},{"location":"features/output/json-output/#motif","title":"Motif","text":"<p>End motif (EDM) and breakpoint motif (BPM) 4-mer frequencies, plus MDS scores for off-target and on-target.</p> <pre><code>\"motif\": {\n  \"edm\": { \"AAAA\": 0.0042, \"AAAC\": 0.0039, \"...\": \"...\" },\n  \"bpm\": { \"AAAA\": 0.0038, \"AAAC\": 0.0041, \"...\": \"...\" },\n  \"edm_1mer\": { \"A\": 0.197, \"C\": 0.345, \"G\": 0.321, \"T\": 0.138 },\n  \"mds\": 0.8234,\n  \"edm_on_target\": { \"AAAA\": 0.0051, \"...\": \"...\" },\n  \"bpm_on_target\": { \"AAAA\": 0.0043, \"...\": \"...\" },\n  \"mds_on_target\": 0.7918\n}\n</code></pre> Field Type Description <code>edm</code> dict 256 4-mer frequencies at fragment ends (off-target) <code>bpm</code> dict 256 4-mer frequencies at breakpoints (off-target) <code>edm_1mer</code> dict Single-base composition at fragment ends (A/C/G/T) <code>mds</code> float Motif Diversity Score (off-target) <code>edm_on_target</code> dict On-target EDM frequencies (panel mode only) <code>bpm_on_target</code> dict On-target BPM frequencies (panel mode only) <code>mds_on_target</code> float On-target MDS (panel mode only)"},{"location":"features/output/json-output/#ocf-orientation-aware-cfdna-fragmentation","title":"OCF (Orientation-aware cfDNA Fragmentation)","text":"<p>Open chromatin footprint scores by tissue type. Includes off-target, on-target, and positional sync profiles.</p> <pre><code>\"ocf\": {\n  \"off_target\": [ { \"tissue\": \"Liver\", \"score\": 0.42, \"n_fragments\": 12345 } ],\n  \"on_target\":  [ { \"tissue\": \"Liver\", \"score\": 0.51, \"n_fragments\": 3421 } ],\n  \"offtarget\":  [ { \"tissue\": \"Liver\", \"score\": 0.39, \"...\" } ],\n  \"sync\":           [ { \"pos\": -150, \"strand_ratio\": 0.61, \"...\" } ],\n  \"sync_offtarget\": [ { ... } ],\n  \"sync_ontarget\":  [ { ... } ]\n}\n</code></pre> Sub-key When present Description <code>off_target</code> Always Genome-wide OCF scores <code>on_target</code> Panel mode On-target capture region OCF <code>offtarget</code> Panel mode Panel-specific off-target scores <code>sync</code> Always Positional strand-specific profiles <code>sync_offtarget</code> Panel mode Sync profiles for off-target <code>sync_ontarget</code> Panel mode Sync profiles for on-target"},{"location":"features/output/json-output/#tfbs-transcription-factor-binding-site-entropy","title":"TFBS (Transcription Factor Binding Site Entropy)","text":"<p>Fragment size entropy at TFBS regions. Includes sync (per-TF \u00d7 per-size) profiles.</p> <pre><code>\"tfbs\": {\n  \"off_target\": [\n    { \"region\": \"CTCF_chr1_12345\", \"entropy\": 3.45, \"n_fragments\": 234, \"mean_size\": 167.5 }\n  ],\n  \"on_target\": [ ... ],\n  \"sync\": [ { \"tf\": \"CTCF\", \"size_bin\": 150, \"count\": 234, \"fraction\": 0.052 } ],\n  \"sync_ontarget\": [ ... ]\n}\n</code></pre>"},{"location":"features/output/json-output/#atac-chromatin-accessibility-regions","title":"ATAC (Chromatin Accessibility Regions)","text":"<p>Fragment size entropy at ATAC-seq accessible regions. Includes sync (per-tissue \u00d7 per-size) profiles.</p> <pre><code>\"atac\": {\n  \"off_target\": [\n    { \"region\": \"peak_chr1_23456\", \"entropy\": 3.21, \"n_fragments\": 189, \"mean_size\": 145.2 }\n  ],\n  \"on_target\": [ ... ],\n  \"sync\": [ { \"tissue\": \"BRCA\", \"size_bin\": 150, \"count\": 189, \"fraction\": 0.041 } ],\n  \"sync_ontarget\": [ ... ]\n}\n</code></pre>"},{"location":"features/output/json-output/#gc-factors-diagnostic","title":"GC Factors (Diagnostic)","text":"<p>GC bias correction factors used internally during processing.</p> <p>Note</p> <p>Not recommended for ML features. The GC correction is already applied to FSC/FSR/FSD. Use those corrected values instead. GC factors are useful for QC, batch effect detection, and panel development.</p> <pre><code>\"gc_factors\": {\n  \"off_target\": [\n    { \"len_bin\": 100, \"gc_pct\": 45, \"correction_factor\": 1.12 }\n  ],\n  \"on_target\": [ ... ]\n}\n</code></pre>"},{"location":"features/output/json-output/#mfsd-mutant-fragment-size-distribution","title":"mFSD (Mutant Fragment Size Distribution)","text":"<p>Per-variant fragment size distribution metrics. Only present when a MAF file is provided.</p> <pre><code>\"mfsd\": {\n  \"enabled\": true,\n  \"n_variants\": 47,\n  \"variants\": [\n    {\n      \"Chrom\": \"17\", \"Pos\": 7577548, \"Ref\": \"C\", \"Alt\": \"T\", \"VarType\": \"SNP\",\n      \"REF_Count\": 234, \"ALT_Count\": 12, \"NonREF_Count\": 8, \"N_Count\": 45, \"Total_Count\": 299,\n      \"REF_Weighted\": 221.4, \"ALT_Weighted\": 11.3, \"NonREF_Weighted\": 7.6, \"N_Weighted\": 42.8, \"VAF_GC_Corrected\": 0.048,\n      \"ALT_LLR\": 3.41, \"REF_LLR\": -3.41,\n      \"REF_MeanSize\": 168.3, \"ALT_MeanSize\": 142.7, \"NonREF_MeanSize\": 155.1, \"N_MeanSize\": 171.2,\n      \"Delta_ALT_REF\": -25.6, \"KS_ALT_REF\": 0.31, \"KS_Pval_ALT_REF\": 0.003,\n      \"Delta_ALT_NonREF\": -12.4, \"KS_ALT_NonREF\": 0.18, \"KS_Pval_ALT_NonREF\": 0.041,\n      \"Delta_REF_NonREF\": 13.2, \"KS_REF_NonREF\": 0.15, \"KS_Pval_REF_NonREF\": 0.089,\n      \"Delta_ALT_N\": -28.5, \"KS_ALT_N\": 0.34, \"KS_Pval_ALT_N\": 0.001,\n      \"Delta_REF_N\": -3.1, \"KS_REF_N\": 0.08, \"KS_Pval_REF_N\": 0.621,\n      \"Delta_NonREF_N\": -16.1, \"KS_NonREF_N\": 0.19, \"KS_Pval_NonREF_N\": 0.033,\n      \"VAF_Proxy\": 0.049, \"Error_Rate\": 0.027, \"N_Rate\": 0.150, \"Size_Ratio\": 0.848, \"Quality_Score\": 0.731,\n      \"ALT_Confidence\": \"HIGH\", \"KS_Valid\": true\n    }\n  ]\n}\n</code></pre> <p>When no MAF is provided: <code>\"mfsd\": { \"enabled\": false }</code></p> Field Group Columns Description Variant info <code>Chrom</code>, <code>Pos</code>, <code>Ref</code>, <code>Alt</code>, <code>VarType</code> Variant coordinates and type Counts <code>REF_Count</code>, <code>ALT_Count</code>, <code>NonREF_Count</code>, <code>N_Count</code>, <code>Total_Count</code> Raw fragment counts per allele class GC-Weighted <code>REF_Weighted</code>, <code>ALT_Weighted</code>, <code>NonREF_Weighted</code>, <code>N_Weighted</code>, <code>VAF_GC_Corrected</code> GC-bias corrected counts/VAF Log-Likelihood <code>ALT_LLR</code>, <code>REF_LLR</code> Log-likelihood ratios (duplex/low-N) Mean Sizes <code>REF_MeanSize</code>, <code>ALT_MeanSize</code>, <code>NonREF_MeanSize</code>, <code>N_MeanSize</code> Mean fragment size per allele class KS Tests <code>Delta_*/KS_*/KS_Pval_*</code> Kolmogorov\u2013Smirnov distance + p-value (6 pairings) Derived <code>VAF_Proxy</code>, <code>Error_Rate</code>, <code>N_Rate</code>, <code>Size_Ratio</code>, <code>Quality_Score</code> Summary biomarker values Flags <code>ALT_Confidence</code>, <code>KS_Valid</code> Quality flags"},{"location":"features/output/json-output/#region-mds-per-exongene-motif-diversity-score","title":"Region MDS (Per-Exon/Gene Motif Diversity Score)","text":"<p>Per-exon and gene-level MDS from <code>region-mds</code> command. Present when <code>--region-mds</code> is run.</p> <pre><code>\"region_mds\": {\n  \"n_exons\": 1820,\n  \"mds_exon_mean\": 0.512,\n  \"mds_exon_std\": 0.041,\n  \"exon\": [\n    {\n      \"gene\": \"ATM\",\n      \"name\": \"ATM:exon1\",\n      \"chrom\": \"11\",\n      \"start\": 108093558,\n      \"end\": 108093795,\n      \"strand\": \"+\",\n      \"n_fragments\": 234,\n      \"mds\": 0.531\n    }\n  ],\n  \"n_genes\": 146,\n  \"mds_e1_mean\": 0.504,\n  \"gene\": [\n    {\n      \"gene\": \"ATM\",\n      \"n_exons\": 23,\n      \"n_fragments\": 5210,\n      \"mds_mean\": 0.519,\n      \"mds_e1\": 0.531,\n      \"mds_std\": 0.038\n    }\n  ]\n}\n</code></pre> Field Level Description <code>exon[]</code> Exon Per-exon records from <code>{sample}.MDS.exon.tsv</code> <code>exon[].mds</code> Exon MDS for this exon/target region <code>exon[].name</code> Exon Exon identifier (<code>gene:exonN</code> for WGS, target name for panel) <code>mds_exon_mean</code> Summary Mean MDS across all exons <code>mds_exon_std</code> Summary Std dev of per-exon MDS <code>gene[]</code> Gene Per-gene records from <code>{sample}.MDS.gene.tsv</code> <code>gene[].mds_mean</code> Gene Mean MDS across all exons of this gene <code>gene[].mds_e1</code> Gene MDS of the first exon (E1) \u2014 promoter proxy <code>mds_e1_mean</code> Summary Mean E1 MDS across all genes"},{"location":"features/output/json-output/#uxm-methylation","title":"UXM (Methylation)","text":"<p>CpG methylation features. Only present when methylation BAM input is provided.</p> <pre><code>\"uxm\": {\n  \"enabled\": true,\n  \"data\": [\n    { \"region\": \"chr1:0-500000\", \"U_fraction\": 0.82, \"X_fraction\": 0.05, \"M_fraction\": 0.13 }\n  ]\n}\n</code></pre> <p>When no methylation input: <code>\"uxm\": { \"enabled\": false }</code></p>"},{"location":"features/output/json-output/#ml-integration-example","title":"ML Integration Example","text":"<pre><code>import json\nimport pandas as pd\n\nwith open(\"sample.features.json\") as f:\n    features = json.load(f)\n\n# FSC off-target (genome-wide)\ndf_fsc = pd.DataFrame(features[\"fsc\"][\"off_target\"])\n\n# WPS \u2014 reconstruct DataFrame from columnar arrays\nwps = features[\"wps\"]\ndf_wps = pd.DataFrame({\"region_id\": wps[\"regions\"], \"wps_nuc\": wps[\"wps_nuc\"], \"wps_tf\": wps[\"wps_tf\"]})\nprint(f\"WPS anchors: {len(df_wps)}\")\n\n# Region MDS \u2014 per-gene E1 MDS\ndf_mds_gene = pd.DataFrame(features[\"region_mds\"][\"gene\"])\nprint(f\"Mean E1 MDS: {features['region_mds']['mds_e1_mean']:.3f}\")\n\n# mFSD \u2014 variant-level fragment size shift\nif features.get(\"mfsd\", {}).get(\"enabled\"):\n    df_mfsd = pd.DataFrame(features[\"mfsd\"][\"variants\"])\n    print(f\"mFSD variants: {features['mfsd']['n_variants']}\")\n\n# Motif diversity\nmds_z = features[\"motif\"].get(\"mds_z\", 0)\nprint(f\"MDS: {features['motif']['mds']:.4f}\")\n</code></pre>"},{"location":"features/output/json-output/#json-generation-with-panel-mode","title":"JSON Generation with Panel Mode","text":"<p>For MSK-ACCESS panels:</p> <pre><code>krewlyzer run-all -i sample.bam -r hg19.fa -o out/ \\\n    --assay xs2 \\\n    --target-regions targets.bed \\\n    --pon-model xs2.pon.parquet \\\n    --generate-json\n</code></pre> <p>Panel mode adds these additional features to the JSON: - <code>fsc_gene</code>: 146 genes (gene-level FSC) - <code>fsc_region</code>: per-exon FSC - <code>fsc_region_e1</code>: first-exon FSC - <code>wps_panel</code>: 1,820 anchors - <code>wps_background</code>: Alu stacking profiles - <code>ocf.on_target</code>, <code>tfbs.on_target</code>, <code>atac.on_target</code>: panel-specific entropy - PON z-scores across all features</p>"},{"location":"features/output/json-output/#output-file-structure","title":"Output File Structure","text":"<p>Krewlyzer generates TSV/Parquet files alongside the optional unified JSON:</p>"},{"location":"features/output/json-output/#core-fragmentomics","title":"Core Fragmentomics","text":"<pre><code>out/\n\u251c\u2500\u2500 sample.FSD.tsv                   # Fragment size distribution (arm-level)\n\u251c\u2500\u2500 sample.FSD.ontarget.tsv          # Panel mode: on-target FSD\n\u251c\u2500\u2500 sample.FSR.tsv                   # Fragment size ratio (short/long)\n\u251c\u2500\u2500 sample.FSR.ontarget.tsv          # Panel mode: on-target FSR\n\u251c\u2500\u2500 sample.FSC.tsv                   # Fragment size coverage (bin-level)\n\u251c\u2500\u2500 sample.FSC.ontarget.tsv          # Panel mode: on-target FSC\n\u251c\u2500\u2500 sample.FSC.gene.tsv              # Gene-level FSC (with --assay)\n\u251c\u2500\u2500 sample.FSC.regions.tsv           # Exon-level FSC (aggregate_by='region')\n\u251c\u2500\u2500 sample.FSC.regions.e1only.tsv    # E1-only FSC (first exon per gene)\n\u251c\u2500\u2500 sample.fsc_counts.tsv            # Raw GC-binned fragment counts (pre-correction)\n\u2514\u2500\u2500 sample.correction_factors.tsv    # GC correction factors\n</code></pre>"},{"location":"features/output/json-output/#wps-windowed-protection-score_1","title":"WPS (Windowed Protection Score)","text":"<pre><code>out/\n\u251c\u2500\u2500 sample.WPS.parquet               # Per-region WPS profiles (foreground)\n\u251c\u2500\u2500 sample.WPS.panel.parquet         # Panel-specific anchors (with --assay)\n\u2514\u2500\u2500 sample.WPS_background.parquet    # Alu stacking profiles (background)\n</code></pre>"},{"location":"features/output/json-output/#motif-tissue-of-origin","title":"Motif &amp; Tissue-of-Origin","text":"<pre><code>out/\n\u251c\u2500\u2500 sample.EndMotif.tsv              # 4-mer end motif frequencies (off-target)\n\u251c\u2500\u2500 sample.EndMotif.ontarget.tsv     # 4-mer end motif frequencies (on-target)\n\u251c\u2500\u2500 sample.EndMotif1mer.tsv          # Single-base end compositions (A/C/G/T)\n\u251c\u2500\u2500 sample.BreakPointMotif.tsv       # 4-mer breakpoint motif frequencies\n\u251c\u2500\u2500 sample.BreakPointMotif.ontarget.tsv\n\u251c\u2500\u2500 sample.MDS.tsv                   # Motif Diversity Score (off-target)\n\u251c\u2500\u2500 sample.MDS.ontarget.tsv          # Motif Diversity Score (on-target)\n\u251c\u2500\u2500 sample.MDS.exon.tsv              # Per-exon MDS (region-mds command)\n\u251c\u2500\u2500 sample.MDS.gene.tsv              # Per-gene aggregated MDS (region-mds command)\n\u251c\u2500\u2500 sample.OCF.tsv                   # Orientation-aware fragmentation\n\u251c\u2500\u2500 sample.OCF.ontarget.tsv          # Panel mode: on-target OCF\n\u251c\u2500\u2500 sample.OCF.offtarget.tsv         # Panel mode: off-target OCF\n\u2514\u2500\u2500 sample.OCF.sync.tsv              # Positional strand-specific profiles\n</code></pre>"},{"location":"features/output/json-output/#region-entropy-tfbsatac","title":"Region Entropy (TFBS/ATAC)","text":"<pre><code>out/\n\u251c\u2500\u2500 sample.TFBS.tsv                  # TF binding site entropy (808 factors)\n\u251c\u2500\u2500 sample.TFBS.ontarget.tsv         # Panel mode: on-target TFBS\n\u251c\u2500\u2500 sample.TFBS.sync.tsv             # Per-TF \u00d7 per-size profiles\n\u251c\u2500\u2500 sample.TFBS.ontarget.sync.tsv\n\u251c\u2500\u2500 sample.ATAC.tsv                  # ATAC-seq peak entropy (23 cancer types)\n\u251c\u2500\u2500 sample.ATAC.ontarget.tsv         # Panel mode: on-target ATAC\n\u251c\u2500\u2500 sample.ATAC.sync.tsv             # Per-tissue \u00d7 per-size profiles\n\u2514\u2500\u2500 sample.ATAC.ontarget.sync.tsv\n</code></pre>"},{"location":"features/output/json-output/#variant-mfsd","title":"Variant (mFSD)","text":"<pre><code>out/\n\u251c\u2500\u2500 sample.mFSD.tsv                  # Per-variant fragment size metrics (46 columns)\n\u2514\u2500\u2500 sample.mFSD.distributions.tsv    # Per-variant size histograms (optional)\n</code></pre>"},{"location":"features/output/json-output/#methylation-uxm","title":"Methylation (UXM)","text":"<pre><code>out/\n\u2514\u2500\u2500 sample.UXM.tsv                   # CpG methylation U/X/M fractions\n</code></pre>"},{"location":"features/output/json-output/#unified-output","title":"Unified Output","text":"<pre><code>out/\n\u251c\u2500\u2500 sample.metadata.json             # Run metadata and QC metrics\n\u2514\u2500\u2500 sample.features.json             # All features (with --generate-json)\n</code></pre> <p>Note</p> <p>The <code>--generate-json</code> flag produces the unified JSON in addition to the standard TSV/Parquet outputs.</p>"},{"location":"features/output/json-output/#see-also","title":"See Also","text":"<ul> <li>Pipeline Integration - <code>run-all</code> command and <code>--generate-json</code> flag</li> <li>Input File Formats - Custom input file specifications</li> <li>Troubleshooting - Common format issues</li> </ul>"},{"location":"features/regulatory/motif/","title":"End Motif","text":""},{"location":"features/regulatory/motif/#motif-based-feature-extraction","title":"Motif-based Feature Extraction","text":"<p>Command: <code>krewlyzer motif</code></p> <p>Plain English</p> <p>Motif analysis looks at the 4-letter DNA sequences at fragment ends. Different enzymes cut DNA at different sequences\u2014tumors have more diverse cutting patterns.</p> <p>Key metric: MDS (Motif Diversity Score) - higher MDS = more abnormal cutting = potential tumor signal</p>"},{"location":"features/regulatory/motif/#purpose","title":"Purpose","text":"<p>Extracts end motif, breakpoint motif, and Motif Diversity Score (MDS) from sequencing fragments.</p>"},{"location":"features/regulatory/motif/#processing-flowchart","title":"Processing Flowchart","text":"<pre><code>flowchart LR\n    BAM[BAM File] --&gt; RUST[Rust Backend]\n    REF[Reference FASTA] --&gt; RUST\n    RUST --&gt; EM[\"EndMotif.tsv\"]\n    RUST --&gt; BM[\"BreakPointMotif.tsv\"]\n    RUST --&gt; MDS[\"MDS.tsv\"]\n\n    subgraph \"With --target-regions\"\n        RUST --&gt; EM_ON[\"EndMotif.ontarget.tsv\"]\n        RUST --&gt; BM_ON[\"BreakPointMotif.ontarget.tsv\"]\n    end\n</code></pre>  Use mouse to pan and zoom"},{"location":"features/regulatory/motif/#biological-context","title":"Biological Context","text":"<p>Motif analysis of cfDNA fragment ends reveals tissue-of-origin, nucleosome positioning, and nuclease activity. MDS quantifies motif diversity, which may be altered in cancer. See Zhou et al., 2020 for details.</p>"},{"location":"features/regulatory/motif/#usage","title":"Usage","text":"<pre><code>krewlyzer motif -i /path/to/input.bam -r /path/to/reference.fa -o /path/to/output_dir \\\n    -k 4 --threads 4\n</code></pre>"},{"location":"features/regulatory/motif/#options","title":"Options","text":"Option Short Type Default Description <code>--input</code> <code>-i</code> PATH required Input BAM file <code>--reference</code> <code>-r</code> PATH required Reference genome FASTA (indexed) <code>--output</code> <code>-o</code> PATH required Output directory <code>--genome</code> <code>-G</code> TEXT hg19 Genome build (hg19/hg38) <code>--target-regions</code> <code>-T</code> PATH Target BED (for on/off-target motifs) <code>--skip-target-regions</code> FLAG Force WGS mode (ignore bundled targets) <code>--assay</code> <code>-A</code> TEXT Assay code (xs1/xs2) for bundled assets <code>--pon-model</code> <code>-P</code> PATH PON model for MDS z-score computation <code>--pon-variant</code> TEXT all_unique PON variant: <code>all_unique</code> or <code>duplex</code> <code>--skip-pon</code> FLAG Skip PON z-score normalization <code>--kmer</code> <code>-k</code> INT 4 K-mer size for motif extraction <code>--chromosomes</code> TEXT Comma-separated chromosomes to process <code>--sample-name</code> <code>-s</code> TEXT Override sample name <code>--require-proper-pair</code> FLAG True Require proper pairs (disable for duplex) <code>--verbose</code> <code>-v</code> FLAG Enable verbose logging <code>--threads</code> <code>-t</code> INT 0 Number of threads (0=all)"},{"location":"features/regulatory/motif/#output-files","title":"Output Files","text":"File Description <code>{sample}.EndMotif.tsv</code> K-mer frequencies at fragment 5' ends <code>{sample}.BreakPointMotif.tsv</code> K-mer frequencies flanking breakpoints <code>{sample}.MDS.tsv</code> Motif Diversity Score <code>{sample}.EndMotif1mer.tsv</code> 1-mer frequencies with C-end fraction (Jagged Index)"},{"location":"features/regulatory/motif/#jagged-index-1-mer-end-motifs","title":"Jagged Index (1-mer End Motifs)","text":"<p>The Jagged Index captures the fraction of fragment ends terminating with Cytosine (C), which is elevated in tumor-derived cfDNA with \"jagged\" single-stranded overhangs.</p>"},{"location":"features/regulatory/motif/#output-endmotif1mertsv","title":"Output: EndMotif1mer.tsv","text":"<pre><code>base    count     fraction\nA       661428    0.188214\nC       1261449   0.358953    # \u2190 C-end fraction\nG       849433    0.241712\nT       741931    0.211121\n# c_fraction    0.358953\n# entropy       1.952998\n# c_bias        0.108953\n</code></pre>"},{"location":"features/regulatory/motif/#metrics","title":"Metrics","text":"Metric Formula Interpretation <code>c_fraction</code> C_count / total_count Fraction of C-ending fragments <code>entropy</code> Shannon entropy (0-2 bits) Randomness of 1-mer distribution <code>c_bias</code> c_fraction - 0.25 Deviation from expected 25%"},{"location":"features/regulatory/motif/#c-end-fraction-interpretation","title":"C-End Fraction Interpretation","text":"c_fraction c_bias Interpretation 0.25-0.30 0 to +0.05 Normal / healthy-like 0.30-0.35 +0.05 to +0.10 Mildly elevated (possible tumor) &gt;0.35 &gt;0.10 Elevated (tumor signal)"},{"location":"features/regulatory/motif/#biological-basis","title":"Biological Basis","text":"<p>cfDNA fragmentation by DNASE1L3 produces fragments with single-stranded 5' overhangs (\"jagged ends\"). Tumor-derived cfDNA shows: - ~87.8% jagged ends (vs lower in healthy) - Higher C-end fraction due to preferential C-terminal cutting</p> <p>Tip</p> <p>The C-end fraction complements MDS for detecting tumor-derived cfDNA. Use both metrics together for improved sensitivity.</p>"},{"location":"features/regulatory/motif/#formulas","title":"Formulas","text":""},{"location":"features/regulatory/motif/#motif-diversity-score-mds","title":"Motif Diversity Score (MDS)","text":"<p>MDS quantifies the randomness of 4-mer end motifs using normalized Shannon entropy:</p> \\[ \\text{MDS} = \\frac{-\\sum_{i} p_i \\times \\log_2(p_i)}{\\log_2(4^k)} \\] <p>Variables: - \\(p_i\\) = frequency of the i-th motif - \\(k\\) = k-mer length (default: 4) - Result range: \\([0, 1]\\)</p> <p>Interpretation:</p> MDS Value Meaning ~1.0 Random/diverse (healthy-like) &lt; 0.8 Stereotyped (possible tumor signal)"},{"location":"features/regulatory/motif/#pon-normalization","title":"PON Normalization","text":"<p>When <code>--pon-model</code> is provided, MDS output includes z-score normalization:</p> <pre><code>krewlyzer motif -i sample.bam -r hg19.fa -o output/ \\\n    --pon-model healthy_cohort.pon.parquet\n</code></pre>"},{"location":"features/regulatory/motif/#output-columns-with-pon","title":"Output Columns with PON","text":"Column Formula Description <code>MDS</code> Shannon entropy Raw score (0-1) <code>mds_z</code> <code>(MDS - PON_mean) / PON_std</code> Z-score vs healthy baseline"},{"location":"features/regulatory/motif/#z-score-interpretation","title":"Z-Score Interpretation","text":"mds_z Meaning -2 to +2 Within normal range &lt; -2 Abnormally low diversity (possible tumor) &gt; +2 Rare (check data quality) <p>Tip</p> <p>Lower MDS (negative z-score) indicates stereotyped cutting patterns often associated with tumor-derived cfDNA.</p>"},{"location":"features/regulatory/motif/#panel-mode-target-regions","title":"Panel Mode (--target-regions)","text":"<p>When <code>--target-regions</code> is provided, motif analysis produces separate outputs for on-target and off-target fragments:</p> <pre><code>krewlyzer motif -i sample.bam -r hg19.fa -o output/ \\\n    --target-regions MSK-ACCESS_targets.bed\n</code></pre>"},{"location":"features/regulatory/motif/#outputs-in-panel-mode","title":"Outputs in Panel Mode","text":"File Contents Use Case <code>{sample}.EndMotif.tsv</code> Off-target fragments Unbiased global motif signal <code>{sample}.EndMotif.ontarget.tsv</code> On-target fragments Local capture region analysis <code>{sample}.MDS.tsv</code> Off-target MDS Primary biomarker <p>Important</p> <p>Off-target = unbiased \u2013 preferred for fragmentomics biomarkers. On-target = capture-biased \u2013 use cautiously; reflects library prep artifacts.</p>"},{"location":"features/regulatory/motif/#why-split","title":"Why Split?","text":"<pre><code>flowchart TB\n    subgraph \"On-Target (Capture Bias)\"\n        CAP[\"Hybridization probes\"] --&gt; BIAS[\"GC &amp; motif bias\"]\n        BIAS --&gt; LOCAL[\"Local signal only\"]\n    end\n\n    subgraph \"Off-Target (Unbiased)\"\n        WGS[\"Random cfDNA\"] --&gt; PURE[\"True biological signal\"]\n        PURE --&gt; GLOBAL[\"Global fragmentomics\"]\n    end\n</code></pre>  Use mouse to pan and zoom  <p>For panel data (MSK-ACCESS), on-target fragments have capture bias from hybridization probes. Off-target reads represent unbiased cfDNA and should be used for motif biomarkers.</p>"},{"location":"features/regulatory/motif/#clinical-interpretation","title":"Clinical Interpretation","text":"Metric Healthy Cancer (ctDNA) MDS Higher (random) Lower (stereotyped) Jagged ends Lower Higher (87.8% jagged) Specific motifs Baseline Cancer-associated enriched"},{"location":"features/regulatory/motif/#biological-basis_1","title":"Biological Basis","text":"<ul> <li>cfDNA fragmentation driven by nucleases (DNASE1, DNASE1L3)</li> <li>~87.8% of cfDNA molecules have jagged (single-stranded) ends</li> <li>Tumor-derived fragments show higher jaggedness than wild-type</li> </ul>"},{"location":"features/regulatory/motif/#see-also","title":"See Also","text":"<ul> <li>Citation &amp; Scientific Background - Zhou et al. paper</li> <li>Troubleshooting - Common issues</li> </ul>"},{"location":"features/regulatory/ocf/","title":"OCF","text":""},{"location":"features/regulatory/ocf/#orientation-aware-fragmentation-ocf","title":"Orientation-aware Fragmentation (OCF)","text":"<p>Command: <code>krewlyzer ocf</code></p> <p>Plain English</p> <p>OCF detects where cfDNA fragments came from by looking at their \"orientation\" near regulatory regions. Different tissues cut DNA in different directions\u2014OCF captures this signal for tissue-of-origin detection.</p> <p>Use case: Identify liver cancer vs. colon cancer based on cfDNA fragmentation patterns.</p>"},{"location":"features/regulatory/ocf/#purpose","title":"Purpose","text":"<p>Computes orientation-aware cfDNA fragmentation (OCF) values in tissue-specific open chromatin regions. Enables tissue-of-origin analysis from cfDNA.</p>"},{"location":"features/regulatory/ocf/#processing-flowchart","title":"Processing Flowchart","text":"<pre><code>flowchart LR\n    BED[\"sample.bed.gz\"] --&gt; RUST[\"Rust Pipeline\"]\n    OCR[\"Open Chromatin Regions\"] --&gt; RUST\n    GC[\"GC Correction\"] --&gt; RUST\n\n    RUST --&gt; OCF[\"OCF.tsv\"]\n    RUST --&gt; SYNC[\"OCF.sync.tsv\"]\n\n    subgraph \"With --pon-model\"\n        OCF --&gt; PON[\"z-score normalization\"]\n    end\n\n    subgraph \"With --target-regions\"\n        RUST --&gt; OCF_ON[\"OCF.ontarget.tsv\"]\n    end\n</code></pre>  Use mouse to pan and zoom  <p>Warning</p> <p>OCF regions are only available for GRCh37/hg19. For hg38, you must provide a custom OCR file with <code>-r/--ocr-input</code>.</p>"},{"location":"features/regulatory/ocf/#pythonrust-architecture","title":"Python/Rust Architecture","text":"<pre><code>flowchart TB\n    subgraph \"Python (CLI)\"\n        CLI[\"ocf.py\"] --&gt; UP[\"unified_processor.py\"]\n        UP --&gt; ASSETS[\"AssetManager\"]\n    end\n\n    subgraph \"Rust Backend\"\n        UP --&gt; RUST[\"_core.run_unified_pipeline()\"]\n        RUST --&gt; GC[\"GC correction\"]\n        GC --&gt; OCF_CALC[\"OCF strand counting\"]\n    end\n\n    subgraph \"Python (Post-processing)\"\n        OCF_CALC --&gt; PROC[\"Output cleanup\"]\n        PROC --&gt; PON[\"PON z-scores\"]\n        PON --&gt; OUT[\"OCF.tsv\"]\n    end\n</code></pre>  Use mouse to pan and zoom"},{"location":"features/regulatory/ocf/#biological-context","title":"Biological Context","text":"<p>OCF (Sun et al., 2019) measures the phasing of upstream (U) and downstream (D) fragment ends in open chromatin regions, informing tissue-of-origin of cfDNA.</p>"},{"location":"features/regulatory/ocf/#usage","title":"Usage","text":"<pre><code># Basic usage\nkrewlyzer ocf -i sample.bed.gz -o output_dir/ --genome hg19\n\n# With PON for z-scores\nkrewlyzer ocf -i sample.bed.gz -o output/ -P tissue.pon.parquet\n\n# Panel data with on/off-target split\nkrewlyzer ocf -i sample.bed.gz -o output/ \\\n    --target-regions MSK-ACCESS_targets.bed\n</code></pre>"},{"location":"features/regulatory/ocf/#cli-options","title":"CLI Options","text":"Option Short Type Default Description <code>--input</code> <code>-i</code> PATH required Input .bed.gz file <code>--output</code> <code>-o</code> PATH required Output directory <code>--sample-name</code> <code>-s</code> TEXT Override sample name <code>--ocr-input</code> <code>-r</code> PATH Open chromatin regions file <code>--target-regions</code> <code>-T</code> PATH Target BED (for on/off-target split) <code>--skip-target-regions</code> FLAG Force WGS mode (ignore bundled targets) <code>--assay</code> <code>-A</code> TEXT Assay code (xs1/xs2) for bundled assets <code>--genome</code> <code>-G</code> TEXT hg19 Genome build (hg19/hg38) <code>--pon-model</code> <code>-P</code> PATH PON model for z-score computation <code>--pon-variant</code> TEXT all_unique PON variant: <code>all_unique</code> or <code>duplex</code> <code>--skip-pon</code> FLAG Skip PON z-score normalization <code>--gc-correct</code> FLAG True Apply GC bias correction <code>--verbose</code> <code>-v</code> FLAG Enable verbose logging <code>--threads</code> <code>-t</code> INT 0 Number of threads (0=all)"},{"location":"features/regulatory/ocf/#output-files","title":"Output Files","text":"File Description <code>{sample}.OCF.tsv</code> Summary OCF per tissue type <code>{sample}.OCF.sync.tsv</code> Detailed sync scores"},{"location":"features/regulatory/ocf/#formulas","title":"Formulas","text":""},{"location":"features/regulatory/ocf/#ocf-score-calculation","title":"OCF Score Calculation","text":"\\[ \\text{OCF} = \\sum \\left( \\text{Right}_{-60} + \\text{Left}_{+60} \\right) - \\sum \\left( \\text{Left}_{-60} + \\text{Right}_{+60} \\right) \\] <p>Where: - \\(\\text{Right}_{-60}\\) = Right fragment ends at -60bp from OCR center (phased) - \\(\\text{Left}_{+60}\\) = Left fragment ends at +60bp from OCR center (phased) - \\(\\text{Left}_{-60}\\), \\(\\text{Right}_{+60}\\) = Background (unphased)</p> <p>Calculation Details: 1. Fragments are mapped relative to the center of the Open Chromatin Region (OCR) 2. Left/Right ends counted in 10bp bins across \u00b11000bp window 3. Counts normalized by total sequencing depth</p>"},{"location":"features/regulatory/ocf/#pon-normalization","title":"PON Normalization","text":"<p>When <code>--pon-model</code> is provided, OCF output includes z-score columns:</p>"},{"location":"features/regulatory/ocf/#output-columns-with-pon","title":"Output Columns with PON","text":"Column Formula Description <code>OCF</code> Raw OCF score Phased fragment orientation <code>ocf_z</code> <code>(OCF - PON_mean) / PON_std</code> Z-score vs healthy baseline"},{"location":"features/regulatory/ocf/#z-score-interpretation","title":"Z-Score Interpretation","text":"ocf_z Meaning -2 to +2 Normal tissue contribution &gt; +2 Elevated tissue signal (possible tumor origin) &lt; -2 Decreased tissue contribution"},{"location":"features/regulatory/ocf/#panel-mode","title":"Panel Mode","text":"<p>For targeted sequencing panels (MSK-ACCESS):</p> <pre><code>krewlyzer ocf -i sample.bed.gz -o output/ \\\n    --target-regions MSK-ACCESS_targets.bed\n</code></pre>"},{"location":"features/regulatory/ocf/#how-panel-ocf-works","title":"How Panel OCF Works","text":"<p>In panel mode, OCF produces two complementary outputs using a sophisticated two-pass approach:</p> <pre><code>flowchart TB\n    subgraph \"Pass 1: Genome-Wide\"\n        OCR1[\"All 50K OCR regions\"] --&gt; RUN1[\"OCF analysis\"]\n        FRAGS1[\"All fragments\"] --&gt; RUN1\n        RUN1 --&gt; OCF[\"OCF.tsv\"]\n        RUN1 --&gt; SYNC[\"OCF.sync.tsv\"]\n    end\n\n    subgraph \"Pass 2: Panel-Focused\"\n        OCR2[\"Panel OCRs (~500)\"] --&gt; RUN2[\"OCF analysis\"]\n        TARGET[\"Target regions\"] --&gt; FILTER[\"Filter OCRs\"]\n        OCR1 --&gt; FILTER\n        FILTER --&gt; OCR2\n        FRAGS2[\"On-target frags\"] --&gt; RUN2\n        RUN2 --&gt; OCFON[\"OCF.ontarget.tsv\"]\n    end\n</code></pre>  Use mouse to pan and zoom"},{"location":"features/regulatory/ocf/#panel-ocf-regions","title":"Panel OCF Regions","text":"<p>Before the ontarget OCF run, the genome-wide OCR atlas (~50,000 regions) is filtered to keep only regions that overlap with panel targets (+2kb promoter extension). For a typical panel like MSK-ACCESS:</p> Genome-Wide Panel-Filtered OCR regions ~50,000 ~500 Noise reduction - ~99%"},{"location":"features/regulatory/ocf/#output-files_1","title":"Output Files","text":"File Fragment Source OCR Regions Use Case <code>{sample}.OCF.tsv</code> All fragments All ~50K Unbiased genome-wide tissue signal <code>{sample}.OCF.ontarget.tsv</code> On-target only Panel ~500 Panel-focused tissue signal <code>{sample}.OCF.sync.tsv</code> All fragments All ~50K Debugging/visualization <code>{sample}.OCF.ontarget.sync.tsv</code> On-target only Panel ~500 Panel OCF detail <code>{sample}.OCF.offtarget.tsv</code> Off-target only All ~50K Off-target baseline <code>{sample}.OCF.offtarget.sync.tsv</code> Off-target only All ~50K Off-target detail <p>Note</p> <p>The <code>ontarget</code> naming is consistent with other features (FSD.ontarget, FSC.ontarget). For OCF, ontarget means both on-target fragments AND panel-filtered OCR regions.</p>"},{"location":"features/regulatory/ocf/#why-both-filters","title":"Why Both Filters?","text":"<pre><code>flowchart LR\n    subgraph \"On-Target Fragments\"\n        CAP[\"Captured near panel genes\"]\n    end\n\n    subgraph \"Panel OCR Regions\"\n        POCR[\"OCRs near panel genes\"]\n    end\n\n    CAP --&gt; BOTH[\"Same genomic space\"]\n    POCR --&gt; BOTH\n    BOTH --&gt; SIGNAL[\"Maximum signal-to-noise\"]\n</code></pre>  Use mouse to pan and zoom  <p>On-target fragments and panel OCR regions both focus on the same genomic space (near panel target genes), so combining both filters maximizes the signal-to-noise ratio for tissue-of-origin detection.</p>"},{"location":"features/regulatory/ocf/#example-msk-access-panel","title":"Example: MSK-ACCESS Panel","text":"Tissue OCF.tsv (Genome-Wide) OCF.ontarget.tsv (Panel) Liver 265.3 52.8 Intestine 224.4 -20.9 Lung 173.0 -9.6 Breast 108.5 19.0 Ovary 123.1 88.9 Placenta -25.1 -51.6 T-cell 8.9 86.7 <p>Tip</p> <p>Genome-wide OCF provides the unbiased baseline for tissue-of-origin analysis. Panel OCF provides a focused view specific to your assay's target regions.</p>"},{"location":"features/regulatory/ocf/#clinical-interpretation","title":"Clinical Interpretation","text":""},{"location":"features/regulatory/ocf/#healthy-plasma-baseline","title":"Healthy Plasma Baseline","text":"Tissue OCF Value T-cells (hematopoietic) Highest Liver Second highest Other tissues Near zero"},{"location":"features/regulatory/ocf/#cancer-specific-patterns","title":"Cancer-Specific Patterns","text":"Cancer Type Expected OCF Change Hepatocellular carcinoma \u2191 Liver OCF Colorectal cancer \u2191 Intestine OCF, \u2193 T-cell OCF Lung cancer \u2191 Lung OCF, \u2193 T-cell OCF"},{"location":"features/regulatory/ocf/#interpretation-guide","title":"Interpretation Guide","text":"Pattern Interpretation \u2191 Tissue-specific OCF Tumor shedding from that tissue \u2193 T-cell OCF Dilution by tumor DNA OCF correlates with tumor fraction Higher ctDNA \u2192 stronger signal"},{"location":"features/regulatory/ocf/#see-also","title":"See Also","text":"<ul> <li>Input File Formats - Region BED format for <code>--ocr-input</code></li> <li>PON Models \u2013 Tissue baseline models</li> <li>Citation \u2013 Sun et al. paper</li> <li>Troubleshooting \u2013 hg38 issues</li> </ul>"},{"location":"features/regulatory/region-entropy/","title":"Region Entropy","text":""},{"location":"features/regulatory/region-entropy/#region-entropy-tfbsatac-size-entropy","title":"Region Entropy (TFBS/ATAC Size Entropy)","text":"<p>Command: <code>krewlyzer region-entropy</code></p> <p>Plain English</p> <p>Region Entropy calculates the diversity of fragment sizes at regulatory regions. A high entropy value indicates many different fragment sizes; low entropy indicates uniform sizes.</p> <p>Use case: Cancer detection and subtyping - tumor cfDNA shows altered nucleosome positioning at specific regulatory elements.</p> <p>Note</p> <p>This feature is based on Helzer KT, et al. (2025) \"Analysis of cfDNA fragmentomics metrics and commercial targeted sequencing panels\" published in Nature Communications.</p>"},{"location":"features/regulatory/region-entropy/#purpose","title":"Purpose","text":"<p>Calculates Shannon entropy of fragment size distributions at: - TFBS: Transcription Factor Binding Sites (808 factors from GTRD) - ATAC: Cancer-specific ATAC-seq peaks (23 cancer types from TCGA)</p> <p>These metrics enable cancer phenotyping from targeted sequencing panels without requiring whole genome sequencing.</p>"},{"location":"features/regulatory/region-entropy/#scientific-background","title":"Scientific Background","text":""},{"location":"features/regulatory/region-entropy/#from-helzer-et-al-2025","title":"From Helzer et al. 2025","text":"<p>Fragmentomics-based analysis of cell-free DNA (cfDNA) has emerged as a method to infer epigenetic and transcriptional data. While many reports analyze whole genome sequencing (WGS), targeted exon panels can be similarly employed for cancer phenotyping with minimal decrease in performance despite their smaller genomic coverage.</p> <p>The study assessed 13 fragmentomics metrics including: - Fragment length proportions (small fragments, Shannon entropy) - Normalized fragment read depth - End motif diversity score (MDS) - TFBS entropy - fragments overlapping transcription factor binding sites - ATAC entropy - fragments overlapping cancer-specific open chromatin regions</p> <p>Key findings relevant to TFBS/ATAC entropy: - Diversity metrics like Shannon entropy measure the spread of fragment sizes in a region - TFBS and ATAC entropy work well for cancer detection and subtyping - These metrics can be applied to commercial targeted sequencing panels</p>"},{"location":"features/regulatory/region-entropy/#biological-mechanism","title":"Biological Mechanism","text":"<p>Fragment size distributions at regulatory regions reflect nucleosome positioning:</p> <ul> <li>Nucleosome-bound DNA: ~147bp core + ~20bp linker = ~167bp</li> <li>Open chromatin (active TF binding): Variable sizes due to transcription factor binding</li> <li>Tumor alterations: Aberrant nucleosome positioning \u2192 altered size distributions</li> </ul> <p>Cancer cells exhibit: - Epigenetic dysregulation \u2192 Changed TFBS accessibility - Altered enhancer usage \u2192 Different ATAC peak patterns - Tissue-specific signatures \u2192 Cancer type identification</p>"},{"location":"features/regulatory/region-entropy/#processing-flowchart","title":"Processing Flowchart","text":"<pre><code>flowchart LR\n    BED[\"sample.bed.gz\"] --&gt; RUST[\"Rust Backend(par_iter)\"]\n    TFBS[\"TFBS regions\"] --&gt; RUST\n    ATAC[\"ATAC regions\"] --&gt; RUST\n\n    RUST --&gt; ENTROPY[\"Entropy Calculation\"]\n\n    subgraph \"Per Region Label (Parallel)\"\n        ENTROPY --&gt; COUNT[\"Fragment count\"]\n        ENTROPY --&gt; SIZES[\"Size distribution\"]\n        SIZES --&gt; SHANNON[\"Shannon Entropy\"]\n    end\n\n    SHANNON --&gt; TSV[\"TFBS.tsv / ATAC.tsv\"]\n    TSV --&gt; PON[\"PON Z-score\"]\n</code></pre>  Use mouse to pan and zoom  <p>Performance</p> <p>Region-level parallelization via Rayon <code>par_iter()</code> enables efficient multi-core processing of TFBS/ATAC regions.</p>"},{"location":"features/regulatory/region-entropy/#shannon-entropy-formula","title":"Shannon Entropy Formula","text":"\\[ H = -\\sum_{i} p_i \\log_2(p_i) \\] <p>Where: - \\(p_i\\) = Proportion of fragments with size \\(i\\) - High entropy = Many equally represented sizes (diverse) - Low entropy = One dominant size (uniform)</p> <p>As described in Helzer et al.: \"Shannon entropy was calculated on the frequency of the fragment lengths... This yielded a single entropy value for each [TF/cancer type] in each sample.\"</p>"},{"location":"features/regulatory/region-entropy/#usage","title":"Usage","text":"<pre><code># Basic usage (computes both TFBS and ATAC)\nkrewlyzer region-entropy -i sample.bed.gz -o output_dir/\n\n# TFBS only\nkrewlyzer region-entropy -i sample.bed.gz -o output/ --no-atac\n\n# ATAC only with PON normalization\nkrewlyzer region-entropy -i sample.bed.gz -o output/ \\\n    --no-tfbs --pon-model healthy.pon.parquet\n\n# Via run-all (automatic when assets available)\nkrewlyzer run-all -i sample.bam -r hg19.fa -o output/\n</code></pre>"},{"location":"features/regulatory/region-entropy/#cli-options","title":"CLI Options","text":"Option Short Type Default Description <code>--input</code> <code>-i</code> PATH required Input .bed.gz file (from extract) <code>--output</code> <code>-o</code> PATH required Output directory <code>--sample-name</code> <code>-s</code> TEXT Override sample name <code>--tfbs/--no-tfbs</code> FLAG <code>--tfbs</code> Enable/disable TFBS entropy <code>--atac/--no-atac</code> FLAG <code>--atac</code> Enable/disable ATAC entropy <code>--tfbs-regions</code> PATH Custom TFBS regions BED.gz <code>--atac-regions</code> PATH Custom ATAC regions BED.gz <code>--genome</code> <code>-G</code> TEXT hg19 Genome build (hg19/GRCh37/hg38/GRCh38) <code>--gc-factors</code> <code>-F</code> PATH GC correction factors TSV <code>--pon-model</code> <code>-P</code> PATH PON model for z-score normalization <code>--pon-variant</code> TEXT all_unique PON variant: <code>all_unique</code> or <code>duplex</code> <code>--skip-pon</code> FLAG Skip PON z-score normalization (for ML negatives) <code>--target-regions</code> <code>-T</code> PATH Target regions BED (panel mode: generates .ontarget.tsv) <code>--skip-target-regions</code> FLAG Force WGS mode (ignore bundled targets from --assay) <code>--threads</code> <code>-t</code> INT 0 Number of threads (0 = all cores) <code>--verbose</code> <code>-v</code> FLAG Enable verbose logging"},{"location":"features/regulatory/region-entropy/#assets","title":"Assets","text":""},{"location":"features/regulatory/region-entropy/#tfbs-regions","title":"TFBS Regions","text":"<p>Source: Gene Transcription Regulation Database (GTRD) v19.10</p> <p>As described in Helzer et al.: \"A collection of consensus Homo sapiens TFBSs was downloaded from the Gene Transcription Regulation Database (GTRD, v19.10). For each TF, the top 5000 sites with the greatest amount of experimental support were used for analysis. TFs with fewer than 5000 sites were discarded, leaving a total of 808 TFs used for the analysis.\"</p> Genome File TF Count Sites per TF GRCh37 <code>TFBS.GRCh37.bed.gz</code> 808 5,000 GRCh38 <code>TFBS.GRCh38.bed.gz</code> 808 5,000 <p>Format: </p><pre><code>chr1  10000  10500  CTCF\nchr1  15000  15200  FOXA1\n</code></pre><p></p>"},{"location":"features/regulatory/region-entropy/#atac-regions","title":"ATAC Regions","text":"<p>Source: TCGA ATAC-seq Pan-Cancer Atlas</p> <p>As described in Helzer et al.: \"Consensus genomic regions from Assay for Transposase Accessible Chromatin with sequencing (ATAC-seq) data was downloaded from The Cancer Genome Atlas (TCGA) for 23 different cancer types.\"</p> Genome File Cancer Types GRCh37 <code>ATAC.GRCh37.bed.gz</code> 23 GRCh38 <code>ATAC.GRCh38.bed.gz</code> 23 <p>Cancer Types: ACC, BLCA, BRCA, CESC, CHOL, COAD, ESCA, GBM, HNSC, KIRC, KIRP, LAML, LGG, LIHC, LUAD, LUSC, MESO, PCPG, PRAD, SKCM, STAD, TGCT, THCA, UCEC</p> <p>Format: </p><pre><code>chr1  10000  10500  BRCA\nchr1  15000  15200  LUAD\n</code></pre><p></p> <p>Data Source: Region files are from Zhao-Lab-UW-DHO/fragmentomics_metrics</p>"},{"location":"features/regulatory/region-entropy/#panel-mode-dual-output","title":"Panel Mode (Dual Output)","text":"<p>For targeted sequencing panels (like MSK-ACCESS), krewlyzer generates dual output:</p> <ol> <li>Genome-wide (<code>.tsv</code>): All fragments across all TFBS/ATAC regions \u2192 WGS-comparable baseline</li> <li>Panel-specific (<code>.ontarget.tsv</code>): Uses pre-intersected panel regions \u2192 panel-specific signal</li> </ol> <pre><code>flowchart LR\n    subgraph \"Genome-wide Output\"\n        GW_TFBS[\"All TFBS regions\"]\n        GW_ATAC[\"All ATAC regions\"]\n    end\n\n    subgraph \"Panel-specific Output\"\n        PS_TFBS[\"xs1/xs2 TFBS regions\"]\n        PS_ATAC[\"xs1/xs2 ATAC regions\"]\n    end\n\n    GW_TFBS --&gt; TSV1[\"sample.TFBS.tsv\"]\n    GW_ATAC --&gt; TSV2[\"sample.ATAC.tsv\"]\n    PS_TFBS --&gt; TSV3[\"sample.TFBS.ontarget.tsv\"]\n    PS_ATAC --&gt; TSV4[\"sample.ATAC.ontarget.tsv\"]\n</code></pre>  Use mouse to pan and zoom"},{"location":"features/regulatory/region-entropy/#usage_1","title":"Usage","text":"<pre><code># With --assay \u2192 auto-loads panel-specific region files\nkrewlyzer run-all -i sample.bam -r hg19.fa -o out/ --assay xs2\n\n# Or with target regions \u2192 enables panel mode\nkrewlyzer run-all -i sample.bam -r hg19.fa -o out/ \\\n    -T msk-access-v2.targets.bed\n</code></pre>"},{"location":"features/regulatory/region-entropy/#output-files-panel-mode","title":"Output Files (Panel Mode)","text":"File Description GC Correction <code>{sample}.TFBS.tsv</code> All 808 TFs (genome-wide) Off-target GC model <code>{sample}.TFBS.ontarget.tsv</code> TFs overlapping panel On-target GC model <code>{sample}.TFBS.sync.tsv</code> Detailed size distributions - <code>{sample}.TFBS.ontarget.sync.tsv</code> Panel size distributions - <code>{sample}.ATAC.tsv</code> All 23 cancer types Off-target GC model <code>{sample}.ATAC.ontarget.tsv</code> Cancer types in panel On-target GC model <p>Note</p> <p>On-target outputs use on-target GC correction factors when available, providing better accuracy for capture-biased data.</p>"},{"location":"features/regulatory/region-entropy/#pon-normalization","title":"PON Normalization","text":"<p>With a PON model, raw entropy is converted to Z-scores:</p> \\[ Z = \\frac{\\text{entropy} - \\mu_{\\text{PON}}}{\\sigma_{\\text{PON}}} \\]"},{"location":"features/regulatory/region-entropy/#building-pon-with-tfbsatac","title":"Building PON with TFBS/ATAC","text":"<pre><code>krewlyzer build-pon -i samples.txt -r hg19.fa -o healthy.pon.parquet\n</code></pre> <p>The PON model stores: - <code>tfbs_baseline</code>: Per-TF mean/std entropy from healthy samples - <code>atac_baseline</code>: Per-cancer-type mean/std entropy from healthy samples</p>"},{"location":"features/regulatory/region-entropy/#applying-pon","title":"Applying PON","text":"<pre><code>krewlyzer region-entropy -i sample.bed.gz -o out/ \\\n    -P healthy.pon.parquet\n</code></pre> <p>Output with PON: </p><pre><code>label   count   mean_size   entropy   z_score\nCTCF    1234    167.2       5.23      1.45\nFOXA1   892     165.8       4.98      -0.32\n</code></pre><p></p>"},{"location":"features/regulatory/region-entropy/#output-format","title":"Output Format","text":""},{"location":"features/regulatory/region-entropy/#tfbs-output-sampletfbstsv","title":"TFBS Output: <code>{sample}.TFBS.tsv</code>","text":"Column Type Description <code>label</code> TEXT Transcription factor name (e.g., CTCF, FOXA1) <code>count</code> INT Number of fragments overlapping TF regions <code>mean_size</code> FLOAT Mean fragment size at these regions <code>entropy</code> FLOAT Shannon entropy of size distribution (bits) <code>z_score</code> FLOAT PON-normalized z-score (0 if no PON)"},{"location":"features/regulatory/region-entropy/#atac-output-sampleatactsv","title":"ATAC Output: <code>{sample}.ATAC.tsv</code>","text":"Column Type Description <code>label</code> TEXT Cancer type (e.g., BRCA, LUAD, COAD) <code>count</code> INT Number of fragments overlapping cancer peaks <code>mean_size</code> FLOAT Mean fragment size at these regions <code>entropy</code> FLOAT Shannon entropy of size distribution (bits) <code>z_score</code> FLOAT PON-normalized z-score (0 if no PON)"},{"location":"features/regulatory/region-entropy/#interpretation","title":"Interpretation","text":""},{"location":"features/regulatory/region-entropy/#entropy-values","title":"Entropy Values","text":"Range Interpretation Clinical Significance 0-2 Very low entropy Single dominant fragment size 2-4 Low entropy Few distinct sizes 4-6 Moderate entropy Normal healthy range 6-8 High entropy Many distinct sizes &gt; 8 Very high entropy Possible tumor signal"},{"location":"features/regulatory/region-entropy/#z-scores","title":"Z-Scores","text":"Z-Score Interpretation -2 to +2 Within normal range +2 to +3 Elevated (possible cancer signal) &gt; +3 Significantly elevated &lt; -2 Significantly reduced"},{"location":"features/regulatory/region-entropy/#algorithm-details","title":"Algorithm Details","text":""},{"location":"features/regulatory/region-entropy/#rust-backend-region_entropyrs","title":"Rust Backend (<code>region_entropy.rs</code>)","text":"<p>Following the methodology from Helzer et al.:</p> <ol> <li>Load regions: Read BED.gz with label in 4th column</li> <li>Intersect fragments: For each region, collect fragments with minimum 1bp overlap</li> <li>Build histograms: Count fragments per size (20-500bp) per label</li> <li>Compute entropy: Shannon entropy from normalized histogram</li> <li>Output: TSV with label, count, mean_size, entropy</li> </ol>"},{"location":"features/regulatory/region-entropy/#python-processing-region_entropy_processorpy","title":"Python Processing (<code>region_entropy_processor.py</code>)","text":"<ol> <li>Load raw output: Read Rust-generated TSV</li> <li>Apply PON baseline: If model provided, compute Z-scores</li> <li>Write final output: TSV with z_score column</li> </ol>"},{"location":"features/regulatory/region-entropy/#performance","title":"Performance","text":"Dataset Regions Time Memory TFBS (808 TFs) ~4M regions ~30s ~500MB ATAC (23 types) ~700K regions ~20s ~400MB"},{"location":"features/regulatory/region-entropy/#citation","title":"Citation","text":"<p>If you use this feature, please cite:</p> <p>Reference</p> <p>Helzer KT, Sharifi MN, Sperger JM, et al. Analysis of cfDNA fragmentomics metrics and commercial targeted sequencing panels. Nat Commun 16, 9122 (2025). https://doi.org/10.1038/s41467-025-64153-z</p> <p>Data source: - GitHub: Zhao-Lab-UW-DHO/fragmentomics_metrics</p>"},{"location":"features/regulatory/region-entropy/#see-also","title":"See Also","text":"<ul> <li>Extract \u2013 Generate input .bed.gz files</li> <li>Build PON \u2013 Create PON models with TFBS/ATAC baselines</li> <li>OCF \u2013 Related open chromatin feature</li> <li>Citation \u2013 All scientific references</li> </ul>"},{"location":"features/regulatory/region-mds/","title":"Region MDS","text":""},{"location":"features/regulatory/region-mds/#region-mds-per-exon-motif-diversity-score","title":"Region MDS \u2014 Per-Exon Motif Diversity Score","text":"<p>Command: <code>krewlyzer region-mds</code></p> <p>Plain English</p> <p>Region MDS calculates motif diversity at each gene's exons individually. This reveals where aberrant fragmentation is occurring rather than just if it's happening globally.</p> <p>Key metric: E1 MDS - lower E1 MDS = aberrant fragmentation at first exon = possible cancer signal</p>"},{"location":"features/regulatory/region-mds/#purpose","title":"Purpose","text":"<p>Calculates per-region Motif Diversity Score (Shannon entropy of 4-mer end motifs) from BAM files, enabling detection of localized fragmentation patterns at individual genes.</p>"},{"location":"features/regulatory/region-mds/#processing-flowchart","title":"Processing Flowchart","text":"<pre><code>flowchart LR\n    BAM[BAM File] --&gt; RUST[Rust Backend]\n    REF[Reference FASTA] --&gt; RUST\n    BED[Gene BED] --&gt; RUST\n    RUST --&gt; EXON[\"MDS.exon.tsv\"]\n    RUST --&gt; GENE[\"MDS.gene.tsv\"]\n\n    subgraph \"Gene-Level Aggregation\"\n        EXON --&gt; AGG[Aggregate by gene]\n        AGG --&gt; GENE\n    end\n</code></pre>  Use mouse to pan and zoom"},{"location":"features/regulatory/region-mds/#biological-context","title":"Biological Context","text":"<p>Based on Helzer et al. (2025), cfDNA fragments show characteristic 4-mer end motif patterns that vary by genomic location. In cancer:</p> <ul> <li>E1 (first exon) near promoters shows most pronounced MDS changes</li> <li>Lower MDS indicates restricted motif usage (potentially tumor-derived)</li> <li>Per-gene analysis enables detection of specific aberrant loci</li> </ul> <p>See Citation &amp; Scientific Background for methodology details.</p>"},{"location":"features/regulatory/region-mds/#usage","title":"Usage","text":"<pre><code># Panel mode with bundled gene BED\nkrewlyzer region-mds sample.bam ref.fa output/ --assay xs2\n\n# WGS mode\nkrewlyzer region-mds sample.bam ref.fa output/ --assay wgs\n\n# Custom gene BED\nkrewlyzer region-mds sample.bam ref.fa output/ --gene-bed custom.bed\n</code></pre>"},{"location":"features/regulatory/region-mds/#options","title":"Options","text":"Option Short Type Default Description <code>bam_input</code> PATH required Input BAM file (indexed) <code>reference</code> PATH required Reference genome FASTA <code>output</code> PATH required Output directory <code>--sample-name</code> <code>-s</code> TEXT Override sample name (default: derived from BAM filename) <code>--gene-bed</code> <code>-g</code> PATH Custom gene/exon BED file <code>--genome</code> <code>-G</code> TEXT hg19 Genome build (hg19/hg38) <code>--assay</code> <code>-a</code> TEXT Assay code (xs1, xs2, wgs) for bundled gene BED <code>--e1-only</code> FLAG Only output E1 (first exon) results <code>--mapq</code> INT 20 Minimum mapping quality <code>--minlen</code> INT 65 Minimum fragment length <code>--maxlen</code> INT 1000 Maximum fragment length <code>--pon-model</code> <code>-P</code> PATH PON model for z-score computation <code>--pon-variant</code> TEXT all_unique PON variant: <code>all_unique</code> or <code>duplex</code> <code>--skip-pon</code> FLAG Skip PON z-score normalization <code>--threads</code> <code>-t</code> INT 0 Number of threads (0 = all cores) <code>--verbose</code> <code>-v</code> FLAG Enable verbose logging <code>--silent</code> FLAG Suppress progress bar"},{"location":"features/regulatory/region-mds/#output-files","title":"Output Files","text":"File Description <code>{sample}.MDS.exon.tsv</code> Per-exon/target MDS scores <code>{sample}.MDS.gene.tsv</code> Gene-level aggregated MDS"},{"location":"features/regulatory/region-mds/#mdsexontsv-columns","title":"MDS.exon.tsv Columns","text":"Column Description <code>gene</code> Gene symbol <code>name</code> Exon/region name <code>chrom</code> Chromosome <code>start</code> Start position <code>end</code> End position <code>strand</code> Strand (+/-) <code>n_fragments</code> Fragment count <code>mds</code> Motif Diversity Score"},{"location":"features/regulatory/region-mds/#mdsgenetsv-columns","title":"MDS.gene.tsv Columns","text":"Column Description <code>gene</code> Gene symbol <code>n_exons</code> Number of exons <code>n_fragments</code> Total fragment count <code>mds_mean</code> Mean MDS across exons <code>mds_e1</code> MDS of first exon (E1) <code>mds_std</code> Standard deviation <code>mds_z</code> Z-score vs PON (with <code>--pon-model</code>) <code>mds_e1_z</code> E1 z-score vs PON (with <code>--pon-model</code>)"},{"location":"features/regulatory/region-mds/#formulas","title":"Formulas","text":""},{"location":"features/regulatory/region-mds/#motif-diversity-score-mds","title":"Motif Diversity Score (MDS)","text":"<p>MDS quantifies the randomness of 4-mer end motifs using Shannon entropy:</p> \\[ \\text{MDS} = -\\sum_{i} p_i \\times \\log_2(p_i) \\] <p>Variables: - \\(p_i\\) = frequency of the i-th 4-mer motif (256 possible) - Result range: ~6.0 to ~8.0 (higher = more diverse)</p> <p>Interpretation:</p> MDS Value Meaning Higher (~7.5-8.0) Random/diverse motifs (healthy) Lower (~6.0-7.0) Stereotyped motifs (potentially aberrant)"},{"location":"features/regulatory/region-mds/#e1-first-exon-significance","title":"E1 (First Exon) Significance","text":"<p>The first exon of each gene is identified by genomic position and tracked separately:</p> <ol> <li>Promoter proximity: E1 is closest to the promoter region</li> <li>Transcription start: Contains or abuts the TSS</li> <li>Cancer sensitivity: Shows most pronounced MDS changes in cancer</li> </ol> <p>Tip</p> <p>Focus on <code>mds_e1</code> in the gene output for maximum sensitivity to promoter-proximal aberrations.</p>"},{"location":"features/regulatory/region-mds/#pon-z-score-normalization","title":"PON Z-Score Normalization","text":"<p>When <code>--pon-model</code> is provided, z-scores enable comparison against healthy baseline:</p> <pre><code>krewlyzer region-mds sample.bam ref.fa output/ --assay xs2 \\\n    --pon-model healthy_cohort.pon.parquet\n</code></pre>"},{"location":"features/regulatory/region-mds/#z-score-formula","title":"Z-Score Formula","text":"<pre><code>z = (observed_mds - expected_mds) / std_mds\n</code></pre>"},{"location":"features/regulatory/region-mds/#z-score-interpretation","title":"Z-Score Interpretation","text":"Z-Score Meaning -2 to +2 Within normal range &lt; -2 Abnormally low diversity (possible tumor) &gt; +2 Unusually high (check data quality)"},{"location":"features/regulatory/region-mds/#gene-bed-format","title":"Gene BED Format","text":"<p>The tool supports two formats (see Input Formats):</p>"},{"location":"features/regulatory/region-mds/#panel-format-5-columns","title":"Panel Format (5 columns)","text":"<pre><code>chr1    1000    2000    TP53    exon_01\nchr1    3000    4000    TP53    exon_02\n</code></pre>"},{"location":"features/regulatory/region-mds/#wgs-format-8-columns","title":"WGS Format (8 columns)","text":"<pre><code>chr1    1000    2000    ENSG00000141510 NM_000546   TP53    1   +\nchr1    3000    4000    ENSG00000141510 NM_000546   TP53    2   +\n</code></pre>"},{"location":"features/regulatory/region-mds/#integration-with-run-all","title":"Integration with run-all","text":"<p>Region MDS runs automatically when <code>--assay</code> is specified:</p> <pre><code>krewlyzer run-all -i sample.bam -r ref.fa -o output/ --assay xs2 --generate-json\n</code></pre>"},{"location":"features/regulatory/region-mds/#e1-only-mode","title":"E1-Only Mode","text":"<p>For promoter-focused analysis, use <code>--region-mds-e1-only</code> to process only first exons:</p> <pre><code># Standalone\nkrewlyzer region-mds sample.bam ref.fa output/ --assay xs2 --e1-only\n\n# Via run-all\nkrewlyzer run-all -i sample.bam -r ref.fa -o output/ --assay xs2 --region-mds-e1-only\n</code></pre> <p>Tip</p> <p>E1-only mode reduces processing time and output size for promoter-centric cancer detection.</p> <p>See Panel Mode for details on panel-specific processing.</p>"},{"location":"features/regulatory/region-mds/#clinical-interpretation","title":"Clinical Interpretation","text":"Metric Healthy Cancer (ctDNA) Gene MDS Mean Higher (~7.5-8.0) Lower at affected genes E1 MDS Similar to mean Decreased at oncogenes/TSGs Cross-gene std Low (consistent) Variable (heterogeneous)"},{"location":"features/regulatory/region-mds/#biological-basis","title":"Biological Basis","text":"<ul> <li>cfDNA fragmentation reflects chromatin accessibility and nuclease activity</li> <li>Promoter-proximal regions (E1) are sensitive to transcriptional state</li> <li>Cancer-associated genes show altered fragmentation near promoters</li> </ul>"},{"location":"features/regulatory/region-mds/#see-also","title":"See Also","text":"<ul> <li>Citation &amp; Scientific Background - Helzer et al. (2025)</li> <li>Motif Extraction - Global MDS analysis</li> <li>OCF - Orientation-aware fragmentation</li> <li>JSON Output - File format details</li> </ul>"},{"location":"features/variant/mfsd/","title":"mFSD","text":""},{"location":"features/variant/mfsd/#mutant-fragment-size-distribution-mfsd","title":"Mutant Fragment Size Distribution (mFSD)","text":"<p>Command: <code>krewlyzer mfsd</code></p> <p>Plain English: mFSD compares fragment sizes at known mutation sites. Fragments carrying the mutation (ALT) tend to be shorter than healthy fragments (REF).</p> <p>Use case: MRD monitoring - track tumor DNA by comparing mutant vs. wild-type fragment sizes.</p>"},{"location":"features/variant/mfsd/#purpose","title":"Purpose","text":"<p>Compares the size distribution of mutant vs. wild-type fragments at variant sites, with support for all small variant types and 4-way fragment classification.</p>"},{"location":"features/variant/mfsd/#processing-flowchart","title":"Processing Flowchart","text":"<pre><code>flowchart LR\n    BAM[\"sample.bam\"] --&gt; RUST[\"Rust Backend\"]\n    VCF[\"variants.vcf/maf\"] --&gt; RUST\n    REF[\"Reference FASTA\"] --&gt; RUST\n\n    RUST --&gt; MFSD[\"mFSD.tsv\"]\n\n    subgraph \"Per Variant\"\n        RUST --&gt; CLASS{\"Classify Reads\"}\n        CLASS --&gt; REF_F[\"REF fragments\"]\n        CLASS --&gt; ALT_F[\"ALT fragments\"]\n        CLASS --&gt; NONREF[\"NonREF\"]\n        CLASS --&gt; N_F[\"N fragments\"]\n    end\n\n    subgraph \"Statistics\"\n        REF_F --&gt; KS[\"KS Test\"]\n        ALT_F --&gt; KS\n        KS --&gt; PVAL[\"p-value, Delta\"]\n    end\n</code></pre>  Use mouse to pan and zoom"},{"location":"features/variant/mfsd/#biological-context","title":"Biological Context","text":"<p>Mutant ctDNA fragments are typically shorter (~145bp) than wild-type cfDNA (~166bp) due to: - Altered nucleosome positioning in tumor cells - Different chromatin accessibility - Enhanced apoptosis patterns</p> <p>This module quantifies this difference using high-depth targeted sequencing data.</p>"},{"location":"features/variant/mfsd/#variant-types-supported","title":"Variant Types Supported","text":"Type Example Description SNV A&gt;T Single nucleotide variant MNV AT&gt;GC Multi-nucleotide variant Insertion A&gt;ATG Pure insertion Deletion ATG&gt;A Pure deletion Complex ATG&gt;CT Mixed substitution + indel"},{"location":"features/variant/mfsd/#usage","title":"Usage","text":"<pre><code># Basic usage with VCF\nkrewlyzer mfsd -i sample.bam -V variants.vcf -o output_dir/\n\n# With MAF file and GC correction\nkrewlyzer mfsd -i sample.bam -V variants.maf -o output/ \\\n    -r hg19.fa --correction-factors factors.tsv\n\n# With per-variant distributions\nkrewlyzer mfsd -i sample.bam -V variants.vcf -o output/ \\\n    --output-distributions\n</code></pre>"},{"location":"features/variant/mfsd/#dual-bam-support","title":"Dual BAM Support","text":"<p>For optimal results with duplex sequencing panels (e.g., MSK-ACCESS), use separate BAMs:</p> BAM Type Use Case Why <code>all_unique</code> FSC, FSD, WPS, OCF Maximum coverage for background features <code>duplex</code> mFSD Highest accuracy for variant detection"},{"location":"features/variant/mfsd/#via-run-all-cli","title":"Via run-all CLI","text":"<pre><code># Provide dedicated duplex BAM for mFSD\nkrewlyzer run-all -i sample.all_unique.bam --mfsd-bam sample.duplex.bam \\\n    -r hg19.fa -o out/ --assay xs2 --variants sample.maf\n</code></pre> <p>Note</p> <p>When <code>--mfsd-bam</code> is provided, duplex weighting is auto-enabled. If no duplex tags (cD/Marianas) are found, a warning is logged but processing continues with weight=1.0.</p>"},{"location":"features/variant/mfsd/#via-nextflow-samplesheet","title":"Via Nextflow Samplesheet","text":"<pre><code>sample,bam,mfsd_bam,meth_bam,vcf,bed,maf,single_sample_maf,assay,pon,targets\nACCESS_001,/path/to/sample.all_unique.bam,/path/to/sample.duplex.bam,,,/path/to/variants.maf,true,XS2,,\n</code></pre>"},{"location":"features/variant/mfsd/#cli-options","title":"CLI Options","text":"Option Short Type Default Description <code>--input</code> <code>-i</code> PATH required Input BAM file <code>--variants</code> <code>-V</code> PATH required VCF or MAF file with variants <code>--output</code> <code>-o</code> PATH required Output directory <code>--sample-name</code> <code>-s</code> TEXT Override sample name <code>--reference</code> <code>-r</code> PATH Reference FASTA for GC correction <code>--correction-factors</code> <code>-F</code> PATH Pre-computed correction factors CSV <code>--duplex</code> <code>-D</code> FLAG Enable duplex consensus weighting (fgbio/Marianas) <code>--mapq</code> <code>-q</code> INT 20 Minimum mapping quality <code>--minlen</code> INT 65 Minimum fragment length <code>--maxlen</code> INT 1000 Maximum fragment length <code>--skip-duplicates</code> FLAG True Skip duplicate reads (always enabled in backend) <code>--require-proper-pair</code> FLAG False Require proper pairs (disable for duplex BAMs) <code>--output-distributions</code> <code>-d</code> FLAG Output per-variant size distributions <code>--verbose</code> <code>-v</code> FLAG Enable verbose logging <code>--threads</code> <code>-t</code> INT 0 Number of threads (0=all) <p>Base Quality Filtering</p> <p>Base quality filtering (<code>--min-baseq</code>) is available when mFSD is invoked via <code>krewlyzer run-all --min-baseq &lt;N&gt;</code>. The standalone <code>krewlyzer mfsd</code> command does not expose this flag directly.</p>"},{"location":"features/variant/mfsd/#duplex-sequencing-support","title":"Duplex Sequencing Support","text":"<p>mFSD supports duplex consensus sequencing for ultra-sensitive variant detection. When <code>--duplex</code> is enabled, fragments from high-confidence duplex families receive higher weight in statistical calculations.</p>"},{"location":"features/variant/mfsd/#supported-duplex-formats","title":"Supported Duplex Formats","text":""},{"location":"features/variant/mfsd/#xs2-fgbiopicard","title":"XS2: fgbio/Picard","text":"<p>Uses SAM auxiliary tags set by fgbio CallDuplexConsensusReads:</p> Tag Meaning Use in mFSD <code>aD</code> Max depth of strand A single-strand consensus SS-A depth <code>bD</code> Max depth of strand B single-strand consensus SS-B depth <code>cD</code> Max depth of duplex consensus Primary weight source <code>aM/bM/cM</code> Min depth at any point Quality check <code>aE/bE/cE</code> Error rate Quality filter <p>Example SAM record: </p><pre><code>read1   0   chr1   1000   60   100M   *   0   150   ACGT...   IIII...   cD:i:5   aD:i:8   bD:i:7\n</code></pre><p></p>"},{"location":"features/variant/mfsd/#xs1-marianas","title":"XS1: Marianas","text":"<p>Encodes family size in the read name per Marianas documentation:</p> <pre><code>Marianas:UMI1+UMI2:contig:start:posCount:negCount:contig2:start2:pos2:neg2\n</code></pre> Position Field Example 0 <code>Marianas</code> Marianas 1 UMI ACT+TTA 2 Read1 contig 2 3 Read1 start 48033828 4 Read1 (+) count 4 5 Read1 (-) count 3 <p>Family size = posCount + negCount (e.g., 4 + 3 = 7)</p>"},{"location":"features/variant/mfsd/#duplex-weighting-formula","title":"Duplex Weighting Formula","text":"<p>When <code>--duplex</code> is enabled, each fragment receives a weight based on its duplex family size:</p> \\[ \\text{weight} = \\max(\\ln(\\text{family_size}), 1.0) \\] Family Size Weight Interpretation 1 1.0 Single read (no UMI collapse) 2 1.0 Minimum duplex (capped) 3 1.1 Low-confidence duplex 5 1.6 Moderate confidence 10 2.3 High confidence 50 3.9 Very high confidence"},{"location":"features/variant/mfsd/#interpretation-in-duplex-mode","title":"Interpretation in Duplex Mode","text":"<p>Important</p> <p>When <code>--duplex</code> is enabled, <code>ALT_Weighted</code> and <code>REF_Weighted</code> will exceed raw counts. A ratio of ~1.6x indicates typical duplex family sizes of 3-5.</p> Column Without Duplex With Duplex <code>ALT_Count</code> Raw fragment count Raw fragment count <code>ALT_Weighted</code> = ALT_Count = \u03a3(weight \u00d7 fragment) <code>VAF_GC_Corrected</code> Based on raw Based on weighted counts <p>Example: </p><pre><code>Variant at chr1:156845927\n  ALT_Count    = 393\n  ALT_Weighted = 691  (ratio = 1.76)\n  \u2192 Indicates high-confidence duplex families\n</code></pre><p></p>"},{"location":"features/variant/mfsd/#log-likelihood-ratio-llr-scoring","title":"Log-Likelihood Ratio (LLR) Scoring","text":"<p>For low fragment count scenarios (common in duplex/panel sequencing), traditional KS tests are unreliable. mFSD provides LLR scoring as a probabilistic alternative.</p>"},{"location":"features/variant/mfsd/#llr-formula","title":"LLR Formula","text":"\\[ \\text{LLR} = \\sum_{i=1}^{n} \\left[ \\log P(\\text{size}_i | \\text{Tumor}) - \\log P(\\text{size}_i | \\text{Healthy}) \\right] \\] <p>Using Gaussian models: - Healthy: \u03bc = 167bp, \u03c3 = 35bp (nucleosomal periodicity) - Tumor: \u03bc = 145bp, \u03c3 = 25bp (sub-nucleosomal fragments)</p>"},{"location":"features/variant/mfsd/#llr-output-columns","title":"LLR Output Columns","text":"Column Range Interpretation <code>ALT_LLR</code> any Log-likelihood ratio for ALT fragments <code>REF_LLR</code> any Log-likelihood ratio for REF fragments"},{"location":"features/variant/mfsd/#llr-interpretation-guide","title":"LLR Interpretation Guide","text":"LLR Value Interpretation Action &gt; 5 Strong tumor signal High confidence in tumor-derived fragments 0 to 5 Weak tumor signal Possible tumor, verify with other evidence -5 to 0 Weak healthy signal Likely healthy, low tumor content &lt; -5 Strong healthy signal Consistent with healthy cfDNA <p>Tip</p> <p>For low-N variants (ALT_Count &lt; 5), use <code>ALT_LLR</code> instead of <code>KS_Pval_ALT_REF</code>. The LLR is robust with even 1-2 fragments, while KS tests require \u22655.</p>"},{"location":"features/variant/mfsd/#clinical-example-mrd-detection","title":"Clinical Example: MRD Detection","text":"<pre><code>Variant at TP53:chr17:7577539\n  ALT_Count = 3           # Too few for KS test\n  KS_Valid  = FALSE       # KS test unreliable\n  ALT_LLR   = 4.2         # Positive = tumor-like fragments\n  REF_LLR   = -89.5       # Negative = healthy-like REF population\n\n  \u2192 Interpretation: ALT fragments show tumor signature despite low count\n</code></pre>"},{"location":"features/variant/mfsd/#cross-species-and-assay-support","title":"Cross-Species and Assay Support","text":"<p>The LLR model uses Gaussian distributions for healthy and tumor fragment length peaks. These parameters can be customized for different species or library preparations.</p>"},{"location":"features/variant/mfsd/#built-in-presets","title":"Built-in Presets","text":"Preset Healthy \u03bc Healthy \u03c3 Tumor \u03bc Tumor \u03c3 Use Case human (default) 167bp 35bp 145bp 25bp Human cfDNA canine 153bp 30bp 135bp 22bp Canine cfDNA ssdna 160bp 40bp 140bp 30bp Single-stranded library prep"},{"location":"features/variant/mfsd/#biological-rationale","title":"Biological Rationale","text":"<p>Fragment length peaks vary across species due to: - Nucleosome spacing differences - Canine nucleosomes are more tightly packed - Chromatin structure - Different histone modifications - Library preparation - ssDNA preps capture shorter fragments</p> <pre><code>flowchart LR\n    subgraph \"Human cfDNA\"\n        H_HEALTHY[\"Healthy: ~167bp\"] \n        H_TUMOR[\"Tumor: ~145bp\"]\n    end\n\n    subgraph \"Canine cfDNA\"\n        C_HEALTHY[\"Healthy: ~153bp\"]\n        C_TUMOR[\"Tumor: ~135bp\"]\n    end\n\n    H_HEALTHY --&gt; DELTA1[\"\u0394 = -22bp\"]\n    H_TUMOR --&gt; DELTA1\n    C_HEALTHY --&gt; DELTA2[\"\u0394 = -18bp\"]\n    C_TUMOR --&gt; DELTA2\n</code></pre>  Use mouse to pan and zoom"},{"location":"features/variant/mfsd/#python-api-access","title":"Python API Access","text":"<pre><code>from krewlyzer._core import LLRModelParams\n\n# Use built-in presets\nhuman_params = LLRModelParams.human()\ncanine_params = LLRModelParams.canine()\nssdna_params = LLRModelParams.ssdna()\n\n# Custom parameters\ncustom = LLRModelParams(\n    healthy_mu=160.0,\n    healthy_sigma=32.0,\n    tumor_mu=140.0,\n    tumor_sigma=20.0\n)\n</code></pre> <p>Note</p> <p>CLI support for preset selection is planned for a future release. Currently, the Rust backend defaults to human parameters.</p>"},{"location":"features/variant/mfsd/#fragment-classification","title":"Fragment Classification","text":"<p>Fragments are classified into 4 categories:</p> <pre><code>flowchart TB\n    READ[\"Fragment at variant site\"] --&gt; CHECK{\"Base at variant?\"}\n    CHECK --&gt;|\"Matches REF\"| REF[\"REF category\"]\n    CHECK --&gt;|\"Matches ALT\"| ALT[\"ALT category\"]\n    CHECK --&gt;|\"Other base\"| NONREF[\"NonREF category\"]\n    CHECK --&gt;|\"N base\"| N[\"N category\"]\n</code></pre>  Use mouse to pan and zoom  Category Description Interpretation REF Supports reference allele Healthy cfDNA ALT Supports alternate allele Tumor signal NonREF Other base (not REF/ALT/N) Sequencing errors N Contains N at variant Low quality"},{"location":"features/variant/mfsd/#formulas","title":"Formulas","text":""},{"location":"features/variant/mfsd/#ks-test-kolmogorov-smirnov","title":"KS Test (Kolmogorov-Smirnov)","text":"\\[ \\text{KS statistic} = \\max |F_1(x) - F_2(x)| \\] <p>Where: - \\(F_1(x)\\) = CDF of ALT fragment sizes - \\(F_2(x)\\) = CDF of REF fragment sizes</p>"},{"location":"features/variant/mfsd/#size-delta","title":"Size Delta","text":"\\[ \\Delta_{\\text{ALT-REF}} = \\text{ALT_MeanSize} - \\text{REF_MeanSize} \\] <p>Expected: - Healthy: \\(\\approx 0\\) - Cancer: \\(&lt; 0\\) (ALT shorter)</p>"},{"location":"features/variant/mfsd/#vaf-proxy","title":"VAF Proxy","text":"\\[ \\text{VAF_Proxy} = \\frac{\\text{ALT_Count}}{\\text{REF_Count} + \\text{ALT_Count}} \\]"},{"location":"features/variant/mfsd/#output-format","title":"Output Format","text":""},{"location":"features/variant/mfsd/#main-output-samplemfsdtsv","title":"Main Output: <code>{sample}.mFSD.tsv</code>","text":"Column Group Columns Description Variant Info (5) <code>Chrom</code>, <code>Pos</code>, <code>Ref</code>, <code>Alt</code>, <code>VarType</code> Variant coordinates and type Raw Counts (5) <code>REF_Count</code>, <code>ALT_Count</code>, <code>NonREF_Count</code>, <code>N_Count</code>, <code>Total_Count</code> Fragment counts per allele class GC-Weighted Counts (5) <code>REF_Weighted</code>, <code>ALT_Weighted</code>, <code>NonREF_Weighted</code>, <code>N_Weighted</code>, <code>VAF_GC_Corrected</code> GC-bias corrected counts and VAF Log-Likelihood Ratio (2) <code>ALT_LLR</code>, <code>REF_LLR</code> Log-likelihood ratios (useful for low-N duplex variants where KS unreliable) Mean Sizes (4) <code>REF_MeanSize</code>, <code>ALT_MeanSize</code>, <code>NonREF_MeanSize</code>, <code>N_MeanSize</code> Mean fragment size per allele class KS Tests (18) <code>Delta_*/KS_*/KS_Pval_*</code> \u00d7 6 allele pairings Kolmogorov\u2013Smirnov distance + p-value for: ALT-REF, ALT-NonREF, REF-NonREF, ALT-N, REF-N, NonREF-N Derived (5) <code>VAF_Proxy</code>, <code>Error_Rate</code>, <code>N_Rate</code>, <code>Size_Ratio</code>, <code>Quality_Score</code> Computed summary biomarkers Flags (2) <code>ALT_Confidence</code>, <code>KS_Valid</code> Quality indicators (<code>HIGH</code>/<code>LOW</code>/<code>NONE</code>; TRUE/FALSE)"},{"location":"features/variant/mfsd/#optional-samplemfsddistributionstsv","title":"Optional: <code>{sample}.mFSD.distributions.tsv</code>","text":"<p>With <code>--output-distributions</code>: </p><pre><code>Chrom  Pos    Ref  Alt  Category  Size  Count\nchr1   12345  A    T    REF       145   3\nchr1   12345  A    T    REF       166   12\nchr1   12345  A    T    ALT       142   2\n</code></pre><p></p>"},{"location":"features/variant/mfsd/#clinical-interpretation","title":"Clinical Interpretation","text":"Metric Healthy Cancer (ctDNA) <code>Delta_ALT_REF</code> ~0 Negative (ALT shorter) <code>Size_Ratio</code> ~1.0 &lt; 1.0 <code>VAF_Proxy</code> 0 &gt; 0 (correlates with TF)"},{"location":"features/variant/mfsd/#mrd-settings","title":"MRD Settings","text":"<ul> <li>Low fragment counts (1-2) produce <code>NA</code></li> <li><code>ALT_Confidence</code>: HIGH (\u22655), LOW (1-4), NONE (0)</li> <li><code>KS_Valid</code>: TRUE if REF and ALT \u22652 fragments each</li> </ul>"},{"location":"features/variant/mfsd/#see-also","title":"See Also","text":"<ul> <li>PON Models \u2013 GC correction factors</li> <li>Citation \u2013 Scientific references</li> </ul>"},{"location":"getting-started/","title":"Overview","text":""},{"location":"getting-started/#getting-started","title":"Getting Started","text":"<p>Welcome to Krewlyzer! This section will help you get up and running quickly.</p>"},{"location":"getting-started/#quick-links","title":"Quick Links","text":"Page Description Installation Install via pip, Docker, or from source Quickstart 5-minute tutorial Concepts Fragmentomics background and key concepts"},{"location":"getting-started/#recommended-path","title":"Recommended Path","text":"<ol> <li>Install Krewlyzer via your preferred method</li> <li>Run the quickstart to process your first sample</li> <li>Learn the concepts to understand what the outputs mean</li> <li>Explore features to customize your analysis</li> </ol>"},{"location":"getting-started/concepts/","title":"Concepts","text":""},{"location":"getting-started/concepts/#what-is-cell-free-dna","title":"What is Cell-Free DNA?","text":"<p>New to liquid biopsy? This page explains the biological foundation of cfDNA analysis. Already familiar? Skip to Getting Started.</p>"},{"location":"getting-started/concepts/#the-liquid-biopsy-revolution","title":"The Liquid Biopsy Revolution","text":"<p>When cells in your body die\u2014whether from normal turnover, injury, or disease\u2014they release tiny pieces of their DNA into the bloodstream. These fragments, called cell-free DNA (cfDNA), circulate briefly before being cleared by the liver and kidneys.</p> <p>Here's the breakthrough: cfDNA carries information about its source tissue.</p> <p>For cancer patients, this means tumor DNA fragments (called ctDNA - circulating tumor DNA) mix with healthy cfDNA in the blood. By analyzing a simple blood draw, we can:</p> <ul> <li>Detect cancer without a tissue biopsy</li> <li>Monitor treatment response in real-time</li> <li>Catch cancer recurrence earlier than imaging</li> <li>Identify the tissue of origin for cancers of unknown primary</li> </ul> <pre><code>     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n     \u2502                    Blood Sample                     \u2502\n     \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n     \u2502  \u2502  cfDNA Pool                                   \u2502  \u2502\n     \u2502  \u2502                                               \u2502  \u2502\n     \u2502  \u2502  ~~~~  Normal cell DNA (~95-99%)             \u2502  \u2502\n     \u2502  \u2502  \u2593\u2593\u2593\u2593  Tumor DNA (ctDNA, ~1-5%)              \u2502  \u2502\n     \u2502  \u2502                                               \u2502  \u2502\n     \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"getting-started/concepts/#why-fragment-sizes-matter","title":"Why Fragment Sizes Matter","text":"<p>This is where it gets interesting. Cancer cells don't just release different DNA sequences\u2014they release differently-sized fragments.</p>"},{"location":"getting-started/concepts/#the-nucleosome-connection","title":"The Nucleosome Connection","text":"<p>DNA in your cells isn't floating freely\u2014it's wrapped around protein spools called nucleosomes. Each nucleosome protects about 147 base pairs (bp) of DNA. When cells die, enzymes cut the DNA between nucleosomes, creating fragments.</p> <pre><code>                          Nucleosome (~147bp protected)\n                          \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n     \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n                 \u25b2                            \u25b2\n                 \u2502                            \u2502\n              Cut here                     Cut here\n              (linker DNA)                (linker DNA)\n</code></pre> <p>The result: Most cfDNA fragments are ~166bp long (147bp nucleosome + ~20bp linker DNA).</p>"},{"location":"getting-started/concepts/#cancer-changes-the-pattern","title":"Cancer Changes the Pattern","text":"<p>Tumor cells have abnormal chromatin (DNA packaging). This leads to:</p> Characteristic Healthy cfDNA Tumor cfDNA (ctDNA) Dominant size ~166bp ~145bp (shorter!) Size distribution Sharp peak Broader, left-shifted 10bp periodicity Strong (DNA helix twist) Often disrupted Nucleosome pattern Regular spacing Irregular <p>Key insight: By measuring the ratio of short fragments (tumor-enriched) to long fragments (healthy-enriched), we can estimate tumor burden.</p>"},{"location":"getting-started/concepts/#what-krewlyzer-extracts","title":"What Krewlyzer Extracts","text":"<p>Krewlyzer analyzes cfDNA sequencing data to extract fragmentomics features\u2014numerical signatures that capture these biological patterns.</p>"},{"location":"getting-started/concepts/#the-feature-categories","title":"The Feature Categories","text":"<pre><code>flowchart TB\n    BAM[Blood Sample BAM] --&gt; KREW[Krewlyzer]\n\n    KREW --&gt; SIZE[Fragment Size Features]\n    KREW --&gt; MOTIF[Cutting Pattern Features]\n    KREW --&gt; NUC[Nucleosome Features]\n    KREW --&gt; MUT[Mutation Features]\n\n    SIZE --&gt; FSC[FSC: Coverage by size]\n    SIZE --&gt; FSR[FSR: Short/Long ratio]\n    SIZE --&gt; FSD[FSD: Distribution per arm]\n\n    MOTIF --&gt; EDM[End Motifs: 4-mer frequencies]\n    MOTIF --&gt; MDS[MDS: Diversity score]\n\n    NUC --&gt; WPS[WPS: Protection scores]\n    NUC --&gt; OCF[OCF: Orientation patterns]\n\n    MUT --&gt; MFSD[mFSD: Mutant vs wild-type]\n</code></pre>  Use mouse to pan and zoom"},{"location":"getting-started/concepts/#what-each-feature-tells-you","title":"What Each Feature Tells You","text":"Feature What It Measures Clinical Application FSR Short vs long fragment ratio Tumor burden estimation FSD Size distribution per chromosome arm Copy number changes, aneuploidy WPS Nucleosome protection patterns Tissue of origin, gene regulation OCF Fragment orientation at open chromatin Tissue-specific cfDNA detection MDS Diversity of fragment end sequences Chromatin accessibility changes mFSD Fragment sizes at known mutations MRD monitoring, variant tracking"},{"location":"getting-started/concepts/#a-real-world-example","title":"A Real-World Example","text":"<p>Let's walk through what happens when you analyze a cancer patient's blood:</p>"},{"location":"getting-started/concepts/#1-input-sequenced-blood-sample","title":"1. Input: Sequenced Blood Sample","text":"<p>You have a BAM file from sequencing cfDNA extracted from a blood draw.</p>"},{"location":"getting-started/concepts/#2-run-krewlyzer","title":"2. Run Krewlyzer","text":"<pre><code>krewlyzer run-all -i patient_blood.bam -r hg19.fa -o results/\n</code></pre>"},{"location":"getting-started/concepts/#3-examine-key-outputs","title":"3. Examine Key Outputs","text":"<p>FSR (Fragment Size Ratio): </p><pre><code>region              core_short_count  long_count  core_short_long_ratio\nchr1:0-5000000      12,450           8,200       1.52\nchr1:5000000-10M    11,890           7,950       1.50\n...\n</code></pre><p></p> <p>A <code>core_short_long_ratio</code> of 1.5 (vs. ~0.9 in healthy samples) suggests elevated tumor burden.</p> <p>FSD (Fragment Size Distribution): The size histogram shows a left-shifted peak at ~148bp instead of the healthy ~166bp.</p> <p>WPS (Windowed Protection Score): Disrupted periodicity at ~190bp suggests abnormal nucleosome spacing\u2014a hallmark of cancer.</p>"},{"location":"getting-started/concepts/#who-uses-krewlyzer","title":"Who Uses Krewlyzer?","text":"User Type Use Case Cancer researchers Studying tumor evolution, treatment resistance Clinical lab developers Building liquid biopsy diagnostic assays Bioinformaticians Creating ML models for early cancer detection Pharmaceutical teams Monitoring drug response in clinical trials Translational scientists Connecting fragmentomics to biology"},{"location":"getting-started/concepts/#next-steps","title":"Next Steps","text":"<p>Ready to start analyzing your data?</p> <ol> <li>Installation - Get Krewlyzer running</li> <li>Getting Started - Your first analysis in 5 minutes</li> <li>Glossary - Terminology reference</li> <li>Features Overview - Detailed feature documentation</li> </ol>"},{"location":"getting-started/concepts/#further-reading","title":"Further Reading","text":""},{"location":"getting-started/concepts/#key-papers","title":"Key Papers","text":"<ul> <li>DELFI (2019): Cristiano et al., Nature - Genome-wide fragment analysis for cancer detection</li> <li>Nucleosome Footprinting (2016): Snyder et al., Cell - WPS and tissue-of-origin</li> <li>OCF (2019): Sun et al., Genome Research - Orientation-aware fragmentation</li> </ul> <p>See Citation &amp; Scientific Background for complete references.</p>"},{"location":"getting-started/installation/","title":"Installation","text":""},{"location":"getting-started/installation/#installation","title":"Installation","text":""},{"location":"getting-started/installation/#quick-reference","title":"Quick Reference","text":"Method Best For Includes Data Docker/Singularity Production &amp; HPC \u2705 All bundled Clone + Install Development \u2705 Via Git LFS pip + Data Clone Custom environments \u26a0\ufe0f Requires env var"},{"location":"getting-started/installation/#option-1-docker-recommended","title":"Option 1: Docker (Recommended)","text":"<p>The easiest way to run Krewlyzer with all dependencies and data:</p> <pre><code># Use a specific release tag (no :latest tag is published)\ndocker pull ghcr.io/msk-access/krewlyzer:X.Y.Z\n</code></pre> <p>Versioned Tags Only</p> <p>We publish versioned tags only (e.g., <code>:0.5.3</code>). There is no <code>:latest</code> tag. Replace <code>X.Y.Z</code> with the version from releases.</p>"},{"location":"getting-started/installation/#running-with-docker","title":"Running with Docker","text":"<pre><code>docker run --rm -v $PWD:/data ghcr.io/msk-access/krewlyzer:X.Y.Z \\\n    run-all -i /data/sample.bam \\\n    --reference /data/hg19.fa \\\n    --output /data/results/ \\\n    --assay xs2\n</code></pre> <p>Volume Mounting</p> <p>Use <code>-v $PWD:/data</code> to mount your current directory. All paths use the <code>/data/</code> prefix. For Nextflow pipelines, volume mounting is automatic.</p>"},{"location":"getting-started/installation/#option-2-singularityapptainer-hpc","title":"Option 2: Singularity/Apptainer (HPC)","text":"<p>For HPC clusters where Docker isn't available:</p> <pre><code># Pull and convert to Singularity Image Format (SIF)\nsingularity pull krewlyzer.sif docker://ghcr.io/msk-access/krewlyzer:X.Y.Z\n\n# Or using Apptainer (newer name for Singularity)\napptainer pull krewlyzer.sif docker://ghcr.io/msk-access/krewlyzer:X.Y.Z\n</code></pre>"},{"location":"getting-started/installation/#running-with-singularity","title":"Running with Singularity","text":"<pre><code>singularity exec krewlyzer.sif krewlyzer run-all \\\n    -i /path/to/sample.bam \\\n    --reference /path/to/hg19.fa \\\n    --output /path/to/results/ \\\n    --assay xs2\n</code></pre> <p>HPC Bind Paths</p> <p>Singularity auto-binds <code>$HOME</code>, <code>/tmp</code>, and <code>$PWD</code>. For other paths, use <code>-B /scratch:/scratch</code>.</p>"},{"location":"getting-started/installation/#option-3-clone-repository","title":"Option 3: Clone Repository","text":"<p>Full installation with bundled data (for development or when Docker isn't available):</p> <pre><code># Clone repository with LFS data\ngit clone https://github.com/msk-access/krewlyzer.git\ncd krewlyzer\ngit lfs pull\n\n# Install in development mode\npip install -e .\n\n# Verify\nkrewlyzer --version\n</code></pre> <p>Why This Works Without Configuration</p> <p>With <code>pip install -e .</code> (editable mode), Python runs code directly from the source directory. Asset paths resolve to <code>src/krewlyzer/data/</code> where all LFS files exist.</p>"},{"location":"getting-started/installation/#option-4-pip-install-data-clone","title":"Option 4: pip Install + Data Clone","text":"<p>For environments where you want PyPI code with external data:</p>"},{"location":"getting-started/installation/#step-1-install-package","title":"Step 1: Install Package","text":"<pre><code>pip install krewlyzer\n</code></pre>"},{"location":"getting-started/installation/#step-2-clone-data-repository","title":"Step 2: Clone Data Repository","text":"<pre><code># Shallow clone (faster, code not needed)\ngit clone --depth 1 https://github.com/msk-access/krewlyzer.git ~/.krewlyzer-data\ncd ~/.krewlyzer-data &amp;&amp; git lfs pull\n</code></pre>"},{"location":"getting-started/installation/#step-3-configure-environment-variable","title":"Step 3: Configure Environment Variable","text":"<pre><code># Set for current session\nexport KREWLYZER_DATA_DIR=~/.krewlyzer-data/src/krewlyzer/data\n\n# Add to shell profile for persistence\necho 'export KREWLYZER_DATA_DIR=~/.krewlyzer-data/src/krewlyzer/data' &gt;&gt; ~/.bashrc\n</code></pre> <p>Required for pip Install</p> <p>The <code>KREWLYZER_DATA_DIR</code> environment variable is required when installing via pip. Without it, asset auto-loading will fail. You can still use explicit paths like <code>--pon-model</code>.</p>"},{"location":"getting-started/installation/#requirements","title":"Requirements","text":"<ul> <li>OS: Linux or macOS (tested on Ubuntu 20.04+, macOS 12+)</li> <li>Python: 3.10+</li> <li>RAM: \u226516GB recommended for large BAM files</li> <li>Reference: Indexed FASTA file (hg19 or hg38)</li> </ul>"},{"location":"getting-started/installation/#reference-genome-setup","title":"Reference Genome Setup","text":"<p>Download and index the reference genome:</p> hg19 (GRCh37)hg38 (GRCh38) <pre><code>wget https://hgdownload.soe.ucsc.edu/goldenPath/hg19/bigZips/hg19.fa.gz\ngunzip hg19.fa.gz\nsamtools faidx hg19.fa\n</code></pre> <pre><code>wget https://hgdownload.soe.ucsc.edu/goldenPath/hg38/bigZips/hg38.fa.gz\ngunzip hg38.fa.gz\nsamtools faidx hg38.fa\n</code></pre>"},{"location":"getting-started/installation/#bundled-data-files","title":"Bundled Data Files","text":"<p>Krewlyzer includes annotation files in <code>src/krewlyzer/data/</code>:</p> Directory Contents <code>ChromosomeBins/</code> 100kb genome bins (hg19, hg38) <code>ChromosomeArms/</code> Chromosome arm definitions <code>WpsAnchors/</code> WPS anchor regions (TSS + CTCF) <code>OpenChromatinRegion/</code> Tissue-specific OCR for OCF <code>MethMark/</code> Methylation markers for UXM <code>pon/</code> Panel of Normals models <code>TFBS/</code> GTRD meta-clusters for region entropy <code>ATAC/</code> TCGA ATAC peaks for region entropy"},{"location":"getting-started/installation/#troubleshooting","title":"Troubleshooting","text":""},{"location":"getting-started/installation/#asset-not-found-or-pon-not-found","title":"\"Asset not found\" or \"PON not found\"","text":"<p>If you installed via <code>pip install krewlyzer</code>, you need to set up the data directory:</p> <pre><code>git clone --depth 1 https://github.com/msk-access/krewlyzer.git ~/.krewlyzer-data\ncd ~/.krewlyzer-data &amp;&amp; git lfs pull\nexport KREWLYZER_DATA_DIR=~/.krewlyzer-data/src/krewlyzer/data\n</code></pre>"},{"location":"getting-started/installation/#modulenotfounderror-krewlyzer_core","title":"\"ModuleNotFoundError: krewlyzer._core\"","text":"<p>The Rust extension failed to build. Ensure you have:</p> <ul> <li>Python 3.10+</li> <li>C compiler (<code>gcc</code> or <code>clang</code>)</li> <li>Rust toolchain (install via rustup)</li> </ul> <p>Reinstall with verbose output:</p> <pre><code>pip install krewlyzer -v\n</code></pre>"},{"location":"getting-started/installation/#htslib-not-found","title":"\"htslib not found\"","text":"<p>Install htslib development files:</p> Ubuntu/DebianmacOS <pre><code>sudo apt-get install libhts-dev\n</code></pre> <pre><code>brew install htslib\n</code></pre>"},{"location":"getting-started/installation/#memory-errors","title":"Memory Errors","text":"<p>For large BAM files, increase available memory or process chromosomes separately:</p> <pre><code>krewlyzer extract sample.bam -r hg19.fa -o output/ --chromosomes chr1,chr2\n</code></pre>"},{"location":"getting-started/quickstart/","title":"Quickstart","text":""},{"location":"getting-started/quickstart/#getting-started","title":"Getting Started","text":"<p>Get running with Krewlyzer in 5 minutes.</p>"},{"location":"getting-started/quickstart/#quick-install","title":"Quick Install","text":"Docker (Recommended)Clone + Installpip + Data Clone <pre><code>docker pull ghcr.io/msk-access/krewlyzer:X.Y.Z  # Replace X.Y.Z with latest release version\n</code></pre> <pre><code>git clone https://github.com/msk-access/krewlyzer.git &amp;&amp; cd krewlyzer\ngit lfs pull &amp;&amp; pip install -e .\n</code></pre> <pre><code>pip install krewlyzer\ngit clone --depth 1 https://github.com/msk-access/krewlyzer.git ~/.krewlyzer-data\ncd ~/.krewlyzer-data &amp;&amp; git lfs pull\nexport KREWLYZER_DATA_DIR=~/.krewlyzer-data/src/krewlyzer/data\n</code></pre> <p>pip Users</p> <p>See Installation Guide for <code>KREWLYZER_DATA_DIR</code> setup.</p>"},{"location":"getting-started/quickstart/#your-first-analysis","title":"Your First Analysis","text":"<p>Run all fragmentomics features on a BAM file:</p> <pre><code>krewlyzer run-all sample.bam \\\n    --reference hg19.fa \\\n    --output results/\n</code></pre>"},{"location":"getting-started/quickstart/#check-results","title":"Check Results","text":"<pre><code>ls results/\n# sample.bed.gz                    # Extracted fragments\n# sample.metadata.json             # Run metadata and QC metrics\n# sample.correction_factors.tsv    # GC correction factors\n# sample.EndMotif.tsv              # End motif frequencies\n# sample.EndMotif1mer.tsv          # 1-mer motifs + Jagged Index\n# sample.BreakPointMotif.tsv       # Breakpoint motif frequencies\n# sample.MDS.tsv                   # Motif Diversity Score\n# sample.FSC.tsv                   # Fragment size coverage\n# sample.FSR.tsv                   # Fragment size ratios\n# sample.FSD.tsv                   # Size distribution by arm\n# sample.WPS.parquet               # Windowed protection scores\n# sample.WPS_background.parquet    # WPS background (Alu)\n# sample.OCF.tsv                   # Orientation-aware fragmentation\n# sample.TFBS.tsv                  # TFBS entropy (808 TFs)\n# sample.ATAC.tsv                  # ATAC entropy (23 cancer types)\n# sample.features.json             # Unified JSON for ML\n</code></pre>"},{"location":"getting-started/quickstart/#common-workflows","title":"Common Workflows","text":""},{"location":"getting-started/quickstart/#targeted-panel-msk-access","title":"Targeted Panel (MSK-ACCESS)","text":"<p>For MSK-ACCESS v1 or v2 panels, use the <code>--assay</code> flag for panel-optimized analysis:</p> <pre><code>krewlyzer run-all sample.bam \\\n    --reference hg19.fa \\\n    --output results/ \\\n    --assay xs2 \\\n    --target-regions MSK-ACCESS-v2_targets.bed\n</code></pre> <p>This enables: - Gene-level FSC aggregation (146 genes) - Dual WPS output (genome-wide + panel-specific) - On/off-target splitting for all features</p> <p>For PON normalization: </p><pre><code>krewlyzer run-all sample.bam \\\n    --reference hg19.fa \\\n    --output results/ \\\n    --assay xs2 \\\n    --target-regions targets.bed \\\n    --pon-model xs2.pon.parquet \\\n    --generate-json\n</code></pre><p></p> <p>\u2192 Full MSK-ACCESS Quickstart for detailed workflows.</p>"},{"location":"getting-started/quickstart/#with-variant-analysis","title":"With Variant Analysis","text":"<p>Add mutant fragment size analysis using a VCF/MAF:</p> <pre><code>krewlyzer run-all sample.bam \\\n    --reference hg19.fa \\\n    --output results/ \\\n    --variants variants.maf\n</code></pre>"},{"location":"getting-started/quickstart/#individual-tools","title":"Individual Tools","text":"<p>Run specific features separately:</p> <pre><code># Extract fragments first\nkrewlyzer extract -i sample.bam -r hg19.fa -o output/\n\n# Then run feature tools on the BED\nkrewlyzer fsc -i output/sample.bed.gz -o output/\nkrewlyzer wps -i output/sample.bed.gz -o output/\n</code></pre>"},{"location":"getting-started/quickstart/#next-steps","title":"Next Steps","text":"<ul> <li>Installation Guide - Detailed setup instructions</li> <li>Usage Guide - Full CLI reference</li> <li>Feature Documentation - Per-feature details</li> <li>Nextflow Pipeline - Batch processing</li> </ul>"},{"location":"guides/building-pon/","title":"Building PON","text":""},{"location":"guides/building-pon/#build-pon","title":"build-pon","text":"<p>Build a unified Panel of Normals (PON) model from healthy plasma samples.</p>"},{"location":"guides/building-pon/#synopsis","title":"Synopsis","text":"<pre><code>krewlyzer build-pon SAMPLE_LIST --assay NAME -r REFERENCE -o OUTPUT [OPTIONS]\n</code></pre>"},{"location":"guides/building-pon/#description","title":"Description","text":"<p>Creates a PON model containing all baselines needed for cfDNA analysis from a cohort of healthy samples:</p> <ul> <li>GC Bias Model - For coverage correction</li> <li>FSD Baseline - Fragment size distributions per arm</li> <li>WPS Baseline - Nucleosome protection per region</li> <li>OCF Baseline - Open chromatin footprinting per region</li> <li>MDS Baseline - Motif diversity and k-mer frequencies</li> <li>TFBS Baseline - Transcription factor binding site entropy (808 TFs)</li> <li>ATAC Baseline - ATAC-seq peak entropy (23 cancer types)</li> </ul> <p>This model is used for bias correction and z-score normalization during sample processing.</p>"},{"location":"guides/building-pon/#arguments","title":"Arguments","text":"Argument Description <code>SAMPLE_LIST</code> Text file with paths to BAM or BED.gz files (one per line)"},{"location":"guides/building-pon/#required-options","title":"Required Options","text":"Option Description <code>-a, --assay</code> Assay name (e.g., <code>msk-access-v2</code>) <code>-r, --reference</code> Reference FASTA file (indexed) <code>-o, --output</code> Output PON model file (<code>.pon.parquet</code>)"},{"location":"guides/building-pon/#optional-parameters","title":"Optional Parameters","text":"Option Default Description <code>-G, --genome</code> hg19 Genome build (hg19/GRCh37/hg38/GRCh38) <code>-T, --target-regions</code> None BED file with target regions (panel mode) <code>--skip-target-regions</code> False Force WGS mode (ignore bundled targets from --assay) <code>-W, --wps-anchors</code> Built-in WPS anchors BED.gz (merged TSS+CTCF) <code>-b, --bin-file</code> Built-in Bin file for FSC/FSR <code>--temp-dir</code> System temp Directory for temporary files <code>-p, --threads</code> 4 Total threads (divided among parallel samples) <code>-P, --parallel-samples</code> 1 Number of samples to process in parallel <code>--memory-per-sample</code> 12 Expected memory per sample in GB (panel: 12-20, WGS: 4-8) <code>--sample-timeout</code> 3600 Max seconds per sample (0=no timeout) <code>--allow-failures</code> False Continue if a sample fails <code>--require-proper-pair</code> False Only properly paired reads <code>-v, --verbose</code> False Verbose output"},{"location":"guides/building-pon/#pipeline-flow","title":"Pipeline Flow","text":"<pre><code>flowchart TB\n    subgraph Input\n        SL[\"sample_list.txt\"]\n        BAM[\"BAM/CRAM files\"]\n        BED[\"BED.gz files\"]\n    end\n\n    subgraph \"Per-Sample Processing (Parallel with -P)\"\n        EXT[\"Extract fragments\"]\n        GC[\"GC observations\"]\n        FSD[\"FSD per arm\"]\n        WPS[\"WPS per anchor\"]\n        OCF[\"OCF per region\"]\n        MDS[\"MDS k-mers\"]\n        FSC_G[\"FSC gene/region\"]\n        TFBS[\"TFBS entropy\"]\n        ATAC[\"ATAC entropy\"]\n        RMDS[\"Region MDS\"]\n    end\n\n    subgraph \"Baseline Aggregation\"\n        AGG_GC[\"GC bias curves\\nmean/std per bin\"]\n        AGG_FSD[\"FSD baseline\\nmean/std per arm\"]\n        AGG_WPS[\"WPS baseline\\nmean/std per region\"]\n        AGG_OCF[\"OCF baseline\\nmean/std per region\"]\n        AGG_MDS[\"MDS baseline\\nk-mer mean/std\"]\n        AGG_FSC[\"FSC gene/region\\nmean/std per gene\"]\n        AGG_TFBS[\"TFBS baseline\\nmean/std per TF\"]\n        AGG_ATAC[\"ATAC baseline\\nmean/std per type\"]\n        AGG_RMDS[\"Region MDS\\nmean/std per gene\"]\n    end\n\n    subgraph Output\n        PON[\"PON.parquet\"]\n    end\n\n    SL --&gt; BAM &amp; BED\n    BAM --&gt; EXT --&gt; GC &amp; FSD &amp; WPS &amp; OCF &amp; MDS &amp; FSC_G &amp; TFBS &amp; ATAC &amp; RMDS\n    BED --&gt; GC &amp; FSD &amp; WPS &amp; OCF\n\n    GC --&gt; AGG_GC --&gt; PON\n    FSD --&gt; AGG_FSD --&gt; PON\n    WPS --&gt; AGG_WPS --&gt; PON\n    OCF --&gt; AGG_OCF --&gt; PON\n    MDS --&gt; AGG_MDS --&gt; PON\n    FSC_G --&gt; AGG_FSC --&gt; PON\n    TFBS --&gt; AGG_TFBS --&gt; PON\n    ATAC --&gt; AGG_ATAC --&gt; PON\n    RMDS --&gt; AGG_RMDS --&gt; PON\n</code></pre>  Use mouse to pan and zoom"},{"location":"guides/building-pon/#examples","title":"Examples","text":"<p>WGS Mode: </p><pre><code>krewlyzer build-pon healthy_samples.txt \\\n    --assay wgs-hg19 \\\n    --reference hg19.fa \\\n    --output wgs.pon.parquet\n</code></pre><p></p> <p>Panel Mode (MSK-ACCESS): </p><pre><code>krewlyzer build-pon healthy_samples.txt \\\n    --assay msk-access-v2 \\\n    --reference hg19.fa \\\n    --target-regions msk_access_targets.bed \\\n    --output msk-access.pon.parquet \\\n    --threads 16\n</code></pre><p></p> <p>HPC with custom temp directory: </p><pre><code>krewlyzer build-pon healthy_samples.txt \\\n    --assay xs1 \\\n    --reference hg19.fa \\\n    --target-regions msk_access_v1_targets.bed \\\n    --temp-dir /scratch/$USER/pon_tmp \\\n    --output xs1.pon.parquet \\\n    --threads 16 \\\n    --verbose\n</code></pre><p></p>"},{"location":"guides/building-pon/#input-formats","title":"Input Formats","text":"<p>Sample list file (<code>samples.txt</code>): </p><pre><code>/path/to/sample1.bam\n/path/to/sample2.bam\n/path/to/sample3.bed.gz\n</code></pre><p></p> <p>Both BAM/CRAM and BED.gz inputs are supported:</p> Input Type Extraction MDS Baseline Speed BAM/CRAM Full \u2713 Included Slower BED.gz Skip \u2717 Not available Faster <p>Note</p> <p>MDS baseline requires BAM/CRAM input because it needs fragment end sequences for k-mer extraction. BED.gz files only contain coordinates.</p>"},{"location":"guides/building-pon/#output","title":"Output","text":"<p>The output is a Parquet file containing:</p> Component Description Used By Metadata assay, build_date, n_samples, reference, panel_mode All GC Bias Expected coverage by GC bin for short/intermediate/long fragments FSC, FSR FSD Baseline Mean/std size proportions per chromosome arm FSD WPS Baseline Mean/std WPS per transcript region WPS OCF Baseline Mean/std OCF per open chromatin region OCF MDS Baseline K-mer frequencies and MDS mean/std Motif TFBS Baseline Mean/std entropy per TF (808 factors) Region Entropy ATAC Baseline Mean/std entropy per cancer type (23 types) Region Entropy Region MDS Baseline Per-gene MDS mean/std for E1 Region MDS FSC Gene Baseline Per-gene normalized depth mean/std FSC Gene FSC Region Baseline Per-exon normalized depth mean/std FSC Region <p>In panel mode, additional on-target baselines are included:</p> Component Description GC Bias (ontarget) On-target GC correction model FSD Baseline (ontarget) On-target FSD stats TFBS Baseline (ontarget) Panel-specific TF entropy ATAC Baseline (ontarget) Panel-specific ATAC entropy"},{"location":"guides/building-pon/#panel-mode","title":"Panel Mode","text":"<p>When <code>--target-regions</code> is provided:</p> <ol> <li>GC model trained on off-target fragments only (unbiased by capture)</li> <li>FSD/WPS include separate on-target statistics</li> <li>Output model includes <code>panel_mode=true</code> in metadata</li> </ol>"},{"location":"guides/building-pon/#recommendations","title":"Recommendations","text":"<ul> <li>Minimum samples: 10+ for stable baselines</li> <li>FSC gene/region: Requires minimum 3 samples per gene for statistics</li> <li>Same assay: All samples must be from the same assay</li> <li>Same reference: Must match reference used for processing</li> <li>Healthy samples: Use confirmed non-cancer samples only</li> </ul>"},{"location":"guides/building-pon/#mds-baseline","title":"MDS Baseline","text":"<p>The MDS (Motif Diversity Score) baseline is computed from k-mer frequencies at fragment ends:</p> Metric Description <code>kmer_expected</code> Mean frequency per 4-mer across samples <code>kmer_std</code> Standard deviation per 4-mer <code>mds_mean</code> Mean MDS (Shannon entropy) <code>mds_std</code> MDS standard deviation <p>Important</p> <p>MDS baseline requires BAM/CRAM input because it needs fragment end sequences. BED.gz files cannot provide this data.</p> <p>Z-score interpretation:</p> mds_z Interpretation -2 to +2 Normal range &lt; -2 Abnormally low diversity &gt; +2 Rare, check data quality"},{"location":"guides/building-pon/#hpc-usage-slurm","title":"HPC Usage (SLURM)","text":"<p>For running <code>build-pon</code> on HPC clusters with SLURM, use one of these approaches:</p>"},{"location":"guides/building-pon/#resource-planning","title":"Resource Planning","text":"Parallel Samples Memory CPUs Est. Time (50 samples) 2 50 GB 16 ~48 hours 4 100 GB 32 ~24 hours 6 150 GB 48 ~12 hours <p>Tip</p> <p>High-coverage panel data (e.g., MSK-ACCESS) typically uses 15-20 GB per sample during peak extraction. WGS data may use less. Start conservative and adjust based on memory logs.</p>"},{"location":"guides/building-pon/#sbatch-script-recommended","title":"sbatch Script (Recommended)","text":"<p>Create <code>run_pon.sh</code>:</p> <pre><code>#!/bin/bash\n#SBATCH --partition=your_partition\n#SBATCH --job-name=build_pon\n#SBATCH --nodes=1\n#SBATCH --ntasks=1\n#SBATCH --cpus-per-task=48\n#SBATCH --mem=150G\n#SBATCH --time=12:00:00\n#SBATCH --output=pon_build_%j.out\n#SBATCH --error=pon_build_%j.err\n\n# Create temp directory\nmkdir -p ./pon_temp\n\nkrewlyzer build-pon samples.txt \\\n  --assay your-assay \\\n  -r /path/to/reference.fasta \\\n  -o output.pon.parquet \\\n  --temp-dir ./pon_temp \\\n  --threads 48 \\\n  -P 6 \\\n  --memory-per-sample 20 \\\n  --sample-timeout 7200 \\\n  --allow-failures \\\n  -v\n</code></pre> <p>Submit with: </p><pre><code>sbatch run_pon.sh\n</code></pre><p></p>"},{"location":"guides/building-pon/#srun-one-liner","title":"srun One-liner","text":"<pre><code>mkdir -p ./pon_temp &amp;&amp; srun \\\n  --partition=your_partition \\\n  --job-name=build_pon \\\n  --nodes=1 \\\n  --ntasks=1 \\\n  --cpus-per-task=48 \\\n  --mem=150G \\\n  --time=12:00:00 \\\n  krewlyzer build-pon samples.txt \\\n    --assay your-assay \\\n    -r /path/to/reference.fasta \\\n    -o output.pon.parquet \\\n    --temp-dir ./pon_temp \\\n    --threads 48 -P 6 --memory-per-sample 20 \\\n    --sample-timeout 7200 --allow-failures -v \\\n  2&gt;&amp;1 | tee pon_build.log\n</code></pre>"},{"location":"guides/building-pon/#key-slurm-parameters","title":"Key SLURM Parameters","text":"Parameter Value Explanation <code>--nodes=1</code> 1 Single node (Python multiprocessing doesn't span nodes) <code>--ntasks=1</code> 1 One main process (parallelism handled internally) <code>--cpus-per-task</code> 48 All CPUs available to the process <code>--mem</code> 150G 6 samples \u00d7 20 GB + buffer"},{"location":"guides/building-pon/#key-krewlyzer-parameters","title":"Key krewlyzer Parameters","text":"Parameter Example Description <code>-P</code> / <code>--parallel-samples</code> 6 Concurrent samples (internal workers) <code>--threads</code> 48 Total threads (divided among workers) <code>--memory-per-sample</code> 20 Memory hint for auto-mode (panel: 15-20 GB) <code>--sample-timeout</code> 7200 Per-sample timeout in seconds (2 hours) <code>--temp-dir</code> ./pon_temp Local scratch directory <code>--allow-failures</code> - Continue if a sample fails <p>Warning</p> <p>If jobs are OOM-killed, reduce <code>-P</code> or increase <code>--mem</code>. The new memory monitoring will log usage at each processing stage.</p>"},{"location":"guides/gc-correction/","title":"GC Correction","text":""},{"location":"guides/gc-correction/#gc-bias-correction","title":"GC Bias Correction","text":"<p>GC content bias is a major source of variability in cfDNA sequencing. Krewlyzer implements LOESS-based correction in Rust for high performance.</p>"},{"location":"guides/gc-correction/#why-gc-correction","title":"Why GC Correction?","text":"<p>DNA fragments with extreme GC content (very AT-rich or GC-rich) are under-represented due to:</p> <ol> <li>PCR amplification bias - GC-rich regions amplify less efficiently</li> <li>Sequencing bias - Certain GC ranges have lower quality scores</li> <li>Capture bias - Hybridization efficiency varies with GC</li> </ol> <p>Without correction, fragment counts are confounded by GC content, obscuring biological signal.</p>"},{"location":"guides/gc-correction/#how-it-works","title":"How It Works","text":""},{"location":"guides/gc-correction/#loess-regression","title":"LOESS Regression","text":"<p>Krewlyzer uses Locally Estimated Scatterplot Smoothing (LOESS) to model the relationship between GC content and fragment count:</p> <pre><code>For each fragment type (short, intermediate, long):\n1. Bin fragments by GC content (0.00-1.00 in 0.01 steps)\n2. Fit LOESS curve: count = f(gc)\n3. Compute correction factor: factor[gc] = median(count) / loess_fit[gc]\n4. Apply: corrected_count = raw_count \u00d7 factor[gc]\n</code></pre>"},{"location":"guides/gc-correction/#configuration","title":"Configuration","text":"Parameter Default Description LOESS fraction 0.3 Fraction of data for local fitting LOESS iterations 3 Robustness iterations Delta 0.01 Smoothing delta"},{"location":"guides/gc-correction/#fragment-length-bins","title":"Fragment Length Bins","text":"<p>GC correction is applied per fragment length bin (17 bins, 20bp width):</p> Bin Range Fragment Type 0 60-79bp Ultra-short 1 80-99bp Ultra-short 2-4 100-159bp Short 5-7 160-219bp Intermediate 8-16 220-400bp Long"},{"location":"guides/gc-correction/#usage","title":"Usage","text":""},{"location":"guides/gc-correction/#automatic-default","title":"Automatic (Default)","text":"<p>GC correction is enabled by default for most tools:</p> <pre><code>krewlyzer extract -i sample.bam -r hg19.fa -o output/\n# Generates: sample.correction_factors.tsv\n</code></pre>"},{"location":"guides/gc-correction/#disable-gc-correction","title":"Disable GC Correction","text":"<pre><code>krewlyzer fsc -i sample.bed.gz --no-gc-correct -o output/\n</code></pre>"},{"location":"guides/gc-correction/#using-pre-computed-factors","title":"Using Pre-computed Factors","text":"<pre><code># mFSD can use factors from extract\nkrewlyzer mfsd -i sample.bam -V variants.vcf \\\n    --correction-factors output/sample.correction_factors.tsv \\\n    -o output/\n</code></pre>"},{"location":"guides/gc-correction/#per-tool-gc-correction","title":"Per-Tool GC Correction","text":"Tool GC Option Source Notes extract <code>--gc-correct</code> Computes factors Generates <code>.correction_factors.tsv</code> FSC <code>--gc-correct</code> From extract Via <code>run_unified_pipeline</code> FSR <code>--gc-correct</code> From extract Via <code>run_unified_pipeline</code> FSD <code>--gc-correct</code> From extract Via <code>run_unified_pipeline</code> WPS <code>--gc-correct</code> From extract Via <code>run_unified_pipeline</code> OCF <code>--gc-correct</code> From extract Via <code>run_unified_pipeline</code> Region Entropy <code>--gc-factors</code> From extract TFBS/ATAC fragment weighting Region MDS N/A Uses raw motif counts (no GC correction) mFSD <code>--correction-factors</code> Manual input Uses pre-computed CSV motif N/A N/A No GC correction UXM N/A N/A No GC correction"},{"location":"guides/gc-correction/#panel-data-target-regions","title":"Panel Data (--target-regions)","text":"<p>When <code>--target-regions</code> is provided to <code>extract</code>: - GC model is built from off-target fragments only - Avoids capture bias contamination - Generates both <code>.correction_factors.tsv</code> (off-target) and <code>.correction_factors.ontarget.tsv</code> (on-target)</p>"},{"location":"guides/gc-correction/#building-gc-reference-assets","title":"Building GC Reference Assets","text":"<p>The <code>build-gc-reference</code> command pre-computes reference GC data:</p> <pre><code># Standard (WGS) mode\nkrewlyzer build-gc-reference hg19.fa -o data/gc/ -e hg19-blacklist.bed\n\n# Panel mode (generates both WGS and on-target assets)\nkrewlyzer build-gc-reference hg19.fa -o data/gc/ -T msk_targets.bed\n</code></pre>"},{"location":"guides/gc-correction/#output-files","title":"Output Files","text":"Mode File Description Standard <code>valid_regions_{genome}.bed.gz</code> 100kb bins for GC estimation Standard <code>ref_genome_GC_{genome}.parquet</code> Expected fragment counts Panel <code>valid_regions_{genome}.ontarget.bed.gz</code> Bins overlapping targets Panel <code>ref_genome_GC_{genome}.ontarget.parquet</code> On-target expected counts"},{"location":"guides/gc-correction/#options","title":"Options","text":"Option Description <code>-o, --output</code> Output directory (required) <code>-e, --exclude-regions</code> Blacklist BED to exclude <code>-T, --target-regions</code> Target BED for panel mode <code>--bin-size</code> Bin size in bp (default: 100kb) <code>-n, --genome-name</code> Genome name (default: from FASTA)"},{"location":"guides/gc-correction/#correction-factors-file","title":"Correction Factors File","text":"<p>The <code>extract</code> command generates <code>{sample}.correction_factors.tsv</code>:</p> <pre><code>len_bin,gc_bin,factor,observed,expected,n_fragments\n0,0.30,1.23,1234,1003,50000\n0,0.31,1.21,1256,1038,51234\n...\n</code></pre> Column Description <code>len_bin</code> Fragment length bin (0-16) <code>gc_bin</code> GC content (0.00-1.00) <code>factor</code> Correction multiplier <code>observed</code> Raw fragment count <code>expected</code> LOESS-predicted count <code>n_fragments</code> Number of fragments in bin"},{"location":"guides/gc-correction/#pon-based-hybrid-correction","title":"PON-based Hybrid Correction","text":"<p>When a PON model is provided, correction uses a hybrid approach:</p> <pre><code>flowchart LR\n    obs[Observed Counts] --&gt; pon[PON Correction]\n    pon --&gt; |\"observed / pon_expected\"| res[Residual LOESS]\n    res --&gt; |\"pon_corrected / residual\"| final[Final Counts]\n</code></pre>  Use mouse to pan and zoom  <p>Algorithm: 1. PON correction: Divide by assay-specific expected coverage 2. Residual LOESS: Fit sample-specific residual bias 3. Final: Divide PON-corrected counts by residual</p> <p>This removes both assay-wide and sample-specific GC effects.</p>"},{"location":"guides/gc-correction/#implementation-details","title":"Implementation Details","text":""},{"location":"guides/gc-correction/#rust-module-gc_correctionrs","title":"Rust Module: <code>gc_correction.rs</code>","text":"<p>Key structures:</p> <pre><code>/// Fragment length bins (17 bins, 60-400bp)\npub struct LengthBin(u8);\n\n/// GC correction factors lookup\npub struct CorrectionFactors {\n    factors: HashMap&lt;(LengthBin, u8), f64&gt;,\n    stats: HashMap&lt;(LengthBin, u8), CorrectionBinStats&gt;,\n}\n\n/// Apply LOESS-based correction\npub fn correct_gc_bias(\n    gc_values: &amp;[f64],\n    counts: &amp;[f64],\n    config: Option&lt;GcCorrectionConfig&gt;\n) -&gt; Result&lt;Vec&lt;f64&gt;&gt;\n</code></pre>"},{"location":"guides/gc-correction/#python-interface","title":"Python Interface","text":"<pre><code>from krewlyzer import _core\n\n# Compute and save correction factors\n_core.gc.compute_and_write_gc_factors(\n    bed_path=\"sample.bed.gz\",\n    gc_reference_path=\"gc_reference.parquet\",\n    output_path=\"correction_factors.tsv\"\n)\n</code></pre>"},{"location":"guides/gc-correction/#when-to-disable","title":"When to Disable","text":"<p>Disable GC correction (<code>--no-gc-correct</code>) when:</p> <ul> <li>Comparing raw signal across samples with known GC differences</li> <li>Validating uncorrected patterns</li> <li>Working with very small regions where LOESS may be unstable</li> </ul> <p>For most applications, keep correction enabled (default).</p>"},{"location":"guides/msk-access-quickstart/","title":"MSK-ACCESS Quickstart","text":""},{"location":"guides/msk-access-quickstart/#msk-access-quickstart","title":"MSK-ACCESS Quickstart","text":"<p>This guide walks through analyzing MSK-ACCESS panel data with Krewlyzer.</p>"},{"location":"guides/msk-access-quickstart/#prerequisites","title":"Prerequisites","text":"<ul> <li>Krewlyzer installed (<code>pip install krewlyzer</code> or Docker)</li> <li>MSK-ACCESS BAM file (sorted, indexed)</li> <li>Reference genome (hg19.fa)</li> </ul>"},{"location":"guides/msk-access-quickstart/#basic-panel-analysis","title":"Basic Panel Analysis","text":"<pre><code>krewlyzer run-all -i ACCESS_sample.bam \\\n    --reference hg19.fa \\\n    --output results/ \\\n    --assay xs2 \\\n    --target-regions MSK-ACCESS-v2_targets.bed\n</code></pre>"},{"location":"guides/msk-access-quickstart/#what-this-does","title":"What This Does","text":"Flag Effect <code>--assay xs2</code> Enables MSK-ACCESS v2 optimizations <code>--target-regions</code> Splits outputs into on/off-target"},{"location":"guides/msk-access-quickstart/#output-files","title":"Output Files","text":""},{"location":"guides/msk-access-quickstart/#standard-outputs","title":"Standard Outputs","text":"File Description <code>sample.bed.gz</code> Extracted fragments <code>sample.FSC.tsv</code> Fragment size coverage <code>sample.FSC.ontarget.tsv</code> FSC for on-target regions <code>sample.FSR.tsv</code> Fragment size ratios <code>sample.FSD.tsv</code> Size distribution by arm <code>sample.WPS.parquet</code> Nucleosome protection (genome-wide) <code>sample.OCF.tsv</code> Tissue of origin footprint <code>sample.EndMotif.tsv</code> End motif frequencies <code>sample.MDS.tsv</code> Motif Diversity Score"},{"location":"guides/msk-access-quickstart/#panel-specific-outputs-with-assay","title":"Panel-Specific Outputs (with <code>--assay</code>)","text":"File Description <code>sample.FSC.gene.tsv</code> Gene-level FSC (146 genes for xs2) <code>sample.WPS.panel.parquet</code> Panel-focused WPS (~2k anchors)"},{"location":"guides/msk-access-quickstart/#with-pon-normalization","title":"With PON Normalization","text":"<p>For z-score computation against healthy baselines:</p> <pre><code>krewlyzer run-all -i ACCESS_sample.bam \\\n    --reference hg19.fa \\\n    --output results/ \\\n    --assay xs2 \\\n    --target-regions MSK-ACCESS-v2_targets.bed \\\n    --pon-model xs2.pon.parquet\n</code></pre> <p>This adds z-score columns to all outputs (e.g., <code>z_core_short</code>, <code>wps_nuc_z</code>, <code>mds_z</code>).</p>"},{"location":"guides/msk-access-quickstart/#json-output-for-ml","title":"JSON Output for ML","text":"<p>Generate a unified JSON file for machine learning pipelines:</p> <pre><code>krewlyzer run-all -i ACCESS_sample.bam \\\n    --reference hg19.fa \\\n    --output results/ \\\n    --assay xs2 \\\n    --target-regions MSK-ACCESS-v2_targets.bed \\\n    --pon-model xs2.pon.parquet \\\n    --generate-json\n</code></pre> <p>This creates <code>sample.features.json</code> with all features. See JSON Output for schema details.</p>"},{"location":"guides/msk-access-quickstart/#assay-options","title":"Assay Options","text":"Assay Code Panel Genes WPS Anchors <code>xs1</code> MSK-ACCESS v1 128 1,611 <code>xs2</code> MSK-ACCESS v2 146 1,820"},{"location":"guides/msk-access-quickstart/#standalone-tool-examples","title":"Standalone Tool Examples","text":""},{"location":"guides/msk-access-quickstart/#fsc-with-gene-aggregation","title":"FSC with Gene Aggregation","text":"<pre><code>krewlyzer fsc -i sample.bed.gz -o results/ \\\n    --assay xs2 \\\n    --target-regions targets.bed\n</code></pre> <p>Outputs: <code>sample.FSC.tsv</code> + <code>sample.FSC.gene.tsv</code></p>"},{"location":"guides/msk-access-quickstart/#wps-with-dual-output","title":"WPS with Dual Output","text":"<pre><code>krewlyzer wps -i sample.bed.gz -o results/ \\\n    --assay xs2 \\\n    --target-regions targets.bed\n</code></pre> <p>Outputs: <code>sample.WPS.parquet</code> (genome-wide) + <code>sample.WPS.panel.parquet</code> (panel genes)</p>"},{"location":"guides/msk-access-quickstart/#building-your-own-pon","title":"Building Your Own PON","text":"<p>Create a PON from your healthy plasma samples:</p> <pre><code># Create sample list file\nls /path/to/healthy/*-duplex.bam &gt; healthy_samples.txt\n\n# Build PON (HPC with custom temp directory)\nkrewlyzer build-pon healthy_samples.txt \\\n    --assay xs2 \\\n    --reference hg19.fa \\\n    --target-regions MSK-ACCESS-v2_targets.bed \\\n    --temp-dir /scratch/$USER/pon_tmp \\\n    --output xs2.pon.parquet \\\n    --threads 16 \\\n    --verbose\n</code></pre> <p>Tip: Use <code>--temp-dir</code> to specify a directory with more disk space than <code>/tmp</code>. Each BAM extraction creates temporary BED.gz files (~100MB each).</p>"},{"location":"guides/msk-access-quickstart/#nextflow-batch-processing","title":"Nextflow Batch Processing","text":"<p>For multiple samples, use the Nextflow pipeline:</p> <pre><code>nextflow run nextflow/main.nf \\\n    --samplesheet samples.csv \\\n    --ref /path/to/hg19.fa \\\n    --outdir results/\n</code></pre>"},{"location":"guides/msk-access-quickstart/#samplesheet-example","title":"Samplesheet Example","text":"<pre><code>sample,bam,meth_bam,vcf,bed,maf,single_sample_maf,assay,pon,targets\nACCESS_001,/data/sample1.bam,,,,,false,XS2,,\nACCESS_002,/data/sample2.bam,,,,,false,XS2,,\nACCESS_003,/data/sample3.bam,,,,,false,XS2,,\n</code></pre> <p>When <code>assay=XS2</code> is set, the pipeline automatically resolves: - PON: <code>{asset_dir}/pon/GRCh37/xs2.pon.parquet</code> - Targets: <code>{asset_dir}/targets/GRCh37/xs2.targets.bed</code></p>"},{"location":"guides/msk-access-quickstart/#key-differences-from-wgs","title":"Key Differences from WGS","text":"Aspect WGS MSK-ACCESS Coverage Uniform Targeted GC Model All fragments Off-target only FSC Output Windows + Gene-level WPS Output Genome-wide + Panel-specific Fragments used All Split on/off-target"},{"location":"guides/msk-access-quickstart/#troubleshooting","title":"Troubleshooting","text":""},{"location":"guides/msk-access-quickstart/#0-of-reads-pass-filters","title":"\"0% of reads pass filters\"","text":"<p>Duplex/consensus BAMs need: </p><pre><code>krewlyzer run-all ... --no-require-proper-pair\n</code></pre><p></p>"},{"location":"guides/msk-access-quickstart/#missing-gene-bed","title":"Missing Gene BED","text":"<p>Ensure bundled data is present: </p><pre><code>ls $(python -c \"from krewlyzer.assets import AssetManager; a=AssetManager('hg19'); print(a.base_path)\")/genes/GRCh37/\n# Should show: xs1.genes.bed.gz, xs2.genes.bed.gz\n</code></pre><p></p>"},{"location":"guides/msk-access-quickstart/#next-steps","title":"Next Steps","text":"<ul> <li>Panel Mode Details - How on/off-target splitting works</li> <li>PON Building - Create your own PON</li> <li>JSON Schema - ML integration</li> <li>Troubleshooting - Common issues</li> </ul>"},{"location":"guides/panel-mode/","title":"Panel Mode","text":""},{"location":"guides/panel-mode/#panel-mode","title":"Panel Mode","text":"<p>Panel mode enables accurate cfDNA analysis for capture-based sequencing panels like MSK-ACCESS.</p>"},{"location":"guides/panel-mode/#overview","title":"Overview","text":"<p>When using targeted capture panels, two key issues affect cfDNA analysis:</p> <ol> <li>GC Bias: Capture probes introduce additional GC bias on top of sequencing bias</li> <li>Coverage Splitting: On-target fragments behave differently than off-target fragments</li> </ol> <p>Panel mode addresses both by: - Training the GC model on off-target fragments only (unbiased by capture) - Computing dual baselines for on-target and off-target regions separately</p>"},{"location":"guides/panel-mode/#enabling-panel-mode","title":"Enabling Panel Mode","text":""},{"location":"guides/panel-mode/#building-gc-reference-assets-one-time","title":"Building GC Reference Assets (One-time)","text":"<p>For panel mode, generate panel-specific GC reference assets:</p> <pre><code>krewlyzer build-gc-reference hg19.fa -o data/gc/ \\\n    --target-regions msk_access_baits.bed\n</code></pre> <p>This generates both standard and on-target GC reference files.</p>"},{"location":"guides/panel-mode/#at-pon-build-time","title":"At PON Build Time","text":"<pre><code>krewlyzer build-pon samples.txt \\\n    --assay msk-access-v2 \\\n    --reference hg19.fa \\\n    --target-regions msk_access_baits.bed \\\n    --output msk-access.pon.parquet\n</code></pre>"},{"location":"guides/panel-mode/#at-sample-processing-time","title":"At Sample Processing Time","text":"<p>The <code>--assay</code> flag enables panel-specific optimizations:</p> <pre><code># MSK-ACCESS v2 with all panel features\nkrewlyzer run-all -i sample.bam -r hg19.fa -o out/ \\\n    --assay xs2 \\\n    --target-regions msk_access_baits.bed \\\n    --pon-model msk-access.pon.parquet\n</code></pre>"},{"location":"guides/panel-mode/#what-assay-enables","title":"What <code>--assay</code> Enables","text":"Feature Without --assay With --assay Gene FSC Window-based only + Gene-level aggregation (<code>FSC.gene.tsv</code>) WPS Anchors Genome-wide (~15k) Panel-specific (~2k + genome-wide) WPS Output Single <code>WPS.parquet</code> Dual: <code>WPS.parquet</code> + <code>WPS.panel.parquet</code> JSON Output Standard features + <code>fsc_gene</code>, <code>wps_panel</code>"},{"location":"guides/panel-mode/#dual-wps-output","title":"Dual WPS Output","text":"<p>With <code>--assay</code>, Krewlyzer generates two WPS files:</p> File Anchors Use Case <code>{sample}.WPS.parquet</code> Genome-wide TSS+CTCF Cancer detection signature <code>{sample}.WPS.panel.parquet</code> Panel gene anchors Targeted gene profiling <p>This dual output provides both broad cancer signals and focused gene-level analysis.</p>"},{"location":"guides/panel-mode/#minimal-panel-mode-no-pon","title":"Minimal Panel Mode (No PON)","text":"<p>For quick analysis without a custom PON:</p> <pre><code>krewlyzer run-all -i sample.bam -r hg19.fa -o out/ \\\n    --assay xs2 \\\n    --target-regions targets.bed\n</code></pre>"},{"location":"guides/panel-mode/#auto-loading-assets-with-assay","title":"Auto-Loading Assets with <code>--assay</code>","text":"<p>When you specify <code>--assay</code>, krewlyzer automatically loads bundled assets:</p> <pre><code># Auto-loads PON and target regions for xs2\nkrewlyzer run-all -i sample.bam -r hg19.fa -o out/ --assay xs2\n</code></pre> Assay PON Model Target Regions <code>xs1</code> <code>xs1.all_unique.pon.parquet</code> <code>xs1.targets.bed.gz</code> <code>xs2</code> <code>xs2.all_unique.pon.parquet</code> <code>xs2.targets.bed.gz</code> <code>wgs</code> None None (WGS mode) <p>This auto-loading applies to all tools including: - <code>extract</code>, <code>run-all</code>, <code>fsc</code>, <code>fsd</code>, <code>fsr</code>, <code>wps</code>, <code>ocf</code>, <code>region-entropy</code>, <code>motif</code>, <code>region-mds</code>, <code>build-pon</code></p>"},{"location":"guides/panel-mode/#forcing-wgs-mode-with-skip-target-regions","title":"Forcing WGS Mode with <code>--skip-target-regions</code>","text":"<p>To force WGS-like behavior even when using a panel assay (e.g., for comparison):</p> <pre><code># Use xs2 PON but disable panel mode (process as WGS)\nkrewlyzer run-all -i sample.bam -r hg19.fa -o out/ \\\n    --assay xs2 \\\n    --skip-target-regions\n</code></pre> <p>This is useful when: - Comparing panel samples to WGS baselines - Running validation without on/off-target splitting - Processing samples where target regions don't apply</p> <p>Note</p> <p><code>--skip-target-regions</code> only disables target region loading. The PON model is still loaded from <code>--assay</code> unless you also add <code>--skip-pon</code>.</p>"},{"location":"guides/panel-mode/#flag-priority","title":"Flag Priority","text":"<p>Asset resolution follows this priority order:</p> <ol> <li>Explicit path (<code>--target-regions path/to/file.bed</code>) - highest priority</li> <li>Skip flag (<code>--skip-target-regions</code>) - forces WGS mode</li> <li>Bundled asset (auto-loaded from <code>--assay</code>)</li> <li>None - WGS mode (no targets)</li> </ol>"},{"location":"guides/panel-mode/#how-it-works","title":"How It Works","text":""},{"location":"guides/panel-mode/#gc-correction","title":"GC Correction","text":"<pre><code>WGS Mode:     All fragments \u2192 GC model \u2192 Single correction curve\nPanel Mode:   Off-target fragments \u2192 GC model \u2192 Unbiased correction curve\n              On-target fragments \u2192 GC model \u2192 Capture-aware correction curve\n</code></pre> <p>The GC model is built from off-target fragments because: - On-target fragments have probe-specific GC bias - Off-target fragments represent natural cfDNA (similar to WGS)</p>"},{"location":"guides/panel-mode/#dual-correction-factor-files","title":"Dual Correction Factor Files","text":"<p>In panel mode, <code>krewlyzer extract</code> generates TWO correction factor files:</p> File Source Used For <code>{sample}.correction_factors.tsv</code> Off-target fragments Primary biomarker analysis <code>{sample}.correction_factors.ontarget.tsv</code> On-target fragments Copy number, variant calling"},{"location":"guides/panel-mode/#feature-splitting","title":"Feature Splitting","text":"<p>In panel mode, each feature outputs two files:</p> Feature Primary File On-Target File FSC <code>.FSC.tsv</code> <code>.FSC.ontarget.tsv</code> FSD <code>.FSD.tsv</code> <code>.FSD.ontarget.tsv</code> OCF <code>.OCF.tsv</code> <code>.OCF.ontarget.tsv</code> TFBS <code>.TFBS.tsv</code> (genome-wide) <code>.TFBS.ontarget.tsv</code> (panel regions) ATAC <code>.ATAC.tsv</code> (genome-wide) <code>.ATAC.ontarget.tsv</code> (panel regions) Motif <code>.EndMotif.tsv</code> <code>.EndMotif.ontarget.tsv</code> MDS <code>.MDS.tsv</code> <code>.MDS.ontarget.tsv</code> <p>Note</p> <p>FSR does not produce a separate on-target file. The FSR ratio is computed from off-target FSC counts, which represent unbiased cfDNA.</p> <p>Note</p> <p>On-target outputs use on-target GC correction factors (<code>.correction_factors.ontarget.tsv</code>) when available, providing better accuracy for capture-biased data.</p> <p>Note on OCF ontarget: OCF.ontarget uses both on-target fragments AND panel-filtered OCR regions. This dual-filter approach maximizes signal-to-noise for panel-specific tissue-of-origin detection. See OCF Feature for details.</p> <p>Note on TFBS/ATAC:  - Primary files (<code>.TFBS.tsv</code>, <code>.ATAC.tsv</code>) use all fragments across all ~808 TFs / 23 cancer types \u2192 WGS-comparable baseline - On-target files use pre-intersected panel regions \u2192 panel-specific signal enrichment</p> <p>See Region Entropy for details.</p> <p>Primary files are used for: - Fragment-based biomarkers - GC-corrected coverage analysis - Comparison with WGS baselines</p> <p>On-target files are used for: - Copy number analysis - Integration with variant calling - Panel-specific tissue signals (OCF)</p>"},{"location":"guides/panel-mode/#target-regions-file","title":"Target Regions File","text":"<p>The <code>--target-regions</code> BED file should contain the capture probe coordinates:</p> <pre><code>chr1    11166102    11166202    MTOR_exon1\nchr1    27022522    27022622    ARID1A_exon1\n...\n</code></pre> <ul> <li>Use the bait coordinates (not target intervals)</li> <li>Standard BED format (0-based, half-open)</li> <li>Optional 4th column for region names</li> </ul>"},{"location":"guides/panel-mode/#gene-centric-fsc-msk-access","title":"Gene-Centric FSC (MSK-ACCESS)","text":"<p>For MSK-ACCESS panels (v1 and v2), krewlyzer provides gene-level FSC aggregation:</p> <pre><code># FSC with gene-level output for MSK-ACCESS v2\nkrewlyzer fsc -i sample.bed.gz -o out/ --assay xs2\n</code></pre>"},{"location":"guides/panel-mode/#output-files","title":"Output Files","text":"File Description <code>{sample}.FSC.tsv</code> Standard window-based FSC <code>{sample}.FSC.gene.tsv</code> Gene-level FSC (146 genes for xs2)"},{"location":"guides/panel-mode/#gene-fsc-output-format","title":"Gene FSC Output Format","text":"<pre><code>gene    n_regions  total_bp  ultra_short  core_short  mono_nucl  di_nucl  long  total  ultra_short_ratio  ...\nATM     62         8432      1234         5678        9012       3456     789   20169  0.0612             ...\nBRCA2   42         5689      ...\n</code></pre>"},{"location":"guides/panel-mode/#supported-assays","title":"Supported Assays","text":"Assay Flag Genes MSK-ACCESS v1 <code>--assay xs1</code> 128 MSK-ACCESS v2 <code>--assay xs2</code> 146 <p>The gene groupings are bundled with krewlyzer in <code>data/genes/GRCh37/</code>.</p>"},{"location":"guides/panel-mode/#panel-wps-anchors-msk-access","title":"Panel WPS Anchors (MSK-ACCESS)","text":"<p>For MSK-ACCESS panels, WPS analysis uses panel-specific anchors filtered to genes in the panel:</p> <pre><code># WPS with panel-specific anchors for MSK-ACCESS v2\nkrewlyzer wps -i sample.bed.gz -o out/ \\\n    --wps-anchors $(python -c \"from krewlyzer.core.wps_anchor_filter import get_bundled_wps_anchors; print(get_bundled_wps_anchors('xs2', 'GRCh37'))\")\n</code></pre>"},{"location":"guides/panel-mode/#bundled-panel-anchors","title":"Bundled Panel Anchors","text":"Assay File Anchors MSK-ACCESS v1 <code>xs1.wps_anchors.bed.gz</code> 1,611 MSK-ACCESS v2 <code>xs2.wps_anchors.bed.gz</code> 1,820"},{"location":"guides/panel-mode/#anchor-types","title":"Anchor Types","text":"<ul> <li>TSS anchors: Transcription start sites for panel genes</li> <li>CTCF anchors: CTCF binding sites within 100kb of panel TSS sites</li> </ul> <p>Tip</p> <p>Using panel-specific anchors reduces noise from irrelevant genome-wide signals and focuses WPS analysis on oncologically relevant regions.</p>"},{"location":"guides/panel-mode/#pon-compatibility","title":"PON Compatibility","text":"<p>The PON model stores whether it was built in panel mode:</p> <pre><code>from krewlyzer.pon.model import PonModel\n\npon = PonModel.load(\"msk-access.pon.parquet\")\nprint(f\"Panel mode: {pon.panel_mode}\")\nprint(f\"Target file: {pon.target_regions_file}\")\n</code></pre> <p>For best results, use a PON built with the same <code>--target-regions</code> as sample processing.</p>"},{"location":"includes/abbreviations/","title":"Abbreviations","text":""},{"location":"nextflow/","title":"Overview","text":""},{"location":"nextflow/#nextflow-pipeline","title":"Nextflow Pipeline","text":"<p>Run Krewlyzer at scale with the Nextflow pipeline.</p>"},{"location":"nextflow/#quick-start","title":"Quick Start","text":"<pre><code>nextflow run msk-access/krewlyzer \\\n    --samplesheet samples.csv \\\n    --ref /path/to/hg19.fa \\\n    --outdir results/\n</code></pre>"},{"location":"nextflow/#workflow-architecture","title":"Workflow Architecture","text":"<p>The pipeline uses a Nextflow-native parallel pattern:</p> <pre><code>flowchart TB\n    BAM[\"sample.bam\"] --&gt; EXTRACT[\"KREWLYZER_EXTRACT\"]\n    EXTRACT --&gt; BED[\"sample.bed.gz\"]\n\n    BED --&gt; MOTIF[\"KREWLYZER_MOTIF\"]\n    BED --&gt; FSC[\"KREWLYZER_FSC\"]\n    BED --&gt; FSR[\"KREWLYZER_FSR\"]\n    BED --&gt; FSD[\"KREWLYZER_FSD\"]\n    BED --&gt; WPS[\"KREWLYZER_WPS\"]\n    BED --&gt; OCF[\"KREWLYZER_OCF\"]\n    BED --&gt; ENTROPY[\"KREWLYZER_REGION_ENTROPY\"]\n\n    BAM --&gt; RMDS[\"KREWLYZER_REGION_MDS\"]\n\n    subgraph \"Parallel Paths\"\n        METH_BAM[\"meth.bam\"] --&gt; UXM[\"KREWLYZER_UXM\"]\n        BAM2[\"BAM + MAF\"] --&gt; MFSD[\"KREWLYZER_MFSD\"]\n    end\n</code></pre>  Use mouse to pan and zoom"},{"location":"nextflow/#documentation","title":"Documentation","text":"Page Description Samplesheet Input samplesheet format Parameters All pipeline parameters Outputs Output channels and files Examples Workflow examples"},{"location":"nextflow/#features","title":"Features","text":"<ul> <li>Parallel processing - Process multiple samples simultaneously</li> <li>Resume support - Resume failed runs</li> <li>Container support - Docker/Singularity</li> <li>Cloud ready - AWS, Google Cloud, Azure</li> </ul>"},{"location":"nextflow/#performance-benchmarks","title":"Performance Benchmarks","text":"<p>Real-world performance from MSK-ACCESS v1/v2 duplex plasma samples:</p> Sample Type Duration CPU Usage Peak Memory Healthy control 2-5 min 90-140% 1.7-1.9 GB ctDNA plasma 4-6 min 190-300% 2.8-3.2 GB <p>Tested Configuration</p> <ul> <li>Docker with amd64 emulation on Apple Silicon</li> <li>8 CPUs, 32 GB memory</li> <li>Panel mode with <code>--skip-pon</code> and <code>--duplex</code> enabled</li> </ul>"},{"location":"nextflow/#see-also","title":"See Also","text":"<ul> <li>CLI Reference - Command-line usage</li> <li>Panel Mode - MSK-ACCESS workflows</li> </ul>"},{"location":"nextflow/examples/","title":"Examples","text":""},{"location":"nextflow/examples/#nextflow-examples","title":"Nextflow Examples","text":"<p>Common workflows for batch processing with Krewlyzer.</p>"},{"location":"nextflow/examples/#basic-run","title":"Basic Run","text":"<pre><code>nextflow run msk-access/krewlyzer \\\n    --samplesheet samples.csv \\\n    --ref /path/to/hg19.fa \\\n    --outdir results/\n</code></pre>"},{"location":"nextflow/examples/#msk-access-panel","title":"MSK-ACCESS Panel","text":"<pre><code>nextflow run msk-access/krewlyzer \\\n    --samplesheet samples.csv \\\n    --ref /path/to/hg19.fa \\\n    --asset_dir /path/to/krewlyzer/data/ \\\n    --outdir results/\n</code></pre> <p>With samplesheet: </p><pre><code>sample,bam,mfsd_bam,meth_bam,vcf,bed,maf,single_sample_maf,assay,pon,targets\nACCESS_001,/data/sample1.bam,,,,,,false,XS2,,\nACCESS_002,/data/sample2.bam,,,,,,false,XS2,,\n</code></pre><p></p>"},{"location":"nextflow/examples/#with-variant-analysis","title":"With Variant Analysis","text":"<pre><code>nextflow run msk-access/krewlyzer \\\n    --samplesheet samples.csv \\\n    --ref /path/to/hg19.fa \\\n    --outdir results/\n</code></pre> <p>With samplesheet: </p><pre><code>sample,bam,mfsd_bam,meth_bam,vcf,bed,maf,single_sample_maf,assay,pon,targets\nSAMPLE_001,/data/sample1.bam,,,/data/variants.vcf,,,,XS2,,\nSAMPLE_002,/data/sample2.bam,,,,,,/data/cohort.maf,false,XS2,,\n</code></pre><p></p>"},{"location":"nextflow/examples/#using-docker","title":"Using Docker","text":"<pre><code>nextflow run msk-access/krewlyzer \\\n    -profile docker \\\n    --samplesheet samples.csv \\\n    --ref /path/to/hg19.fa \\\n    --outdir results/\n</code></pre>"},{"location":"nextflow/examples/#slurm-cluster","title":"SLURM Cluster","text":"<pre><code>nextflow run msk-access/krewlyzer \\\n    -profile slurm \\\n    --samplesheet samples.csv \\\n    --ref /path/to/hg19.fa \\\n    --outdir results/\n</code></pre>"},{"location":"nextflow/examples/#iris-hpc-msk","title":"IRIS HPC (MSK)","text":"<p>For running on MSKCC's IRIS cluster, use the nf-core/configs institutional profile:</p> <pre><code>nextflow run msk-access/krewlyzer \\\n    -profile iris \\\n    --samplesheet samples.csv \\\n    --ref /data1/ref/hg19/hg19.fa \\\n    --outdir /scratch/$GROUP/results/\n</code></pre> <p>Tip</p> <p>The <code>iris</code> profile automatically configures: - SLURM executor with proper queue settings - Singularity with pre-cached images at <code>/data1/core006/resources/singularity_image_library</code> - Scratch paths and work directories</p> <p>For preemptable (faster) queue:</p> <pre><code>nextflow run msk-access/krewlyzer \\\n    -profile iris \\\n    --preemptable true \\\n    --samplesheet samples.csv \\\n    --ref /data1/ref/hg19/hg19.fa \\\n    --outdir /scratch/$GROUP/results/\n</code></pre>"},{"location":"nextflow/examples/#resume-failed-run","title":"Resume Failed Run","text":"<pre><code>nextflow run msk-access/krewlyzer \\\n    -resume \\\n    --samplesheet samples.csv \\\n    --ref /path/to/hg19.fa \\\n    --outdir results/\n</code></pre>"},{"location":"nextflow/outputs/","title":"Outputs","text":""},{"location":"nextflow/outputs/#nextflow-outputs","title":"Nextflow Outputs","text":"<p>Output files produced by the Krewlyzer Nextflow pipeline.</p>"},{"location":"nextflow/outputs/#wgs-output-directory","title":"WGS Output Directory","text":"<pre><code>results/\n\u251c\u2500\u2500 {sample}.bed.gz                         # Extracted fragments\n\u251c\u2500\u2500 {sample}.bed.gz.tbi                     # Tabix index\n\u251c\u2500\u2500 {sample}.metadata.json                  # Run metadata and QC metrics\n\u251c\u2500\u2500 {sample}.correction_factors.tsv         # GC correction factors\n\u251c\u2500\u2500 {sample}.EndMotif.tsv                   # 4-mer end motif frequencies\n\u251c\u2500\u2500 {sample}.EndMotif1mer.tsv               # 1-mer end motif + Jagged Index\n\u251c\u2500\u2500 {sample}.BreakPointMotif.tsv            # Breakpoint motif frequencies\n\u251c\u2500\u2500 {sample}.MDS.tsv                        # Motif Diversity Score\n\u251c\u2500\u2500 {sample}.FSC.tsv                        # Fragment size coverage (off-target)\n\u251c\u2500\u2500 {sample}.FSR.tsv                        # Fragment size ratio\n\u251c\u2500\u2500 {sample}.FSD.tsv                        # Fragment size distribution (per arm)\n\u251c\u2500\u2500 {sample}.WPS.parquet                    # WPS nucleosome profiles (foreground)\n\u251c\u2500\u2500 {sample}.WPS_background.parquet         # WPS Alu stacking (background)\n\u251c\u2500\u2500 {sample}.OCF.tsv                        # OCF tissue-of-origin scores\n\u251c\u2500\u2500 {sample}.OCF.sync.tsv                   # OCF sync scores (detail)\n\u251c\u2500\u2500 {sample}.TFBS.tsv                       # TFBS entropy (808 TFs)\n\u251c\u2500\u2500 {sample}.ATAC.tsv                       # ATAC entropy (23 cancer types)\n\u2514\u2500\u2500 {sample}.features.json                  # Unified ML features (--generate_json)\n</code></pre>"},{"location":"nextflow/outputs/#panel-mode-outputs-with-assay-or-targets","title":"Panel Mode Outputs (with <code>--assay</code> or <code>--targets</code>)","text":"<p>When assay or targets are provided, additional on-target and panel-specific files are generated:</p> <pre><code>results/\n\u251c\u2500\u2500 ... (all WGS outputs above) ...\n\u2502\n\u2502\u2500\u2500 # GC Correction\n\u251c\u2500\u2500 {sample}.correction_factors.ontarget.tsv    # On-target GC factors\n\u2502\n\u2502\u2500\u2500 # Motif (on-target split)\n\u251c\u2500\u2500 {sample}.EndMotif.ontarget.tsv\n\u251c\u2500\u2500 {sample}.BreakPointMotif.ontarget.tsv\n\u251c\u2500\u2500 {sample}.MDS.ontarget.tsv\n\u2502\n\u2502\u2500\u2500 # FSC (gene-centric + regions)\n\u251c\u2500\u2500 {sample}.FSC.ontarget.tsv                   # On-target FSC\n\u251c\u2500\u2500 {sample}.FSC.gene.tsv                       # Gene-level FSC (e.g., 146 genes for xs2)\n\u251c\u2500\u2500 {sample}.FSC.regions.tsv                    # Per-exon/target FSC\n\u251c\u2500\u2500 {sample}.FSC.regions.e1only.tsv             # E1-only FSC (first exon per gene)\n\u2502\n\u2502\u2500\u2500 # FSD (on-target split)\n\u251c\u2500\u2500 {sample}.FSD.ontarget.tsv\n\u2502\n\u2502\u2500\u2500 # WPS (panel-specific anchors)\n\u251c\u2500\u2500 {sample}.WPS.panel.parquet                  # Panel gene WPS profiles\n\u2502\n\u2502\u2500\u2500 # OCF (on/off-target + panel-filtered OCRs)\n\u251c\u2500\u2500 {sample}.OCF.ontarget.tsv\n\u251c\u2500\u2500 {sample}.OCF.ontarget.sync.tsv\n\u251c\u2500\u2500 {sample}.OCF.offtarget.tsv\n\u251c\u2500\u2500 {sample}.OCF.offtarget.sync.tsv\n\u2502\n\u2502\u2500\u2500 # TFBS/ATAC (on-target + sync)\n\u251c\u2500\u2500 {sample}.TFBS.ontarget.tsv\n\u251c\u2500\u2500 {sample}.TFBS.sync.tsv\n\u251c\u2500\u2500 {sample}.TFBS.ontarget.sync.tsv\n\u251c\u2500\u2500 {sample}.ATAC.ontarget.tsv\n\u251c\u2500\u2500 {sample}.ATAC.sync.tsv\n\u251c\u2500\u2500 {sample}.ATAC.ontarget.sync.tsv\n\u2502\n\u2502\u2500\u2500 # Region MDS (per-gene/exon)\n\u251c\u2500\u2500 {sample}.MDS.exon.tsv                       # Per-exon MDS scores\n\u2514\u2500\u2500 {sample}.MDS.gene.tsv                       # Gene-level aggregated MDS\n</code></pre>"},{"location":"nextflow/outputs/#mfsd-variant-outputs-with-vcfmaf-in-samplesheet","title":"mFSD Variant Outputs (with VCF/MAF in samplesheet)","text":"<pre><code>results/\n\u251c\u2500\u2500 {sample}.mFSD.tsv                       # Per-variant mFSD summary\n\u2514\u2500\u2500 {sample}.mFSD.distributions.tsv         # Per-variant size distributions (optional)\n</code></pre>"},{"location":"nextflow/outputs/#uxm-methylation-outputs-with-meth_bam-in-samplesheet","title":"UXM Methylation Outputs (with <code>meth_bam</code> in samplesheet)","text":"<pre><code>results/\n\u2514\u2500\u2500 {sample}.UXM.tsv                        # Fragment-level methylation\n</code></pre>"},{"location":"nextflow/outputs/#available-modules","title":"Available Modules","text":"Module Description <code>KREWLYZER_EXTRACT</code> Fragment extraction <code>KREWLYZER_FSC</code> Fragment Size Coverage <code>KREWLYZER_FSR</code> Fragment Size Ratio <code>KREWLYZER_FSD</code> Fragment Size Distribution <code>KREWLYZER_WPS</code> Windowed Protection Score <code>KREWLYZER_OCF</code> Orientation cfDNA Fragmentation <code>KREWLYZER_MOTIF</code> End Motif &amp; MDS <code>KREWLYZER_REGION_ENTROPY</code> TFBS/ATAC entropy <code>KREWLYZER_REGION_MDS</code> Per-gene MDS <code>KREWLYZER_UXM</code> Methylation <code>KREWLYZER_MFSD</code> Mutant Fragment Size <code>KREWLYZER_RUNALL</code> Full pipeline <code>KREWLYZER_BUILD_PON</code> Build PON"},{"location":"nextflow/parameters/","title":"Parameters","text":""},{"location":"nextflow/parameters/#nextflow-parameters","title":"Nextflow Parameters","text":"<p>All parameters for the Krewlyzer Nextflow pipeline. See <code>nextflow.config</code> for defaults.</p>"},{"location":"nextflow/parameters/#required-parameters","title":"Required Parameters","text":"Parameter Description <code>--samplesheet</code> CSV with sample information (format) <code>--ref</code> Reference genome FASTA (indexed)"},{"location":"nextflow/parameters/#general-parameters","title":"General Parameters","text":"Parameter Default Description <code>--outdir</code> <code>./results</code> Output directory <code>--asset_dir</code> Base directory for PON/targets (enables assay resolution) <code>--targets</code> Global target BED (fallback if not in samplesheet) <code>--genome</code> <code>hg19</code> Genome build (<code>hg19</code> or <code>hg38</code>) <code>--threads</code> <code>8</code> Threads per process <code>--verbose</code> <code>false</code> Enable verbose logging"},{"location":"nextflow/parameters/#mode-selection","title":"Mode Selection","text":"Parameter Default Description <code>--use_runall</code> <code>true</code> <code>true</code> = unified <code>run-all</code> (default), <code>false</code> = tool-level subworkflow"},{"location":"nextflow/parameters/#pon-parameters","title":"PON Parameters","text":"Parameter Default Description <code>--pon_model</code> Global PON model path (fallback) <code>--pon_variant</code> <code>all_unique</code> PON variant: <code>all_unique</code> or <code>duplex</code> <code>--skip_pon</code> <code>false</code> Skip PON z-score normalization"},{"location":"nextflow/parameters/#panel-wps-parameters","title":"Panel &amp; WPS Parameters","text":"Parameter Default Description <code>--bait_padding</code> <code>50</code> Bait edge padding for WPS (bp) <code>--wps_anchors</code> Custom WPS anchors BED (auto-loaded from assay if not set) <code>--wps_background</code> Custom WPS background Alu BED (auto-loaded if not set)"},{"location":"nextflow/parameters/#filter-algorithm-parameters","title":"Filter &amp; Algorithm Parameters","text":"Parameter Default Description <code>--mapq</code> <code>20</code> Minimum mapping quality <code>--minlen</code> <code>65</code> Minimum fragment length <code>--maxlen</code> <code>1000</code> Maximum fragment length <code>--min_baseq</code> <code>20</code> Minimum base quality for mFSD variant calling <code>--duplex</code> <code>true</code> Enable duplex weighting for mFSD (graceful fallback) <code>--skip_duplicates</code> <code>true</code> Skip duplicate reads <code>--require_proper_pair</code> <code>false</code> Require proper pairs (disable for duplex BAMs) <code>--exclude_regions</code> BED file of regions to exclude"},{"location":"nextflow/parameters/#feature-toggles","title":"Feature Toggles","text":"Parameter Default Description <code>--no_tfbs</code> <code>false</code> Disable TFBS region entropy <code>--no_atac</code> <code>false</code> Disable ATAC region entropy <code>--skip_target_regions</code> <code>false</code> Force WGS mode (ignore bundled targets) <code>--disable_e1_aggregation</code> <code>false</code> Skip E1-only FSC aggregation <code>--region_mds_e1_only</code> <code>false</code> Run region-MDS on E1 (first exon) only"},{"location":"nextflow/parameters/#output-parameters","title":"Output Parameters","text":"Parameter Default Description <code>--generate_json</code> <code>true</code> Generate unified <code>features.json</code> for ML pipelines"},{"location":"nextflow/parameters/#see-also","title":"See Also","text":"<ul> <li>Samplesheet Format</li> <li>CLI Parameters</li> <li>Pipeline Outputs</li> </ul>"},{"location":"nextflow/samplesheet/","title":"Samplesheet","text":""},{"location":"nextflow/samplesheet/#samplesheet-format","title":"Samplesheet Format","text":"<p>The Nextflow pipeline accepts a CSV samplesheet with the following columns:</p>"},{"location":"nextflow/samplesheet/#columns","title":"Columns","text":"<pre><code>sample,bam,mfsd_bam,meth_bam,vcf,bed,maf,single_sample_maf,assay,pon,targets\n</code></pre> Column Type Required Description <code>sample</code> TEXT \u2713 Sample identifier <code>bam</code> PATH \u2713 WGS/Panel BAM file (all_unique for panels) <code>mfsd_bam</code> PATH Duplex BAM for mFSD (falls back to <code>bam</code> if empty) <code>meth_bam</code> PATH Bisulfite BAM for UXM <code>vcf</code> PATH VCF for mFSD <code>bed</code> PATH Pre-extracted .bed.gz <code>maf</code> PATH MAF for mFSD <code>single_sample_maf</code> BOOL Skip MAF filtering if <code>true</code> <code>assay</code> TEXT Assay code: <code>XS1</code>, <code>XS2</code>, <code>WGS</code> <code>pon</code> PATH Sample-specific PON (overrides assay) <code>targets</code> PATH Sample-specific targets (overrides assay)"},{"location":"nextflow/samplesheet/#input-logic","title":"Input Logic","text":"Input Combination Workflow <code>bam</code> only Full run-all (extract \u2192 features) <code>bam</code> + <code>vcf</code>/<code>maf</code> run-all + mFSD <code>bam</code> + <code>mfsd_bam</code> + <code>maf</code> run-all with dual BAM support <code>meth_bam</code> only UXM methylation <code>bed</code> only FSC, FSR, FSD, WPS, OCF (no extract)"},{"location":"nextflow/samplesheet/#assay-resolution","title":"Assay Resolution","text":"<p>When <code>assay</code> is set and <code>--asset_dir</code> is provided:</p> Assay PON Targets Genes <code>XS1</code> <code>xs1.pon.parquet</code> <code>xs1.targets.bed</code> 128 <code>XS2</code> <code>xs2.pon.parquet</code> <code>xs2.targets.bed</code> 146 <code>WGS</code> <code>wgs.pon.parquet</code> None -"},{"location":"nextflow/samplesheet/#example","title":"Example","text":"<pre><code>sample,bam,mfsd_bam,meth_bam,vcf,bed,maf,single_sample_maf,assay,pon,targets\n# MSK-ACCESS V1 samples (auto-resolve PON/targets)\nACCESS_001,/data/sample1.bam,,,,,,,XS1,,\nACCESS_002,/data/sample2.bam,,,,,,/data/cohort.maf,false,XS2,,\n\n# MSK-ACCESS V2 with duplex BAM for mFSD\nACCESS_V2,/data/sample.all_unique.bam,/data/sample.duplex.bam,,,,,maf.tsv,true,XS2,,\n\n# WGS (no targets)\nWGS_001,/data/wgs.bam,,,/data/wgs.vcf,,,,,WGS,,\n\n# Custom PON/targets\nCUSTOM,/data/custom.bam,,,,,,,,,/data/custom.pon.parquet,/data/custom.bed\n</code></pre>"},{"location":"reference/architecture/","title":"Architecture","text":""},{"location":"reference/architecture/#architecture","title":"Architecture","text":"<p>Krewlyzer uses a hybrid Python/Rust architecture for optimal performance and usability.</p>"},{"location":"reference/architecture/#overview","title":"Overview","text":"<pre><code>flowchart TB\n    subgraph CLI[\"Python CLI (Typer)\"]\n        cli[krewlyzer CLI]\n        wrapper[wrapper.py]\n    end\n\n    subgraph Python[\"Python Layer\"]\n        extract[extract.py]\n        motif[motif.py]\n        fsc[fsc.py]\n        fsr[fsr.py]\n        wps[wps.py]\n        ocf[ocf.py]\n        mfsd[mfsd.py]\n        uxm[uxm.py]\n        region_mds[region_mds.py]\n    end\n\n    subgraph Rust[\"Rust Core (_core)\"]\n        lib[lib.rs]\n        extract_motif[extract_motif.rs]\n        motif_utils[motif_utils.rs]\n        region_mds_rs[region_mds.rs]\n        pipeline[pipeline.rs]\n        gc[gc_correction.rs]\n        pon[pon_model.rs]\n        engine[engine.rs]\n    end\n\n    cli --&gt; wrapper\n    wrapper --&gt; Python\n    Python --&gt; Rust\n</code></pre>  Use mouse to pan and zoom"},{"location":"reference/architecture/#rust-core-krewlyzer_core","title":"Rust Core (<code>krewlyzer._core</code>)","text":"<p>The performance-critical functions are implemented in Rust and exposed to Python via PyO3.</p>"},{"location":"reference/architecture/#module-structure","title":"Module Structure","text":"Module Size Purpose <code>lib.rs</code> 4KB PyO3 module definition, thread config <code>bed.rs</code> 4KB BGZF-first file reader - auto-detects BGZF vs gzip <code>extract_motif.rs</code> 17KB BAM parsing, fragment extraction, motif counting <code>motif_utils.rs</code> 4KB Shared 4-mer encoding and MDS calculation <code>region_mds.rs</code> 18KB Per-region MDS analysis (Helzer et al.) <code>region_entropy.rs</code> 15KB TFBS/ATAC region entropy with panel support <code>pipeline.rs</code> 10KB Unified FSC/FSD/WPS/OCF pipeline <code>fsc.rs</code> 11KB Fragment size coverage by bins <code>fsd.rs</code> 7KB Size distribution per arm <code>wps.rs</code> 18KB Windowed protection score <code>ocf.rs</code> 10KB Orientation-aware fragmentation <code>mfsd.rs</code> 35KB Mutant fragment size analysis <code>gc_correction.rs</code> 20KB LOESS-based GC bias correction <code>pon_model.rs</code> 7KB PON model loading and hybrid correction <code>gc_reference.rs</code> 20KB Pre-computed GC reference generation <code>filters.rs</code> 3KB Fragment filtering logic <code>pon_builder.rs</code> 15KB PON model construction <code>uxm.rs</code> 12KB Fragment-level methylation (UXM)"},{"location":"reference/architecture/#bgzf-first-file-reader-bedrs","title":"BGZF-First File Reader (<code>bed.rs</code>)","text":"<p>The <code>get_reader()</code> function provides smart compressed file handling:</p> <pre><code>flowchart LR\n    A[\".bed.gz file\"] --&gt; B{Is BGZF?}\n    B --&gt;|Yes| C[\"noodles::bgzf::Reader\"]\n    B --&gt;|No| D[\"flate2::MultiGzDecoder\"]\n    C --&gt; E[\"BufReader\"]\n    D --&gt; E\n</code></pre>  Use mouse to pan and zoom  <ul> <li>BGZF detection: Examines file header for BGZF magic bytes (<code>0x1f 0x8b</code> + <code>BC</code> subfield)</li> <li>Primary: Uses <code>noodles::bgzf::io::Reader</code> for BGZF files (tabix-indexed)</li> <li>Fallback: Uses <code>flate2::MultiGzDecoder</code> for standard gzip files</li> </ul> <p>This is critical because fragment BED files with <code>.tbi</code> indexes use BGZF compression, which contains multiple gzip blocks. Standard <code>GzDecoder</code> only reads the first block.</p>"},{"location":"reference/architecture/#shared-utilities-motif_utilsrs","title":"Shared Utilities: <code>motif_utils.rs</code>","text":"<p>The <code>motif_utils.rs</code> module provides shared DNA sequence manipulation functions used across multiple feature modules:</p> Function Signature Description <code>reverse_complement</code> <code>fn(seq: &amp;[u8]) -&gt; Vec&lt;u8&gt;</code> Reverses and complements DNA sequence (A\u2194T, G\u2194C) <code>kmer4_to_index</code> <code>fn(kmer: &amp;[u8]) -&gt; Option&lt;usize&gt;</code> Converts 4-mer to index 0-255 using 2-bit encoding <code>calculate_mds</code> <code>fn(counts: &amp;[u64; 256]) -&gt; f64</code> Shannon entropy of 4-mer histogram, normalized to [0,1] <code>calculate_gc</code> <code>fn(seq: &amp;[u8]) -&gt; f64</code> GC content as fraction of valid ACGT bases <p>Used by: - <code>extract_motif.rs</code> - Global MDS calculation from BAM - <code>region_mds.rs</code> - Per-gene MDS at exon boundaries</p> <p>Example usage (Rust): </p><pre><code>use crate::motif_utils::{kmer4_to_index, calculate_mds};\n\n// Count 4-mers\nlet mut counts = [0u64; 256];\nif let Some(idx) = kmer4_to_index(b\"ACGT\") {\n    counts[idx] += 1;\n}\n\n// Calculate MDS\nlet mds = calculate_mds(&amp;counts);  // Range: 0.0 (uniform) to 1.0 (max diversity)\n</code></pre><p></p>"},{"location":"reference/architecture/#key-functions-exposed","title":"Key Functions Exposed","text":"<pre><code>from krewlyzer import _core\n\n# Thread configuration\n_core.configure_threads(num_threads=8)\n\n# Fragment extraction\n_core.extract_motif.process_bam_parallel(\n    bam_path, reference_path, filters, ...\n)\n\n# Unified pipeline\n_core.run_unified_pipeline(\n    bed_path, gc_ref_path, valid_regions_path,\n    correction_out_path, correction_input_path,\n    fsc_bins, fsc_output,\n    wps_regions, wps_output,\n    wps_background_regions, wps_background_output, wps_empty,\n    fsd_arms, fsd_output,\n    ocf_regions, ocf_output,\n    target_regions_path, bait_padding, silent\n)\n\n# GC correction\n_core.gc.compute_and_write_gc_factors(...)\n</code></pre>"},{"location":"reference/architecture/#run_unified_pipeline-parameters","title":"run_unified_pipeline Parameters","text":"Parameter Type Description <code>bed_path</code> PathBuf Input .bed.gz file path <code>gc_ref_path</code> Option GC reference parquet for computing factors <code>valid_regions_path</code> Option Valid regions BED for GC <code>correction_out_path</code> Option Output path for computed GC factors <code>correction_input_path</code> Option Pre-computed GC factors TSV <code>fsc_bins</code> Option FSC/FSR bins BED <code>fsc_output</code> Option FSC output TSV path <code>wps_regions</code> Option WPS foreground anchors BED <code>wps_output</code> Option WPS foreground output parquet <code>wps_background_regions</code> Option WPS background (Alu) BED <code>wps_background_output</code> Option WPS background output parquet <code>wps_empty</code> bool Include empty WPS regions <code>fsd_arms</code> Option Chromosome arms BED for FSD <code>fsd_output</code> Option FSD output TSV path <code>ocf_regions</code> Option Open chromatin regions for OCF <code>ocf_output</code> Option OCF output directory <code>target_regions_path</code> Option Panel target BED (on/off split) <code>bait_padding</code> u64 Bait edge padding in bp (default: 50) <code>silent</code> bool Suppress progress output"},{"location":"reference/architecture/#python-layer","title":"Python Layer","text":"<p>The Python layer provides:</p> <ol> <li>CLI Interface (<code>cli.py</code>) - Typer-based commands</li> <li>Orchestration (<code>wrapper.py</code>) - run-all coordination</li> <li>Asset Management (<code>assets.py</code>) - Bundled data files</li> <li>Feature Modules - Per-tool logic (<code>fsc.py</code>, <code>fsr.py</code>, etc.)</li> <li>PON Integration (<code>pon/</code>) - Model loading and building</li> <li>Core Utilities (<code>core/</code>) - Shared helpers</li> </ol>"},{"location":"reference/architecture/#core-module-core","title":"Core Module (<code>core/</code>)","text":"File Purpose <code>sample_processor.py</code> Unified BAM extraction - <code>extract_sample()</code>, <code>write_motif_outputs()</code>, <code>write_extraction_outputs()</code> <code>unified_processor.py</code> Central feature runner - single-pass FSC/FSR/FSD/WPS/OCF via <code>run_features()</code> <code>asset_resolution.py</code> Centralized asset resolution - <code>resolve_target_regions()</code>, <code>resolve_pon_model()</code> for auto-loading <code>logging.py</code> Logging utilities - <code>log_startup_banner()</code>, <code>ResolvedAsset</code> dataclass <code>gc_assets.py</code> Centralized GC asset resolution <code>fsc_processor.py</code> FSC z-score computation <code>fsr_processor.py</code> FSR ratio calculation <code>wps_processor.py</code> WPS post-processing <code>wps_anchor_filter.py</code> Panel-specific anchor filtering <code>motif_processor.py</code> Motif file writing (EDM, BPM, MDS) <code>gene_bed.py</code> Gene BED parsing for FSC gene aggregation <code>feature_serializer.py</code> Unified JSON output generation <p>Architecture Note:  - <code>sample_processor.py</code> provides <code>extract_sample()</code> for unified BAM extraction used by <code>extract.py</code>, <code>motif.py</code>, <code>wrapper.py</code>, and <code>build-pon</code> - <code>unified_processor.py</code> provides <code>run_features()</code> for unified feature extraction used by all CLI tools and <code>wrapper.py</code></p>"},{"location":"reference/architecture/#recent-improvements-2024-2025","title":"Recent Improvements (2024-2025)","text":"Change Files Benefit Unified Extraction <code>core/sample_processor.py</code> Single <code>extract_sample()</code> for all BAM extraction, ~150 lines reduced Unified Processor <code>core/unified_processor.py</code> Single entry point for all features, ~350 lines reduced GC Asset Helper <code>core/gc_assets.py</code> Eliminated 100+ lines duplication Dual WPS Output <code>wps.py</code>, <code>wrapper.py</code> Panel + genome-wide WPS JSON Serializer <code>core/feature_serializer.py</code> Unified ML output Assay Support <code>assets.py</code>, <code>wrapper.py</code> MSK-ACCESS v1/v2 auto-resolution"},{"location":"reference/architecture/#asset-management","title":"Asset Management","text":"<p>The <code>AssetManager</code> class in <code>assets.py</code> provides centralized resolution of bundled data files based on genome build.</p>"},{"location":"reference/architecture/#initialization","title":"Initialization","text":"<pre><code>from krewlyzer.assets import AssetManager\n\nassets = AssetManager(\"hg19\")  # or \"hg38\", \"GRCh37\", \"GRCh38\"\nprint(assets.genome_dir)       # \"GRCh37\"\nprint(assets.file_prefix)      # \"hg19\"\n</code></pre>"},{"location":"reference/architecture/#asset-properties","title":"Asset Properties","text":"Property Path Pattern Used By <code>bins_100kb</code> <code>ChromosomeBins/{genome}/{prefix}_window_100kb.bed.gz</code> FSC, FSR <code>arms</code> <code>ChromosomeArms/{genome}/{prefix}.arms.bed.gz</code> FSD <code>wps_anchors</code> <code>WpsAnchors/{genome}/{prefix}.wps_anchors.bed.gz</code> WPS <code>wps_background</code> <code>WpsBackground/{genome}/{prefix}.alu_consensus.bed.gz</code> WPS <code>ocf_regions</code> <code>OpenChromatinRegion/{genome}/7specificTissue.all.OC.bed.gz</code> OCF <code>gc_ref</code> <code>gc/{genome}/ref_genome_GC_{prefix}.parquet</code> GC correction <code>valid_regions</code> <code>gc/{genome}/valid_regions_{prefix}.bed.gz</code> GC correction <code>exclude_regions</code> <code>exclude-regions/{genome}/{prefix}-blacklist.v2.bed.gz</code> Extract"},{"location":"reference/architecture/#assay-specific-assets","title":"Assay-Specific Assets","text":"<p>For MSK-ACCESS panels, <code>AssetManager</code> provides assay-aware resolution:</p> <pre><code># Get panel-specific WPS anchors\nxs2_anchors = assets.get_wps_anchors(\"xs2\")  \n# \u2192 WpsAnchors/GRCh37/xs2.wps_anchors.bed.gz\n\n# Get panel targets\nxs2_targets = assets.get_targets(\"xs2\")\n# \u2192 targets/GRCh37/xs2.targets.bed\n\n# Get panel PON\nxs2_pon = assets.get_pon(\"xs2\")\n# \u2192 pon/GRCh37/xs2.all_unique.pon.parquet\n</code></pre>"},{"location":"reference/architecture/#auto-loading-with-assay","title":"Auto-Loading with <code>--assay</code>","text":"<p>All CLI tools support auto-loading bundled assets via <code>--assay</code>:</p> <pre><code># Auto-loads PON and target regions for xs2\nkrewlyzer run-all -i sample.bam -o out/ --assay xs2\n</code></pre> <p>Asset resolution follows this priority: 1. Explicit path (<code>--target-regions</code>, <code>--pon-model</code>) - highest 2. Skip flag (<code>--skip-target-regions</code>, <code>--skip-pon</code>) 3. Bundled asset (auto-loaded from <code>--assay</code>) 4. None - WGS mode</p> Assay WPS Anchors Target Genes PON <code>xs1</code> (MSK-ACCESS v1) 1,611 128 \u2713 <code>xs2</code> (MSK-ACCESS v2) 1,820 146 \u2713"},{"location":"reference/architecture/#data-folder-structure","title":"Data Folder Structure","text":"<pre><code>data/\n\u251c\u2500\u2500 ChromosomeArms/{GRCh37,GRCh38}/\n\u251c\u2500\u2500 ChromosomeBins/{GRCh37,GRCh38}/\n\u251c\u2500\u2500 WpsAnchors/{GRCh37,GRCh38}/\n\u2502   \u251c\u2500\u2500 {hg19,hg38}.wps_anchors.bed.gz    # Genome-wide\n\u2502   \u251c\u2500\u2500 xs1.wps_anchors.bed.gz             # MSK-ACCESS v1\n\u2502   \u2514\u2500\u2500 xs2.wps_anchors.bed.gz             # MSK-ACCESS v2\n\u251c\u2500\u2500 WpsBackground/{GRCh37,GRCh38}/\n\u251c\u2500\u2500 OpenChromatinRegion/{GRCh37}/          # hg19 only\n\u251c\u2500\u2500 gc/{GRCh37,GRCh38}/\n\u251c\u2500\u2500 genes/{GRCh37}/                         # Gene BEDs per assay\n\u251c\u2500\u2500 targets/{GRCh37}/                       # Target BEDs per assay\n\u2514\u2500\u2500 pon/{GRCh37}/                           # Pre-built PON models\n</code></pre>"},{"location":"reference/architecture/#python-vs-rust-responsibilities","title":"Python vs Rust Responsibilities","text":""},{"location":"reference/architecture/#by-feature","title":"By Feature","text":"Feature Rust (Fast Path) Python (Orchestration) Extract BAM parsing, fragment filtering, BED writing File I/O orchestration Motif k-mer counting, GC observation File writing, MDS calculation FSC Fragment counting per bin, GC correction PON z-score overlay FSR Fragment ratio calculation PON z-score overlay FSD Size histogram per arm, on/off-target split PON log-ratio normalization WPS Protection score, Savitzky-Golay, FFT, NRL PON z-score subtraction OCF Strand asymmetry calculation PON z-score overlay mFSD Variant-level size profiles Output formatting UXM Methylation state extraction Output formatting"},{"location":"reference/architecture/#by-operation-type","title":"By Operation Type","text":"Operation Language File BAM reading Rust <code>extract_motif.rs</code> Fragment extraction Rust <code>extract_motif.rs</code> Target region intersection Rust <code>fsd.rs</code>, <code>extract_motif.rs</code> GC observation collection Rust <code>extract_motif.rs</code> GC LOESS fitting Rust <code>gc_correction.rs</code> Correction factor application Rust Consumers in <code>pipeline.rs</code> FSC/FSD/WPS/OCF counting Rust <code>pipeline.rs</code> Savitzky-Golay smoothing Rust <code>wps.rs</code> FFT periodicity (NRL) Rust <code>wps.rs</code> PON z-score (FSD, WPS, OCF, TFBS/ATAC) Rust <code>fsd.rs</code>, <code>wps.rs</code>, <code>ocf.rs</code>, <code>region_entropy.rs</code> Gene FSC aggregation Rust <code>fsc.rs</code> PON baseline loading Rust via Parquet in z-score functions PON building Python <code>pon/build.py</code> File I/O coordination Python <code>wrapper.py</code>, feature modules CLI parsing Python <code>cli.py</code>, Typer"},{"location":"reference/architecture/#completed-rust-migrations","title":"Completed Rust Migrations \u2705","text":"Component Function Speedup FSD log-ratio normalization <code>fsd.apply_pon_logratio</code> 10-50x WPS PON z-score subtraction <code>wps.apply_pon_zscore</code> 5-20x GC bias aggregation <code>pon_builder.compute_gc_bias_model</code> 3-10x FSD baseline aggregation <code>pon_builder.compute_fsd_baseline</code> 3-10x WPS baseline aggregation <code>pon_builder.compute_wps_baseline</code> 3-10x OCF PON z-score <code>ocf.apply_pon_zscore</code> 5-20x TFBS/ATAC PON z-score <code>region_entropy.apply_pon_zscore</code> 5-20x Gene FSC aggregation <code>fsc.aggregate_by_gene</code> 3-10x"},{"location":"reference/architecture/#rust-first-fallback-strategy","title":"Rust-First Fallback Strategy","text":"<p>All performance-critical functions use Rust-first with Python fallback:</p> <pre><code># Pattern used in fsd_processor.py, wps_processor.py, build.py\ntry:\n    from krewlyzer import _core\n    result = _core.module.function(args)  # Rust (10-50x faster)\n    if result:\n        return result\nexcept Exception as e:\n    logger.debug(f\"Rust failed: {e}\")\n\n# Python fallback (slower but always available)\nreturn python_implementation(args)\n</code></pre> <p>Benefits: - \u2705 Performance: Rust path is 3-50x faster - \u2705 Reliability: Python fallback if Rust extension fails - \u2705 Debugging: Python code is easier to step through - \u2705 Accuracy: Both paths produce identical results</p>"},{"location":"reference/architecture/#execution-flow","title":"Execution Flow","text":"<pre><code>flowchart TB\n    subgraph \"1. CLI Layer\"\n        CLI[\"krewlyzer run-all\"]\n        CLI --&gt; WRAPPER[\"wrapper.py\"]\n    end\n\n    subgraph \"2. Asset Resolution\"\n        WRAPPER --&gt; ASSETS[\"AssetManager(genome)\"]\n        ASSETS --&gt; |\"bins_100kb, arms, wps_anchors...\"| CONFIG[\"Tool Configuration\"]\n    end\n\n    subgraph \"3. Extraction (Rust)\"\n        CONFIG --&gt; EXTRACT[\"_core.extract_motif.process_bam_parallel()\"]\n        EXTRACT --&gt; BED[\"sample.bed.gz\"]\n        EXTRACT --&gt; MOTIF[\"EndMotif.tsv, MDS.tsv\"]\n        EXTRACT --&gt; GC_OBS[\"GC observations\"]\n    end\n\n    subgraph \"4. GC Correction (Rust)\"\n        GC_OBS --&gt; GC_LOESS[\"_core.gc.compute_gc_factors()\"]\n        GC_LOESS --&gt; GC_FACTORS[\"correction_factors.tsv\"]\n    end\n\n    subgraph \"5. Unified Pipeline (Rust)\"\n        BED --&gt; UNIFIED[\"_core.run_unified_pipeline()\"]\n        GC_FACTORS --&gt; UNIFIED\n        UNIFIED --&gt; FSC_RAW[\"fsc_counts.tsv\"]\n        UNIFIED --&gt; FSD_RAW[\"FSD.tsv\"]\n        UNIFIED --&gt; WPS_RAW[\"WPS.parquet\"]\n        UNIFIED --&gt; OCF_RAW[\"OCF.tsv\"]\n    end\n\n    subgraph \"6. Post-Processing (Python)\"\n        FSC_RAW --&gt; FSC_PROC[\"fsc_processor.py\"]\n        FSC_RAW --&gt; FSR_PROC[\"fsr_processor.py\"]\n        FSD_RAW --&gt; FSD_PROC[\"fsd_processor.py\"]\n        WPS_RAW --&gt; WPS_PROC[\"wps_processor.py\"]\n\n        PON[\"PON Model\"] --&gt; FSC_PROC &amp; FSR_PROC &amp; FSD_PROC &amp; WPS_PROC\n\n        FSC_PROC --&gt; FSC_OUT[\"FSC.tsv (z-scores)\"]\n        FSR_PROC --&gt; FSR_OUT[\"FSR.tsv (ratios)\"]\n        FSD_PROC --&gt; FSD_OUT[\"FSD.tsv (logR)\"]\n        WPS_PROC --&gt; WPS_OUT[\"WPS.parquet (smoothed)\"]\n    end\n</code></pre>  Use mouse to pan and zoom  <p>Key Points:</p> <ol> <li>Single BAM Read: Extraction reads BAM once, outputs BED.gz + motifs</li> <li>GC Correction First: LOESS-based correction computed before features</li> <li>Single BED Pass: <code>run_unified_pipeline()</code> processes BED.gz once for all features</li> <li>Python Post-processing: PON normalization and z-scores added in Python</li> <li>Parallel Features: FSC, FSD, WPS, OCF computed simultaneously in Rust</li> </ol>"},{"location":"reference/architecture/#performance-characteristics","title":"Performance Characteristics","text":"Operation Engine Parallelism BAM reading Rust (htslib) Multi-threaded Fragment extraction Rust Rayon parallel Motif counting Rust Rayon parallel FSC/FSD/WPS/OCF Rust pipeline Single-pass I/O GC correction Rust LOESS Per-fragment-type mFSD Rust Per-variant parallel UXM Rust Per-region parallel"},{"location":"reference/architecture/#speedup-vs-pure-python","title":"Speedup vs Pure Python","text":"<ul> <li>3-4x faster for large BAM files (&gt;100M reads)</li> <li>Single-pass I/O for unified pipeline (vs 4 separate passes)</li> <li>Rayon parallelism scales with CPU cores</li> </ul>"},{"location":"reference/architecture/#building-from-source","title":"Building from Source","text":""},{"location":"reference/architecture/#requirements","title":"Requirements","text":"<ul> <li>Python 3.10+</li> <li>Rust toolchain (via rustup)</li> <li>C compiler (clang recommended)</li> <li>htslib development headers</li> </ul>"},{"location":"reference/architecture/#build-steps","title":"Build Steps","text":"<pre><code># Clone and enter\ngit clone https://github.com/msk-access/krewlyzer.git\ncd krewlyzer\n\n# Create environment\nuv venv .venv &amp;&amp; source .venv/bin/activate\n\n# Build Rust extension\ncd rust &amp;&amp; maturin develop --release\ncd ..\n\n# Install Python package\nuv pip install -e \".[dev,test]\"\n\n# Verify\npython -c \"from krewlyzer import _core; print(_core.version())\"\n</code></pre>"},{"location":"reference/architecture/#extending-krewlyzer","title":"Extending Krewlyzer","text":""},{"location":"reference/architecture/#adding-a-new-rust-function","title":"Adding a New Rust Function","text":"<ol> <li>Add function in <code>rust/src/mymodule.rs</code></li> <li>Export via PyO3 in <code>rust/src/lib.rs</code></li> <li>Call from Python: <code>_core.mymodule.my_function(...)</code></li> </ol>"},{"location":"reference/architecture/#adding-a-new-feature-tool","title":"Adding a New Feature Tool","text":"<ol> <li>Create <code>src/krewlyzer/myfeature.py</code></li> <li>Add CLI command in <code>src/krewlyzer/cli.py</code></li> <li>Optionally add to <code>wrapper.py</code> for run-all integration</li> </ol>"},{"location":"reference/glossary/","title":"Glossary","text":""},{"location":"reference/glossary/#glossary","title":"Glossary","text":"<p>Quick reference for terminology used throughout Krewlyzer documentation.</p>"},{"location":"reference/glossary/#biological-terms","title":"Biological Terms","text":""},{"location":"reference/glossary/#dna-chromatin","title":"DNA &amp; Chromatin","text":"Term Plain English Technical Definition cfDNA DNA floating in blood Cell-free DNA - short DNA fragments released from dying cells into the bloodstream ctDNA Tumor DNA in blood Circulating tumor DNA - the fraction of cfDNA originating from cancer cells Nucleosome DNA packaging unit Histone octamer with ~147bp of DNA wrapped around it; the fundamental unit of chromatin Chromatin DNA + proteins The complex of DNA and histone proteins that makes up chromosomes Linker DNA DNA between spools The ~20bp of DNA connecting adjacent nucleosomes Mono-nucleosomal One wrapped loop Fragment derived from a single nucleosome (~145-180bp) Di-nucleosomal Two wrapped loops Fragment spanning two nucleosomes (~300-340bp)"},{"location":"reference/glossary/#fragment-characteristics","title":"Fragment Characteristics","text":"Term Plain English Technical Definition Fragment One piece of DNA A single cfDNA molecule with defined start and end positions Fragment length DNA piece size The number of base pairs from the 5' end to 3' end of a fragment End motif Cutting pattern The 4-nucleotide sequence at the 5' end of a fragment Breakpoint motif Internal cut The sequence context where a fragment was cut"},{"location":"reference/glossary/#genomic-context","title":"Genomic Context","text":"Term Plain English Technical Definition Chromosome arm Half of a chromosome The p (short) or q (long) arm of a chromosome, separated by the centromere GC content Letter composition The percentage of G (guanine) and C (cytosine) bases in a sequence Open chromatin Accessible DNA Genomic regions not tightly wrapped, allowing transcription factor access TSS Gene start site Transcription Start Site - where RNA polymerase begins transcribing CTCF site DNA organizer CCCTC-binding factor sites that organize 3D chromatin structure Alu element Repeated sequence A ~300bp repetitive element found ~1 million times in the human genome"},{"location":"reference/glossary/#sequencing-alignment-terms","title":"Sequencing &amp; Alignment Terms","text":""},{"location":"reference/glossary/#read-processing","title":"Read Processing","text":"Term Plain English Technical Definition BAM file Aligned sequences Binary Alignment Map - compressed file containing sequencing reads aligned to a reference genome Read Sequenced chunk A single sequence generated by the sequencer (R1 = forward, R2 = reverse) Read pair Two matching reads R1 and R2 reads from the same DNA fragment (paired-end sequencing) Proper pair Good alignment Read pair where both reads align correctly in expected orientation and distance MAPQ Alignment confidence Mapping quality - Phred-scaled probability that alignment position is wrong Duplicate PCR copy Multiple reads from the same original molecule (amplification artifact)"},{"location":"reference/glossary/#quality-thresholds","title":"Quality Thresholds","text":"Setting Plain English Krewlyzer Default MAPQ \u2265 20 High confidence alignment 99% probability alignment is correct Min length 65bp Not too short Excludes fragments smaller than most cfDNA Max length 400bp Not too long Excludes di-nucleosomal and larger fragments Skip duplicates Remove PCR copies Ensures each molecule counted once Require proper pair Good read pairs only May need to disable for duplex/consensus BAMs"},{"location":"reference/glossary/#krewlyzer-feature-terms","title":"Krewlyzer Feature Terms","text":""},{"location":"reference/glossary/#fragment-size-features","title":"Fragment Size Features","text":"Feature Measures Higher Value Means FSC (Coverage) Fragment count per genomic bin More fragments in that region FSR (Ratio) Short \u00f7 Long fragment ratio More tumor-derived DNA FSD (Distribution) Size histogram per arm (Shape matters, not value)"},{"location":"reference/glossary/#size-bin-definitions-rust-backend","title":"Size Bin Definitions (Rust Backend)","text":"Bin Name Size Range Biological Meaning ultra_short 65-99bp Sub-nucleosomal, TF footprints core_short 100-149bp Tumor-enriched (primary biomarker) mono_nucl 150-259bp Standard mono-nucleosomal cfDNA di_nucl 260-399bp Di-nucleosomal and larger long 400+bp Very long fragments (rare)"},{"location":"reference/glossary/#nucleosome-features","title":"Nucleosome Features","text":"Feature Measures Higher Value Means WPS Protection score at each position Nucleosome present (positive) or absent (negative) NRL Nucleosome Repeat Length Expected ~190bp; deviation suggests abnormality nrl_quality Periodicity strength (0-1) Clearer nucleosome spacing pattern"},{"location":"reference/glossary/#other-features","title":"Other Features","text":"Feature Measures Higher Value Means MDS Motif Diversity Score More diverse (potentially tumor-related) end motifs OCF Orientation asymmetry Tissue-specific fragmentation pattern mFSD Mutant vs wild-type sizes ALT shorter than REF = ctDNA present"},{"location":"reference/glossary/#normalization-terms","title":"Normalization Terms","text":""},{"location":"reference/glossary/#gc-correction","title":"GC Correction","text":"Term Plain English Technical Definition GC bias Uneven amplification PCR/capture preferentially amplifies certain GC contents LOESS Smoothing algorithm Locally Estimated Scatterplot Smoothing - fits local regression curves Correction factor Adjustment weight Multiplier to remove GC-related count biases"},{"location":"reference/glossary/#panel-of-normals-pon","title":"Panel of Normals (PON)","text":"Term Plain English Technical Definition PON Healthy baseline Panel of Normals - reference statistics from healthy samples Z-score Deviation from normal (Sample - PON_mean) / PON_std; measures abnormality Log-ratio Relative change log\u2082(Sample / PON_expected); positive = elevated PON stability Reliability weight 1 / (variance + k); higher = more trustworthy comparison"},{"location":"reference/glossary/#panel-sequencing-terms","title":"Panel Sequencing Terms","text":""},{"location":"reference/glossary/#target-capture","title":"Target Capture","text":"Term Plain English Technical Definition Panel Targeted genes Capture probe set designed to sequence specific genomic regions On-target Captured regions Fragments overlapping panel target regions Off-target Background DNA Fragments not overlapping targets (unbiased background) Bait Capture probe Oligonucleotide used to pull down target DNA in hybridization capture Bait padding Edge buffer bp to trim from bait edges to avoid capture artifacts"},{"location":"reference/glossary/#msk-access-assay-codes","title":"MSK-ACCESS Assay Codes","text":"Code Description XS1 MSK-ACCESS v1.0 panel XS2 MSK-ACCESS v2.0 panel WGS Whole Genome Sequencing (no targets)"},{"location":"reference/glossary/#file-format-terms","title":"File Format Terms","text":"Extension Description Generated By <code>.bam</code> Aligned reads External aligner (BWA, etc.) <code>.bed.gz</code> Fragment coordinates <code>krewlyzer extract</code> <code>.tsv</code> Tab-separated features All feature commands <code>.parquet</code> Columnar data format WPS (efficient for large arrays) <code>.pon.parquet</code> PON model <code>krewlyzer pon build</code>"},{"location":"reference/glossary/#see-also","title":"See Also","text":"<ul> <li>What is Cell-Free DNA? - Biological context</li> <li>Getting Started - Quick start guide</li> <li>Troubleshooting - Common issues</li> </ul>"},{"location":"reference/input-formats/","title":"Input Formats","text":""},{"location":"reference/input-formats/#input-file-formats","title":"Input File Formats","text":"<p>This page documents the expected formats for custom input files used as overrides. Krewlyzer validates these formats when you provide custom files.</p>"},{"location":"reference/input-formats/#quick-reference","title":"Quick Reference","text":"File Type Columns Used By Example Sample List paths <code>build-pon</code> <code>/path/to/sample.bam</code> BED3 chrom, start, end <code>--bin-input</code>, <code>--target-regions</code> <code>chr1\\t0\\t100000</code> Gene BED chrom, start, end, gene, [name] <code>--gene-bed</code> <code>chr1\\t100\\t5000\\tTP53\\texon1</code> Arms BED chrom, start, end, arm <code>--arms-file</code> <code>chr1\\t0\\t125000000\\t1p</code> WPS Anchors BED6 format <code>--wps-anchors</code>, <code>--wps-background</code> <code>chr1\\t1000\\t2000\\tGene_TSS\\t0\\t+</code> Region BED chrom, start, end, label <code>--ocr-file</code>, <code>--tfbs-regions</code>, <code>--atac-regions</code> <code>chr1\\t500\\t800\\tLiver</code> GC Factors TSV length_bin, gc_pct, factor <code>--gc-factors</code> <code>10\\t45\\t1.05</code>"},{"location":"reference/input-formats/#sample-list","title":"Sample List","text":"<p>Plain text file with one sample path per line for PON building.</p>"},{"location":"reference/input-formats/#format","title":"Format","text":"<pre><code>/path/to/sample1.bam\n/path/to/sample2.bam\n/path/to/sample3.bed.gz\n</code></pre> Input Type Description <code>.bam</code> / <code>.cram</code> Full processing including MDS baseline <code>.bed.gz</code> Pre-extracted fragments (faster, no MDS)"},{"location":"reference/input-formats/#notes","title":"Notes","text":"<ul> <li>One path per line</li> <li>No header row</li> <li>Paths can be absolute or relative to working directory</li> <li>Mixing BAM and BED.gz inputs is allowed</li> </ul>"},{"location":"reference/input-formats/#used-by","title":"Used By","text":"<ul> <li><code>build-pon SAMPLE_LIST</code> - First positional argument</li> </ul>"},{"location":"reference/input-formats/#bed3","title":"BED3","text":"<p>Standard 3-column BED format for genomic intervals.</p>"},{"location":"reference/input-formats/#format_1","title":"Format","text":"<pre><code>chrom    start    end\n</code></pre> Column Type Description chrom string Chromosome (e.g., <code>chr1</code>, <code>chrX</code>) start int 0-based start position end int 1-based end position (exclusive)"},{"location":"reference/input-formats/#example","title":"Example","text":"<pre><code>chr1    0   100000\nchr1    100000  200000\nchr2    0   100000\n</code></pre>"},{"location":"reference/input-formats/#used-by_1","title":"Used By","text":"<ul> <li><code>--bin-input</code> / <code>-b</code> - Custom bins for FSC/FSR</li> <li><code>--target-regions</code> / <code>-T</code> - Panel capture regions</li> <li><code>--mark-input</code> / <code>-m</code> - UXM methylation markers</li> </ul>"},{"location":"reference/input-formats/#gene-bed","title":"Gene BED","text":"<p>Extended BED format for gene annotations with 4-5 columns.</p>"},{"location":"reference/input-formats/#format_2","title":"Format","text":"<pre><code>chrom    start    end    gene    [name]\n</code></pre> Column Type Required Description chrom string \u2705 Chromosome start int \u2705 0-based start end int \u2705 1-based end gene string \u2705 Gene symbol (e.g., <code>TP53</code>) name string Optional Exon/region name"},{"location":"reference/input-formats/#example_1","title":"Example","text":"<pre><code>chr17   7676594 7676707 TP53    exon1\nchr17   7676707 7676863 TP53    exon2\nchr7    140719327   140724764   BRAF    exon15\n</code></pre>"},{"location":"reference/input-formats/#used-by_2","title":"Used By","text":"<ul> <li>Custom gene files for panel FSC</li> </ul>"},{"location":"reference/input-formats/#arms-bed","title":"Arms BED","text":"<p>Chromosome arm annotations for FSD analysis.</p>"},{"location":"reference/input-formats/#format_3","title":"Format","text":"<pre><code>chrom    start    end    arm\n</code></pre> Column Type Description chrom string Chromosome (e.g., <code>chr1</code>) start int 0-based start position end int 1-based end position arm string Arm identifier (must match pattern: <code>Np</code> or <code>Nq</code>)"},{"location":"reference/input-formats/#arm-pattern","title":"Arm Pattern","text":"<p>The arm column must match the regex pattern: <code>^\\d{1,2}[pq]$</code></p> <p>Valid examples: <code>1p</code>, <code>1q</code>, <code>22p</code>, <code>22q</code> Invalid: <code>Arm1</code>, <code>chr1p</code>, <code>p</code></p>"},{"location":"reference/input-formats/#example_2","title":"Example","text":"<pre><code>chr1    0   125000000   1p\nchr1    125000000   249250621   1q\nchr2    0   93300000    2p\nchr2    93300000    243199373   2q\n</code></pre>"},{"location":"reference/input-formats/#used-by_3","title":"Used By","text":"<ul> <li><code>--arms-file</code> / <code>-a</code> - Custom chromosome arms for FSD</li> </ul>"},{"location":"reference/input-formats/#wps-anchors","title":"WPS Anchors","text":"<p>BED6 format for WPS anchor regions (TSS, CTCF sites, etc.).</p>"},{"location":"reference/input-formats/#format_4","title":"Format","text":"<pre><code>chrom    start    end    name    score    strand\n</code></pre> Column Type Description chrom string Chromosome start int 0-based start end int 1-based end name string Anchor name (e.g., <code>TP53_TSS</code>) score int Score (typically 0) strand string Strand: <code>+</code>, <code>-</code>, or <code>.</code>"},{"location":"reference/input-formats/#example_3","title":"Example","text":"<pre><code>chr1    11873   14409   DDX11L1_TSS 0   +\nchr1    29553   31109   MIR1302-2_TSS   0   +\nchr17   7676594 7676707 TP53_TSS    0   -\n</code></pre>"},{"location":"reference/input-formats/#used-by_4","title":"Used By","text":"<ul> <li><code>--wps-anchors</code> - Custom WPS anchor regions</li> <li><code>--wps-background</code> / <code>-B</code> - Background normalization regions</li> </ul>"},{"location":"reference/input-formats/#region-bed","title":"Region BED","text":"<p>Labeled genomic regions for OCF, TFBS, and ATAC analysis.</p>"},{"location":"reference/input-formats/#format_5","title":"Format","text":"<pre><code>chrom    start    end    label\n</code></pre> Column Type Description chrom string Chromosome start int 0-based start end int 1-based end label string Region label (tissue, TF name, cancer type)"},{"location":"reference/input-formats/#example_4","title":"Example","text":"<pre><code>chr1    100 500 Liver\nchr1    600 900 Lung\nchr2    1000    1500    Blood\n</code></pre>"},{"location":"reference/input-formats/#used-by_5","title":"Used By","text":"<ul> <li><code>--ocr-file</code> / <code>-r</code> - Open chromatin regions for OCF</li> <li><code>--tfbs-regions</code> - Transcription factor binding sites</li> <li><code>--atac-regions</code> - ATAC-seq peaks</li> </ul>"},{"location":"reference/input-formats/#gc-factors-tsv","title":"GC Factors TSV","text":"<p>Tab-separated correction factors for GC bias normalization.</p>"},{"location":"reference/input-formats/#format_6","title":"Format","text":"<pre><code>length_bin    gc_pct    factor\n</code></pre> Column Type Description length_bin int Fragment length bin: <code>(length - 60) // 5</code> gc_pct int GC percentage (0-100) factor float Correction factor (typically 0.5-2.0)"},{"location":"reference/input-formats/#example_5","title":"Example","text":"<pre><code>length_bin  gc_pct  factor\n10  40  1.05\n10  41  1.03\n10  42  0.98\n11  40  1.02\n</code></pre>"},{"location":"reference/input-formats/#notes_1","title":"Notes","text":"<ul> <li>Length bin 10 corresponds to fragments 110-114bp</li> <li>GC percentage is rounded to the nearest integer</li> <li>Factors near 1.0 indicate minimal bias</li> </ul>"},{"location":"reference/input-formats/#used-by_6","title":"Used By","text":"<ul> <li><code>--gc-factors</code> / <code>-F</code> - Custom GC correction factors</li> </ul>"},{"location":"reference/input-formats/#compression-support","title":"Compression Support","text":"<p>All BED files can be gzip-compressed (<code>.bed.gz</code>). Krewlyzer automatically detects and handles compression.</p> <pre><code># Both work\nkrewlyzer validate --arms-bed my_arms.bed\nkrewlyzer validate --arms-bed my_arms.bed.gz\n</code></pre>"},{"location":"reference/input-formats/#validation","title":"Validation","text":"<p>Validate your files before analysis:</p> <pre><code># Validate specific files\nkrewlyzer validate --gene-bed my_genes.bed\nkrewlyzer validate --arms-bed my_arms.bed --wps-anchors my_anchors.bed\n\n# Validate bundled assets\nkrewlyzer validate --genome hg19\n</code></pre> <p>If validation fails, you'll see: - Expected format and columns - Line number of the first error - Example of correct format</p> <p>See Troubleshooting &gt; Asset Validation for common errors.</p>"},{"location":"reference/output-files/","title":"Output Files","text":""},{"location":"reference/output-files/#output-files-reference","title":"Output Files Reference","text":"<p>Complete reference for every file Krewlyzer produces \u2014 what it contains, what each column means, when to use it, and how to apply it in ML models.</p>"},{"location":"reference/output-files/#quick-reference","title":"Quick Reference","text":"File Feature Resolution ML Signal <code>{s}.FSD.tsv</code> FSD Per chr arm Arm-level fragmentation shift <code>{s}.FSR.tsv</code> FSR 5 Mb window PON-normalized short/long ratio <code>{s}.FSC.tsv</code> FSC 5 Mb window Multi-channel size coverage <code>{s}.FSC.gene.tsv</code> FSC Per gene Gene fragmentation composition <code>{s}.FSC.regions.tsv</code> FSC Per exon/target Exon fragmentation composition <code>{s}.FSC.regions.e1only.tsv</code> FSC-E1 Per gene (E1) Promoter-proximal signal <code>{s}.fsc_counts.tsv</code> FSC-raw Per GC bin GC correction diagnostics <code>{s}.WPS.parquet</code> WPS Per anchor Nucleosome positioning <code>{s}.WPS.panel.parquet</code> WPS Panel anchors Gene-level nucleosome <code>{s}.WPS_background.parquet</code> WPS-bg Alu stacks Global chromatin state <code>{s}.EndMotif.tsv</code> Motif Global (1 row) 256 4-mer end frequencies <code>{s}.EndMotif1mer.tsv</code> Motif Global (4 rows) Base composition at ends <code>{s}.BreakPointMotif.tsv</code> Motif Global (1 row) 256 4-mer break frequencies <code>{s}.MDS.tsv</code> MDS Global (1 row) Motif diversity scalar <code>{s}.MDS.exon.tsv</code> Region-MDS Per exon Per-exon motif diversity <code>{s}.MDS.gene.tsv</code> Region-MDS Per gene Per-gene MDS + E1 <code>{s}.OCF.tsv</code> OCF Per tissue Tissue-of-origin score <code>{s}.OCF.sync.tsv</code> OCF Positional Strand-phased profiles <code>{s}.TFBS.tsv</code> TFBS Per TF TF footprint entropy <code>{s}.TFBS.sync.tsv</code> TFBS Per TF \u00d7 size Size-resolved TF profiles <code>{s}.ATAC.tsv</code> ATAC Per tissue ATAC region entropy <code>{s}.ATAC.sync.tsv</code> ATAC Per tissue \u00d7 size Size-resolved ATAC profiles <code>{s}.mFSD.tsv</code> mFSD Per variant Variant fragment size metrics <code>{s}.mFSD.distributions.tsv</code> mFSD Per variant \u00d7 size Raw size histograms <code>{s}.UXM.tsv</code> UXM Per region U/X/M methylation fractions <code>{s}.correction_factors.tsv</code> GC Per (len, GC) bin GC bias weights <code>{s}.metadata.json</code> Meta Global Run parameters + QC <code>{s}.features.json</code> All All Unified ML feature export <p><code>{s}</code> = sample name.</p>"},{"location":"reference/output-files/#on-target-vs-off-target-files","title":"On-Target vs Off-Target Files","text":"<p>Most fragmentomics features generate two parallel outputs in panel mode: a standard file (off-target reads) and an <code>.ontarget.tsv</code> variant (on-target reads). Understanding the difference is critical for choosing the right input to any ML model.</p>"},{"location":"reference/output-files/#what-on-target-and-off-target-mean","title":"What \"On-Target\" and \"Off-Target\" Mean","text":"<p>In panel sequencing (e.g. MSK-ACCESS), reads fall into two categories:</p> Category Reads Depth GC bias Off-target Do NOT overlap capture bait regions Low (~1\u20135\u00d7) but genome-wide Unbiased \u2014 not affected by probe GC On-target Overlap the capture bait regions High (~500\u20132000\u00d7) but only at panel genes Biased \u2014 capture efficiency varies by probe GC content"},{"location":"reference/output-files/#why-the-split-matters","title":"Why the Split Matters","text":"<pre><code>          All cfDNA fragments in BAM\n                    \u2502\n         \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n    Off-target             On-target\n  (genome-wide)         (panel genes only)\n         \u2502                    \u2502\n   FSC.tsv, FSR.tsv      FSC.ontarget.tsv\n   MDS.tsv, OCF.tsv      MDS.ontarget.tsv\n   FSD.tsv, ...          FSD.ontarget.tsv\n</code></pre> <p>The off-target pool is sampled uniformly across the genome, unaffected by probe GC, making it the gold standard for fragmentation features (FSR, FSC, FSD, MDS, OCF). The GC correction model is also trained exclusively on off-target fragments.</p> <p>The on-target pool has high depth at panel loci but is confounded by capture efficiency \u2014 probes with higher GC content capture more efficiently, making fragment size distributions at those loci appear artificially different. On-target reads are primarily useful for gene-level copy number and region-specific analysis, not genome-wide fragmentation.</p>"},{"location":"reference/output-files/#which-to-use","title":"Which to Use","text":"Task Use Reason Pan-cancer ML features (FSR, FSC, FSD, MDS, OCF) Off-target (<code>.tsv</code>) Unbiased, genome-wide, GC-corrected with unbiased model Gene-level copy number (FSC.gene.tsv) On-target internally Gene FSC already uses on-target correction factors Gene fragmentation composition (FSC.regions, E1) On-target reads, but captured in gene/region TSVs Not the raw <code>.ontarget.tsv</code> \u2014 use FSC.gene / FSC.regions Motif features for tissue-of-origin (MDS, EDM, BPM) Off-target (<code>.tsv</code>) On-target motifs are biased by probe sequence MDS on-target (when off-target too sparse) <code>.ontarget.tsv</code> Lower depth but gene-anchored signal OCF tissue-of-origin Off-target (<code>.tsv</code>) On-target OCF biased by capture regions' tissue specificity Building a PON Off-target only Must match what the sample uses <p>Do not mix off-target and on-target in the same model</p> <p>Features from <code>FSR.tsv</code> (off-target) and <code>FSR.ontarget.tsv</code> (on-target) are not on the same scale. The on-target pool has different GC bias, different fragment size distributions, and different effective depth. Always use the same variant consistently across all samples in a cohort.</p>"},{"location":"reference/output-files/#complete-on-target-off-target-file-inventory","title":"Complete On-Target / Off-Target File Inventory","text":"Base file On-target variant Off-target variant <code>{s}.FSD.tsv</code> <code>{s}.FSD.ontarget.tsv</code> \u2014 (base is off-target) <code>{s}.FSR.tsv</code> <code>{s}.FSR.ontarget.tsv</code> \u2014 <code>{s}.FSC.tsv</code> <code>{s}.FSC.ontarget.tsv</code> \u2014 <code>{s}.EndMotif.tsv</code> <code>{s}.EndMotif.ontarget.tsv</code> \u2014 <code>{s}.BreakPointMotif.tsv</code> <code>{s}.BreakPointMotif.ontarget.tsv</code> \u2014 <code>{s}.MDS.tsv</code> <code>{s}.MDS.ontarget.tsv</code> \u2014 <code>{s}.OCF.tsv</code> <code>{s}.OCF.ontarget.tsv</code> <code>{s}.OCF.offtarget.tsv</code> \u26a0\ufe0f <code>{s}.OCF.sync.tsv</code> <code>{s}.OCF.ontarget.sync.tsv</code> <code>{s}.OCF.offtarget.sync.tsv</code> <code>{s}.TFBS.tsv</code> <code>{s}.TFBS.ontarget.tsv</code> \u2014 <code>{s}.TFBS.sync.tsv</code> <code>{s}.TFBS.ontarget.sync.tsv</code> \u2014 <code>{s}.ATAC.tsv</code> <code>{s}.ATAC.ontarget.tsv</code> \u2014 <code>{s}.ATAC.sync.tsv</code> <code>{s}.ATAC.ontarget.sync.tsv</code> \u2014 <code>{s}.correction_factors.tsv</code> <code>{s}.correction_factors.ontarget.tsv</code> \u2014 <p>\u26a0\ufe0f OCF <code>offtarget</code> is a special case: OCF computes 3 variants \u2014 all reads, on-target reads, and a panel-specific off-target score derived from regions near but not in the capture baits. The <code>OCF.offtarget.tsv</code> is the panel-off-target score, not the same concept as the base <code>OCF.tsv</code>.</p>"},{"location":"reference/output-files/#gc-correction-and-on-target","title":"GC Correction and On-Target","text":"<p>GC correction is trained on off-target reads only, then applied to both pools:</p> <pre><code>Off-target reads \u2192 GC model training \u2192 correction_factors.tsv\nOn-target reads  \u2192 correction_factors.ontarget.tsv (separate model)\n</code></pre> <p>The on-target GC model accounts for probe-specific capture bias. It is used internally when generating <code>FSC.gene.tsv</code> and <code>FSC.regions.tsv</code> \u2014 you do not need to apply it manually.</p>"},{"location":"reference/output-files/#core-fragmentomics","title":"Core Fragmentomics","text":""},{"location":"reference/output-files/#fsd-fragment-size-distribution","title":"FSD (Fragment Size Distribution)","text":"<p>File: <code>{sample}.FSD.tsv</code> / <code>{sample}.FSD.ontarget.tsv</code></p> <p>FSD measures how many fragments of each size (65\u2013400 bp, 5 bp bins) come from each chromosomal arm. Each row is one arm.</p>"},{"location":"reference/output-files/#columns","title":"Columns","text":"Column Type Description <code>region</code> str Arm label, e.g. <code>chr1p</code>, <code>chr17q</code> <code>65-69</code>, <code>70-74</code>, \u2026 <code>395-399</code> float GC-corrected fragment count in that 5 bp size bin <code>total</code> float Total GC-corrected fragment count for this arm"},{"location":"reference/output-files/#purpose-use-cases","title":"Purpose &amp; Use Cases","text":"<ul> <li>ARM-LEVEL fragmentation fingerprint: Each arm's histogram reflects the chromatin state of that chromosomal region</li> <li>Aneuploidy / CNV detection: Arms with deletions or amplifications show altered absolute counts in <code>total</code></li> <li>Tumor-specific size shift: Cancer plasma shows a systematic shift toward shorter fragments genome-wide</li> </ul>"},{"location":"reference/output-files/#ml-use-case","title":"ML Use Case","text":"<pre><code>import pandas as pd\nimport numpy as np\n\ndf = pd.read_csv(\"sample.FSD.tsv\", sep=\"\\t\", index_col=\"region\")\nsize_cols = [c for c in df.columns if c != \"total\"]\n\n# Feature vector: proportion of each size class per arm\nprops = df[size_cols].div(df[\"total\"] + 1e-9, axis=0)\n\n# Reduce to 3-class: short (65-149), mono (150-259), long (260-400)\nprops[\"short_frac\"] = props[[c for c in size_cols if int(c.split(\"-\")[0]) &lt; 150]].sum(axis=1)\nprops[\"mono_frac\"]  = props[[c for c in size_cols if 150 &lt;= int(c.split(\"-\")[0]) &lt; 260]].sum(axis=1)\nprops[\"long_frac\"]  = props[[c for c in size_cols if int(c.split(\"-\")[0]) &gt;= 260]].sum(axis=1)\n</code></pre> <p>Best for: Arm-level <code>short_frac</code> as 46-feature input (2 arms \u00d7 23 chromosomes) per sample for pan-cancer models.</p> <p>On-target variant</p> <p><code>FSD.ontarget.tsv</code> uses only reads overlapping target capture regions. Useful for panel-specific copy number analysis, but capture-biased \u2014 prefer off-target for fragmentation ML features.</p>"},{"location":"reference/output-files/#fsr-fragment-size-ratio","title":"FSR (Fragment Size Ratio)","text":"<p>File: <code>{sample}.FSR.tsv</code> / <code>{sample}.FSR.ontarget.tsv</code></p> <p>FSR computes the PON-normalized short-to-long ratio per 5 Mb window. This is the primary genome-wide tumor fraction biomarker.</p>"},{"location":"reference/output-files/#columns_1","title":"Columns","text":"Column Type Description <code>region</code> str 5 Mb window, e.g. <code>chr1:0-5000000</code> <code>short_count</code> float GC-corrected count of short frags (65\u2013149 bp) <code>long_count</code> float GC-corrected count of long frags (261\u2013400 bp) <code>total_count</code> float Total GC-corrected count <code>short_norm</code> float <code>short_count / PON_short_mean</code> \u2014 PON-normalized short <code>long_norm</code> float <code>long_count / PON_long_mean</code> \u2014 PON-normalized long <code>short_long_ratio</code> float <code>short_norm / long_norm</code> \u2014 primary biomarker <code>short_long_log2</code> float <code>log2(short_long_ratio)</code> \u2014 ML-ready signed metric <code>short_frac</code> float <code>short_count / total_count</code> \u2014 raw proportion <code>long_frac</code> float <code>long_count / total_count</code> \u2014 raw proportion"},{"location":"reference/output-files/#purpose-use-cases_1","title":"Purpose &amp; Use Cases","text":"<ul> <li>Tumor fraction estimation: <code>short_long_ratio</code> increases proportionally with ctDNA fraction</li> <li>Genome-wide cancer screen: Profile of 500+ windows per sample captures focal and arm-level alterations</li> <li>PON comparison: PON normalization (<code>short_norm</code>, <code>long_norm</code>) removes batch effects before ratio \u2014 critical for cross-batch comparison</li> </ul> <p>Why not just use <code>short_frac</code> from FSC?</p> <p><code>short_frac</code> is a raw proportion \u2014 it conflates true biology with library prep and GC bias. <code>short_long_ratio</code> divides PON-normalized values, canceling technical noise. Use FSR for any cross-sample comparison.</p>"},{"location":"reference/output-files/#ml-use-case_1","title":"ML Use Case","text":"<pre><code>df = pd.read_csv(\"sample.FSR.tsv\", sep=\"\\t\")\n\n# Primary feature vector: ~500 windows \u00d7 1 scalar\nfeature_vec = df[\"short_long_log2\"].values  # signed, mean ~0 in healthy\n\n# Genome-wide statistics as compact features\nfeatures = {\n    \"fsr_mean\":   df[\"short_long_log2\"].mean(),\n    \"fsr_std\":    df[\"short_long_log2\"].std(),\n    \"fsr_q90\":    df[\"short_long_log2\"].quantile(0.9),\n    \"fsr_n_elevated\": (df[\"short_long_log2\"] &gt; 0.3).sum(),\n}\n</code></pre> <p>Typical range: healthy ~0.0 \u00b1 0.15; high ctDNA &gt; +0.4 (more short frags than PON)</p>"},{"location":"reference/output-files/#fsc-fragment-size-coverage","title":"FSC (Fragment Size Coverage)","text":"<p>File: <code>{sample}.FSC.tsv</code> / <code>{sample}.FSC.ontarget.tsv</code></p> <p>FSC counts fragments in 6 non-overlapping size channels across 5 Mb windows \u2014 the foundational multi-channel coverage feature.</p>"},{"location":"reference/output-files/#columns_2","title":"Columns","text":"Column Type Description <code>chrom</code> str Chromosome <code>start</code> int Window start (0-based) <code>end</code> int Window end <code>ultra_short</code> float GC-corrected count, 65\u2013100 bp <code>core_short</code> float GC-corrected count, 101\u2013149 bp <code>mono_nucl</code> float GC-corrected count, 150\u2013220 bp <code>di_nucl</code> float GC-corrected count, 221\u2013260 bp <code>long</code> float GC-corrected count, 261\u2013400 bp <code>ultra_long</code> float GC-corrected count, 401\u20131000 bp <code>total</code> float GC-corrected total, 65\u20131000 bp <code>mean_gc</code> float Mean GC fraction of fragments in window <code>*_log2</code> float log\u2082(channel / PON_mean), with <code>--pon-model</code> <code>*_reliability</code> float 1/(PON_variance + k) \u2014 weight for PON columns"},{"location":"reference/output-files/#purpose-use-cases_2","title":"Purpose &amp; Use Cases","text":"<ul> <li>Multi-channel fragmentation profile: Each channel represents fragments sharing a biological origin (nucleosomal, sub-nucleosomal, apoptotic)</li> <li>CNV proxy: <code>total</code> counts per arm reflect coverage depth \u2014 useful for detecting large-scale copy number events</li> <li>PON log2 ratios: <code>core_short_log2</code>, <code>mono_nucl_log2</code> etc. are analogous to CNV log-ratio tracks</li> </ul>"},{"location":"reference/output-files/#ml-use-case_2","title":"ML Use Case","text":"<pre><code>df = pd.read_csv(\"sample.FSC.tsv\", sep=\"\\t\")\n\n# 6-channel feature matrix: windows \u00d7 channels\nchannels = [\"ultra_short\", \"core_short\", \"mono_nucl\", \"di_nucl\", \"long\", \"ultra_long\"]\nX = df[channels].values  # shape: (n_windows, 6)\n\n# Normalize to proportions (remove depth variation)\nX_prop = X / (df[\"total\"].values[:, None] + 1e-9)\n\n# With PON: use log2 ratios directly (already depth-normalized)\nlog2_cols = [c + \"_log2\" for c in channels if c + \"_log2\" in df.columns]\nX_pon = df[log2_cols].values  # shape: (n_windows, 6) \u2014 centered near 0 in healthy\n</code></pre> <p>Best for: Input to CNV callers, genome-wide fragmentation classifiers, and tumor fraction regression.</p>"},{"location":"reference/output-files/#fsc-gene-level","title":"FSC Gene-Level","text":"<p>File: <code>{sample}.FSC.gene.tsv</code> Requires: <code>--assay xs2</code> (or other assay code) / <code>run-all</code></p> <p>Aggregates FSC across all exons for each panel gene. Rows = genes.</p>"},{"location":"reference/output-files/#columns_3","title":"Columns","text":"Column Type Description <code>gene</code> str HGNC symbol (e.g. <code>ATM</code>, <code>TP53</code>) <code>n_regions</code> int Number of exons/targets captured <code>total_bp</code> int Total base pairs covered <code>ultra_short</code> \u2026 <code>long</code> float GC-corrected count per size class <code>total</code> float Total GC-corrected count <code>ultra_short_ratio</code> \u2026 <code>long_ratio</code> float <code>channel / total</code> \u2014 size composition <code>normalized_depth</code> float RPKM-like: <code>(total \u00d7 10\u2079) / (total_bp \u00d7 total_frags)</code>"},{"location":"reference/output-files/#purpose-use-cases_3","title":"Purpose &amp; Use Cases","text":"<ul> <li>Gene-level copy number: <code>normalized_depth</code> enables comparing coverage across genes in the same sample</li> <li>Gene fragmentation composition: <code>*_ratio</code> columns show whether a gene's reads are enriched for short (tumor) or long (normal) fragments</li> <li>Panel-level feature matrix: 146 genes \u00d7 6 channels = 876 features per sample</li> </ul>"},{"location":"reference/output-files/#ml-use-case_3","title":"ML Use Case","text":"<pre><code>df = pd.read_csv(\"sample.FSC.gene.tsv\", sep=\"\\t\").set_index(\"gene\")\n\n# Gene-level short enrichment\ndf[\"tumor_signal\"] = df[\"ultra_short_ratio\"] + df[\"core_short_ratio\"]\n\n# Full channel composition feature matrix: 146 genes \u00d7 5 ratios\nratio_cols = [\"ultra_short_ratio\", \"core_short_ratio\", \"mono_nucl_ratio\", \"di_nucl_ratio\", \"long_ratio\"]\nX = df[ratio_cols].values  # shape: (146, 5) per sample\n\n# Normalized depth for CNV\ncnv_proxy = df[\"normalized_depth\"]  # pivot across samples \u2192 CNV log-ratio\n</code></pre> <p>Best for: Gene-specific models, tissue-of-origin (which genes show altered fragmentation), copy number inference.</p>"},{"location":"reference/output-files/#fsc-region-level","title":"FSC Region-Level","text":"<p>File: <code>{sample}.FSC.regions.tsv</code> Requires: <code>--assay</code> or <code>run-all</code></p> <p>Per-exon/target fragment size coverage. Most granular FSC output.</p>"},{"location":"reference/output-files/#columns_4","title":"Columns","text":"Column Type Description <code>chrom</code> str Chromosome <code>start</code> / <code>end</code> int Exon/target coordinates <code>gene</code> str Gene symbol <code>region_name</code> str Unique exon/target identifier <code>region_bp</code> int Region size in bp <code>ultra_short</code> \u2026 <code>long</code> float GC-corrected counts <code>total</code> float Total count <code>ultra_short_ratio</code> \u2026 <code>long_ratio</code> float <code>channel / total</code> <code>normalized_depth</code> float RPKM-like depth"},{"location":"reference/output-files/#purpose-use-cases_4","title":"Purpose &amp; Use Cases","text":"<ul> <li>Exon-level resolution: Useful when only specific exons (e.g., hotspot exons in <code>TP53</code>) show altered fragmentation</li> <li>Fine-grained CNV: Detect focal amplifications or deletions at single-exon scale</li> <li>Input for PON building: Use to compute exon-level expected depth profiles</li> </ul>"},{"location":"reference/output-files/#ml-use-case_4","title":"ML Use Case","text":"<pre><code>df = pd.read_csv(\"sample.FSC.regions.tsv\", sep=\"\\t\")\n\n# Pivot: regions \u00d7 channels, one row per region\npivot = df.pivot_table(index=\"region_name\", values=[\"core_short_ratio\", \"mono_nucl_ratio\"])\n\n# Filter to well-covered regions\nwell_covered = df[df[\"total\"] &gt; 50][\"region_name\"]\ndf_filtered = df[df[\"region_name\"].isin(well_covered)]\n</code></pre>"},{"location":"reference/output-files/#fsc-e1-only","title":"FSC E1-Only","text":"<p>File: <code>{sample}.FSC.regions.e1only.tsv</code> Requires: <code>--assay</code> or <code>run-all</code> (disable with <code>--disable-e1-aggregation</code>)</p> <p>First exon (E1) per gene only. Same columns as <code>FSC.regions.tsv</code>.</p>"},{"location":"reference/output-files/#purpose-use-cases_5","title":"Purpose &amp; Use Cases","text":"<ul> <li>Promoter-proximal fragmentation: E1 = first exon = nucleosome-depleted region (NDR) near TSS. NDRs have the most cancer-specific fragmentation patterns (Helzer et al. 2025)</li> <li>Highest cancer signal: E1 consistently outperforms whole-gene FSC in early cancer detection tasks</li> <li>Compact feature set: 146 genes \u00d7 1 exon = compact, interpretable vector</li> </ul>"},{"location":"reference/output-files/#ml-use-case_5","title":"ML Use Case","text":"<pre><code>df = pd.read_csv(\"sample.FSC.regions.e1only.tsv\", sep=\"\\t\").set_index(\"gene\")\n\n# Primary cancer signal: promoter short enrichment\ndf[\"promoter_short\"] = df[\"ultra_short_ratio\"] + df[\"core_short_ratio\"]\n\n# 146-gene feature vector \u2014 best single FSC feature for early detection\nX = df[\"promoter_short\"].values\n</code></pre> <p>Use E1 over gene-level for early detection models</p> <p><code>e1only</code> routinely achieves lower AUC for early-stage cancer vs <code>FSC.gene.tsv</code> because E1 captures NDR-specific fragmentation that is washed out by whole-gene averaging.</p>"},{"location":"reference/output-files/#fsc-counts-pre-correction","title":"FSC Counts (Pre-Correction)","text":"<p>File: <code>{sample}.fsc_counts.tsv</code> / <code>{sample}.correction_factors.ontarget.tsv</code></p> <p>Raw bin-level fragment counts before GC correction \u2014 used internally for GC model training.</p>"},{"location":"reference/output-files/#purpose-use-cases_6","title":"Purpose &amp; Use Cases","text":"<ul> <li>GC bias diagnostics: Compare observed vs expected counts per (length, GC) bin</li> <li>Batch QC: Libraries with systematic GC bias show large correction factors in specific bins</li> <li>Not for ML features: GC-corrected values in <code>FSC.tsv</code> are the right input; <code>fsc_counts</code> is pre-correction</li> </ul>"},{"location":"reference/output-files/#nucleosome-positioning","title":"Nucleosome Positioning","text":""},{"location":"reference/output-files/#wps-windowed-protection-score","title":"WPS (Windowed Protection Score)","text":"<p>File: <code>{sample}.WPS.parquet</code></p> <p>Per-anchor nucleosome protection profiles. Each row is one genomic anchor (gene TSS or CTCF site). WPS captures how protected (nucleosome-covered) a region is to fragments of two sizes.</p>"},{"location":"reference/output-files/#columns-parquet","title":"Columns (Parquet)","text":"Column Type Description <code>region_id</code> str Anchor identifier (e.g. <code>ENSG00000142611_TSS</code>) <code>chrom</code> str Chromosome <code>center</code> int Anchor midpoint <code>strand</code> str <code>+</code> / <code>-</code> <code>region_type</code> str <code>TSS</code>, <code>CTCF</code>, etc. <code>wps_nuc</code> float Raw nucleosomal WPS (120\u2013180 bp fragments) <code>wps_tf</code> float Raw TF footprint WPS (35\u201380 bp fragments) <code>wps_nuc_smooth</code> float Savitzky-Golay smoothed nucleosomal WPS <code>wps_tf_smooth</code> float Savitzky-Golay smoothed TF WPS <code>wps_nuc_mean</code> float Mean WPS across anchor window <code>wps_tf_mean</code> float Mean TF WPS across anchor window <code>prot_frac_nuc</code> float Fraction of window with WPS &gt; 0 (nucleosome-covered) <code>prot_frac_tf</code> float Fraction of window with TF WPS &gt; 0 <code>wps_nuc_z</code> float Z-score vs PON baseline (with <code>--pon-model</code>) <code>wps_tf_z</code> float TF WPS Z-score vs PON"},{"location":"reference/output-files/#purpose-use-cases_7","title":"Purpose &amp; Use Cases","text":"<ul> <li>Nucleosome positioning: <code>wps_nuc_smooth</code> detects nucleosome phasing at TSS/CTCF anchors</li> <li>TF accessibility: <code>wps_tf</code> / <code>prot_frac_tf</code> reflects accessible chromatin at TF binding sites</li> <li>Cancer signal: Tumor DNA shows flattened/disrupted WPS profiles at TSS of active genes</li> <li>NRL (Nucleosome Repeat Length): Computed in <code>WPS_background.parquet</code> from Alu stacking</li> </ul>"},{"location":"reference/output-files/#ml-use-case_6","title":"ML Use Case","text":"<pre><code>import pandas as pd\n\ndf = pd.read_parquet(\"sample.WPS.parquet\")\n\n# Feature vector per sample: mean WPS across all anchors\nfeatures = {\n    \"wps_nuc_global_mean\": df[\"wps_nuc_mean\"].mean(),\n    \"wps_nuc_global_std\":  df[\"wps_nuc_mean\"].std(),\n    \"prot_frac_nuc_mean\":  df[\"prot_frac_nuc\"].mean(),\n    \"prot_frac_tf_mean\":   df[\"prot_frac_tf\"].mean(),\n}\n\n# Per-anchor feature matrix for gene-level models\nX = df[[\"wps_nuc_mean\", \"wps_tf_mean\", \"prot_frac_nuc\", \"prot_frac_tf\"]].values\n# shape: (~15,000 anchors, 4) \u2014 one row per TSS/CTCF\n</code></pre> <p>Best for: Deep learning input (WPS profiles as 1D signals), nucleosome periodicity score, TSS accessibility classifier.</p>"},{"location":"reference/output-files/#wps-panel","title":"WPS Panel","text":"<p>File: <code>{sample}.WPS.panel.parquet</code> Requires: <code>--assay</code></p> <p>Same columns as <code>WPS.parquet</code>, filtered to panel gene anchors (~1,820 for xs2). Rows are panel-gene TSS and CTCF sites.</p>"},{"location":"reference/output-files/#ml-use-case_7","title":"ML Use Case","text":"<pre><code>df = pd.read_parquet(\"sample.WPS.panel.parquet\")\n\n# Compact panel feature: 1820 anchors \u00d7 4 = 7280 features\nX = df[[\"wps_nuc_mean\", \"wps_tf_mean\", \"prot_frac_nuc\", \"prot_frac_tf\"]].values\n\n# Gene-indexed lookup\ndf_gene = df.set_index(\"region_id\")\ntp53_wps = df_gene.loc[\"TP53_TSS\", \"wps_nuc_mean\"]\n</code></pre>"},{"location":"reference/output-files/#wps-background","title":"WPS Background","text":"<p>File: <code>{sample}.WPS_background.parquet</code></p> <p>Hierarchical Alu element stacking analysis capturing global chromatin state and nucleosome repeat length (NRL).</p>"},{"location":"reference/output-files/#columns_5","title":"Columns","text":"Column Type Description <code>group_id</code> str <code>Global_All</code>, <code>Family_AluY/S/J/Other</code>, <code>Chr{N}_All</code> <code>stacked_wps_nuc</code> float[] 30-position binned stacked WPS (nucleosomal) <code>stacked_wps_tf</code> float[] 30-position binned stacked WPS (TF) <code>alu_count</code> int Number of Alu elements in this group <code>mean_wps_nuc</code> float Mean WPS amplitude <code>nrl_bp</code> float Estimated Nucleosome Repeat Length in bp (~190 in healthy) <code>nrl_deviation_bp</code> float Deviation from expected 190 bp NRL <code>periodicity_score</code> float Signal-to-noise ratio of periodicity (0\u20131) <code>adjusted_score</code> float Periodicity score penalized by NRL deviation <code>fragment_ratio</code> float Ratio of short/long fragments at Alu sites"},{"location":"reference/output-files/#purpose-use-cases_8","title":"Purpose &amp; Use Cases","text":"<ul> <li>Global chromatin compaction: <code>nrl_bp</code> shortens in cancer (chromatin opens globally)</li> <li>NRL as tumor biomarker: Healthy plasma NRL ~190 bp; cancer &lt; 185 bp</li> <li>Background correction: Used to compute \"global_pon\" baseline for WPS z-scores</li> </ul>"},{"location":"reference/output-files/#ml-use-case_8","title":"ML Use Case","text":"<pre><code>df = pd.read_parquet(\"sample.WPS_background.parquet\")\nglobal_row = df[df[\"group_id\"] == \"Global_All\"].iloc[0]\n\nfeatures = {\n    \"nrl_bp\": global_row[\"nrl_bp\"],\n    \"periodicity_score\": global_row[\"periodicity_score\"],\n    \"adjusted_score\": global_row[\"adjusted_score\"],\n    \"fragment_ratio_bg\": global_row[\"fragment_ratio\"],\n}\n</code></pre> <p>Best for: Global chromatin state features, cancer screening, NRL as continuous tumor fraction predictor.</p>"},{"location":"reference/output-files/#motif-tissue-of-origin","title":"Motif &amp; Tissue-of-Origin","text":""},{"location":"reference/output-files/#endmotif","title":"EndMotif","text":"<p>File: <code>{sample}.EndMotif.tsv</code> / <code>{sample}.EndMotif.ontarget.tsv</code></p> <p>4-mer frequencies at fragment 5\u2032 ends. One row per sample, 256 columns (one per AAAA\u2192TTTT 4-mer).</p>"},{"location":"reference/output-files/#columns_6","title":"Columns","text":"Column Description <code>AAAA</code> \u2026 <code>TTTT</code> Frequency of that 4-mer at fragment ends (sums to 1.0)"},{"location":"reference/output-files/#purpose-use-cases_9","title":"Purpose &amp; Use Cases","text":"<ul> <li>Tissue-of-origin: Different tissues have distinct end-motif preferences based on DNASE1L3 activity</li> <li>Cancer detection: DNASE1L3 is suppressed in cancer, producing a flattened, less-specific motif profile</li> <li>MDS input: Raw material for Motif Diversity Score calculation</li> </ul>"},{"location":"reference/output-files/#ml-use-case_9","title":"ML Use Case","text":"<pre><code>df = pd.read_csv(\"sample.EndMotif.tsv\", sep=\"\\t\")\n# Single row: 256 4-mer frequencies\nX = df.iloc[0].values  # 256-dimensional feature vector\n\n# Reduce by GC content group (64 \u2192 5 groups)\ngc_groups = {\"AT-rich\": [k for k in df.columns if k.count(\"A\") + k.count(\"T\") &gt;= 3], ...}\n</code></pre>"},{"location":"reference/output-files/#endmotif-1-mer","title":"EndMotif 1-mer","text":"<p>File: <code>{sample}.EndMotif1mer.tsv</code></p> <p>Single-base (A/C/G/T) composition at fragment ends.</p>"},{"location":"reference/output-files/#columns-base-fraction","title":"Columns: <code>base</code>, <code>fraction</code>","text":""},{"location":"reference/output-files/#purpose-use-cases_10","title":"Purpose &amp; Use Cases","text":"<ul> <li>GC bias QC: Should be roughly balanced; extreme GC skew indicates library quality issues</li> <li>DNASE1L3 proxy: Healthy cfDNA has distinct strand-asymmetric base preferences</li> </ul>"},{"location":"reference/output-files/#breakpointmotif","title":"BreakPointMotif","text":"<p>File: <code>{sample}.BreakPointMotif.tsv</code> / <code>{sample}.BreakPointMotif.ontarget.tsv</code></p> <p>4-mer frequencies at internal fragment breakpoints (rather than ends). Same 256-column format as EndMotif.</p>"},{"location":"reference/output-files/#purpose-vs-endmotif","title":"Purpose vs EndMotif","text":"EndMotif BreakPointMotif Measures DNASE1L3 cutting preference Mechanical fragmentation patterns Cancer signal DNASE1L3 suppression Chromatin compaction / MNase-like cleavage Correlation r ~ 0.6 with BPM Complementary signal <p>Best for: Combining both in multimodal ML models \u2014 they capture distinct biological processes.</p>"},{"location":"reference/output-files/#mds-motif-diversity-score","title":"MDS (Motif Diversity Score)","text":"<p>File: <code>{sample}.MDS.tsv</code> / <code>{sample}.MDS.ontarget.tsv</code></p> <p>Single-number summary of end-motif randomness (Shannon entropy of 256 4-mers).</p>"},{"location":"reference/output-files/#columns-mds-float","title":"Columns: <code>MDS</code> (float)","text":"<p>Range: Healthy plasma ~0.80\u20130.85; cancer (DNASE1L3 suppressed) &lt; 0.75</p>"},{"location":"reference/output-files/#ml-use-case_10","title":"ML Use Case","text":"<pre><code>mds = float(pd.read_csv(\"sample.MDS.tsv\", sep=\"\\t\")[\"MDS\"].iloc[0])\n# Single scalar \u2014 highly interpretable cancer feature\n</code></pre>"},{"location":"reference/output-files/#mds-exon-level","title":"MDS Exon-Level","text":"<p>File: <code>{sample}.MDS.exon.tsv</code> Requires: <code>region-mds</code> command or <code>run-all</code></p> <p>MDS calculated per exon/target from BAM reads overlapping that region.</p>"},{"location":"reference/output-files/#columns_7","title":"Columns","text":"Column Description <code>gene</code> Gene symbol <code>name</code> Exon identifier (<code>gene:exonN</code> for WGS; target name for panel) <code>chrom</code> Chromosome <code>start</code> / <code>end</code> Exon coordinates <code>strand</code> Strand <code>n_fragments</code> Fragments overlapping this exon <code>mds</code> Motif Diversity Score for this exon"},{"location":"reference/output-files/#ml-use-case_11","title":"ML Use Case","text":"<pre><code>df = pd.read_csv(\"sample.MDS.exon.tsv\", sep=\"\\t\")\n\n# Filter low-coverage exons\ndf_high = df[df[\"n_fragments\"] &gt;= 20]\n\n# Per-exon MDS as feature matrix (rows = exons)\nX = df_high[[\"mds\"]].values  # or pivot into gene \u00d7 exon matrix\n</code></pre>"},{"location":"reference/output-files/#mds-gene-level","title":"MDS Gene-Level","text":"<p>File: <code>{sample}.MDS.gene.tsv</code> Requires: <code>region-mds</code> command or <code>run-all</code></p> <p>Gene-level aggregation of per-exon MDS, plus E1 (first exon) MDS as the promoter-proximal signal.</p>"},{"location":"reference/output-files/#columns_8","title":"Columns","text":"Column Description <code>gene</code> Gene symbol <code>n_exons</code> Number of exons with data <code>n_fragments</code> Total fragments across all exons <code>mds_mean</code> Mean MDS across all exons <code>mds_e1</code> MDS of E1 (first exon) only <code>mds_std</code> Standard deviation of per-exon MDS <code>mds_z</code> Z-score vs PON (with <code>--pon-model</code>) <code>mds_e1_z</code> E1 MDS z-score vs PON"},{"location":"reference/output-files/#ml-use-case_12","title":"ML Use Case","text":"<pre><code>df = pd.read_csv(\"sample.MDS.gene.tsv\", sep=\"\\t\").set_index(\"gene\")\n\n# E1 MDS is highest-signal feature (promoter-proximal NDR)\nX_e1 = df[\"mds_e1\"].values           # 146 features for panel\nX_z  = df[\"mds_e1_z\"].fillna(0).values  # PON-normalized \u2014 zero-centered in healthy\n</code></pre> <p>Best for: Gene-level cancer classifiers, promoter aberration detection, combining with FSC-E1.</p>"},{"location":"reference/output-files/#ocf-orientation-aware-cfdna-fragmentation","title":"OCF (Orientation-aware cfDNA Fragmentation)","text":"<p>File: <code>{sample}.OCF.tsv</code> / <code>{sample}.OCF.ontarget.tsv</code> / <code>{sample}.OCF.offtarget.tsv</code></p> <p>Tissue-of-origin scores based on strand asymmetry of fragment ends at tissue-specific open chromatin regions.</p>"},{"location":"reference/output-files/#columns_9","title":"Columns","text":"Column Description <code>tissue</code> Tissue type (Liver, Lung, Colon, Placenta, etc.) <code>OCF</code> Raw score = <code>(U - D) / (U + D)</code> \u2014 upstream/downstream asymmetry <code>ocf_z</code> OCF z-score vs PON (with <code>--pon-model</code>)"},{"location":"reference/output-files/#purpose-use-cases_11","title":"Purpose &amp; Use Cases","text":"<ul> <li>Tissue-of-origin: Which tissue contributed most cfDNA \u2014 useful for cancer site-of-origin</li> <li>Multi-tissue mixture deconvolution: Multiple elevated <code>ocf_z</code> values suggest multi-tissue contribution</li> <li>ctDNA fraction proxy: Overall OCF magnitude correlates with cfDNA purity</li> </ul>"},{"location":"reference/output-files/#ml-use-case_13","title":"ML Use Case","text":"<pre><code>df = pd.read_csv(\"sample.OCF.tsv\", sep=\"\\t\").set_index(\"tissue\")\n\n# OCF score vector across tissues (e.g. 10 tissues = 10 features)\nX_ocf = df[\"OCF\"].values\nX_z   = df[\"ocf_z\"].fillna(0).values  # zero-centered in healthy\n\n# Tissue with max signal\ntop_tissue = df[\"ocf_z\"].idxmax()\n</code></pre> <p>Best for: Primary tumor site-of-origin classification, multi-class tissue deconvolution.</p>"},{"location":"reference/output-files/#ocf-sync","title":"OCF Sync","text":"<p>File: <code>{sample}.OCF.sync.tsv</code></p> <p>Positional strand-specific protection profiles \u2014 detailed positional data underlying the OCF summary score.</p>"},{"location":"reference/output-files/#columns-label-count-mean_size-entropy","title":"Columns: <code>label</code>, <code>count</code>, <code>mean_size</code>, <code>entropy</code>","text":"<p>Use: Raw data for visualizing strand phasing; input to advanced nucleosome positioning models.</p>"},{"location":"reference/output-files/#tfbs-transcription-factor-binding-site-entropy","title":"TFBS (Transcription Factor Binding Site Entropy)","text":"<p>File: <code>{sample}.TFBS.tsv</code> / <code>{sample}.TFBS.ontarget.tsv</code></p> <p>Fragment size entropy at TFBS regions for 808 transcription factors. Reflects chromatin accessibility and TF binding.</p>"},{"location":"reference/output-files/#columns_10","title":"Columns","text":"Column Description <code>label</code> TF name (e.g. <code>CTCF</code>, <code>SP1</code>, <code>E2F1</code>) <code>count</code> Fragment count <code>mean_size</code> Mean fragment size at this TF's sites <code>entropy</code> Shannon entropy of fragment size distribution"},{"location":"reference/output-files/#purpose-use-cases_12","title":"Purpose &amp; Use Cases","text":"<ul> <li>TF accessibility: Low entropy = dominated by one size class (nucleosomal); high entropy = mixed, accessible</li> <li>TF-specific cancer signal: Some TFs (E2F family, SP1) show altered fragmentation in cancer</li> <li>808-feature vector: One entropy value per TF = large, rich feature set</li> </ul>"},{"location":"reference/output-files/#ml-use-case_14","title":"ML Use Case","text":"<pre><code>df = pd.read_csv(\"sample.TFBS.tsv\", sep=\"\\t\").set_index(\"label\")\n\n# 808 TF entropy values \u2014 high-dimensional feature vector\nX_tfbs = df[\"entropy\"].values\n\n# Mean size as complementary feature\nX_size = df[\"mean_size\"].values\n\n# Combine\nX = np.stack([X_tfbs, X_size], axis=1)  # shape: (808, 2)\n</code></pre>"},{"location":"reference/output-files/#tfbs-sync","title":"TFBS Sync","text":"<p>File: <code>{sample}.TFBS.sync.tsv</code></p> <p>Per-TF \u00d7 per-size distribution \u2014 the raw size histogram for each TF.</p>"},{"location":"reference/output-files/#columns-label-size-count-proportion","title":"Columns: <code>label</code>, <code>size</code>, <code>count</code>, <code>proportion</code>","text":"<p>Use: Size-resolved TF footprinting; input for detecting nucleosome-footprint transitions.</p>"},{"location":"reference/output-files/#atac-chromatin-accessibility-entropy","title":"ATAC (Chromatin Accessibility Entropy)","text":"<p>File: <code>{sample}.ATAC.tsv</code> / <code>{sample}.ATAC.ontarget.tsv</code></p> <p>Fragment size entropy at ATAC-seq accessible regions for 23 cancer-relevant tissue types.</p>"},{"location":"reference/output-files/#columns_11","title":"Columns","text":"<p>Same as TFBS: <code>label</code> (tissue type), <code>count</code>, <code>mean_size</code>, <code>entropy</code></p>"},{"location":"reference/output-files/#purpose-use-cases_13","title":"Purpose &amp; Use Cases","text":"<ul> <li>Tissue-specific accessibility: Which tissue's ATAC peaks show altered fragmentation</li> <li>Cancer type inference: Different cancer types show tissue-specific ATAC entropy patterns</li> <li>Complementary to OCF: OCF uses strand asymmetry; ATAC uses size entropy \u2014 different signal axis</li> </ul>"},{"location":"reference/output-files/#ml-use-case_15","title":"ML Use Case","text":"<pre><code>df = pd.read_csv(\"sample.ATAC.tsv\", sep=\"\\t\").set_index(\"label\")\n\n# 23 tissue entropy values \u2014 compact tissue-of-origin feature\nX_atac = df[\"entropy\"].values\n\n# Combine OCF + ATAC tissue vectors for multimodal tissue classifier\nX_combined = np.concatenate([ocf_scores, atac_entropy])\n</code></pre>"},{"location":"reference/output-files/#atac-sync","title":"ATAC Sync","text":"<p>File: <code>{sample}.ATAC.sync.tsv</code></p> <p>Per-tissue \u00d7 per-size fragment distributions.</p>"},{"location":"reference/output-files/#columns-label-size-count-proportion_1","title":"Columns: <code>label</code>, <code>size</code>, <code>count</code>, <code>proportion</code>","text":""},{"location":"reference/output-files/#variant-level","title":"Variant-Level","text":""},{"location":"reference/output-files/#mfsd-mutant-fragment-size-distribution","title":"mFSD (Mutant Fragment Size Distribution)","text":"<p>File: <code>{sample}.mFSD.tsv</code> Requires: <code>--maf</code> / <code>run-all</code> with MAF input</p> <p>Per-variant fragment size analysis. Compares ALT-bearing fragments vs REF, NonREF, and N (uncertain) allele classes.</p>"},{"location":"reference/output-files/#column-groups-46-total","title":"Column Groups (46 total)","text":"Group Columns Description Variant (5) <code>Chrom</code>, <code>Pos</code>, <code>Ref</code>, <code>Alt</code>, <code>VarType</code> Variant coordinates and type Raw Counts (5) <code>REF_Count</code>, <code>ALT_Count</code>, <code>NonREF_Count</code>, <code>N_Count</code>, <code>Total_Count</code> Fragments per allele class GC-Weighted (5) <code>REF_Weighted</code>, <code>ALT_Weighted</code>, <code>NonREF_Weighted</code>, <code>N_Weighted</code>, <code>VAF_GC_Corrected</code> GC-corrected counts and VAF Log-Likelihood (2) <code>ALT_LLR</code>, <code>REF_LLR</code> For low-N variants (ALT_Count &lt; 5) Mean Sizes (4) <code>REF_MeanSize</code>, <code>ALT_MeanSize</code>, <code>NonREF_MeanSize</code>, <code>N_MeanSize</code> Mean fragment size per class KS Tests (18) <code>Delta_*/KS_*/KS_Pval_*</code> \u00d7 6 pairings KS distance + p-value for each allele pair Derived (5) <code>VAF_Proxy</code>, <code>Error_Rate</code>, <code>N_Rate</code>, <code>Size_Ratio</code>, <code>Quality_Score</code> Summary biomarkers Flags (2) <code>ALT_Confidence</code>, <code>KS_Valid</code> Quality indicators"},{"location":"reference/output-files/#purpose-use-cases_14","title":"Purpose &amp; Use Cases","text":"<ul> <li>MRD detection: <code>VAF_GC_Corrected</code> + <code>KS_Pval_ALT_REF</code> identify true somatic mutations vs noise</li> <li>Fragment size as orthogonal evidence: <code>Delta_ALT_REF</code> negative = ALT fragments shorter than REF = tumor-derived ctDNA</li> <li>Duplex support: <code>ALT_LLR</code> provides statistically valid evidence even at 1\u20132 fragment counts</li> <li>Multi-variant aggregation: Combine evidence across many variants to estimate ctDNA fraction</li> </ul>"},{"location":"reference/output-files/#ml-use-case_16","title":"ML Use Case","text":"<pre><code>df = pd.read_csv(\"sample.mFSD.tsv\", sep=\"\\t\")\n\n# Filter to high-quality variants\ndf_hq = df[(df[\"ALT_Confidence\"] == \"HIGH\") &amp; (df[\"KS_Valid\"] == True)]\n\n# Per-variant feature vector\nfeatures = df_hq[[\"VAF_GC_Corrected\", \"Delta_ALT_REF\", \"KS_ALT_REF\",\n                   \"Size_Ratio\", \"Quality_Score\", \"ALT_LLR\"]].values\n\n# Sample-level aggregation: weighted average across variants\nsample_vaf = (df_hq[\"VAF_GC_Corrected\"] * df_hq[\"Quality_Score\"]).sum() / df_hq[\"Quality_Score\"].sum()\n</code></pre> <p>Best for: MRD detection models, ctDNA fraction estimation from targeted panels, variant-level cancer classifiers.</p>"},{"location":"reference/output-files/#mfsd-distributions","title":"mFSD Distributions","text":"<p>File: <code>{sample}.mFSD.distributions.tsv</code> Requires: <code>--output-distributions</code> flag</p> <p>Per-variant raw size histograms for manual inspection.</p>"},{"location":"reference/output-files/#columns-chrom-pos-ref-alt-category-size-count","title":"Columns: <code>Chrom</code>, <code>Pos</code>, <code>Ref</code>, <code>Alt</code>, <code>Category</code>, <code>Size</code>, <code>Count</code>","text":"<p>Use: Visualizing the ALT vs REF size shift for individual variants; QC and debugging.</p>"},{"location":"reference/output-files/#methylation","title":"Methylation","text":""},{"location":"reference/output-files/#uxm-methylation","title":"UXM (Methylation)","text":"<p>File: <code>{sample}.UXM.tsv</code> Requires: Methylation-enabled BAM input</p> <p>CpG methylation classification per genomic region. Each fragment is classified as Unmethylated (U), Partially-methylated (X), or fully Methylated (M).</p>"},{"location":"reference/output-files/#columns_12","title":"Columns","text":"Column Description <code>region</code> Genomic region identifier <code>U</code> Fraction of unmethylated fragments <code>X</code> Fraction of partially methylated fragments <code>M</code> Fraction of fully methylated fragments"},{"location":"reference/output-files/#purpose-use-cases_15","title":"Purpose &amp; Use Cases","text":"<ul> <li>Tumor DNA methylation: Cancer shows global hypomethylation (\u2191U) and focal hypermethylation (\u2191M at TSGs)</li> <li>Tissue-of-origin: Tissue-specific methylation patterns enable ctDNA source attribution</li> <li>Multi-modal fusion: Combine with FSR and MDS for maximum sensitivity in early detection</li> </ul>"},{"location":"reference/output-files/#ml-use-case_17","title":"ML Use Case","text":"<pre><code>df = pd.read_csv(\"sample.UXM.tsv\", sep=\"\\t\").set_index(\"region\")\n\n# 3-class methylation state per region\nX = df[[\"U\", \"X\", \"M\"]].values  # shape: (n_regions, 3); rows sum to 1.0\n\n# Sample-level statistics\nfeatures = {\n    \"global_U\": df[\"U\"].mean(),   # high = hypomethylation (cancer signal)\n    \"global_M\": df[\"M\"].mean(),   # varies by tissue\n    \"U_std\": df[\"U\"].std(),       # heterogeneity across regions\n}\n</code></pre>"},{"location":"reference/output-files/#diagnostic-qc-outputs","title":"Diagnostic / QC Outputs","text":""},{"location":"reference/output-files/#gc-correction-factors","title":"GC Correction Factors","text":"<p>File: <code>{sample}.correction_factors.tsv</code> / <code>{sample}.correction_factors.ontarget.tsv</code></p> <p>GC-bias correction weights per (fragment length bin, GC content) pair.</p>"},{"location":"reference/output-files/#columns_13","title":"Columns","text":"Column Description <code>length_bin_min</code> Fragment length bin lower bound (bp) <code>length_bin_max</code> Fragment length bin upper bound (bp) <code>gc_percent</code> GC content percentage (0\u2013100) <code>observed</code> Observed fragment count <code>expected</code> Expected count from GC model <code>correction_factor</code> <code>expected / observed</code> \u2014 multiply raw counts by this"},{"location":"reference/output-files/#purpose-use-cases_16","title":"Purpose &amp; Use Cases","text":"<ul> <li>Library QC: Values far from 1.0 indicate GC bias in sequencing/capture</li> <li>Batch effect debugging: Compare correction factors across runs to detect systematic issues</li> <li>Input to GC model PON: Used to build PON correction factor baselines</li> </ul> <p>Not for ML features</p> <p>GC correction is already applied to FSC, FSR, FSD, and WPS outputs. Use those corrected values. <code>correction_factors.tsv</code> is diagnostic data.</p>"},{"location":"reference/output-files/#metadata-json","title":"Metadata JSON","text":"<p>File: <code>{sample}.metadata.json</code></p> <p>Run parameters, QC metrics, and processing provenance.</p> <pre><code>{\n  \"sample_id\": \"sample_001\",\n  \"krewlyzer_version\": \"0.6.0\",\n  \"genome\": \"hg19\",\n  \"assay\": \"xs2\",\n  \"total_fragments\": 8234567,\n  \"on_target_rate\": 0.44,\n  \"mean_fragment_size\": 168.3,\n  \"duplication_rate\": 0.12,\n  \"processing_time_s\": 342.1\n}\n</code></pre> <p>Use: Filter samples by QC thresholds before ML training (e.g. <code>total_fragments &gt; 5M</code>, <code>on_target_rate &gt; 0.3</code>).</p>"},{"location":"reference/output-files/#features-json","title":"Features JSON","text":"<p>File: <code>{sample}.features.json</code> Requires: <code>--generate-json</code></p> <p>Unified export of all features above in a single JSON file for ML pipelines. See JSON Output Reference for the complete schema.</p> <pre><code>import json\nwith open(\"sample.features.json\") as f:\n    features = json.load(f)\n\n# Access any output without reading individual TSVs\nfsr_windows = features[\"fsr\"][\"off_target\"]\nmds = features[\"motif\"][\"mds\"]\nregion_mds = features[\"region_mds\"][\"gene\"]\n</code></pre>"},{"location":"reference/output-files/#feature-selection-guide-for-ml-models","title":"Feature Selection Guide for ML Models","text":"Model type Recommended features File(s) Pan-cancer screen (WGS) FSR <code>short_long_log2</code>, MDS, WPS <code>prot_frac_nuc_mean</code>, FSD <code>short_frac</code> FSR, MDS, WPS_background, FSD Pan-cancer screen (panel) FSC-E1 <code>promoter_short</code>, MDS-E1, OCF <code>ocf_z</code>, WPS panel FSC.e1only, MDS.gene, OCF, WPS.panel Tumor fraction regression FSR <code>short_long_log2</code> genome-wide, WPS <code>nrl_bp</code> FSR, WPS_background Cancer type / site-of-origin OCF tissue vector, ATAC tissue vector, TFBS vector OCF, ATAC, TFBS Gene-level amplification FSC gene <code>normalized_depth</code>, FSD arm <code>total</code> FSC.gene, FSD MRD (residual disease) mFSD <code>VAF_GC_Corrected</code>, <code>Quality_Score</code>, <code>Delta_ALT_REF</code> mFSD Promoter accessibility WPS E1 <code>wps_nuc_mean</code>, MDS E1, FSC-E1 ratios WPS.panel, MDS.gene, FSC.e1only Methylation-augmented UXM <code>U</code>/<code>M</code> + FSR + MDS UXM, FSR, MDS"},{"location":"reference/output-files/#see-also","title":"See Also","text":"<ul> <li>JSON Output Reference \u2014 unified JSON schema for all features</li> <li>FSR vs FSC ratios \u2014 why they differ</li> <li>PON Models \u2014 normalization baselines</li> <li>GC Correction \u2014 correction methodology</li> </ul>"},{"location":"reference/pon-models/","title":"PON Models","text":""},{"location":"reference/pon-models/#panel-of-normals-pon","title":"Panel of Normals (PON)","text":"<p>The Panel of Normals (PON) is a unified model built from healthy plasma samples that enables:</p> <ol> <li>GC bias correction - Per-fragment correction for GC content bias</li> <li>Z-score normalization - Detect deviations from healthy baseline for all features</li> <li>Panel mode support - Dual on/off-target baselines for capture panels</li> </ol>"},{"location":"reference/pon-models/#quick-start","title":"Quick Start","text":"<pre><code># Build PON from healthy samples\nkrewlyzer build-pon samples.txt --assay msk-access-v2 -r hg19.fa -o pon.parquet\n\n# Use PON for sample processing\nkrewlyzer run-all -i sample.bam -r hg19.fa -o out/ -P pon.parquet\n</code></pre>"},{"location":"reference/pon-models/#auto-pon-loading","title":"Auto-PON Loading","text":"<p>When you specify an assay with <code>-A</code>, krewlyzer automatically loads the bundled PON:</p> <pre><code># Auto-loads bundled PON for xs2 assay\nkrewlyzer run-all -i sample.bam -r hg19.fa -o out/ -A xs2 -G hg19\n</code></pre> <p>This is equivalent to explicitly passing <code>-P</code> with the bundled PON path.</p>"},{"location":"reference/pon-models/#skipping-z-score-normalization-skip-pon","title":"Skipping Z-Score Normalization (<code>--skip-pon</code>)","text":"<p>For ML training workflows where PON samples are used as true negatives, use <code>--skip-pon</code> to output raw features without z-score normalization:</p> <pre><code># Process PON samples as ML negatives (no z-scores)\nkrewlyzer run-all -i pon_sample.bam -r hg19.fa -o out/ -A xs2 --skip-pon\n</code></pre> <p>Warning</p> <p><code>-P</code> and <code>--skip-pon</code> are mutually exclusive. If you specify an explicit PON model, you want z-scores applied. Use <code>--skip-pon</code> only with <code>-A</code> (assay) for the ML negatives workflow.</p> <p>The <code>--skip-pon</code> flag: - Works with <code>-A/--assay</code> (auto-loads bundled PON but skips z-scores) - Available on all tools: <code>run-all</code>, <code>fsc</code>, <code>fsd</code>, <code>fsr</code>, <code>wps</code>, <code>ocf</code>, <code>region-entropy</code>, <code>motif</code> - Logs which tools are skipping normalization</p>"},{"location":"reference/pon-models/#pon-variant-selection-pon-variant","title":"PON Variant Selection (<code>--pon-variant</code>)","text":"<p>For duplex sequencing workflows (fgbio/Marianas), use <code>--pon-variant duplex</code> to select PONs built from duplex consensus reads:</p> <pre><code># Default: all_unique PON (maximum coverage for standard cfDNA)\nkrewlyzer run-all -i sample.bam -r hg19.fa -o out/ -A xs2\n\n# Duplex PON (highest accuracy for duplex sequencing data)\nkrewlyzer run-all -i sample.bam -r hg19.fa -o out/ -A xs2 --pon-variant duplex\n</code></pre> Variant Description Best For <code>all_unique</code> Built from all unique reads Standard cfDNA (default) <code>duplex</code> Built from duplex consensus reads Duplex sequencing workflows <p>Tip</p> <p>The <code>--pon-variant</code> flag is independent of the <code>--duplex</code> flag for mFSD. Use <code>--duplex</code> for mFSD weighting (enables cD tag usage), and <code>--pon-variant</code> for PON selection across all tools.</p> <p>The <code>--pon-variant</code> flag: - Defaults to <code>all_unique</code> (maximum coverage PON) - Available on all PON-using tools: <code>run-all</code>, <code>fsc</code>, <code>fsd</code>, <code>fsr</code>, <code>wps</code>, <code>ocf</code>, <code>motif</code>, <code>region-entropy</code>, <code>region-mds</code> - File structure: <code>pon/{genome}/{variant}/{assay}.{variant}.pon.parquet</code></p>"},{"location":"reference/pon-models/#pon-components","title":"PON Components","text":"Component Description Used By GC Bias Model Expected coverage by GC content per fragment type FSC, FSR, WPS FSD Baseline Size distribution per chromosome arm FSD WPS Baseline WPS mean/std per transcript region WPS OCF Baseline Open chromatin scores per region OCF MDS Baseline k-mer frequencies and motif diversity Motif TFBS Baseline Per-TF entropy mean/std Region Entropy ATAC Baseline Per-cancer-type entropy mean/std Region Entropy Region MDS Baseline Per-gene MDS mean/std for E1 Region MDS FSC Gene Baseline Per-gene normalized depth mean/std FSC Gene FSC Region Baseline Per-exon normalized depth mean/std FSC Region"},{"location":"reference/pon-models/#panel-mode","title":"Panel Mode","text":"<p>For capture panels (like MSK-ACCESS), use <code>--target-regions</code> when building the PON:</p> <pre><code>krewlyzer build-pon samples.txt -a msk-access-v2 -r hg19.fa -T targets.bed -o pon.parquet\n</code></pre> <p>This enables:</p> <ul> <li>GC model trained on off-target only - Avoids capture bias</li> <li>Separate on/off-target baselines - For features that differ in captured regions</li> <li>Panel mode detection - Sample processing auto-detects matching PON mode</li> </ul>"},{"location":"reference/pon-models/#building-a-pon","title":"Building a PON","text":"<p>See build-pon CLI for detailed options.</p> <p>Requirements: - Minimum 10 healthy samples recommended - Same assay/panel as samples to be processed - Same reference genome</p>"},{"location":"reference/pon-models/#using-pon-in-processing","title":"Using PON in Processing","text":"<p>When <code>--pon-model</code> is provided to <code>run-all</code>:</p> <ol> <li>PON is loaded once and passed to all processors</li> <li>Each feature computes z-scores against healthy baseline</li> <li>Output includes both raw values and PON-normalized columns</li> </ol>"},{"location":"reference/pon-models/#output-columns","title":"Output Columns","text":"<p>With PON, additional columns are added to outputs:</p> Feature PON Column(s) Description FSC <code>*_log2</code> Log2 ratio vs PON expected FSC Gene <code>depth_zscore</code> Gene-level depth z-score FSC Region <code>depth_zscore</code> Exon-level depth z-score FSD <code>ratio_log2</code> Size distribution log ratio WPS <code>wps_zscore</code> Z-score vs region baseline OCF <code>ocf_zscore</code> Z-score vs OCF baseline Motif <code>mds_z</code> Z-score for MDS TFBS <code>entropy_z</code> Z-score per TF ATAC <code>entropy_z</code> Z-score per cancer type Region MDS <code>mds_z</code>, <code>mds_e1_z</code> Gene-level and E1 z-scores"},{"location":"reference/pon-models/#api-reference","title":"API Reference","text":"<pre><code>from krewlyzer.pon.model import PonModel\n\n# Load existing PON\npon = PonModel.load(\"path/to/pon.parquet\")\n\n# Access components\ngc_expected = pon.get_mean(\"short\")  # Expected at median GC\nvariance = pon.get_variance(\"short\")  # For reliability scoring\n\n# Check panel mode\nif pon.panel_mode:\n    print(f\"Built with: {pon.target_regions_file}\")\n</code></pre>"},{"location":"reference/pon-models/#pon-baselines-in-detail","title":"PON Baselines in Detail","text":""},{"location":"reference/pon-models/#gc-bias-model-gc_bias","title":"GC Bias Model (<code>gc_bias</code>)","text":"<p>Stores expected fragment coverage per GC content (0-100%) for each fragment type:</p> Fragment Type Size Range Purpose <code>short</code> 65-149bp Short fragment correction <code>intermediate</code> 150-259bp Mono-nucleosomal <code>long</code> 260-400bp Di-nucleosomal <code>wps_long</code> 120-180bp WPS nucleosomal <code>wps_short</code> 35-80bp WPS TF footprint"},{"location":"reference/pon-models/#fsd-baseline-fsd_baseline","title":"FSD Baseline (<code>fsd_baseline</code>)","text":"<p>Size distribution per chromosome arm (46 arms): - <code>expected</code>: Mean proportion at each size bin - <code>std</code>: Standard deviation across PON samples</p>"},{"location":"reference/pon-models/#wps-baseline-wps_baseline","title":"WPS Baseline (<code>wps_baseline</code>)","text":"<p>Per-region nucleosome positioning metrics.</p> <p>Schema v1.0 (Scalar): - <code>wps_long_mean/std</code>: Single nucleosomal WPS value per region - <code>wps_short_mean/std</code>: Single TF footprint value per region</p> <p>Schema v2.0 (Vector): - <code>wps_nuc_mean/std</code>: 200-element vector (nucleosomal footprint) - <code>wps_tf_mean/std</code>: 200-element vector (TF footprint)</p> <p>Tip</p> <p>v2.0 enables position-specific z-scores and Shape Correlation Score for cancer detection.</p>"},{"location":"reference/pon-models/#shape-score-interpretation","title":"Shape Score Interpretation","text":"Score Interpretation 0.9-1.0 Healthy nucleosome positioning 0.5-0.9 Mild chromatin disorganization &lt;0.5 Significant disruption (cancer signal) <p>See WPS Features for output column details.</p>"},{"location":"reference/pon-models/#ocf-baseline-ocf_baseline","title":"OCF Baseline (<code>ocf_baseline</code>)","text":"<p>Per-region open chromatin footprint: - <code>ocf_mean/std</code>: OCF score baseline - <code>sync_mean/std</code>: Synchronization score baseline</p>"},{"location":"reference/pon-models/#mds-baseline-mds_baseline","title":"MDS Baseline (<code>mds_baseline</code>)","text":"<p>Motif diversity expectations: - <code>kmer_expected</code>: 256 4-mer frequencies from healthy samples - <code>kmer_std</code>: Variability per k-mer - <code>mds_mean/std</code>: Expected Motif Diversity Score</p>"},{"location":"reference/pon-models/#tfbs-baseline-tfbs_baseline","title":"TFBS Baseline (<code>tfbs_baseline</code>)","text":"<p>Per-TF size entropy: - <code>label_stats</code>: Mean/std entropy per TF (808 transcription factors) - Enables z-score per TF for detailed regulatory analysis</p>"},{"location":"reference/pon-models/#atac-baseline-atac_baseline","title":"ATAC Baseline (<code>atac_baseline</code>)","text":"<p>Per-cancer-type size entropy: - <code>label_stats</code>: Mean/std entropy per cancer type (23 types) - Enables tissue-of-origin scoring</p>"},{"location":"reference/pon-models/#region-mds-baseline-region_mds","title":"Region MDS Baseline (<code>region_mds</code>)","text":"<p>Per-gene MDS expectations: - <code>gene_baseline</code>: Dict of gene \u2192 {mds_mean, mds_std, mds_e1_mean, mds_e1_std} - Enables gene-level anomaly detection - E1 (first exon) tracked separately for promoter-proximal sensitivity</p>"},{"location":"reference/pon-models/#fsc-gene-baseline-fsc_gene_baseline","title":"FSC Gene Baseline (<code>fsc_gene_baseline</code>)","text":"<p>Per-gene normalized depth baseline (panel mode only): - <code>data</code>: Dict of gene \u2192 (mean_depth, std_depth, n_samples) - Requires minimum 3 samples for reliable statistics - Clinical use: z-score &gt;&gt; 0 = amplification, z-score &lt;&lt; 0 = deletion</p>"},{"location":"reference/pon-models/#fsc-region-baseline-fsc_region_baseline","title":"FSC Region Baseline (<code>fsc_region_baseline</code>)","text":"<p>Per-exon/probe normalized depth baseline (panel mode only): - <code>data</code>: Dict of region_id \u2192 (mean_depth, std_depth, n_samples) - Region IDs formatted as \"chrom:start-end\" - Covers all exons (no filtering by variance) - Enables detection of focal copy number changes affecting single exons</p>"},{"location":"reference/pon-models/#interpreting-z-scores","title":"Interpreting Z-Scores","text":"<p>Z-scores measure how many standard deviations a sample differs from the healthy PON baseline:</p> \\[ z = \\frac{x_{\\text{sample}} - \\mu_{\\text{PON}}}{\\sigma_{\\text{PON}}} \\]"},{"location":"reference/pon-models/#clinical-interpretation","title":"Clinical Interpretation","text":"Z-Score Range Interpretation Action -2 to +2 Normal range Within healthy variation ** z = 2-3** ** z &gt; 3** ** z &gt; 5**"},{"location":"reference/pon-models/#per-feature-z-score-meaning","title":"Per-Feature Z-Score Meaning","text":"Feature Z-Score Column Positive Z Means Negative Z Means FSC <code>z_core_short</code> More short fragments Fewer short fragments FSD - Shifted size distribution - WPS <code>wps_nuc_z</code> Stronger nucleosome signal Disrupted nucleosomes OCF <code>ocf_z</code> More open chromatin Less accessible MDS <code>mds_z</code> More diverse motifs Less diverse TFBS <code>entropy_z</code> Higher entropy (diverse sizes) Lower entropy (restricted) ATAC <code>entropy_z</code> Higher entropy Lower entropy Region MDS <code>mds_z</code>, <code>mds_e1_z</code> More diverse at gene Restricted motifs (aberrant)"},{"location":"reference/pon-models/#ml-feature-usage","title":"ML Feature Usage","text":"<pre><code># Extract z-score features for classification\nfeatures = {\n    \"fsc_short_z\": sample_fsc[\"z_core_short\"].mean(),\n    \"wps_nuc_z\": sample_wps[\"wps_nuc_z\"].mean(),\n    \"mds_z\": sample_motif[\"mds_z\"],\n}\n\n# Higher |z| = more likely to be tumor\ncombined_signal = sum(abs(z) for z in features.values())\n</code></pre> <p>Tip</p> <p>Combine z-scores across features - Single extreme values may be noise, but consistent deviations across FSC, WPS, and MDS are highly indicative of ctDNA.</p>"},{"location":"resources/citation/","title":"Citation","text":""},{"location":"resources/citation/#citation-scientific-background","title":"Citation &amp; Scientific Background","text":"<p>If you use Krewlyzer in your work, please cite this repository and the relevant methods papers below.</p>"},{"location":"resources/citation/#primary-literature","title":"Primary Literature","text":"<p>Krewlyzer implements or adapts methods from the following foundational papers in cfDNA fragmentomics:</p>"},{"location":"resources/citation/#ocf","title":"OCF \u2014 Orientation-aware Fragmentation","text":"<p>Sun K, Jiang P, Chan KC, et al. Orientation-aware plasma cell-free DNA fragmentation analysis in open chromatin regions informs tissue of origin. Genome Res. 2019;29(3):418-427. DOI</p> <p>Key Concept: OCF measures differentially phased fragment ends (Upstream/Downstream) at tissue-specific open chromatin regions to infer tissue-of-origin.</p> <p>Mechanism: - In open chromatin \u2192 nucleosomes are evicted \u2192 longer linker DNA exposed - During apoptosis \u2192 endonuclease cuts exposed linker DNA - Creates characteristic pattern: U ends peak ~60bp right, D ends peak ~60bp left of OCR center</p> <p>Healthy Baseline: - T-cells: Highest OCF (dominant cfDNA source) - Liver: Second highest - Other tissues: Near zero</p> <p>Cancer Pattern:</p> Cancer Type OCF Change HCC (liver) \u2191 Liver OCF, correlates with tumor fraction (R=0.36) Colorectal \u2191 Intestine OCF (R=0.89), \u2193 T-cell OCF Lung \u2191 Lung OCF, \u2193 T-cell OCF"},{"location":"resources/citation/#wps","title":"WPS \u2014 Windowed Protection Score","text":"<p>Snyder MW, Kircher M, Hill AJ, Daza RM, Shendure J. Cell-free DNA Comprises an In Vivo Nucleosome Footprint that Informs Its Tissues-Of-Origin. Cell. 2016;164(1-2):57-68. DOI</p> <p>Key Concept: WPS quantifies nucleosome occupancy by comparing fragments that span a protection window vs those ending within it.</p> <p>Formula: </p><pre><code>WPS(k) = N_spanning(k) - N_ends(k)\n</code></pre><p></p> <p>Interpretation:</p> WPS Value Meaning Positive Nucleosome present (DNA protected) ~Zero Transitional region Negative Open chromatin (nucleosome-free) <p>Healthy vs Cancer: - Nucleosome patterns are cell-type specific \u2192 infer tissue-of-origin - Cancer: Aberrant nucleosome positioning at oncogene/TSG promoters - Loss of 10bp periodicity at dysregulated genes</p> <p></p>"},{"location":"resources/citation/#fsr","title":"FSC/FSR \u2014 Fragment Size Coverage &amp; Ratio (DELFI)","text":"<p>Cristiano S, et al. Genome-wide cell-free DNA fragmentation in patients with cancer. Nature. 2019;570(7761):385-389. DOI</p> <p>Mouliere F, Chandrananda D, et al. Enhanced detection of circulating tumor DNA by fragment size analysis. Sci Transl Med. 2018;10(466):eaat4921. DOI</p> <p>Key Concept: DELFI (DNA Evaluation of Fragments for earLy Interception) analyzes short/long fragment ratios genome-wide for cancer detection.</p> <p>Fragment Classes:</p> Class Size Range Origin Short 100-150bp Enriched in tumor cfDNA Long 151-220bp Healthy/mono-nucleosomal <p>Healthy vs Cancer:</p> Metric Healthy Cancer Modal peak ~166bp Left-shifted (~145bp) Short/Long ratio Low (baseline) Elevated Genome-wide variability Minimal Increased aberrations <p>Performance: 57-99% sensitivity across 7 cancer types at 98% specificity (AUC=0.94)</p>"},{"location":"resources/citation/#uxm","title":"UXM \u2014 Fragment-level Methylation","text":"<p>Loyfer N, et al. A DNA methylation atlas of normal human cell types. Nature. 2022;613(7943):355-364. DOI</p> <p>Key Concept: Classify each cfDNA fragment as Unmethylated (U), Mixed (X), or Methylated (M) to deconvolve cell-type contributions.</p> <p>Classification Thresholds: - U: \u226425% methylated CpGs - M: \u226575% methylated CpGs - X: Between 25-75%</p> <p>Healthy cfDNA Composition:</p> Cell Type Contribution Megakaryocytes ~31% Granulocytes ~30% Monocytes/Macrophages ~20% Endothelial ~6% Hepatocytes ~3% <p>Resolution: Achieves ~0.1% detection (10x better than array-based methods)</p>"},{"location":"resources/citation/#motif","title":"Motif / Jagged Ends","text":"<p>Zhou Q, et al. Detection and characterization of jagged ends of double-stranded DNA in plasma. Genome Res. 2020;30(8):1144-1153. DOI</p> <p>Key Concept: cfDNA fragments have single-stranded \"jagged\" ends that vary by tissue origin and health status.</p> <p>Key Findings: - 87.8% of cfDNA molecules have jagged ends - Jaggedness relates to nuclease activity (DNASE1/DNASE1L3) - End motif diversity reflects fragmentation patterns</p> <p>Healthy vs Cancer:</p> Metric Healthy Cancer (ctDNA) Jaggedness Lower Higher Fetal vs Maternal Fetal has higher jaggedness \u2014 Tumor vs Wild-type \u2014 Tumor-derived has higher jaggedness <p>MDS (Motif Diversity Score): - High (~1.0): Random/diverse fragmentation (healthy-like) - Low: Stereotyped fragmentation (possible tumor signal)</p>"},{"location":"resources/citation/#mfsd","title":"mFSD \u2014 Variant-centric Fragment Size","text":"<p>Mouliere F, Chandrananda D, et al. Enhanced detection of circulating tumor DNA by fragment size analysis. Sci Transl Med. 2018;10(466):eaat4921. DOI</p> <p>Key Concept: mFSD analyzes fragment size distributions specifically at variant loci, enabling mutation-level fragmentation profiling.</p> <p>Methodology: - Extract fragments overlapping known variant positions - Compare size distributions of variant-supporting vs wild-type fragments - Tumor-derived fragments tend to be shorter</p> <p>Clinical Application: - Enhanced variant calling specificity - Fragment-level evidence for somatic mutations - Integration with VAF for confident detection</p>"},{"location":"resources/citation/#region-entropy","title":"Region Entropy \u2014 TFBS/ATAC Size Entropy","text":"<p>Helzer KT, Sharifi MN, Sperger JM, et al. Analysis of cfDNA fragmentomics metrics and commercial targeted sequencing panels. Nat Commun 16, 9122 (2025). DOI</p> <p>Key Concept: Shannon entropy of fragment size distributions at transcription factor binding sites (TFBS) and open chromatin regions enables cancer phenotyping.</p> <p>Data Sources: - TFBS: GTRD v19.10 \u2014 808 transcription factors, top 5000 experimentally-supported sites per TF - ATAC: TCGA ATAC-seq \u2014 23 cancer-type-specific open chromatin regions</p> <p>Methodology: From Helzer et al.: \"Shannon entropy was calculated on the frequency of the fragment lengths... This yielded a single entropy value for each TF [or cancer type] in each sample.\"</p> <p>Key Findings: - TFBS/ATAC entropy works well for cancer detection and subtyping - Can be applied to commercial targeted sequencing panels without WGS - Diversity metrics measure the spread of fragment sizes at regulatory regions</p> <p>GitHub Data: Zhao-Lab-UW-DHO/fragmentomics_metrics</p>"},{"location":"resources/citation/#region-mds","title":"Region MDS \u2014 Per-Gene Motif Diversity Score","text":"<p>Helzer KT, Sharifi MN, Sperger JM, et al. Analysis of cfDNA fragmentomics metrics and commercial targeted sequencing panels. Nat Commun 16, 9122 (2025). DOI</p> <p>Key Concept: Region MDS applies Motif Diversity Score (Shannon entropy of 4-mer end motifs) at the gene/exon level rather than globally, enabling detection of localized aberrant fragmentation patterns.</p> <p>Methodology: - Calculate MDS independently for each exon/target region - Identify E1 (first exon) of each gene by genomic position - Aggregate to gene-level statistics (mean, E1, std)</p> <p>Key Findings (from Helzer et al.): - Per-region fragmentomics metrics work effectively on commercial panels - E1 (first exon) closest to promoter shows most pronounced cancer-associated changes - MDS changes correlate with aberrant gene regulation in cancer</p> <p>Interpretation:</p> MDS Value Meaning Higher (~7.5-8.0) Diverse motif usage (healthy) Lower (~6.0-7.0) Restricted motifs (potentially aberrant) <p>Clinical Application: - Detect genes with aberrant fragmentation patterns - Z-score normalization against PON enables per-gene anomaly detection - E1 focus for promoter-proximal signal</p>"},{"location":"resources/citation/#acknowledgements","title":"Acknowledgements","text":"<p>Krewlyzer was developed by Ronak Shah at Memorial Sloan Kettering Cancer Center.</p> <p>The fragmentomics methods implemented here build upon foundational work from laboratories worldwide including Dennis Lo (CUHK), Jay Shendure (UW), Victor Velculescu (JHU), and others.</p>"},{"location":"resources/overview/","title":"Overview","text":""},{"location":"resources/overview/#fragmentomics-overview","title":"Fragmentomics Overview","text":"<p>A comprehensive visual guide to Krewlyzer's fragmentomics features and analysis capabilities.</p> <p></p>"},{"location":"resources/overview/#learn-more","title":"Learn More","text":"Topic Link Getting Started Quickstart Guide Key Concepts cfDNA &amp; Fragmentomics Features Feature Documentation CLI Reference run-all Command"},{"location":"resources/troubleshooting/","title":"Troubleshooting","text":""},{"location":"resources/troubleshooting/#troubleshooting","title":"Troubleshooting","text":""},{"location":"resources/troubleshooting/#common-issues","title":"Common Issues","text":""},{"location":"resources/troubleshooting/#file-not-found-error","title":"File Not Found Error","text":"<p>Error: <code>FileNotFoundError: [Errno 2] No such file or directory</code></p> <p>Solution: Ensure all input files (BAM, FASTA, BED) exist and paths are correct. Use absolute paths.</p>"},{"location":"resources/troubleshooting/#permission-error","title":"Permission Error","text":"<p>Error: <code>PermissionError: [Errno 13] Permission denied</code></p> <p>Solution: Check write permissions for the output directory.</p>"},{"location":"resources/troubleshooting/#missing-dependencies","title":"Missing Dependencies","text":"<p>Error: <code>ModuleNotFoundError: No module named '...'</code></p> <p>Solution: Ensure Krewlyzer is installed correctly: </p><pre><code>uv pip install krewlyzer\n</code></pre> Or use the Docker image for a complete environment.<p></p>"},{"location":"resources/troubleshooting/#reference-mismatch","title":"Reference Mismatch","text":"<p>Issue: Results look wrong or empty.</p> <p>Solution: Ensure BAM files and reference FASTA are from the same genome build (both hg19 or both hg38). Krewlyzer defaults to hg19 for bundled data files.</p>"},{"location":"resources/troubleshooting/#memory-errors","title":"Memory Errors","text":"<p>Issue: Process crashes on large BAM files.</p> <p>Solutions: 1. Increase available RAM (\u226516GB recommended) 2. Reduce thread count: <code>--threads 4</code> 3. Process chromosomes separately: </p><pre><code>krewlyzer extract -i sample.bam -r hg19.fa -o output/ --chromosomes chr1,chr2\n</code></pre><p></p>"},{"location":"resources/troubleshooting/#duplex-bam","title":"Duplex/Consensus BAM Issues","text":""},{"location":"resources/troubleshooting/#filter-compatibility-warning-0-of-reads-pass","title":"\"FILTER COMPATIBILITY WARNING: 0% of reads pass\"","text":"<p>Cause: Duplex or consensus BAMs don't have proper pair flags set correctly. The default <code>--require-proper-pair</code> filter removes all reads.</p> <p>What's happening: - Standard BAMs: R1+R2 reads are flagged as \"proper pairs\" - Duplex BAMs: Consensus reads are often single-ended or unpaired - Result: <code>--require-proper-pair</code> (default) filters out everything</p> <p>Solution: Disable proper pair requirement: </p><pre><code>krewlyzer extract -i duplex.bam -r hg19.fa -o output/ \\\n    --no-require-proper-pair\n\nkrewlyzer run-all -i duplex.bam -r hg19.fa -o output/ \\\n    --no-require-proper-pair\n</code></pre><p></p>"},{"location":"resources/troubleshooting/#auto-detection-in-run-all","title":"Auto-detection in run-all","text":"<p>The <code>run-all</code> command automatically detects this situation:</p> <pre><code>\u26a0\ufe0f FILTER COMPATIBILITY WARNING\n   Only 0.00% of sampled reads would pass current filters.\n   Only 0.0% of reads are marked as proper pairs.\n\n   Suggested command:\n   krewlyzer run-all -i sample.bam ... --no-require-proper-pair\n</code></pre> <p>If you see this warning, re-run with <code>--no-require-proper-pair</code>.</p>"},{"location":"resources/troubleshooting/#which-bam-types-need-no-require-proper-pair","title":"Which BAM types need --no-require-proper-pair?","text":"BAM Type Proper Pairs? Need Flag? Standard WGS \u2705 Yes No Standard Panel \u2705 Yes No Duplex/UMI \u274c No Yes Consensus \u274c No Yes Single-end \u274c No Yes"},{"location":"resources/troubleshooting/#gc-correction","title":"GC Correction Issues","text":""},{"location":"resources/troubleshooting/#gc-correction-assets-not-found","title":"\"GC correction assets not found\"","text":"<p>Cause: Missing GC reference files for the specified genome.</p> <p>Solutions: 1. Verify genome build matches bundled assets:    </p><pre><code>krewlyzer extract -i sample.bam -r hg19.fa -o output/ -G hg19\n</code></pre> 2. Use <code>--no-gc-correct</code> to skip GC correction:    <pre><code>krewlyzer fsc -i sample.bed.gz -o output/ --no-gc-correct\n</code></pre><p></p>"},{"location":"resources/troubleshooting/#correction-factors-look-wrong","title":"Correction factors look wrong","text":"<p>Cause: Insufficient coverage or extreme GC bias.</p> <p>Diagnosis: Check <code>correction_factors.tsv</code>: - Factors should be ~0.5-2.0 for most bins - Extreme factors (&gt;10 or &lt;0.1) indicate problems</p> <p>Solutions: 1. Increase coverage (&gt;1M fragments recommended) 2. Check BAM for quality issues (duplicates, low MAPQ)</p>"},{"location":"resources/troubleshooting/#hg38","title":"hg38 / GRCh38 Issues","text":""},{"location":"resources/troubleshooting/#ocf-regions-not-available-for-hg38","title":"\"OCF regions not available for hg38\"","text":"<p>Cause: Bundled OCF regions only exist for hg19/GRCh37.</p> <p>Solutions: 1. Provide a custom OCR file:    </p><pre><code>krewlyzer ocf -i sample.bed.gz -o output/ -G hg38 \\\n    -r custom_ocr_regions.bed.gz\n</code></pre> 2. In <code>run-all</code>, OCF is automatically skipped for hg38 with a warning<p></p>"},{"location":"resources/troubleshooting/#missing-assets-for-hg38","title":"Missing assets for hg38","text":"<p>Cause: Some bundled assets only exist for hg19.</p> <p>Affected: - OCF regions (hg19 only) - Some methylation markers</p> <p>Solution: Use <code>-G hg19</code> if your data supports both, or provide custom files.</p>"},{"location":"resources/troubleshooting/#asset-validation","title":"Asset Validation","text":""},{"location":"resources/troubleshooting/#validating-custom-files-before-running","title":"Validating custom files before running","text":"<p>If you're using custom override files (e.g., <code>--arms-file</code>, <code>--wps-anchors</code>), validate their format first:</p> <pre><code># Validate specific files\nkrewlyzer validate --gene-bed my_genes.bed\nkrewlyzer validate --arms-bed my_arms.bed --wps-anchors my_anchors.bed\n</code></pre> <p>Validation checks column counts, data types, and format requirements. If a file fails validation, you'll see a detailed error with: - Expected format and columns - Line number of the first error - Example of correct format - Link to documentation</p> <p>See Input File Formats for complete format specifications.</p>"},{"location":"resources/troubleshooting/#validating-bundled-assets","title":"Validating bundled assets","text":"<p>After updating krewlyzer or modifying data files, validate bundled assets:</p> <pre><code># Validate all bundled assets for a genome\nkrewlyzer validate --genome hg19\n\n# Also validate assay-specific assets\nkrewlyzer validate --genome hg19 --assay xs2\n</code></pre>"},{"location":"resources/troubleshooting/#validation-during-analysis","title":"Validation during analysis","text":"<p>For production pipelines, use <code>--validate-assets</code> to verify bundled files before each run:</p> <pre><code># Recommended: validate once when setting up a new environment\nkrewlyzer run-all -i sample.bam -r hg19.fa -o output/ \\\n    --validate-assets\n\n# Or with build-pon\nkrewlyzer build-pon samples.txt -a xs2 -r hg19.fa -o pon.parquet \\\n    --validate-assets\n</code></pre> <p>Tip</p> <p>Use <code>--validate-assets</code> after krewlyzer updates or when debugging unexpected errors. For routine processing, validation overhead (~100ms) can be skipped.</p>"},{"location":"resources/troubleshooting/#common-format-errors","title":"Common format errors","text":"Error Cause Solution \"Expected at least N columns\" Missing columns Ensure file is tab-delimited with all required columns \"Invalid arm format\" Wrong arm name Use patterns like <code>1p</code>, <code>1q</code>, <code>22p</code> (not <code>Arm1</code>) \"Expected numeric\" Non-numeric coordinates Check start/end columns are integers"},{"location":"resources/troubleshooting/#pon","title":"PON Model Issues","text":""},{"location":"resources/troubleshooting/#assay-mismatch-warning","title":"\"Assay mismatch warning\"","text":"<p>Cause: PON model built with different assay than sample.</p> <p>Impact: Results may be less accurate but processing continues.</p> <p>Solution: Use a PON model built from the same assay: </p><pre><code>krewlyzer fsc -i sample.bed.gz -o output/ \\\n    -P matching_assay.pon.parquet\n</code></pre><p></p>"},{"location":"resources/troubleshooting/#pon-normalization-looks-wrong","title":"PON normalization looks wrong","text":"<p>Diagnosis: Check log-ratio columns: - <code>*_logR</code> should be centered around 0 for healthy samples - Extreme values (&gt;5 or &lt;-5) indicate mismatch</p> <p>Solutions: 1. Verify PON matches assay and genome build 2. Run without PON to get raw values:    </p><pre><code>krewlyzer fsc -i sample.bed.gz -o output/\n</code></pre><p></p>"},{"location":"resources/troubleshooting/#panel","title":"Panel Data Issues","text":""},{"location":"resources/troubleshooting/#fscfsr-output-is-all-zeros","title":"FSC/FSR output is all zeros","text":"<p>Cause: Default 100kb bins don't overlap panel targets.</p> <p>Solution: Provide custom bins matching your panel: </p><pre><code>krewlyzer fsc -i sample.bed.gz -o output/ \\\n    --bin-input panel_targets.bed\n</code></pre><p></p>"},{"location":"resources/troubleshooting/#on-target-vs-off-target-confusion","title":"On-target vs off-target confusion","text":"<p>Solution: Use <code>--target-regions</code> to generate separate outputs: </p><pre><code>krewlyzer run-all -i sample.bam -r ref.fa -o output/ \\\n    --target-regions panel_targets.bed\n</code></pre> - <code>.tsv</code> files = off-target (unbiased) - <code>.ontarget.tsv</code> files = on-target (capture-biased)<p></p>"},{"location":"resources/troubleshooting/#getting-help","title":"Getting Help","text":"<p>If your issue isn't listed:</p> <ol> <li>Check GitHub Issues</li> <li>Run with <code>--verbose</code> for detailed logging</li> <li>Open a new issue with:</li> <li>Command used</li> <li>Error message</li> <li>Krewlyzer version (<code>krewlyzer --version</code>)</li> </ol>"}]}